# 未来牛群预测算法 - 详细说明与案例演示

**文档版本**: v1.0
**创建日期**: 2025-11-08
**作者**: 王波臻

---

## 1. 原始数据结构

基于真实数据 `/Users/bozhenwang/GeneticImprove/sheet8_2025_10_12_13_13/raw_data/cow_data.xlsx`

### 1.1 每头牛的核心字段

```python
个体牛数据字段:
- 耳号                    # 牛只ID
- 胎次                    # 0=后备牛, >=1=成母牛
- 月龄                    # 出生后月数
- 日龄                    # 出生后天数
- 泌乳天数 (DIM)          # 产后泌乳天数
- 产后天数                # 最近一次产犊后天数
- 繁育状态                # 出生/产后未配/已配未检/初检孕/复检孕/初检空怀等
- 在胎天数                # 怀孕天数（0=未怀孕）
- 配后天数                # 最近一次配种后天数
- 本胎次配次              # 本胎次已配种次数（0-N）
- 与配冻精编号            # 最近一次使用的冻精
- 最近配种日期
- 预计产犊日期            # 基于受胎日期+280天
- 是否禁配                # 是/否
- 禁配原因
- 牛只类别                # 泌乳牛/干奶牛/围产牛/青年牛/育成牛/断奶犊牛/哺乳犊牛
```

### 1.2 当前牛群实际数据（2025年10月快照）

```
总在场牛数: 4191头
├─ 成母牛(胎次>0): 2444头
│   ├─ 泌乳牛: 1968头
│   ├─ 干奶牛: 360头
│   └─ 围产牛: 116头
└─ 后备牛(胎次=0): 1747头
    ├─ 青年牛(已配/待配): 500头
    ├─ 育成牛: 332头
    ├─ 断奶犊牛: 356头
    ├─ 哺乳犊牛: 401头
    └─ 青年围产牛: 83头

繁育状态分布:
- 复检孕: 1251头 (已确认怀孕)
- 出生: 1163头 (新生犊牛)
- 已配未检: 828头 (配种后等待妊检)
- 产后未配: 651头 (产后自愿等待期)
- 初检孕: 243头 (初次妊检怀孕)
- 初检空怀: 27头 (配种后检查未怀孕)
```

---

## 2. 用户需要录入的预测参数

### 2.1 繁殖管理参数

```python
# 1. 淘汰率 (可按月或按年设置)
淘汰率_成母牛: list[float] = [0.30, 0.28, 0.26, 0.25, 0.25]  # 5年
淘汰率_后备牛: list[float] = [0.08, 0.08, 0.08, 0.08, 0.08]  # 5年

# 2. 损失率
犊牛损失率: float = 0.10          # 出生到断奶的损失率
胚胎损失率: float = 0.18          # 怀孕期间的流产率
接产成活率: float = 0.95          # 产犊成活率

# 3. 配种管理
首次产犊月龄: int = 24            # 后备牛预计首次产犊月龄
青年牛首次配种月龄: int = 14      # 后备牛开始配种月龄
成母牛预计配准天数: int = 120     # 成母牛平均配准时的泌乳天数(DIM)
禁配配次: int = 4                 # 超过此配次后禁止继续配种

# 4. 母犊率
母犊率_常规: float = 0.47
母犊率_性控: float = 0.88
母犊率_肉牛: float = 0.47
```

### 2.2 选配策略（分组配种方案）

```python
成母牛选配策略:
  A组: {占比: 0.20, 冻精类型: '性控', 配次: [1,2,3,4]}
  B组: {占比: 0.50, 冻精类型: '常规', 配次: [1,2,3]}
  C组: {占比: 0.30, 冻精类型: '肉牛', 配次: [1,2]}

后备牛选配策略:
  D组: {占比: 0.60, 冻精类型: '性控', 配次: [1,2,3]}
  E组: {占比: 0.30, 冻精类型: '常规', 配次: [1,2]}
  F组: {占比: 0.10, 冻精类型: '肉牛', 配次: [1]}
```

### 2.3 受胎率矩阵（关键参数）

```python
受胎率配置 = {
    "成母牛": {
        "常规冻精": [0.58, 0.48, 0.38, 0.28],  # 1配、2配、3配、4配
        "性控冻精": [0.50, 0.40, 0.30, 0.25],
        "肉牛冻精": [0.60, 0.50, 0.40, 0.30]
    },
    "后备牛": {
        "常规冻精": [0.65, 0.55, 0.45, 0.35],
        "性控冻精": [0.58, 0.48, 0.38, 0.28],
        "肉牛冻精": [0.68, 0.58, 0.48, 0.38]
    }
}
```

### 2.4 成本参数

```python
冻精价格 = {
    "151HO04869": 80.0,      # 性控冻精，元/支
    "029HO21363": 30.0,      # 常规冻精，元/支
    "41118912": 15.0,        # 肉牛冻精，元/支
    # ... 更多公牛冻精
}

后备牛价值_按月龄 = {
    6: 3000,    # 6月龄后备牛价值 元/头
    12: 5000,
    18: 8000,
    24: 12000   # 临产青年牛价值
}
```

---

## 3. 预测算法核心逻辑（按月推进）

### 3.1 整体流程

```python
def simulate_60_months(current_herd: list[Cow], params: PredictionParams):
    """
    模拟未来5年（60个月）

    输入:
        current_herd: 当前牧场所有在场母牛的个体数据
        params: 用户配置的预测参数

    输出:
        每个月的牛群结构、事件统计、财务数据
    """
    results = []
    herd = current_herd.copy()

    for month in range(1, 61):  # 月份: 1-60
        print(f"正在模拟第{month}月...")

        # 步骤1: 更新所有牛的时间相关字段
        update_time_fields(herd, days=30)

        # 步骤2: 处理产犊事件（在胎天数>=280天）
        newborn_calves = handle_calving_events(herd, month, params)

        # 步骤3: 处理淘汰事件
        culled_cows = handle_culling_events(herd, month, params)

        # 步骤4: 处理配种事件（符合条件的牛）
        breeding_records = handle_breeding_events(herd, month, params)

        # 步骤5: 处理妊检事件（配后30天）
        pregnancy_check_results = handle_pregnancy_check(herd, month, params)

        # 步骤6: 统计本月牛群结构
        monthly_stats = calculate_monthly_stats(herd)

        # 步骤7: 计算本月成本和收益
        monthly_finance = calculate_monthly_finance(
            herd, breeding_records, newborn_calves, params
        )

        # 保存本月结果
        results.append({
            "month": month,
            "stats": monthly_stats,
            "events": {
                "calving": newborn_calves,
                "culling": culled_cows,
                "breeding": breeding_records,
                "pregnancy_check": pregnancy_check_results
            },
            "finance": monthly_finance,
            "herd_snapshot": herd.copy()  # 保存本月末牛群快照
        })

    # 按年汇总
    yearly_summary = aggregate_by_year(results)

    return {
        "monthly": results,
        "yearly": yearly_summary
    }
```

---

## 4. 具体案例演示

### 案例A：产后未配的成母牛

**初始状态（2025年10月）**:
```
耳号: 1160
胎次: 5
泌乳天数(DIM): 2天
产后天数: 2天
繁育状态: 产后未配
本胎次配次: 0
牛只类别: 泌乳牛
```

**预测推进过程**:

#### 第1个月（2025年11月）
```python
# 1. 更新时间字段
泌乳天数 = 2 + 30 = 32天
产后天数 = 2 + 30 = 32天

# 2. 判断是否产犊？ 否（未怀孕）

# 3. 判断是否淘汰？
淘汰概率 = 淘汰率_成母牛[0] / 12 = 0.30 / 12 = 2.5%/月
随机判定 → 假设未淘汰

# 4. 判断是否可以配种？
条件检查:
  - 产后天数(32) < 成母牛预计配准天数(120天) → 还在自愿等待期，不配种
  - 配次(0) < 禁配配次(4) → OK

结果: 本月不配种

# 5. 月末状态
繁育状态: 产后未配
泌乳天数: 32天
```

#### 第5个月（2026年2月）
```python
# 1. 更新时间字段
泌乳天数 = 2 + 30*5 = 152天
产后天数 = 2 + 30*5 = 152天

# 2. 判断是否可以配种？
条件检查:
  - 产后天数(152) >= 配准天数(120天) → 可以配种！
  - 未怀孕 → OK

# 3. 执行配种
根据选配策略，1160号牛被分配到哪个组？
假设: 根据TPI指数分配到B组(常规冻精，50%的牛)

配种记录:
  - 配种日期: 2026年2月15日
  - 冻精编号: 029HO21363 (常规冻精)
  - 本胎次配次: 0 + 1 = 1
  - 配后天数: 0
  - 繁育状态: 已配未检

冻精使用: +1支常规冻精
冻精成本: +30元
```

#### 第6个月（2026年3月）
```python
# 1. 更新时间字段
泌乳天数 = 182天
配后天数 = 0 + 30 = 30天

# 2. 判断妊检（配后30天）
配后天数(30) >= 30天 → 进行妊检

受胎判定:
  - 查询受胎率: 成母牛 + 常规冻精 + 1配 = 0.58 (58%)
  - 随机判定: random() = 0.42 < 0.58 → 受胎成功！

妊检结果:
  - 繁育状态: 已配未检 → 初检孕
  - 在胎天数: 30天
  - 预计产犊日期: 2026年2月15日 + 280天 = 2026年11月22日
```

#### 第14个月（2026年11月，预计产犊）
```python
# 1. 更新时间字段
在胎天数 = 30 + 30*8 = 270天
泌乳天数 = 182 + 30*8 = 422天

# 注意: 怀孕后期已干奶
牛只类别: 泌乳牛 → 干奶牛 (泌乳天数>305天且怀孕)
泌乳天数: 重置为 NaN
```

#### 第15个月（2026年12月，产犊）
```python
# 1. 更新时间字段
在胎天数 = 270 + 30 = 300天

# 2. 判断产犊
在胎天数(300) >= 280天 → 产犊！

产犊事件:
  - 应用接产成活率(95%): 随机判定 → 成功产犊
  - 应用胚胎损失率(18%): 前期已考虑，此处不重复

  犊牛性别判定:
    - 冻精类型: 常规
    - 母犊率: 0.47
    - 随机判定: random() = 0.38 < 0.47 → 母犊！

  新生犊牛:
    - 耳号: 系统自动分配 (如251160)
    - 性别: 母
    - 胎次: 0
    - 日龄: 0
    - 月龄: 0
    - 繁育状态: 出生
    - 牛只类别: 哺乳犊牛

  母牛状态更新:
    - 胎次: 5 + 1 = 6
    - 产后天数: 0
    - 泌乳天数: 0
    - 繁育状态: 产后未配
    - 在胎天数: 0
    - 本胎次配次: 0 (重置)
    - 牛只类别: 泌乳牛

产犊统计: +1头母犊
```

**小结**: 一头产后未配的牛，经过5个月的自愿等待期，配种、受胎、怀孕、产犊的完整周期，最终在第15个月产下一头母犊，自己进入第6胎。

---

### 案例B：已配未检的成母牛

**初始状态（2025年10月）**:
```
耳号: 1389
胎次: 4
泌乳天数: 329天
配后天数: 32天
本胎次配次: 4
与配冻精编号: 41118912 (肉牛冻精)
繁育状态: 已配未检
```

**预测推进过程**:

#### 第1个月（2025年11月）
```python
# 1. 更新时间字段
泌乳天数 = 329 + 30 = 359天
配后天数 = 32 + 30 = 62天

# 2. 判断妊检（配后30天已过）
配后天数(62) >= 30天，但上月已检查过
本月不重复检查

# 3. 但是！我们发现配后天数已经超过30天，说明上月应该检查了
回溯逻辑：
  - 如果初始状态是"已配未检"且配后天数>30天
  - 说明这头牛还未进行首次妊检
  - 需要在第1个月进行妊检

妊检判定:
  - 受胎率: 成母牛 + 肉牛冻精 + 4配 = 0.30 (30%)
  - 随机判定: random() = 0.75 > 0.30 → 空怀！

妊检结果:
  - 繁育状态: 已配未检 → 初检空怀
  - 配后天数: 0 (重置)
  - 本胎次配次: 4 (保持)
```

#### 第2个月（2025年12月）
```python
# 1. 更新时间字段
泌乳天数 = 389天
配后天数 = 0 + 30 = 30天

# 2. 判断是否可以配种？
条件检查:
  - 本胎次配次(4) >= 禁配配次(4) → 已达上限，禁止配种！
  - 繁育状态: 初检空怀 → 标记为"待淘汰"

淘汰判定:
  - 原因: 配种4次失败
  - 淘汰事件: 立即淘汰

淘汰统计: +1头成母牛淘汰
牛群: 移除1389号牛
```

**小结**: 这头牛已经配种4次且第4次配种失败，超过禁配配次限制，在第2个月被淘汰。

---

### 案例C：已怀孕的成母牛

**初始状态（2025年10月）**:
```
耳号: 1557
胎次: 4
泌乳天数: 332天
在胎天数: 161天
预计产犊日期: 2026年2月4日
本胎次配次: 3
与配冻精编号: 029HO21363 (常规冻精)
繁育状态: 复检孕
牛只类别: 泌乳牛
```

**预测推进过程**:

#### 第1-3个月（2025年11月-2026年1月）
```python
# 每月更新时间字段
在胎天数逐月增加: 161 → 191 → 221 → 251天

# 第3个月（2026年1月）
在胎天数 = 251天
泌乳天数 = 332 + 90 = 422天

# 判断干奶（通常在产前60天干奶）
距产犊天数 = 280 - 251 = 29天
29天 < 60天 → 应该干奶

牛只类别: 泌乳牛 → 干奶牛
泌乳天数: 重置为 NaN
```

#### 第4个月（2026年2月，产犊月）
```python
# 1. 更新时间字段
在胎天数 = 251 + 30 = 281天

# 2. 判断产犊
在胎天数(281) >= 280天 → 产犊！

产犊事件:
  - 冻精类型: 常规
  - 母犊率: 0.47
  - 随机判定: random() = 0.28 < 0.47 → 母犊

  新生犊牛:
    - 耳号: 261557
    - 性别: 母
    - 胎次: 0
    - 繁育状态: 出生
    - 牛只类别: 哺乳犊牛

  母牛状态更新:
    - 胎次: 4 + 1 = 5
    - 产后天数: 0
    - 泌乳天数: 0
    - 繁育状态: 产后未配
    - 在胎天数: 0
    - 本胎次配次: 0
    - 牛只类别: 泌乳牛
```

#### 第8个月（2026年6月，再次配种）
```python
# 1. 更新时间字段
产后天数 = 0 + 30*4 = 120天
泌乳天数 = 0 + 30*4 = 120天

# 2. 判断配种
产后天数(120) >= 配准天数(120) → 可以配种

# 3. 执行配种（假设分配到B组-常规冻精）
配种记录:
  - 冻精: 029HO21363
  - 本胎次配次: 1
  - 繁育状态: 已配未检

冻精使用: +1支
```

**小结**: 这头怀孕牛正常产犊，产下母犊，经过4个月的自愿等待期后再次配种，进入新一轮繁殖周期。

---

### 案例D：后备牛（青年牛）

**初始状态（2025年10月）**:
```
耳号: 245098
胎次: 0
月龄: 20.33月
在胎天数: 201天
本胎次配次: 2
与配冻精编号: 151HO03970 (性控冻精)
繁育状态: 复检孕
牛只类别: 青年牛
```

**预测推进过程**:

#### 第1-2个月（2025年11月-12月）
```python
# 每月更新
月龄: 20.33 → 21.33 → 22.33月
在胎天数: 201 → 231 → 261天

# 第2个月末
距产犊天数 = 280 - 261 = 19天
牛只类别: 青年牛 → 青年围产牛
```

#### 第3个月（2026年1月，首次产犊！）
```python
# 1. 更新时间字段
月龄 = 23.33月
在胎天数 = 291天

# 2. 判断产犊
在胎天数(291) >= 280天 → 首次产犊！

产犊事件:
  - 冻精类型: 性控
  - 母犊率: 0.88
  - 随机判定: random() = 0.65 < 0.88 → 母犊！

  新生犊牛:
    - 耳号: 265098
    - 性别: 母
    - 胎次: 0
    - 繁育状态: 出生
    - 牛只类别: 哺乳犊牛

  245098号牛状态更新:
    - 胎次: 0 + 1 = 1 (从后备牛变成成母牛！)
    - 月龄: 23.33月 (实际首次产犊月龄)
    - 产后天数: 0
    - 泌乳天数: 0
    - 繁育状态: 产后未配
    - 在胎天数: 0
    - 本胎次配次: 0
    - 牛只类别: 泌乳牛

统计:
  - 后备牛头数: -1
  - 成母牛头数: +1
  - 新生母犊: +1
  - 首次产犊月龄记录: 23.33月
```

**小结**: 后备牛首次产犊后，胎次从0变为1，身份转变为成母牛，开始泌乳。

---

### 案例E：新生犊牛的成长

**初始状态（2025年10月）**:
```
耳号: 245222
胎次: 0
月龄: 16.71月
日龄: 508天
繁育状态: 出生
性别: 母
牛只类别: 青年牛
```

**预测推进过程**:

#### 第1-24个月的成长轨迹

```python
月龄      牛只类别        繁育状态         事件
───────────────────────────────────────────
16.71月   青年牛          出生
17.71月   青年牛          出生             月龄增加
18.71月   青年牛          出生             → 达到配种月龄(14月)！

# 第3个月（月龄18.71月，开始配种）
条件检查:
  - 月龄(18.71) >= 青年牛首次配种月龄(14) → 可配种
  - 胎次(0) → 后备牛
  - 未怀孕 → OK

执行配种:
  - 根据后备牛选配策略，假设分配到D组(性控冻精)
  - 冻精: 151HO04869
  - 本胎次配次: 1
  - 繁育状态: 已配未检

冻精使用: +1支性控冻精

# 第4个月（月龄19.71月，妊检）
配后天数 = 30天 → 妊检

受胎判定:
  - 受胎率: 后备牛 + 性控冻精 + 1配 = 0.58
  - 随机判定: random() = 0.45 < 0.58 → 受胎！

状态更新:
  - 繁育状态: 初检孕
  - 在胎天数: 30天
  - 预计产犊日期: 当前日期 + 250天

# 第12个月（月龄27.71月，约28月龄产犊）
在胎天数 = 280天 → 产犊

产犊事件:
  - 性控冻精 → 母犊率0.88
  - 产下母犊: 耳号275222

245222号牛更新:
  - 胎次: 0 → 1 (成为成母牛)
  - 牛只类别: 青年牛 → 泌乳牛
  - 首次产犊月龄: 27.71月

统计:
  - 后备牛: -1
  - 成母牛: +1
  - 新生母犊: +1
```

**小结**: 犊牛从出生到首次配种（14月龄）、怀孕、首次产犊（约24-28月龄），完成从后备牛到成母牛的转变。

---

## 5. 每月统计输出

### 5.1 牛群结构统计

```python
每月输出:
{
    "month": 1,  # 2025年11月
    "total": 4210,

    "by_parity": {
        0: 1755,  # 后备牛
        1: 815,
        2: 685,
        3: 875,
        4: 65,
        5: 15
    },

    "by_category": {
        "泌乳牛": 1975,
        "干奶牛": 365,
        "围产牛": 120,
        "青年牛": 510,
        "青年围产牛": 85,
        "育成牛": 340,
        "断奶犊牛": 365,
        "哺乳犊牛": 450
    },

    "by_repro_status": {
        "复检孕": 1260,
        "已配未检": 835,
        "产后未配": 645,
        "初检孕": 250,
        "初检空怀": 25,
        "出生": 1195
    },

    "pregnant_cows": 1510,  # 怀孕牛总数
    "milking_cows": 1975,   # 泌乳牛总数
    "breeding_eligible": 720 # 可配种牛数
}
```

### 5.2 事件统计

```python
每月事件:
{
    "month": 1,

    "calving": {
        "total": 125,          # 总产犊数
        "female": 60,          # 母犊
        "male": 65,            # 公犊
        "from_cows": 85,       # 成母牛产犊
        "from_heifers": 40,    # 后备牛首次产犊
        "survival_rate": 0.95  # 成活率
    },

    "breeding": {
        "total": 210,          # 总配种头次
        "cows": 150,           # 成母牛配种
        "heifers": 60,         # 后备牛配种
        "by_semen_type": {
            "性控": 85,
            "常规": 95,
            "肉牛": 30
        },
        "by_attempt": {
            1: 120,  # 1配
            2: 55,   # 2配
            3: 25,   # 3配
            4: 10    # 4配
        }
    },

    "pregnancy_check": {
        "total": 198,          # 妊检头数
        "conceived": 115,      # 受胎
        "open": 83,            # 空怀
        "conception_rate": 0.58 # 本月受胎率
    },

    "culling": {
        "total": 32,           # 淘汰头数
        "cows": 28,            # 成母牛淘汰
        "heifers": 4,          # 后备牛淘汰
        "reasons": {
            "常规淘汰": 20,
            "配种失败": 8,
            "超龄": 4
        }
    }
}
```

### 5.3 成本统计

```python
每月成本:
{
    "month": 1,

    "semen_cost": {
        "性控冻精": 85 * 80 = 6800,   # 元
        "常规冻精": 95 * 30 = 2850,
        "肉牛冻精": 30 * 15 = 450,
        "total": 10100
    },

    "heifer_value_change": {
        "new_born": 60 * 500 = 30000,        # 新生母犊价值（初始估值）
        "growth_value_add": 1755 * 200 = 351000,  # 后备牛月度增值
        "first_calving": -40 * 12000 = -480000,   # 后备牛转成母牛（转出后备牛价值）
        "first_calving_gain": 40 * 15000 = 600000, # 新增成母牛价值
        "net": 501000
    },

    "total_cost": 10100,
    "total_value_change": 501000
}
```

---

## 6. 年度汇总输出

```python
年度汇总 (第1年 = 12个月累计):
{
    "year": 1,

    "herd_end": {
        "total": 4380,
        "cows": 2510,
        "heifers": 1870,
        "by_category": {...}
    },

    "annual_events": {
        "total_calving": 1450,       # 全年产犊
        "female_calves": 695,        # 母犊
        "male_calves": 755,          # 公犊
        "total_breeding": 2420,      # 全年配种头次
        "total_culling": 385,        # 全年淘汰
        "heifer_to_cow": 480         # 后备牛转成母牛
    },

    "annual_semen_usage": {
        "性控冻精": 1020支,
        "常规冻精": 1140支,
        "肉牛冻精": 260支,
        "total": 2420支
    },

    "annual_cost": {
        "semen_cost": 121200,        # 全年冻精成本
        "heifer_value_net": 6012000  # 后备牛价值净增
    },

    "annual_kpi": {
        "conception_rate": 0.56,     # 年度平均受胎率
        "calving_rate": 0.59,        # 产犊率
        "replacement_rate": 0.16,    # 更新率
        "herd_growth_rate": 0.045    # 牛群增长率
    }
}
```

---

## 7. 关键算法细节

### 7.1 淘汰判定

```python
def should_cull(cow: Cow, month: int, params: Params) -> bool:
    """判断是否淘汰"""

    # 规则1: 配种失败超过禁配配次
    if cow.本胎次配次 >= params.禁配配次:
        return True

    # 规则2: 按淘汰率随机淘汰
    year_index = (month - 1) // 12  # 0-4
    if cow.胎次 == 0:
        monthly_cull_rate = params.淘汰率_后备牛[year_index] / 12
    else:
        monthly_cull_rate = params.淘汰率_成母牛[year_index] / 12

    if random.random() < monthly_cull_rate:
        return True

    # 规则3: 后备牛超龄（>30月龄仍未怀孕）
    if cow.胎次 == 0 and cow.月龄 > 30 and not cow.is_pregnant:
        return True

    # 规则4: 高胎次牛产后长期不孕（泌乳天数>400天且未怀孕）
    if cow.胎次 >= 4 and cow.泌乳天数 > 400 and not cow.is_pregnant:
        return True

    return False
```

### 7.2 配种时机判定

```python
def can_breed(cow: Cow, params: Params) -> bool:
    """判断是否可以配种"""

    # 禁配标记
    if cow.是否禁配:
        return False

    # 已怀孕
    if cow.在胎天数 > 0:
        return False

    # 配次已达上限
    if cow.本胎次配次 >= params.禁配配次:
        return False

    # 后备牛
    if cow.胎次 == 0:
        # 月龄达到配种月龄
        if cow.月龄 >= params.青年牛首次配种月龄:
            # 如果已经配过，需要间隔21天（发情周期）
            if cow.本胎次配次 > 0 and cow.配后天数 < 21:
                return False
            return True
        return False

    # 成母牛
    else:
        # 产后自愿等待期
        if cow.产后天数 < 60:  # 最少60天
            return False

        # 达到预计配准天数
        if cow.泌乳天数 >= params.成母牛预计配准天数:
            # 配种间隔
            if cow.本胎次配次 > 0 and cow.配后天数 < 21:
                return False
            return True

        return False
```

### 7.3 受胎判定

```python
def check_conception(cow: Cow, params: Params) -> bool:
    """判定是否受胎（配种后30天妊检）"""

    # 查询受胎率
    if cow.胎次 == 0:
        cow_type = "后备牛"
    else:
        cow_type = "成母牛"

    semen_type = get_semen_type(cow.与配冻精编号)  # 性控/常规/肉牛
    attempt = cow.本胎次配次  # 1-4

    conception_rate = params.受胎率配置[cow_type][semen_type][attempt - 1]

    # 随机判定
    return random.random() < conception_rate
```

---

## 8. 总结

### 核心特点

1. **个体级模拟**: 每头牛都有完整的状态跟踪
2. **时间精确到月**: 可以预测每个月的牛群结构
3. **事件驱动**: 配种、妊检、产犊、淘汰等事件按时间触发
4. **参数化配置**: 淘汰率、受胎率、选配策略等都可调整
5. **真实业务逻辑**: 基于实际牧场管理规则（VWP、禁配配次、发情周期等）

### 输出价值

- **精确预测**: 知道未来每个月有多少头泌乳牛、后备牛、犊牛
- **资源规划**: 知道未来5年每年需要多少冻精、成本多少
- **策略对比**: 可以对比不同选配策略的5年效果
- **风险预警**: 如果某年牛群增长缓慢，可以提前调整策略

---

**下一步**:

1. 请您确认这个算法逻辑是否符合您的预期？
2. 是否有需要调整的地方（如配种时机、淘汰规则等）？
3. 确认后我们可以开始编写代码实现！
