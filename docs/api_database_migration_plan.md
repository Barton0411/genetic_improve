# API化数据库连接迁移计划

## 📋 项目背景

目前伊利奶牛选配系统直接连接阿里云PolarDB数据库，虽然功能正常，但存在安全性隐患：
- 数据库凭证硬编码在客户端
- 直接暴露数据库连接信息
- 无法进行统一的访问控制和审计
- 难以实现细粒度的权限管理

## 🎯 迁移目标

将直连数据库模式改为API服务模式，提升系统安全性和可维护性。

### 预期收益
- ✅ **安全性提升**: 客户端不再存储数据库凭证
- ✅ **访问控制**: 统一的身份验证和授权机制  
- ✅ **审计追踪**: 完整的API访问日志
- ✅ **性能优化**: 连接池管理和缓存机制
- ✅ **扩展性**: 支持微服务架构扩展

## 🏗️ 技术架构

### 当前架构
```
客户端应用 → 直连PolarDB数据库
```

### 目标架构  
```
客户端应用 → API Gateway → 后端服务 → PolarDB数据库
          ↓
    JWT令牌认证
```

## 🔧 实施计划

### Phase 1: API服务开发 (第1天)
1. **设计RESTful API接口**
   - 用户认证 API: `POST /api/auth/login`
   - 数据查询 API: `GET /api/data/{table}`
   - 数据上传 API: `POST /api/data/{table}`
   - 文件上传 API: `POST /api/files/upload`

2. **实现认证服务**
   - JWT令牌机制
   - 角色权限管理
   - 会话管理
   - 密码加密存储

3. **数据访问层**
   - ORM模型定义
   - 数据库连接池
   - 查询优化
   - 事务管理

### Phase 2: 客户端改造 (第2天)
1. **API客户端模块**
   - HTTP请求封装
   - 令牌管理
   - 错误处理
   - 重试机制

2. **身份验证模块**
   - 登录界面保持不变
   - 后台切换为API认证
   - 令牌自动续期
   - 离线缓存机制

3. **数据访问层重构**
   - 替换直连数据库代码
   - API请求适配器
   - 数据缓存策略
   - 离线模式支持

### Phase 3: 测试和部署 (第3天)
1. **完整性测试**
   - 功能回归测试
   - 性能基准测试
   - 安全性测试
   - 兼容性测试

2. **灰度部署**
   - 部署API服务
   - 客户端版本更新
   - 数据迁移验证
   - 回滚方案准备

## 📚 API接口设计

### 认证接口
```
POST /api/auth/login
Content-Type: application/json

Request:
{
  "username": "user",
  "password": "password"
}

Response:
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": 1,
      "username": "user",
      "role": "admin"
    },
    "expires_in": 3600
  }
}
```

### 数据查询接口
```
GET /api/data/cows?page=1&limit=100
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "items": [...],
    "total": 1500,
    "page": 1,
    "limit": 100
  }
}
```

### 文件上传接口
```
POST /api/files/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data

Response:
{
  "success": true,
  "data": {
    "file_id": "12345",
    "filename": "cows_data.xlsx",
    "size": 1024000,
    "upload_time": "2025-09-17T10:00:00Z"
  }
}
```

## 🔒 安全策略

### JWT令牌管理
- **签名算法**: HMAC SHA-256
- **过期时间**: 1小时  
- **刷新机制**: 自动续期
- **存储方式**: 内存存储，不持久化

### API访问控制
- **请求限流**: 100req/min per user
- **IP白名单**: 可选配置
- **HTTPS强制**: 所有API必须HTTPS
- **CORS配置**: 严格跨域控制

### 数据保护
- **敏感数据加密**: AES-256
- **SQL注入防护**: 参数化查询
- **XSS防护**: 输入验证和输出编码
- **审计日志**: 完整的访问记录

## 📊 性能优化

### 数据库层
- **连接池**: 10-50连接池
- **查询缓存**: Redis缓存热点数据
- **分页查询**: 避免大数据量查询
- **索引优化**: 查询性能提升

### API层
- **响应缓存**: 静态数据缓存
- **数据压缩**: Gzip响应压缩  
- **异步处理**: 长时间任务异步化
- **负载均衡**: 多实例部署

## 🧪 测试策略

### 单元测试
- API接口测试
- 认证逻辑测试
- 数据访问测试
- 工具函数测试

### 集成测试
- 端到端流程测试
- 数据库连接测试
- 文件上传下载测试
- 错误处理测试

### 性能测试
- 并发访问测试
- 大数据量测试
- 响应时间测试
- 内存使用测试

## 📦 实现技术栈

### 后端服务
- **框架**: FastAPI (Python)
- **数据库**: SQLAlchemy ORM + PolarDB
- **认证**: python-jose (JWT)
- **缓存**: Redis
- **部署**: Docker + systemd

### 客户端改造
- **HTTP库**: requests 
- **配置管理**: 环境变量
- **缓存**: 本地文件缓存
- **错误处理**: 自定义异常类

## 🚀 部署方案

### 服务器配置
- **CPU**: 2核心 (当前ECS已满足)
- **内存**: 4GB (当前ECS已满足)
- **存储**: 40GB SSD (当前已满足)
- **网络**: 5Mbps (当前已满足)

### 部署步骤
1. **API服务部署**
   ```bash
   # Docker容器部署
   docker build -t genetic-api:1.0 .
   docker run -d -p 8081:8000 genetic-api:1.0
   
   # systemd服务管理
   sudo systemctl enable genetic-api
   sudo systemctl start genetic-api
   ```

2. **Nginx配置更新**
   ```nginx
   # API服务代理
   location /api/ {
       proxy_pass http://localhost:8081/;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
   }
   ```

3. **SSL证书更新**
   ```bash
   # 更新域名证书
   sudo certbot certonly --nginx -d api.genepop.com
   ```

## 🔄 回滚方案

### 紧急回滚
1. 客户端降级到上一版本
2. 恢复直连数据库配置
3. 停用API服务
4. 数据一致性检查

### 数据恢复
1. 数据库备份恢复
2. 文件存储恢复
3. 配置回滚
4. 服务重启

## 📈 监控和运维

### 系统监控
- **API响应时间**: <200ms
- **数据库连接**: <50个活跃连接
- **内存使用**: <70%
- **CPU使用**: <60%

### 日志管理
- **访问日志**: Nginx + API服务
- **错误日志**: 应用级别错误追踪
- **审计日志**: 用户操作记录
- **性能日志**: 慢查询监控

### 告警配置
- **服务宕机**: 立即通知
- **响应超时**: >5秒告警
- **错误率高**: >5%告警
- **存储满**: >80%告警

## 📋 工作清单

### 明日任务 (2025-09-17)
- [ ] 搭建FastAPI项目框架
- [ ] 实现JWT认证服务
- [ ] 设计数据库API接口
- [ ] 创建用户管理模块
- [ ] 实现基础数据查询API
- [ ] 编写API文档和测试

### 预计时间分配
- **项目搭建**: 2小时
- **认证系统**: 3小时  
- **数据接口**: 4小时
- **测试调试**: 3小时
- **文档编写**: 1小时

**总计**: 13小时工作量 (需要1.5天)

## 💡 风险评估

### 技术风险
- **兼容性**: 新旧API兼容性问题 → 版本控制策略
- **性能**: API延迟影响用户体验 → 缓存优化
- **稳定性**: 新服务可靠性待验证 → 充分测试

### 业务风险  
- **用户影响**: 可能需要用户重新登录 → 平滑迁移
- **数据风险**: 迁移过程数据丢失 → 完整备份策略
- **时间风险**: 开发时间可能超预期 → 分阶段实施

### 缓解措施
1. **分阶段实施**: 渐进式迁移，降低风险
2. **完整测试**: 全面的功能和性能测试
3. **备份策略**: 多层级数据备份保护
4. **快速回滚**: 准备完善的回滚机制

---

**文档版本**: 1.0  
**创建时间**: 2025-09-16  
**负责人**: 开发团队  
**审核状态**: 待审核  

**下一步行动**: 开始Phase 1 API服务开发