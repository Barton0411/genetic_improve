# 近交系数计算方法说明

## 概述

本系统采用Wright通径法（Wright's Path Method）计算动物的近交系数，这是畜牧育种领域最常用和经典的计算方法。

## 基本原理

### Wright公式

近交系数的计算公式为：

```
F = Σ(0.5)^(n+n'+1) × (1+F_A)
```

其中：
- **F**: 被计算个体的近交系数
- **n**: 从父亲到共同祖先的代数
- **n'**: 从母亲到共同祖先的代数
- **F_A**: 共同祖先自身的近交系数
- **Σ**: 对所有共同祖先路径的贡献求和

### 计算步骤

1. **系谱构建**
   - 追溯个体的父系和母系系谱
   - 默认追溯6代，形成完整的系谱树

2. **共同祖先识别**
   - 查找父母双方系谱中的共同祖先
   - 记录每个共同祖先的所有路径

3. **路径计算**
   - 计算从父亲到共同祖先的路径长度（n）
   - 计算从母亲到共同祖先的路径长度（n'）
   - 每条路径的基础贡献为：(0.5)^(n+n'+1)

4. **近交系数调整**
   - 如果共同祖先自身有近交系数F_A
   - 则该路径的贡献要乘以(1+F_A)

5. **累加求和**
   - 将所有路径的贡献值累加
   - 得到最终的近交系数F

## 特殊情况处理

### 1. GIB值优先

当动物有基因组近交系数（GIB）时，直接使用GIB值作为近交系数，不再进行系谱计算。这是因为：
- GIB基于基因组数据，更准确反映实际的基因纯合度
- 避免了系谱记录不完整带来的误差

### 2. 系谱信息不全

- 如果父母信息缺失，该个体的近交系数为0
- 如果祖先信息缺失，该支系不参与计算

### 3. 代数限制

- 默认追溯6代（包括本身）
- 超过6代的祖先不参与计算
- 可根据需要调整最大追溯代数

## 计算示例

假设有一头母牛，其父母有共同祖先A：
- 父系路径：父亲 → 祖父 → A（路径长度=2）
- 母系路径：母亲 → 外祖父 → 外曾祖父 → A（路径长度=3）
- 祖先A的近交系数F_A = 0.05

计算过程：
1. 基础贡献 = (0.5)^(2+3+1) = (0.5)^6 = 0.015625
2. 调整后贡献 = 0.015625 × (1 + 0.05) = 0.0164
3. 如果只有这一个共同祖先，则F = 0.0164 = 1.64%

## 结果解释

- **F < 3.125%**：低度近交，一般认为安全
- **3.125% ≤ F < 6.25%**：中度近交，需要注意
- **F ≥ 6.25%**：高度近交，建议避免

注：3.125%相当于半同胞交配（祖孙配），6.25%相当于全同胞交配（兄妹配）

## 系统实现特点

1. **缓存机制**：已计算的近交系数会被缓存，避免重复计算
2. **批量计算**：支持批量计算多个个体的近交系数
3. **路径追踪**：详细记录每条贡献路径，便于分析
4. **可视化展示**：通过系谱图直观展示血缘关系和共同祖先

## 参考文献

1. Wright, S. (1922). Coefficients of inbreeding and relationship. The American Naturalist, 56(645), 330-338.
2. Falconer, D.S., & Mackay, T.F.C. (1996). Introduction to Quantitative Genetics (4th ed.).
3. Van Vleck, L.D. (1993). Selection Index and Introduction to Mixed Model Methods.