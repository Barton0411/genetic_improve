# 待办事项清单

**更新时间:** 2025-11-02
**项目版本:** v1.2.0.4
**规划版本:** v2.2.0（预计2026年3月）

---

## 📌 重要更新说明

本次更新整合了2025-11-02的新需求分析，重新规划了开发优先级和时间线。

**新增需求:** 8个主要功能需求
**预计总工作量:** 44-63天（约3-4个月）
**详细分析:** 参见 `新需求分析_2025-11-02.md`

---

## 🔴 第一阶段：高优先级（2025年11月-12月上旬）

### 1. 完成Excel报告Sheet 8-11 ⏰ 5-7天
**状态:** 进行中 - 设计阶段
**优先级:** 🔴 最高（现有功能完善）

**任务清单:**
- [ ] Sheet 8: 已用公牛性状汇总分析
  - 统计所有已选配公牛
  - 按性状（产奶、体型、健康、繁育）汇总分析
  - 生成公牛使用频率统计
- [ ] Sheet 9: 已用公牛性状明细
  - 列出每头公牛的详细性状数据
  - 包含TPI、NM$、产奶、体型等全部指标
- [ ] Sheet 10: 备选公牛排名
  - 按不同育种目标排序公牛
  - 提供多维度排名（TPI、产奶、体型等）
- [ ] Sheet 11: 选配推荐结果
  - 最终选配方案汇总
  - 性控/常规精液分配统计
  - 预期遗传进展预测

**完成标准:**
- Excel报告功能完整，Sheet 1-11全部完成
- 用户可生成完整的选配分析报告
- 发布 v1.3.0 版本

---

### 2. 未来五年牛头数预测 ⏰ 7-10天
**状态:** 待开始
**优先级:** 🔴 最高（用户需求优先级1）

**功能描述:**
基于当前牛群结构和选配方案，预测未来5年的牛群变化，包括：
- 总牛头数变化趋势
- 各胎次母牛数量分布
- 繁育率、受胎率、死淘率
- 产奶牛、干奶牛、育成牛、犊牛数量
- 不同分娩月份的产犊数量分布
- 收入预测（产奶收入、牛只销售收入）

**参考资料:**
- `未来3年牛群预测-10.18.py` (已有参考代码)
- `选配策略计算器-v2024.9.5-可储存数据.py` (繁育策略参考)

**任务清单:**
- [ ] 需求细化：确认预测粒度（月度/季度/年度）
- [ ] 数据模型设计
  - 牛群结构模型（各类别牛只）
  - 繁育参数模型（受胎率、死淘率等）
  - 收入成本模型
- [ ] 核心算法开发
  - 牛群动态模拟算法
  - 繁育策略影响计算
  - 遗传进展预测
- [ ] 参数配置界面
  - 允许用户调整关键参数（受胎率、死淘率等）
  - 提供默认参数和历史数据参考
- [ ] 结果可视化
  - 牛头数变化趋势图
  - 各类别牛只占比饼图
  - 收入预测曲线
- [ ] 报告生成
  - 添加新的Excel Sheet："五年规划预测"
  - 包含详细数据和可视化图表
- [ ] 测试验证
  - 使用历史数据验证预测准确性
  - 边界条件测试

**技术难点:**
- 多因素耦合（繁育、死淘、产奶等）
- 参数敏感性分析
- 长期预测的不确定性处理

**完成标准:**
- 用户可基于当前牛群生成5年预测报告
- 预测包含牛头数、收入、各类别分布
- 发布 v1.4.0 版本

**依赖:** 无

---

## 🟡 第二阶段：中高优先级（2025年12月-2026年1月）

### 3. 选配方案对比预测 ⏰ 5-7天
**状态:** 待开始
**优先级:** 🟡 高（用户需求优先级2）

**功能描述:**
对比多种选配方案的长期效果：
- 不同性控精液使用比例的影响
- 不同公牛选择策略的遗传进展
- 方案对牛群平均TPI/NM$的影响
- 方案对未来收入的影响差异

**任务清单:**
- [ ] 方案定义界面
  - 用户可创建多个方案（方案A、B、C）
  - 每个方案设置：性控比例、公牛选择策略
- [ ] 并行预测引擎
  - 调用"未来五年预测"核心算法
  - 对每个方案独立预测
- [ ] 对比分析模块
  - 生成方案对比表格
  - 对比维度：遗传进展、收入、成本
- [ ] 可视化对比
  - 方案对比柱状图
  - 遗传进展趋势对比曲线
  - 收入差异分析
- [ ] 报告生成
  - 新增Excel Sheet："方案对比分析"

**完成标准:**
- 用户可创建并对比3-5个选配方案
- 生成详细的对比分析报告
- 发布 v1.5.0 版本

**依赖:** 需求2（未来五年预测）必须先完成

---

### 4. 执行力验证 ⏰ 4-6天
**状态:** 待开始
**优先级:** 🟡 高（用户需求优先级2）

**功能描述:**
验证牧场对软件推荐方案的执行情况：
- 比对历史选配记录与推荐方案
- 计算执行符合度评分
- 识别实际使用的公牛清单
- 分析偏离推荐的原因

**任务清单:**
- [ ] 数据上传模块
  - 设计历史选配记录上传格式
  - 添加上传界面和数据验证
  - 数据存储到数据库
- [ ] 数据匹配算法
  - 匹配母牛ID
  - 匹配公牛NAAB号
  - 处理数据不一致情况
- [ ] 执行力评分算法
  - 推荐公牛使用率
  - 推荐顺位符合度
  - 综合评分计算
- [ ] 实际公牛使用识别
  - 从生产数据中提取公牛清单
  - 统计使用频率
  - 识别"隐藏"的常用公牛
- [ ] 结果展示
  - 执行力评分报告
  - 符合度分析图表
  - 偏离原因分析
- [ ] 报告生成
  - 新增Excel Sheet："执行力验证分析"

**数据格式:**
```
历史选配记录表字段：
- 母牛ID
- 配种日期
- 使用公牛NAAB号
- 精液类型（性控/常规）
- 配种次数
- 是否受胎
```

**完成标准:**
- 用户可上传历史选配记录
- 生成执行力评分和分析报告
- 发布 v1.5.1 版本

**依赖:** 无（独立功能）

---

### 5. 体型外貌分析 ⏰ 5-7天
**状态:** 待开始
**优先级:** 🟡 中高（用户需求优先级3）

**功能描述:**
结合母牛体型外貌数据和公牛体型育种值，进行体型改良选配：
- 识别母牛体型弱项
- 推荐体型改良公牛
- 预测后代体型改善效果
- 可视化体型分析

**现有基础:**
- ✅ 已有体型外貌数据上传模板
- ✅ 公牛数据包含体型性状育种值
- ⚠️ 需要开发分析和推荐算法

**任务清单:**
- [ ] 需求确认
  - 确认体型外貌数据字段（骨架、乳房、肢蹄等）
  - 确认现有牧场使用情况
- [ ] 体型数据处理模块
  - 读取并验证体型外貌数据
  - 标准化体型评分
  - 识别体型弱项（低于阈值的性状）
- [ ] 体型改良推荐算法
  - 根据母牛弱项匹配公牛强项
  - 计算预期改良效果
  - 综合考虑体型和产奶性状平衡
- [ ] 体型分析可视化
  - 雷达图：展示母牛/公牛体型轮廓
  - 对比图：母牛现状 vs 后代预测
  - 散点图：全群体型弱项分布
- [ ] 选配整合
  - 在选配推荐中增加"体型改良"维度
  - 允许用户设置体型权重
- [ ] 报告生成
  - 新增Excel Sheet："体型外貌分析"
  - 包含个体分析和群体统计

**体型性状参考:**
- 骨架（Stature）
- 体深（Strength）
- 尻角度（Rump Angle）
- 后肢侧视（Rear Legs Side View）
- 乳房深度（Udder Depth）
- 乳房质地（Udder Cleft）
- 前乳房附着（Fore Udder Attachment）
- 后乳房高度（Rear Udder Height）

**完成标准:**
- 用户可上传体型外貌数据
- 生成体型改良推荐方案
- 提供可视化体型分析
- 发布 v1.6.0 版本

**依赖:** 无

---

## 🟢 第三阶段：中优先级（2026年1月-2月）

### 6. 5分法匹配生产数据 ⏰ 3-4天
**状态:** 待开始
**优先级:** 🟢 中（特殊需求）

**功能描述:**
验证遗传育种值与实际生产性能的相关性：
- 读取母牛5分法产奶评分（1-5分）
- 按评分分组分析育种指数
- 计算四分位数统计
- 相关性显著性检验
- 可视化展示

**任务清单:**
- [ ] 数据上传模块
  - 设计5分法数据上传格式
  - 字段：母牛ID、产奶评分（1-5）、评分日期
- [ ] 数据匹配
  - 匹配母牛的育种指数（TPI、NM$等）
  - 处理缺失数据
- [ ] 统计分析
  - 按评分分组（1分组、2分组...5分组）
  - 计算每组的育种指数四分位数
  - 箱线图统计
- [ ] 相关性分析
  - Pearson相关系数
  - Spearman秩相关系数
  - 显著性检验（p-value）
- [ ] 可视化
  - 箱线图：各评分组的育种指数分布
  - 散点图：评分 vs 育种指数
  - 回归拟合线
- [ ] 报告生成
  - 新增Excel Sheet："5分法生产数据分析"
  - 包含统计表和可视化图表

**数据格式:**
```
5分法评分表字段：
- 母牛ID
- 产奶评分（1-5分）
- 评分日期
- （可选）泌乳天数
```

**完成标准:**
- 用户可上传5分法数据
- 生成相关性分析报告
- 验证育种值与生产性能关系
- 发布 v1.6.1 版本

**依赖:** 无

---

### 7. 智能分析（多目标优化选配） ⏰ 8-12天
**状态:** 待开始
**优先级:** 🟢 中（用户需求优先级4）
**技术难度:** 🔴 高

**功能描述:**
综合多维度育种目标，自动生成全群最优选配方案：
- 用户可设置育种目标权重（繁育、产奶、体型）
- 自动计算每头母牛的综合最优公牛
- 支持"一键最优"功能
- 提供方案调整和对比

**育种目标维度:**
1. **繁育性状** (0-100%)
   - 女儿受胎率（DPR）
   - 母牛受胎率（CCR）
   - 产犊难易度（SCE、DCE）

2. **产奶性状** (0-100%)
   - 产奶量（Milk）
   - 乳脂量（Fat）
   - 乳蛋白量（Protein）
   - NM$（净价值指数）

3. **体型性状** (0-100%)
   - 综合体型评分（PTAT）
   - 乳房质量（UDC）
   - 肢蹄质量（FLC）

**任务清单:**
- [ ] 需求细化
  - 确认权重调整方式（滑块/输入框）
  - 确认是否需要保存多个权重方案
- [ ] 多目标优化算法
  - 设计综合评分函数
  - 实现权重可调的评分计算
  - 处理近交系数和隐性基因约束
- [ ] 优化引擎开发
  - 为每头母牛计算所有公牛的综合得分
  - 考虑公牛库存限制（可选）
  - 性控/常规精液分配优化
- [ ] 用户界面
  - 权重设置面板（三个滑块，总和100%）
  - 实时预览权重变化的影响
  - "一键最优"按钮
  - 权重方案保存/加载
- [ ] 结果对比
  - 对比不同权重下的选配结果
  - 展示预期遗传进展差异
- [ ] 报告生成
  - 新增Excel Sheet："智能选配分析"
  - 包含权重设置和优化结果

**技术选型:**
- 优化算法：加权评分法（简单）或TOPSIS法（复杂）
- 可扩展性：预留接口用于未来引入NSGA-II等高级算法

**完成标准:**
- 用户可设置育种目标权重
- 生成综合最优选配方案
- 支持方案保存和对比
- 发布 v2.0.0 版本（重大功能升级）

**依赖:** 体型外貌分析完成后更佳（但非必须）

---

## 🔵 第四阶段：低优先级（2026年2月-3月）

### 8. 数据完整性检测 ⏰ 3-4天
**状态:** 待开始
**优先级:** 🔵 低（用户需求优先级5）

**功能描述:**
在生成报告前检测数据完整性，提供缺失数据影响说明：
- 检测所有必需数据表/字段
- 列出缺失项
- 用流程图展示数据依赖关系
- 说明缺失数据对报告的影响

**任务清单:**
- [ ] 数据依赖关系梳理
  - 梳理所有报告Sheet的数据来源
  - 绘制数据依赖流程图
- [ ] 检测规则定义
  - 必需数据：牛群基础信息、系谱数据等
  - 可选数据：体型外貌、5分法评分等
  - 定义检测规则和阈值
- [ ] 检测引擎开发
  - 实现数据完整性检查
  - 识别缺失字段/记录
  - 评估数据质量分数
- [ ] 用户界面
  - 数据检测报告页面
  - 数据依赖流程图展示
  - 缺失数据影响说明
- [ ] 报告生成
  - 在报告首页添加"数据质量说明"
  - 标注受影响的Sheet

**检测项示例:**
- ✅ 必需：牛群基础信息（ID、品种、胎次等）
- ✅ 必需：系谱数据（父系、母系）
- ⚠️ 推荐：育种指数（TPI、NM$）
- ⚠️ 推荐：生产数据（产奶量、体细胞）
- ❌ 可选：体型外貌数据
- ❌ 可选：5分法评分

**完成标准:**
- 生成报告前自动检测数据完整性
- 提供清晰的数据质量报告
- 发布 v2.1.0 版本

**依赖:** 无

---

### 9. 选配结果推送功能 ⏰ 2-3天
**状态:** 待开始（需求确认中）
**优先级:** 🔵 低

**功能描述:**
将选配推荐结果推送到牧场管理系统：
- 选配完成后推送结果
- 添加`result_farm_code`字段标识牧场
- 记录推送日志

**任务清单:**
- [ ] 需求调研
  - 确认牧场管理系统接口规范
  - 确认数据格式和字段
- [ ] API设计
  - 设计`POST /api/data/mating_result`接口
  - 数据格式定义
- [ ] 数据库设计
  - `mating_results`表结构
  - `push_logs`表结构
- [ ] 客户端实现
  - 推送功能集成到选配流程
  - 错误处理和重试机制
- [ ] 测试
  - 与牧场系统对接测试
  - 边界条件测试

**依赖:** 需要与牧场管理系统协调

---

### 10. 权限管理 ⏰ 2-3天
**状态:** 待开始
**优先级:** 🔵 最低（用户需求优先级6）

**功能描述:**
仅部分员工具有推送功能权限：
- 用户角色管理（管理员、普通用户）
- 推送功能权限控制
- 权限配置界面
- 操作日志记录

**任务清单:**
- [ ] 数据库设计
  - 添加用户角色字段
  - 角色权限配置表
- [ ] 后端API
  - 修改登录接口返回角色信息
  - 添加权限验证中间件
- [ ] 客户端实现
  - 根据用户角色显示/隐藏功能
  - 权限配置界面（管理员可见）
- [ ] 操作日志
  - 记录推送操作日志
  - 日志查询界面

**完成标准:**
- 实现用户角色管理
- 推送功能仅对管理员开放
- 发布 v2.2.0 版本

**依赖:** 需求9（选配结果推送）必须先完成

---

## 🔄 现有待办项（低优先级维护任务）

### 11. 用户账号密码管理功能 ⏰ 1-2天
**状态:** 待开发
**优先级:** 🔵 低

**功能描述:**
- 添加修改密码功能
- 注册功能优化：移除邀请码要求
- 添加用户说明：非伊利系统人员账号将不定期失效

**任务清单:**
- [ ] 后端API：添加修改密码接口
- [ ] 客户端：修改密码界面
- [ ] 注册页面添加用户协议说明

---

### 12. 部署文档整合 ⏰ 2-3小时
**状态:** 待开始

**任务:**
- [ ] 创建统一的部署指南
- [ ] 合并重复文档
- [ ] 添加故障排查章节

---

### 13. 安全加固 ⏰ 2-3天
**状态:** 待评估

**任务:**
- [ ] 移除数据库密码硬编码
- [ ] 更强的JWT密钥
- [ ] API认证加固
- [ ] 定期密钥轮换

---

### 14. 性能优化 ⏰ 3-5天
**状态:** 待评估

**任务:**
- [ ] 数据库索引优化
- [ ] API缓存策略
- [ ] 前端资源优化
- [ ] OSS CDN启用

---

### 15. 代码质量提升 ⏰ 5-7天
**状态:** 待评估

**任务:**
- [ ] 单元测试（pytest）
- [ ] 代码重构
- [ ] 类型注解
- [ ] 代码规范（black、flake8）

---

## 📅 开发时间线总览

```
2025年11月 - 12月上旬：第一阶段
├─ Week 1-1.5: Excel报告Sheet 8-11
└─ Week 2-4: 未来五年牛头数预测 → v1.4.0

2025年12月 - 2026年1月：第二阶段
├─ Week 1-2: 选配方案对比预测 → v1.5.0
├─ Week 2-3: 执行力验证 → v1.5.1
└─ Week 3-5: 体型外貌分析 → v1.6.0

2026年1月 - 2月：第三阶段
├─ Week 1: 5分法匹配生产数据 → v1.6.1
└─ Week 1-4: 智能分析 → v2.0.0

2026年2月 - 3月：第四阶段
├─ Week 1: 数据完整性检测 → v2.1.0
├─ Week 2: 选配结果推送
└─ Week 3: 权限管理 → v2.2.0
```

**总预计时间:** 12-16周（3-4个月）

---

## ✅ 已完成功能（v1.2.0.4）

### 核心功能
- ✅ 牛群数据上传与管理
- ✅ 公牛数据上传与管理
- ✅ 系谱识别与分析
- ✅ 育种性状分析（TPI、NM$、产奶等）
- ✅ 母牛指数分析
- ✅ 近交系数分析
- ✅ 隐性基因检测
- ✅ 选配推荐（性控/常规精液）
- ✅ Excel报告生成（Sheet 1-7）

### 基础设施
- ✅ 用户认证系统
- ✅ 数据库集成（PolarDB）
- ✅ OSS存储集成
- ✅ 自动更新功能
- ✅ GitHub Actions自动发布

### 近期完成
- ✅ 2025-10-28: Sheet 5-7 Excel报告
- ✅ 2025-10-28: GitHub Actions OSS自动上传
- ✅ 2025-11-02: 修复育种指数丢失问题
- ✅ 2025-11-02: 禁用夜间模式跟随
- ✅ 2025-11-02: 导航栏布局优化

---

## 📊 开发工作量统计

### 按阶段统计
- **第一阶段:** 12-17天（Excel完善 + 五年预测）
- **第二阶段:** 14-20天（方案对比 + 执行力 + 体型）
- **第三阶段:** 11-16天（5分法 + 智能分析）
- **第四阶段:** 7-10天（数据检测 + 推送 + 权限）

**总计:** 44-63天（约3-4个月）

### 按功能类型统计
- **新功能开发:** 35-50天
- **现有功能完善:** 5-7天
- **辅助功能:** 4-6天

---

## ⚠️ 风险与注意事项

### 技术风险
1. **未来五年预测算法复杂度** - 需要充分测试
2. **智能分析多目标优化** - 算法性能和准确性
3. **数据依赖性** - 新功能需要新数据源

### 需求风险
1. **需求变更** - 分阶段开发，小步迭代
2. **外部系统对接** - 提前确认接口规范

### 资源风险
1. **开发时间** - 总计3-4个月，需要合理安排
2. **测试验证** - 每个阶段需要充分测试

---

## 📝 待确认事项

### 1. 优先级确认
- [ ] 是否同意第一阶段先完成Excel报告再开发五年预测？
- [ ] 是否可接受总体3-4个月的开发周期？

### 2. 功能细节确认
- [ ] 未来五年预测：需要预测到多细的粒度？月度/季度/年度？
- [ ] 智能分析：是否需要保存多个权重方案供切换？
- [ ] 执行力验证：评分标准如何定义？

### 3. 数据准备
- [ ] 历史选配记录数据：格式和字段确认
- [ ] 5分法产奶数据：是否已有存量数据？
- [ ] 体型外貌数据：当前牧场使用情况？

### 4. 技术选型
- [ ] 五年预测：是否需要考虑Monte Carlo模拟？
- [ ] 可视化：是否需要引入更丰富的图表库（如Plotly）？

---

## 📚 参考文档

- **新需求详细分析:** `新需求分析_2025-11-02.md`
- **系统架构:** `ARCHITECTURE.md`
- **API参考:** `API_REFERENCE.md`
- **已完成任务:** `COMPLETED_TASKS.md`
- **项目路线图:** `ROADMAP.md`

---

## 🎯 下一步行动

1. ✅ 完成新需求分析文档
2. ✅ 更新TODO_LIST.md
3. ⏭️ 与用户确认开发计划和优先级
4. ⏭️ 确认数据准备情况
5. ⏭️ 开始第一阶段开发：Excel报告Sheet 8-11

---

**文档维护:**
- **上次更新:** 2025-11-02
- **更新人:** 开发团队
- **下次更新:** 开发计划确认后

**版本历史:**
- v3.0 (2025-11-02): 整合新需求，重新规划优先级
- v2.0 (2025-10-07): 添加文档整理和OSS自动上传
- v1.0 (2025-09-30): 初始版本
