# 缺失公牛上传功能测试指南

## 📋 问题总结

**原始问题**: 缺失公牛未成功上传到 PolarDB 的 miss_bull 表中

**根本原因**: `api_client.py` 的 `upload_missing_bulls()` 方法错误地要求JWT token认证，但服务器端API实际上**无需认证**

## ✅ 已完成的修复

### 1. API客户端修复
**文件**: `api/api_client.py:346-373`

**修复前**: 要求JWT token，未登录直接拒绝上传
```python
if not self.token:
    logger.error("未登录或令牌无效，无法上传缺失公牛数据")
    return False

headers = {'Authorization': f'Bearer {self.token}'}
```

**修复后**: 移除token验证，无需认证直接上传
```python
# 此API无需认证，直接请求即可
success, response = self._make_request('POST', '/api/data/missing_bulls', data)
```

### 2. 添加详细检查点

#### 2.1 base_calculation.py (105-167行)
- ✅ 添加完整流程检查点
- ✅ 显示缺失公牛数量和列表
- ✅ 显示API客户端base_url
- ✅ 捕获并显示异常详情

#### 2.2 inbreeding_page.py (2456-2527行)
- ✅ 添加近交系统专属检查点
- ✅ 显示USE_API标志状态
- ✅ 时间格式转换为ISO格式
- ✅ 异常捕获和详情显示

#### 2.3 index_calculation.py (335-340行)
- ✅ 添加指数排序检查点
- ✅ 标识触发来源

#### 2.4 data_client.py (127-163行, 299-326行)
- ✅ 添加DataAPIClient检查点
- ✅ 显示HTTP请求详情
- ✅ 显示响应数据

## 📍 缺失公牛上传触发场景

### 场景1: 指数排序计算
**触发位置**: `core/breeding_calc/index_calculation.py:335-338`

**触发条件**:
- 用户上传备选公牛数据
- 选择性状权重进行指数排序
- 查询公牛性状时，公牛ID在bull_library数据库中不存在

**调用链**:
```
index_calculation.py:338
  → self.process_missing_bulls() (继承自base_calculation.py)
    → api_client.upload_missing_bulls()
      → POST https://api.genepop.com/api/data/missing_bulls
```

**日志标识**: `[检查点-指数]` → `[检查点]`

---

### 场景2: 近交系数分析
**触发位置**: `core/inbreeding/inbreeding_page.py:3166`

**触发条件**:
- 进行隐性基因筛查分析
- 查询公牛基因信息时，公牛ID在云端PolarDB中不存在

**调用链**:
```
inbreeding_page.py:3166
  → self.process_missing_bulls()
    → upload_missing_bulls_to_cloud() (来自data_client.py)
      → DataAPIClient.upload_missing_bulls()
        → POST https://api.genepop.com/api/data/missing_bulls
```

**日志标识**: `[检查点-近交]` → `[检查点-DataClient]`

---

### 场景3: 其他育种计算
**触发位置**: 任何继承自 `BaseCowCalculation` 的计算类

**调用链**:
```
任意计算类
  → self.process_missing_bulls() (继承自base_calculation.py)
    → api_client.upload_missing_bulls()
      → POST https://api.genepop.com/api/data/missing_bulls
```

## 🔍 测试步骤

### 测试1: 指数排序触发上传

**步骤**:
1. 准备一个备选公牛Excel文件，包含本地bull_library数据库中**不存在**的NAAB编号
2. 在软件中上传该备选公牛文件
3. 进入"育种计算" → "指数排序"
4. 选择权重方案，点击"开始计算"

**预期日志输出**:
```
[检查点-指数] 在指数排序中发现 X 个缺失公牛
[检查点-指数] 调用 process_missing_bulls 进行上传...

========== [检查点] 缺失公牛上传流程开始 ==========
[检查点] 检测到 X 个缺失公牛
[检查点] 数据来源: bull_index
[检查点] 用户名: xxx
[检查点] 缺失公牛列表: ['NAAB001', 'NAAB002']
[检查点] 已准备 X 条数据记录
[检查点] 正在导入 api_client...
[检查点] API客户端已初始化，base_url: https://api.genepop.com
[检查点] 正在调用 upload_missing_bulls...
[检查点] ✅ 上传成功！已上传 X 条缺失公牛记录
========== [检查点] 缺失公牛上传流程结束 ==========
```

**数据库验证**:
```sql
-- 连接PolarDB
mysql -h defectgene-new.mysql.polardb.rds.aliyuncs.com -u doadmin -p

USE defaultdb;
SELECT * FROM miss_bull ORDER BY time DESC LIMIT 10;
```

---

### 测试2: 近交分析触发上传

**步骤**:
1. 准备配种记录，包含云端PolarDB基因数据库中**不存在**的公牛NAAB编号
2. 在软件中上传该配种记录
3. 进入"隐性基因筛查" → "分析已配公牛对"
4. 点击"开始分析"

**预期日志输出**:
```
========== [检查点-近交] 缺失公牛上传流程开始 ==========
[检查点-近交] 检测到 X 个缺失公牛
[检查点-近交] 分析类型: mated
[检查点-近交] 缺失的公牛号: ['NAAB003', 'NAAB004']
[检查点-近交] 用户名: xxx
[检查点-近交] USE_API 标志: True
[检查点-近交] 正在通过 data_client 上传...
[检查点-近交] 已准备 X 条数据记录

[检查点-DataClient] upload_missing_bulls_to_cloud 被调用
[检查点-DataClient] 接收到 X 条记录
[检查点-DataClient] DataAPIClient base_url: https://api.genepop.com
[检查点-DataClient.upload] 准备向 https://api.genepop.com/api/data/missing_bulls 发送POST请求
[检查点-DataClient.upload] 请求数据: X 条记录
[检查点-DataClient.upload] HTTP状态码: 200
[检查点-DataClient.upload] 响应数据: {'success': True, ...}
[检查点-DataClient] ✅ 成功上传X条缺失公牛记录

[检查点-近交] ✅ 上传成功！已上传 X 个缺失公牛记录
========== [检查点-近交] 缺失公牛上传流程结束 ==========
```

---

### 测试3: 手动API测试（无需软件）

**直接调用API**:
```bash
curl -X POST 'https://api.genepop.com/api/data/missing_bulls' \
  -H 'Content-Type: application/json' \
  -d '{
    "bulls": [{
      "bull": "TEST_NAAB_999",
      "source": "manual_test",
      "time": "2025-01-07T15:30:00",
      "user": "test_user"
    }]
  }'
```

**预期响应**:
```json
{
  "success": true,
  "message": "成功上传1条缺失公牛记录",
  "data": {
    "uploaded_count": 1
  },
  "timestamp": 1704629400
}
```

## 🐛 故障排查

### 问题1: 仍然显示"未登录"错误

**可能原因**: 使用了旧版本代码

**解决方法**:
1. 确认 `api/api_client.py` 已更新（检查356-373行）
2. 重启应用程序
3. 检查是否使用了缓存的.pyc文件

---

### 问题2: USE_API 为 False

**日志**: `[检查点-近交] USE_API 标志: False`

**原因**: `api/data_client.py` 导入失败

**解决方法**:
1. 检查文件是否存在: `api/data_client.py`
2. 检查Python路径配置
3. 查看应用启动日志中的ImportError

---

### 问题3: 网络连接失败

**日志**: `ConnectionError` 或 `Timeout`

**解决方法**:
1. 测试网络连接: `ping api.genepop.com`
2. 检查防火墙规则
3. 检查SSL证书: `curl -I https://api.genepop.com/api/health`
4. 查看 `verify_ssl` 配置 (当前为False)

---

### 问题4: 数据格式错误

**日志**: `响应数据: {'success': False, 'message': '数据格式错误'}`

**原因**: 时间字段格式不正确

**解决方法**:
- 确保时间字段为ISO格式字符串: `"2025-01-07T15:30:00"`
- 不要使用pandas的Timestamp对象

## 📊 API端点详情

**端点**: `POST /api/data/missing_bulls`

**认证**: 无需认证（公开端点）

**请求格式**:
```json
{
  "bulls": [
    {
      "bull": "NAAB编号",
      "source": "数据来源标识",
      "time": "ISO格式时间",
      "user": "用户名"
    }
  ]
}
```

**响应格式**:
```json
{
  "success": true,
  "message": "成功上传N条缺失公牛记录",
  "data": {
    "uploaded_count": N
  },
  "timestamp": 1704629400
}
```

**服务器配置**:
- 域名: https://api.genepop.com
- 端口: 443 (HTTPS)
- Nginx反向代理到内部端口8082
- 数据库: PolarDB MySQL
- 表名: `miss_bull`

## 📝 数据库表结构

```sql
CREATE TABLE miss_bull (
  id INT AUTO_INCREMENT PRIMARY KEY,
  bull VARCHAR(50) NOT NULL COMMENT '公牛NAAB编号',
  source VARCHAR(100) COMMENT '数据来源',
  time DATETIME COMMENT '上传时间',
  user VARCHAR(50) COMMENT '用户名',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 🎯 测试成功标准

✅ **指数排序测试通过**:
- 日志显示完整检查点流程
- 返回"上传成功"消息
- PolarDB中能查询到新记录

✅ **近交分析测试通过**:
- 日志显示完整检查点流程
- USE_API标志为True
- DataAPIClient成功调用
- PolarDB中能查询到新记录

✅ **无认证错误**:
- 不再显示"未登录"或"令牌无效"
- 日志中无token相关错误

✅ **网络正常**:
- HTTP状态码200
- 响应数据包含success:true

---

## 📞 支持联系

如测试过程中遇到问题，请提供:
1. 完整的日志输出（包含所有检查点信息）
2. 操作步骤描述
3. 输入数据样本（脱敏处理）
4. 数据库查询结果

**文档创建时间**: 2025-01-07
**最后更新**: 2025-01-07
**版本**: v1.2.0.4+
