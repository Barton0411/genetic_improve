# Excel报告生成完整指南

**项目名称:** 伊利奶牛选配系统 - Excel综合报告
**文档版本:** v2.0 (合并版)
**更新时间:** 2025-11-02
**完成状态:** ✅ 100% 完成 (17个Sheet全部实现)

---

## 📋 目录

1. [概述](#概述)
2. [功能特性](#功能特性)
3. [Sheet结构总览](#sheet结构总览)
4. [详细设计文档](#详细设计文档)
   - [Sheet 1-4: 牧场基础分析](#sheet-1-4-牧场基础分析)
   - [Sheet 5-8: 育种性状分析](#sheet-5-8-育种性状分析)
   - [Sheet 9-10: 母牛指数分析](#sheet-9-10-母牛指数分析)
   - [Sheet 11-13: 配种记录分析](#sheet-11-13-配种记录分析)
   - [Sheet 14-15: 已用公牛分析](#sheet-14-15-已用公牛分析)
   - [Sheet 16-17: 选配推荐结果](#sheet-16-17-选配推荐结果)
5. [技术实现](#技术实现)
6. [数据流程](#数据流程)
7. [使用指南](#使用指南)
8. [开发说明](#开发说明)
9. [版本变更历史](#版本变更历史)

---

## 概述

Excel综合报告是系统的核心功能之一，为牧场提供全面的牛群遗传分析和选配推荐结果。报告包含17个Sheet，涵盖牧场基础信息、系谱识别、育种性状、母牛指数、配种记录、已用公牛分析、备选公牛排名和选配推荐结果。

### 核心价值

- **全面性**: 17个Sheet覆盖牛群管理的所有关键维度
- **可视化**: 25+图表直观展示数据趋势和分布
- **决策支持**: 为育种决策提供数据支撑
- **历史追踪**: 按年份展示遗传进展
- **风险管理**: 隐性基因和近交系数风险提示

---

## 功能特性

### 1. 数据分析维度

- ✅ **牧场基础信息**: 母牛数量、胎次分布、产奶状态
- ✅ **系谱识别**: 6代系谱识别率统计
- ✅ **育种性状**: 年份趋势、正态分布、四分位数
- ✅ **母牛指数**: 自定义指数计算和排名
- ✅ **配种记录**: 隐性基因、近交系数、配种明细
- ✅ **已用公牛**: 历史公牛使用情况和性状分析
- ✅ **备选公牛**: 按育种指数排名推荐
- ✅ **选配结果**: 智能选配推荐明细

### 2. 图表类型

- **饼图**: 5个（胎次分布、产奶状态、系谱识别率）
- **柱状图**: 8个（年份汇总、近交系数分布）
- **折线图**: 10个（性状进展趋势、公牛性状年份对比）
- **正态分布图**: 4个（NM$、TPI、母牛指数分布）
- **散点图**: 2个（配种记录时间线）

### 3. 自动化功能

- ✅ 自动识别最新数据文件
- ✅ 自动计算统计指标
- ✅ 自动生成图表
- ✅ 自动格式化（颜色编码、条件格式）
- ✅ 自动冻结窗格
- ✅ 自动调整列宽

---

## Sheet结构总览

| Sheet | 名称 | 状态 | 包含内容 | 实现模块 |
|-------|------|------|---------|---------|
| 1 | 牧场基础信息 | ✅ 已完成 | 汇总表 + 2个饼图 | sheet1_builder.py |
| 2 | 牧场牛群原始数据 | ✅ 已完成 | 原始母牛数据明细 | sheet2_builder.py |
| 3 | 系谱识别分析 | ✅ 已完成 | 汇总表 + 3个饼图 | sheet3_builder.py |
| 4 | 全群母牛系谱识别明细 | ✅ 已完成 | 系谱识别明细表 | sheet4_builder.py |
| 5 | 年份汇总与性状进展 | ✅ 已完成 | 育种性状年份汇总 + 折线图 | sheet5_traits_summary_builder.py |
| 6 | NM$分布分析 | ✅ 已完成 | NM$正态分布图 + 统计 | sheet6_nm_distribution_builder.py |
| 7 | TPI分布分析 | ✅ 已完成 | TPI正态分布图 + 统计 | sheet7_tpi_distribution_builder.py |
| 8 | 育种性状明细 | ✅ 已完成 | 全群母牛育种性状明细表 | sheet8_traits_detail_builder.py |
| 9 | 母牛指数分布分析 | ✅ 已完成 | 母牛指数正态分布图 + 统计 | sheet9_cow_index_distribution_builder.py |
| 10 | 母牛指数排名明细 | ✅ 已完成 | 母牛指数排名明细表 | sheet10_cow_index_ranking_builder.py |
| 11 | 配种记录-隐性基因分析 | ✅ 已完成 | 2个汇总表（全部年份+近12个月） | sheet11_genes_builder.py |
| 12 | 配种记录-近交系数分析 | ✅ 已完成 | 2个分布表+4个图表+年份趋势表 | sheet12_inbreeding_builder.py |
| 13 | 配种记录明细 | ✅ 已完成 | 配种记录明细表（原始数据） | sheet13_breeding_detail_builder.py |
| 14 | 已用公牛性状汇总分析 | ✅ 已完成 | 按年份汇总表 + 多组折线图 | sheet14_used_bulls_summary_builder.py |
| 15 | 已用公牛性状明细 | ✅ 已完成 | 按年份/类型分多个明细表 | sheet15_used_bulls_detail_builder.py |
| 16 | 备选公牛排名 | ✅ 已完成 | 按育种指数排名 + 主要性状值 | sheet16_candidate_bulls_builder.py |
| 17 | 选配推荐结果 | ✅ 已完成 | 选配推荐明细表 | sheet17_mating_results_builder.py |

---

## 详细设计文档

### Sheet 1-4: 牧场基础分析

#### Sheet 1: 牧场基础信息 ✅

**功能描述:**
提供牧场的基本信息概览，包括母牛总数、胎次分布、产奶状态等。

**内容组成:**

**1.1 牧场基础信息汇总表**

| 统计项 | 数值 |
|-------|-----|
| 牧场总母牛数 | 1,250 |
| 参与配种母牛数 | 1,180 |
| 1胎母牛数 | 350 |
| 2胎母牛数 | 280 |
| 3胎母牛数 | 220 |
| 4胎及以上母牛数 | 330 |
| 泌乳牛数量 | 950 |
| 干奶牛数量 | 230 |
| 青年牛数量 | 70 |

**1.2 胎次分布饼图**
- 4个扇形：1胎、2胎、3胎、4胎及以上
- 显示数量和百分比
- 颜色：淡蓝、淡绿、淡黄、淡橙

**1.3 产奶状态分布饼图**
- 3个扇形：泌乳牛、干奶牛、青年牛
- 显示数量和百分比
- 颜色：蓝色、绿色、橙色

**数据来源:**
- `牧场母牛信息_processed.xlsx` - 母牛基础信息

**实现状态:**
- ✅ 数据收集器: `farm_info_collector.py`
- ✅ Sheet构建器: `sheet1_builder.py`

---

#### Sheet 2: 牧场牛群原始数据 ✅

**功能描述:**
展示牧场所有母牛的原始数据明细，包括母牛号、胎次、产奶状态等基础信息。

**表格格式:**

| 母牛号 | 胎次 | 产奶状态 | 父号 | 祖父号 | 曾祖父号 | 配种日期 | 配种公牛 |
|-------|-----|---------|-----|--------|---------|---------|---------|
| C0012345 | 2 | 泌乳 | 001HO12345 | 001HO23456 | 001HO34567 | 2024-08-15 | 001HO45678 |
| C0012346 | 1 | 泌乳 | 001HO12346 | 001HO23457 | - | - | - |
| ... | ... | ... | ... | ... | ... | ... | ... |

**数据来源:**
- `牧场母牛信息_processed.xlsx`

**格式化规则:**
- 表头冻结
- 列宽自动调整
- 单元格居中对齐

**实现状态:**
- ✅ 数据收集器: `raw_data_collector.py`
- ✅ Sheet构建器: `sheet2_builder.py`

---

#### Sheet 3: 系谱识别分析 ✅

**功能描述:**
统计和分析母牛6代系谱的识别情况，包括母方3代和父方3代的识别率。

**内容组成:**

**3.1 系谱识别汇总表**

| 系谱代数 | 已识别数量 | 未识别数量 | 识别率 |
|---------|----------|----------|--------|
| 母牛父亲 | 1180 | 70 | 94.4% |
| 母牛祖父 | 1050 | 200 | 84.0% |
| 母牛曾祖父 | 850 | 400 | 68.0% |
| 外祖父 | 980 | 270 | 78.4% |
| 外曾祖父 | 720 | 530 | 57.6% |
| 外高祖父 | 520 | 730 | 41.6% |

**3.2 父方系谱识别率饼图**
- 3个扇形：父亲、祖父、曾祖父的识别率
- 颜色：绿色系渐变

**3.3 母方系谱识别率饼图**
- 3个扇形：外祖父、外曾祖父、外高祖父的识别率
- 颜色：蓝色系渐变

**3.4 整体系谱识别率饼图**
- 2个扇形：已识别、未识别
- 显示总体识别率

**数据来源:**
- `牧场母牛信息_processed.xlsx` - 系谱信息字段

**实现状态:**
- ✅ 数据收集器: `pedigree_collector.py`
- ✅ Sheet构建器: `sheet3_builder.py`

---

#### Sheet 4: 全群母牛系谱识别明细 ✅

**功能描述:**
展示每头母牛的6代系谱识别详情，便于追溯和核查。

**表格格式:**

| 母牛号 | 父号 | 识别 | 祖父号 | 识别 | 曾祖父号 | 识别 | 外祖父号 | 识别 | 外曾祖父号 | 识别 | 外高祖父号 | 识别 | 识别代数 |
|-------|-----|-----|--------|-----|---------|-----|---------|-----|----------|-----|-----------|-----|---------|
| C0012345 | 001HO12345 | ✓ | 001HO23456 | ✓ | 001HO34567 | ✓ | 001HO45678 | ✓ | - | ✗ | - | ✗ | 4代 |
| C0012346 | 001HO12346 | ✓ | 001HO23457 | ✓ | - | ✗ | 001HO45679 | ✓ | - | ✗ | - | ✗ | 3代 |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

**格式化规则:**
- 已识别: 绿色背景 + ✓
- 未识别: 红色背景 + ✗
- 识别代数 ≥ 4: 绿色字体（良好）
- 识别代数 < 3: 红色字体（较差）

**数据来源:**
- `牧场母牛信息_processed.xlsx`

**实现状态:**
- ✅ 数据收集器: `pedigree_detail_collector.py`
- ✅ Sheet构建器: `sheet4_builder.py`

---

### Sheet 5-8: 育种性状分析

#### Sheet 5: 年份汇总与性状进展 ✅

**功能描述:**
按年份汇总全群母牛的平均育种性状值，并用折线图展示遗传进展趋势。

**内容组成:**

**5.1 育种性状年份汇总表**

| 年份 | 母牛数 | 平均NM$ | 平均TPI | 平均产奶PTA | 平均乳脂PTA | 平均乳蛋白PTA | 平均体细胞 | 平均DPR | 平均CCR | 平均HCR |
|-----|--------|---------|---------|------------|------------|-------------|----------|---------|---------|---------|
| 2018 | 1050 | 235 | 1850 | 950 | 38 | 32 | 2.92 | -0.5 | -1.2 | -0.8 |
| 2019 | 1120 | 258 | 1920 | 1020 | 42 | 35 | 2.88 | 0.2 | -0.5 | 0.1 |
| 2020 | 1180 | 285 | 2015 | 1080 | 45 | 38 | 2.85 | 0.8 | 0.3 | 0.6 |
| 2021 | 1220 | 312 | 2095 | 1150 | 48 | 41 | 2.82 | 1.2 | 0.9 | 1.1 |
| 2022 | 1250 | 342 | 2180 | 1210 | 52 | 44 | 2.78 | 1.6 | 1.5 | 1.6 |

**5.2 性状进展折线图（4个图表）**

**图表1: 综合指数进展（NM$、TPI）**
- X轴: 年份
- Y轴: 指数值
- 2条折线: NM$（蓝色）、TPI（绿色）

**图表2: 产奶性状进展（产奶、乳脂、乳蛋白PTA）**
- X轴: 年份
- Y轴: PTA值
- 3条折线: 产奶（蓝色）、乳脂（橙色）、乳蛋白（绿色）

**图表3: 体细胞进展**
- X轴: 年份
- Y轴: 体细胞评分
- 1条折线: SCS（红色，数值越低越好）

**图表4: 繁殖性状进展（DPR、CCR、HCR）**
- X轴: 年份
- Y轴: 繁殖性状值
- 3条折线: DPR（蓝色）、CCR（绿色）、HCR（橙色）

**数据来源:**
- `母牛性状数据.xlsx` - 母牛出生年份、育种值

**实现状态:**
- ✅ 数据收集器: `traits_summary_collector.py`
- ✅ Sheet构建器: `sheet5_traits_summary_builder.py`

---

#### Sheet 6: NM$分布分析 ✅

**功能描述:**
展示全群母牛NM$的正态分布情况和统计指标。

**内容组成:**

**6.1 NM$正态分布直方图**
- X轴: NM$值区间（如 -100~0, 0~100, 100~200...）
- Y轴: 母牛数量
- 柱状图 + 拟合正态分布曲线
- 显示均值线（红色虚线）

**6.2 NM$统计指标表**

| 统计指标 | 数值 |
|---------|-----|
| 平均值 | 342 |
| 中位数 | 335 |
| 标准差 | 125 |
| 最小值 | -85 |
| 25分位数 | 245 |
| 50分位数 | 335 |
| 75分位数 | 445 |
| 最大值 | 685 |

**6.3 分位数分布表**

| 分位数区间 | 母牛数 | 占比 |
|-----------|--------|-----|
| < 25分位数 | 312 | 25.0% |
| 25-50分位数 | 313 | 25.0% |
| 50-75分位数 | 312 | 25.0% |
| > 75分位数 | 313 | 25.0% |

**数据来源:**
- `母牛性状数据.xlsx` - NM$列

**实现状态:**
- ✅ 数据收集器: `nm_distribution_collector.py`
- ✅ Sheet构建器: `sheet6_nm_distribution_builder.py`

---

#### Sheet 7: TPI分布分析 ✅

**功能描述:**
展示全群母牛TPI的正态分布情况和统计指标。

**内容组成:**

**7.1 TPI正态分布直方图**
- X轴: TPI值区间（如 1200~1400, 1400~1600...）
- Y轴: 母牛数量
- 柱状图 + 拟合正态分布曲线
- 显示均值线（红色虚线）

**7.2 TPI统计指标表**

| 统计指标 | 数值 |
|---------|-----|
| 平均值 | 2180 |
| 中位数 | 2165 |
| 标准差 | 385 |
| 最小值 | 1050 |
| 25分位数 | 1920 |
| 50分位数 | 2165 |
| 75分位数 | 2450 |
| 最大值 | 3150 |

**7.3 分位数分布表**

| 分位数区间 | 母牛数 | 占比 |
|-----------|--------|-----|
| < 25分位数 | 312 | 25.0% |
| 25-50分位数 | 313 | 25.0% |
| 50-75分位数 | 312 | 25.0% |
| > 75分位数 | 313 | 25.0% |

**数据来源:**
- `母牛性状数据.xlsx` - TPI列

**实现状态:**
- ✅ 数据收集器: `tpi_distribution_collector.py`
- ✅ Sheet构建器: `sheet7_tpi_distribution_builder.py`

---

#### Sheet 8: 育种性状明细 ✅

**功能描述:**
展示全群母牛的完整育种性状明细数据。

**表格格式:**

| 母牛号 | NM$ | TPI | 产奶PTA | 乳脂PTA | 乳蛋白PTA | 乳脂% | 乳蛋白% | 体细胞 | DPR | CCR | HCR | SCE | DCE | ... |
|-------|-----|-----|---------|---------|----------|-------|--------|--------|-----|-----|-----|-----|-----|-----|
| C0012345 | 445 | 2380 | 1280 | 52 | 45 | 0.08 | 0.05 | 2.72 | 1.8 | 1.2 | 1.5 | 4.5 | 2.8 | ... |
| C0012346 | 412 | 2285 | 1180 | 48 | 42 | 0.06 | 0.04 | 2.78 | 1.5 | 0.9 | 1.2 | 4.2 | 2.5 | ... |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

**数据来源:**
- `母牛性状数据.xlsx` - 所有育种性状列

**格式化规则:**
- 表头冻结
- 列宽自动调整
- 数值右对齐
- 性状值按条件格式着色（高值绿色，低值红色）

**实现状态:**
- ✅ 数据收集器: `traits_detail_collector.py`
- ✅ Sheet构建器: `sheet8_traits_detail_builder.py`

---

### Sheet 9-10: 母牛指数分析

#### Sheet 9: 母牛指数分布分析 ✅

**功能描述:**
展示自定义母牛指数的正态分布情况和统计指标。

**内容组成:**

**9.1 母牛指数正态分布直方图**
- X轴: 指数值区间
- Y轴: 母牛数量
- 柱状图 + 拟合正态分布曲线
- 显示均值线（红色虚线）

**9.2 母牛指数统计指标表**

| 统计指标 | 数值 |
|---------|-----|
| 平均值 | 78.5 |
| 中位数 | 77.8 |
| 标准差 | 12.8 |
| 最小值 | 42.5 |
| 25分位数 | 68.2 |
| 50分位数 | 77.8 |
| 75分位数 | 88.5 |
| 最大值 | 102.5 |

**9.3 分位数分布表**

| 分位数区间 | 母牛数 | 占比 |
|-----------|--------|-----|
| < 25分位数 | 312 | 25.0% |
| 25-50分位数 | 313 | 25.0% |
| 50-75分位数 | 312 | 25.0% |
| > 75分位数 | 313 | 25.0% |

**数据来源:**
- `母牛指数计算结果.xlsx` - 母牛指数列

**实现状态:**
- ✅ 数据收集器: `cow_index_distribution_collector.py`
- ✅ Sheet构建器: `sheet9_cow_index_distribution_builder.py`

---

#### Sheet 10: 母牛指数排名明细 ✅

**功能描述:**
按母牛指数从高到低排序，展示全群母牛的指数排名明细。

**表格格式:**

| 排名 | 母牛号 | 母牛指数 | NM$ | TPI | 胎次 | 产奶状态 | 推荐分组 |
|-----|--------|---------|-----|-----|-----|---------|---------|
| 1 | C0015678 | 98.5 | 685 | 2980 | 2 | 泌乳 | A组（性控） |
| 2 | C0012890 | 96.2 | 650 | 2850 | 1 | 泌乳 | A组（性控） |
| 3 | C0013456 | 94.8 | 625 | 2780 | 3 | 泌乳 | A组（性控） |
| ... | ... | ... | ... | ... | ... | ... | ... |
| 1248 | C0018765 | 45.2 | -65 | 1280 | 5 | 干奶 | C组（常规） |
| 1249 | C0019876 | 43.8 | -80 | 1150 | 6 | 干奶 | C组（常规） |
| 1250 | C0020123 | 42.5 | -85 | 1050 | 7 | 干奶 | C组（常规） |

**格式化规则:**
- 指数 > 90: 绿色背景（优秀）
- 指数 75-90: 白色背景（良好）
- 指数 60-75: 黄色背景（一般）
- 指数 < 60: 橙色背景（较差）

**数据来源:**
- `母牛指数计算结果.xlsx`
- `选配分组结果.xlsx`

**实现状态:**
- ✅ 数据收集器: `cow_index_ranking_collector.py`
- ✅ Sheet构建器: `sheet10_cow_index_ranking_builder.py`

---

### Sheet 11-13: 配种记录分析

#### Sheet 11: 配种记录-隐性基因分析 ✅

**功能描述:**
统计和分析历史配种记录中的隐性基因纯合风险，包括全部年份和近12个月的数据对比。

**内容组成:**

**11.1 隐性基因纯合汇总表（全部配种记录年份）**

**表头格式:**
```
隐性基因纯合汇总表——全部配种记录（共XXX配次）
```

**表格格式:**

| 基因名称 | 翻译 | 纯合配次 | 占总配种比例 | 仅公牛携带配次 | 占比 | 仅母牛父亲携带配次 | 占比 | 数据缺少配次 | 占比 |
|---------|-----|---------|------------|--------------|-----|----------------|-----|------------|-----|
| HH1 | 单倍体不育1 | 5 | 1.2% | 45 | 10.5% | 38 | 8.9% | 12 | 2.8% |
| HH2 | 单倍体不育2 | 2 | 0.5% | 28 | 6.5% | 22 | 5.1% | 8 | 1.9% |
| HH3 | 单倍体不育3 | 1 | 0.2% | 15 | 3.5% | 12 | 2.8% | 5 | 1.2% |
| HH4 | 单倍体不育4 | 0 | 0.0% | 8 | 1.9% | 6 | 1.4% | 3 | 0.7% |
| HH5 | 单倍体不育5 | 3 | 0.7% | 22 | 5.1% | 18 | 4.2% | 7 | 1.6% |
| HH6 | 单倍体不育6 | 1 | 0.2% | 12 | 2.8% | 9 | 2.1% | 4 | 0.9% |
| BLAD | 白细胞黏附缺陷症 | 0 | 0.0% | 2 | 0.5% | 1 | 0.2% | 0 | 0.0% |
| Brachyspina | 短脊椎症 | 0 | 0.0% | 8 | 1.9% | 5 | 1.2% | 1 | 0.2% |
| Cholesterol deficiency | 胆固醇缺乏症 | 0 | 0.0% | 5 | 1.2% | 3 | 0.7% | 1 | 0.2% |
| Chondrodysplasia | 软骨发育不良 | 0 | 0.0% | 6 | 1.4% | 4 | 0.9% | 2 | 0.5% |
| Citrullinemia | 瓜氨酸血症 | 0 | 0.0% | 4 | 0.9% | 2 | 0.5% | 1 | 0.2% |
| CVM | 牛脊椎畸形综合征 | 0 | 0.0% | 10 | 2.3% | 7 | 1.6% | 2 | 0.5% |
| DUMPS | 尿苷单磷酸合成酶缺乏症 | 0 | 0.0% | 3 | 0.7% | 2 | 0.5% | 0 | 0.0% |
| Factor XI | 凝血因子XI缺乏症 | 0 | 0.0% | 7 | 1.6% | 4 | 0.9% | 1 | 0.2% |
| Mulefoot | 并趾症 | 0 | 0.0% | 2 | 0.5% | 1 | 0.2% | 0 | 0.0% |
| MW | 早发肌无力 | 0 | 0.0% | 3 | 0.7% | 2 | 0.5% | 0 | 0.0% |

**基因列表（共16个）及中文翻译:**

**HH系列（单倍体不育）:**
- HH1 - 单倍体不育1
- HH2 - 单倍体不育2
- HH3 - 单倍体不育3
- HH4 - 单倍体不育4
- HH5 - 单倍体不育5
- HH6 - 单倍体不育6

**其他遗传缺陷:**
- BLAD - 白细胞黏附缺陷症
- Brachyspina - 短脊椎症
- Cholesterol deficiency - 胆固醇缺乏症
- Chondrodysplasia - 软骨发育不良
- Citrullinemia - 瓜氨酸血症
- CVM - 牛脊椎畸形综合征
- DUMPS - 尿苷单磷酸合成酶缺乏症
- Factor XI - 凝血因子XI缺乏症
- Mulefoot - 并趾症
- MW - 早发肌无力

**基因排序规则:**
1. HH系列基因在前（按HH1-HH6顺序）
2. 其他遗传缺陷在后（按字母顺序）

**格式化规则:**
- **纯合配次、占比**: 红色背景 RGB(255, 199, 206)（最高风险）
- **仅公牛携带配次、占比**: 黄色背景 RGB(255, 235, 156)（中风险）
- **仅母牛父亲携带配次、占比**: 橙色背景 RGB(255, 217, 102)（中低风险）
- **数据缺少配次、占比**: 浅灰色背景 RGB(217, 217, 217)（数据缺失）
- **不需要合计行**

**11.2 隐性基因纯合汇总表（近12个月配种记录）**

**表头格式:**
```
隐性基因纯合汇总表——YYYY年MM月DD日-YYYY年MM月DD日（共XXX配次）
```

**表格格式:** （与11.1相同，包含所有16个基因）

**数据来源:**
- 文件: `已配公牛_近交系数及隐性基因分析结果_最近一次.xlsx`
- 关键列:
  - `配种日期`: 用于筛选近12个月数据
  - `基因列` (如HH1, BLAD, CVM等): 基因风险状态值

**基因自动识别逻辑:**
1. 从数据文件中自动识别所有基因列（不带(母)(公)后缀的列）
2. 验证每个基因列存在（有对应的(母)和(公)列）
3. 排序：HH系列在前，其他基因按字母顺序在后

**数据统计逻辑（基于基因列的状态值）:**

| 状态值 | 统计类别 | 说明 |
|--------|---------|------|
| `'高风险'` | 纯合配次 | 母牛父亲和公牛都携带该基因，后代25%概率发病 |
| `'仅公牛携带'` | 仅公牛携带配次 | 仅公牛携带，后代不发病但可能携带 |
| `'仅母牛父亲携带'` | 仅母牛父亲携带配次 | 母牛可能携带，后代可能携带 |
| `'缺少公牛信息'` | 数据缺少配次 | 公牛基因信息缺失 |
| `'缺少母牛父亲信息'` | 数据缺少配次 | 母牛父亲基因信息缺失 |
| `'缺少双方信息'` | 数据缺少配次 | 双方基因信息都缺失 |
| `'-'` | 安全配次（不统计） | 不携带该基因，安全 |

**时间筛选:**
- **近12个月**: `配种日期 >= 今天 - 365天`

**风险等级说明:**
- **纯合风险（红色）**: 后代有25%概率发病，最高风险
- **仅公牛携带（黄色）**: 后代不发病但可能携带，中风险
- **仅母牛父亲携带（橙色）**: 母牛可能携带，后代可能携带，中低风险
- **数据缺少（灰色）**: 无法判断风险，需要补充数据

**实现状态:**
- ✅ 数据收集器: `gene_collector.py`
  - ✅ 自动识别所有16个基因
  - ✅ 基因中文翻译映射
  - ✅ 按文件名时间戳选择最新文件
  - ✅ 全部年份和近12个月数据统计
  - ✅ 总配次统计
- ✅ Sheet构建器: `sheet11_genes_builder.py`
  - ✅ 10列表格（含翻译列）
  - ✅ 颜色编码风险等级
  - ✅ 标题显示总配次
  - ✅ 日期格式化

---

#### Sheet 12: 配种记录-近交系数分析 ✅

**功能描述:**
统计和分析历史配种记录中的近交系数分布和风险等级，包括全部年份和近12个月的数据对比。

**内容组成:**

**12.1 近交系数分布汇总表（全部配种记录年份）**

**表头格式:**
```
近交系数分布汇总表——全部配种记录（共XXX配次）
```

**表格格式:**

| 近交系数区间 | 配种头次 | 占比 | 风险等级 |
|------------|---------|-----|---------|
| < 3.125% | 856 | 68.5% | 低 |
| 3.125% - 6.25% | 285 | 22.8% | 中 |
| 6.25% - 12.5% | 98 | 7.8% | 高 |
| > 12.5% | 11 | 0.9% | 极高 |
| **总计** | **1250** | **100%** | - |

**格式化规则:**
- > 12.5%: 深红色背景 #FF0000（极高风险）
- 6.25-12.5%: 红色背景 #FFC7CE（高风险）
- 3.125-6.25%: 黄色背景 #FFEB9C（中风险）
- < 3.125%: 浅蓝色背景 #9BC2E6（低风险）

**12.2 近交系数分布汇总表（近12个月）**

**表头格式:**
```
近交系数分布汇总表——YYYY年MM月DD日至YYYY年MM月DD日（共XXX配次）
```

**表格格式:** 同12.1

**12.3 近交系数分布图表**

每个时间段（全部年份、近12个月）包含2个图表：

**图表1: 分布柱状图**
- X轴: 近交系数区间
- Y轴: 配种头次
- 柱子颜色与风险等级一致（浅蓝、黄、红、深红）
- 图表宽度: 13（高度×4/3）
- 位置: 与表格第一行平齐

**图表2: 风险等级占比饼图**
- 扇形颜色与风险等级一致
- 位置: 与表格第一行平齐，横向间隔11列

**12.4 按年份近交系数趋势表**

**表格格式:**

| 年份 | 总配种次数 | 高风险配种数（6.25%-12.5%） | 高风险占比 | 极高风险配种数（>12.5%） | 极高风险占比 |
|-----|----------|--------------------------|-----------|-----------------------|-------------|
| 2020 | 245 | 28 | 11.4% | 5 | 2.0% |
| 2021 | 268 | 25 | 9.3% | 3 | 1.1% |
| 2022 | 289 | 22 | 7.6% | 2 | 0.7% |
| 2023 | 312 | 18 | 5.8% | 1 | 0.3% |
| 2024 | 136 | 6 | 4.4% | 0 | 0.0% |

**格式化规则:**
- 高风险和极高风险数量>0时，标红加粗

**数据来源:**
- 文件: `已配公牛_近交系数及隐性基因分析结果_*.xlsx`
- 关键列: `配种日期`, `后代近交系数`

**实现状态:**
- ✅ 数据收集器: `breeding_inbreeding_collector.py`
  - ✅ 全部年份和近12个月数据统计
  - ✅ 4个区间分布统计
  - ✅ 按年份趋势分析（区分高风险和极高风险）
- ✅ Sheet构建器: `sheet12_inbreeding_builder.py`
  - ✅ 2个分布表（全部年份+近12个月）
  - ✅ 4个图表（2个柱状图+2个饼图）
  - ✅ 图表颜色与风险等级对应
  - ✅ 年份趋势表
  - ✅ 列宽自动调整

---

#### Sheet 13: 配种记录明细 ✅

**功能描述:**
展示所有配种记录的详细数据，包括近交系数和隐性基因分析结果。

**数据内容:**
直接复制"已配公牛_近交系数及隐性基因分析结果_*.xlsx"文件的所有数据

**包含列（共57列）:**

**基础信息（6列）:**
1. 母牛号
2. 配种日期
3. 父号
4. 原始父号
5. 配种公牛号
6. 原始公牛号

**近交系数（3列）:**
7. 近交系数
8. 后代近交系数
9. 后代近交详情

**隐性基因（48列 = 16个基因 × 3列）:**
每个基因包含3列：基因名、基因名(母)、基因名(公)

- HH1, HH1(母), HH1(公)
- HH2, HH2(母), HH2(公)
- HH3, HH3(母), HH3(公)
- HH4, HH4(母), HH4(公)
- HH5, HH5(母), HH5(公)
- HH6, HH6(母), HH6(公)
- BLAD, BLAD(母), BLAD(公)
- Chondrodysplasia, Chondrodysplasia(母), Chondrodysplasia(公)
- Citrullinemia, Citrullinemia(母), Citrullinemia(公)
- DUMPS, DUMPS(母), DUMPS(公)
- Factor XI, Factor XI(母), Factor XI(公)
- CVM, CVM(母), CVM(公)
- Brachyspina, Brachyspina(母), Brachyspina(公)
- Mulefoot, Mulefoot(母), Mulefoot(公)
- Cholesterol deficiency, Cholesterol deficiency(母), Cholesterol deficiency(公)
- MW, MW(母), MW(公)

**格式化规则:**
- 表头: 应用统一的表头样式
- 数据: 居中对齐
- 列宽自动调整:
  - 母牛号、配种公牛号: 15
  - 配种日期: 12
  - 带括号的基因列: 10
  - 后代近交详情: 30
  - 其他列: 12
- 冻结首行

**数据来源:**
- 文件: `已配公牛_近交系数及隐性基因分析结果_*.xlsx`
- 读取: 所有行和所有列（原样复制）

**实现状态:**
- ✅ 数据收集器: `breeding_detail_collector.py`
  - ✅ 读取最新的分析结果文件
  - ✅ 返回完整DataFrame
- ✅ Sheet构建器: `sheet13_breeding_detail_builder.py`
  - ✅ 直接复制所有数据
  - ✅ 表头样式应用
  - ✅ 列宽自动调整
  - ✅ 冻结首行

---

### Sheet 14-15: 已用公牛分析

#### Sheet 14: 已用公牛性状汇总分析 ✅

**功能描述:**
统计和分析历史配种记录中使用过的公牛，按年份汇总展示公牛性状的变化趋势。

**内容组成:**

**14.1 按年份汇总表**

**表头格式:**
```
已用公牛按年份汇总表
```

**表格格式:**

| 年份 | 使用公牛数 | 配种头次 | 平均NM$ | 平均TPI | 平均产奶PTA | 平均乳脂PTA | 平均乳蛋白PTA | 平均体细胞 | 平均DPR | 平均CCR | 平均HCR |
|-----|----------|---------|---------|---------|------------|------------|-------------|----------|---------|---------|---------|
| 2020 | 45 | 856 | 425 | 2280 | 1150 | 48 | 42 | 2.85 | 1.2 | 0.8 | 1.0 |
| 2021 | 52 | 923 | 445 | 2350 | 1200 | 52 | 45 | 2.78 | 1.5 | 1.1 | 1.3 |
| 2022 | 58 | 1012 | 468 | 2420 | 1250 | 55 | 48 | 2.72 | 1.8 | 1.4 | 1.6 |
| 2023 | 62 | 1125 | 492 | 2485 | 1300 | 58 | 50 | 2.68 | 2.0 | 1.6 | 1.8 |
| 2024 | 48 | 685 | 515 | 2550 | 1350 | 60 | 52 | 2.65 | 2.2 | 1.8 | 2.0 |

**14.2 动态性状进展折线图**

根据汇总表中的性状数量，自动生成多组折线图，每组图表包含1-3条折线：

**图表组1: 综合指数（NM$、TPI）**
- X轴: 年份
- Y轴: 指数值
- 2条折线

**图表组2: 产奶性状（产奶PTA、乳脂PTA、乳蛋白PTA）**
- X轴: 年份
- Y轴: PTA值
- 3条折线

**图表组3: 体细胞**
- X轴: 年份
- Y轴: SCS值
- 1条折线

**图表组4: 繁殖性状（DPR、CCR、HCR）**
- X轴: 年份
- Y轴: 繁殖性状值
- 3条折线

**...根据性状数量自动分组**

**14.3 性状进展数据表**

**表头格式:**
```
性状逐年增长、年均增长、累计增长统计表
```

**表格格式:**

| 性状 | 2020-2021增长 | 2021-2022增长 | 2022-2023增长 | 2023-2024增长 | 年均增长 | 累计增长 |
|-----|-------------|-------------|-------------|-------------|---------|---------|
| NM$ | +20 | +23 | +24 | +23 | +22.5 | +90 |
| TPI | +70 | +70 | +65 | +65 | +67.5 | +270 |
| 产奶PTA | +50 | +50 | +50 | +50 | +50 | +200 |
| 乳脂PTA | +4 | +3 | +3 | +2 | +3 | +12 |
| 乳蛋白PTA | +3 | +3 | +2 | +2 | +2.5 | +10 |
| 体细胞 | -0.07 | -0.06 | -0.04 | -0.03 | -0.05 | -0.20 |
| DPR | +0.3 | +0.3 | +0.2 | +0.2 | +0.25 | +1.0 |
| CCR | +0.3 | +0.3 | +0.2 | +0.2 | +0.25 | +1.0 |
| HCR | +0.3 | +0.3 | +0.2 | +0.2 | +0.25 | +1.0 |

**14.4 全部配种记录时间线散点图**

- X轴: 配种日期
- Y轴: 配种公牛的NM$或TPI值
- 每个配次为一个散点
- 显示遗传进展趋势线

**14.5 近12个月配种记录时间线散点图**

- X轴: 配种日期（近12个月）
- Y轴: 配种公牛的NM$或TPI值
- 每个配次为一个散点
- 显示近期遗传进展趋势

**数据来源:**
- 文件: `已配公牛_近交系数及隐性基因分析结果_*.xlsx` - 配种记录
- 公牛库: 公牛育种值数据

**实现状态:**
- ✅ 数据收集器: `used_bulls_summary_collector.py`
  - ✅ 按年份统计使用公牛数和配种头次
  - ✅ 计算各性状年份平均值
  - ✅ 逐年增长、年均增长、累计增长计算
  - ✅ 全部配种和近12个月数据准备
- ✅ Sheet构建器: `sheet14_used_bulls_summary_builder.py`
  - ✅ 按年份汇总表
  - ✅ 动态生成多组折线图
  - ✅ 性状进展数据表
  - ✅ 2个时间线散点图
  - ✅ 自动布局和列宽调整

---

#### Sheet 15: 已用公牛性状明细 ✅

**功能描述:**
按年份和精液类型（性控/常规）分组，展示使用过的公牛的详细性状数据。

**内容组成:**

**按年份-类型分组的明细表**

每个年份-类型组合创建一个独立表格，例如：

**2024年 - 常规冻精使用公牛明细**

**表头格式:**
```
2024年 - 常规冻精使用公牛明细（共XX头公牛，XXX支）
```

**表格格式:**

| 公牛NAAB号 | 使用支数 | NM$ | TPI | 产奶PTA | 乳脂PTA | 乳蛋白PTA | 乳脂% | 乳蛋白% | 体细胞 | DPR | CCR | HCR | ... |
|-----------|---------|-----|-----|---------|---------|----------|-------|--------|--------|-----|-----|-----|-----|
| 001HO12345 | 85 | 545 | 2680 | 1420 | 65 | 55 | 0.10 | 0.06 | 2.58 | 2.5 | 2.1 | 2.3 | ... |
| 001HO23456 | 68 | 520 | 2650 | 1380 | 62 | 52 | 0.08 | 0.05 | 2.62 | 2.3 | 1.9 | 2.1 | ... |
| 001HO34567 | 52 | 498 | 2580 | 1350 | 58 | 50 | 0.06 | 0.04 | 2.68 | 2.1 | 1.7 | 1.9 | ... |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |
| **数据库最高值** | - | **750** | **3200** | **1800** | **85** | **75** | **0.15** | **0.08** | **2.20** | **3.5** | **3.0** | **3.2** | **...** |
| **数据库最低值** | - | **-100** | **1500** | **600** | **20** | **15** | **-0.05** | **-0.02** | **3.50** | **-2.0** | **-2.0** | **-2.0** | **...** |
| **本组平均值** | - | **521** | **2637** | **1383** | **62** | **52** | **0.08** | **0.05** | **2.63** | **2.3** | **1.9** | **2.1** | **...** |

**2024年 - 性控冻精使用公牛明细** (同上格式)

**2023年 - 常规冻精使用公牛明细** (同上格式)

**2023年 - 性控冻精使用公牛明细** (同上格式)

**...依次展示其他年份**

**表格特点:**
- 每个年份-类型组合独立一个表
- 按使用支数降序排列
- 表格末尾3行显示：数据库最高值、最低值、本组平均值
- 隐性基因携带用橙色标记

**数据来源:**
- 配种记录（统计使用支数）
- 公牛库育种值
- 公牛库隐性基因

**实现状态:**
- ✅ 数据收集器: `used_bulls_detail_collector.py`
  - ✅ 按年份和精液类型分组
  - ✅ 统计每头公牛使用支数
  - ✅ 读取公牛育种值
  - ✅ 计算数据库最高/最低值和本组平均值
- ✅ Sheet构建器: `sheet15_used_bulls_detail_builder.py`
  - ✅ 为每个年份-类型组合创建独立表格
  - ✅ 按使用支数降序排列
  - ✅ 末尾3行统计数据
  - ✅ 隐性基因橙色标记
  - ✅ 列宽自动调整

---

### Sheet 16-17: 选配推荐结果

#### Sheet 16: 备选公牛排名 ✅

**功能描述:**
展示备选公牛库中的公牛，按育种指数排名，便于选配时参考。

**表格格式:**

| 排名 | 公牛NAAB号 | 育种指数 | NM$ | TPI | 产奶PTA | 乳脂PTA | 乳蛋白PTA | 乳脂% | 乳蛋白% | 体细胞 | DPR | CCR | HCR | ... | 可用库存 |
|-----|-----------|---------|-----|-----|---------|---------|----------|-------|--------|--------|-----|-----|-----|-----|---------|
| 1 | 001HO67890 | 98.5 | 680 | 2950 | 1520 | 72 | 62 | 0.12 | 0.07 | 2.45 | 2.8 | 2.4 | 2.6 | ... | 50 |
| 2 | 001HO78901 | 96.2 | 650 | 2880 | 1480 | 68 | 58 | 0.10 | 0.06 | 2.52 | 2.6 | 2.2 | 2.4 | ... | 35 |
| 3 | 001HO89012 | 94.8 | 625 | 2820 | 1450 | 65 | 56 | 0.08 | 0.05 | 2.58 | 2.5 | 2.0 | 2.2 | ... | 42 |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

**格式化规则:**
- 育种指数 > 95: 绿色背景（优秀）
- 育种指数 90-95: 白色背景（良好）
- 育种指数 < 90: 黄色背景（一般）
- 可用库存 < 10: 红色字体（库存紧张）

**数据来源:**
- 上传的备选公牛数据
- 公牛指数计算结果
- 公牛库存数据

**实现状态:**
- ✅ 数据收集器: `candidate_bulls_collector.py`
  - ✅ 读取备选公牛数据
  - ✅ 计算公牛指数
  - ✅ 按指数排序
- ✅ Sheet构建器: `sheet16_candidate_bulls_builder.py`
  - ✅ 排名表生成
  - ✅ 条件格式化（指数、库存）
  - ✅ 列宽自动调整

---

#### Sheet 17: 选配推荐结果 ✅

**功能描述:**
展示系统为每头母牛推荐的最优公牛组合，包括预测后代指数、近交系数和隐性基因风险。

**表格格式:**

| 母牛号 | 母牛指数 | 推荐位次 | 公牛NAAB号 | 预测后代指数 | 预测后代NM$ | 预测后代TPI | 后代近交系数 | 隐性基因风险 | 冻精类型 | 备注 |
|-------|---------|---------|-----------|------------|-----------|-----------|------------|------------|---------|-----|
| C0012345 | 85.2 | 1选 | 001HO67890 | 91.8 | 565 | 2765 | 3.2% | 无 | 性控 | 优先推荐 |
| C0012345 | 85.2 | 2选 | 001HO78901 | 90.5 | 550 | 2720 | 4.1% | HH1风险 | 性控 | 备选 |
| C0012345 | 85.2 | 3选 | 001HO89012 | 89.2 | 538 | 2680 | 3.8% | 无 | 性控 | 备选 |
| C0012346 | 82.5 | 1选 | 001HO67890 | 89.5 | 548 | 2710 | 2.8% | 无 | 常规 | 优先推荐 |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

**格式化规则:**
- 后代近交系数 > 6.25%: 红色背景
- 后代近交系数 3.125-6.25%: 黄色背景
- 有隐性基因风险: 橙色标记
- 1选推荐: 加粗
- 预测后代指数前10%: 绿色字体

**数据来源:**
- 选配推荐结果文件
- 后代指数预测
- 近交系数计算
- 隐性基因分析

**实现状态:**
- ✅ 数据收集器: `mating_results_collector.py`
  - ✅ 读取选配推荐结果
  - ✅ 计算预测后代指数
  - ✅ 近交系数和隐性基因风险标记
- ✅ Sheet构建器: `sheet17_mating_results_builder.py`
  - ✅ 选配明细表
  - ✅ 条件格式化（近交、基因、指数）
  - ✅ 列宽自动调整

---

## 技术实现

### 架构设计

Excel报告生成采用**数据收集器 + Sheet构建器**的分层架构：

```
用户触发生成报告
    ↓
ReportGenerator (总控制器)
    ↓
DataCollector (数据收集层) → 收集和预处理数据
    ↓
SheetBuilder (构建层) → 创建Sheet、写入数据、绘制图表
    ↓
ExcelWriter (输出层) → 保存文件
    ↓
报告生成完成
```

### 模块组织

#### 1. 数据收集器 (Data Collectors)

位置: `core/excel_report/data_collectors/`

| 文件名 | 对应Sheet | 职责 |
|-------|----------|-----|
| `farm_info_collector.py` | Sheet 1 | 收集牧场基础信息 |
| `raw_data_collector.py` | Sheet 2 | 读取原始母牛数据 |
| `pedigree_collector.py` | Sheet 3 | 统计系谱识别率 |
| `pedigree_detail_collector.py` | Sheet 4 | 读取系谱识别明细 |
| `traits_summary_collector.py` | Sheet 5 | 按年份汇总育种性状 |
| `nm_distribution_collector.py` | Sheet 6 | NM$分布统计 |
| `tpi_distribution_collector.py` | Sheet 7 | TPI分布统计 |
| `traits_detail_collector.py` | Sheet 8 | 读取育种性状明细 |
| `cow_index_distribution_collector.py` | Sheet 9 | 母牛指数分布统计 |
| `cow_index_ranking_collector.py` | Sheet 10 | 母牛指数排名 |
| `gene_collector.py` | Sheet 11 | 隐性基因分析统计 |
| `breeding_inbreeding_collector.py` | Sheet 12 | 近交系数分布统计 |
| `breeding_detail_collector.py` | Sheet 13 | 读取配种记录明细 |
| `used_bulls_summary_collector.py` | Sheet 14 | 已用公牛按年份汇总 |
| `used_bulls_detail_collector.py` | Sheet 15 | 已用公牛明细 |
| `candidate_bulls_collector.py` | Sheet 16 | 备选公牛排名 |
| `mating_results_collector.py` | Sheet 17 | 选配推荐结果 |

#### 2. Sheet构建器 (Sheet Builders)

位置: `core/excel_report/sheet_builders/`

| 文件名 | 对应Sheet | 职责 |
|-------|----------|-----|
| `sheet1_builder.py` | Sheet 1 | 创建牧场基础信息Sheet |
| `sheet2_builder.py` | Sheet 2 | 创建原始数据Sheet |
| `sheet3_builder.py` | Sheet 3 | 创建系谱识别分析Sheet |
| `sheet4_builder.py` | Sheet 4 | 创建系谱识别明细Sheet |
| `sheet5_traits_summary_builder.py` | Sheet 5 | 创建性状年份汇总Sheet |
| `sheet6_nm_distribution_builder.py` | Sheet 6 | 创建NM$分布Sheet |
| `sheet7_tpi_distribution_builder.py` | Sheet 7 | 创建TPI分布Sheet |
| `sheet8_traits_detail_builder.py` | Sheet 8 | 创建育种性状明细Sheet |
| `sheet9_cow_index_distribution_builder.py` | Sheet 9 | 创建母牛指数分布Sheet |
| `sheet10_cow_index_ranking_builder.py` | Sheet 10 | 创建母牛指数排名Sheet |
| `sheet11_genes_builder.py` | Sheet 11 | 创建隐性基因分析Sheet |
| `sheet12_inbreeding_builder.py` | Sheet 12 | 创建近交系数分析Sheet |
| `sheet13_breeding_detail_builder.py` | Sheet 13 | 创建配种记录明细Sheet |
| `sheet14_used_bulls_summary_builder.py` | Sheet 14 | 创建已用公牛汇总Sheet |
| `sheet15_used_bulls_detail_builder.py` | Sheet 15 | 创建已用公牛明细Sheet |
| `sheet16_candidate_bulls_builder.py` | Sheet 16 | 创建备选公牛排名Sheet |
| `sheet17_mating_results_builder.py` | Sheet 17 | 创建选配推荐结果Sheet |

#### 3. 报告生成器 (Generator)

位置: `core/excel_report/generator.py`

**职责:**
- 总控制器，协调所有数据收集器和Sheet构建器
- 创建Workbook
- 按顺序生成17个Sheet
- 保存Excel文件

**核心方法:**
```python
class ExcelReportGenerator:
    def __init__(self, project_folder):
        self.project_folder = project_folder
        self.workbook = None

    def generate(self):
        """生成完整的Excel报告"""
        self._create_workbook()
        self._generate_all_sheets()
        self._save_report()

    def _generate_all_sheets(self):
        """按顺序生成所有Sheet"""
        # Sheet 1-4: 牧场基础分析
        self._generate_sheet1()
        self._generate_sheet2()
        self._generate_sheet3()
        self._generate_sheet4()

        # Sheet 5-8: 育种性状分析
        self._generate_sheet5()
        self._generate_sheet6()
        self._generate_sheet7()
        self._generate_sheet8()

        # Sheet 9-10: 母牛指数分析
        self._generate_sheet9()
        self._generate_sheet10()

        # Sheet 11-13: 配种记录分析
        self._generate_sheet11()
        self._generate_sheet12()
        self._generate_sheet13()

        # Sheet 14-15: 已用公牛分析
        self._generate_sheet14()
        self._generate_sheet15()

        # Sheet 16-17: 选配推荐结果
        self._generate_sheet16()
        self._generate_sheet17()
```

### 图表生成

使用 `openpyxl.chart` 模块生成图表：

**饼图示例:**
```python
from openpyxl.chart import PieChart, Reference

pie = PieChart()
labels = Reference(sheet, min_col=1, min_row=2, max_row=5)
data = Reference(sheet, min_col=2, min_row=1, max_row=5)
pie.add_data(data, titles_from_data=True)
pie.set_categories(labels)
pie.title = "胎次分布"
```

**折线图示例:**
```python
from openpyxl.chart import LineChart, Reference

line = LineChart()
line.title = "NM$进展趋势"
line.x_axis.title = "年份"
line.y_axis.title = "NM$"
data = Reference(sheet, min_col=2, min_row=1, max_row=6)
cats = Reference(sheet, min_col=1, min_row=2, max_row=6)
line.add_data(data, titles_from_data=True)
line.set_categories(cats)
```

**柱状图示例:**
```python
from openpyxl.chart import BarChart, Reference

bar = BarChart()
bar.type = "col"  # 垂直柱状图
bar.title = "近交系数分布"
data = Reference(sheet, min_col=2, min_row=1, max_row=5)
cats = Reference(sheet, min_col=1, min_row=2, max_row=5)
bar.add_data(data, titles_from_data=True)
bar.set_categories(cats)
```

### 条件格式化

使用 `openpyxl.styles` 和 `openpyxl.formatting.rule` 进行格式化：

**颜色填充:**
```python
from openpyxl.styles import PatternFill

# 红色背景（高风险）
red_fill = PatternFill(start_color="FFC7CE", end_color="FFC7CE", fill_type="solid")
cell.fill = red_fill

# 黄色背景（中风险）
yellow_fill = PatternFill(start_color="FFEB9C", end_color="FFEB9C", fill_type="solid")

# 绿色背景（优秀）
green_fill = PatternFill(start_color="C6EFCE", end_color="C6EFCE", fill_type="solid")
```

**条件格式规则:**
```python
from openpyxl.formatting.rule import CellIsRule

# 近交系数 > 6.25% 标红
red_rule = CellIsRule(operator='greaterThan', formula=['6.25'],
                      fill=red_fill)
sheet.conditional_formatting.add('B2:B100', red_rule)
```

### 性能优化

#### 1. 数据缓存
- 避免重复读取相同文件
- 使用单例模式缓存公牛库数据

#### 2. 批量写入
- 使用 `openpyxl` 的 `write_only` 模式提升大数据量写入速度
- 批量写入多行数据而非逐行写入

#### 3. 异步处理
- 在GUI中使用多线程，避免阻塞主线程
- 显示进度条提升用户体验

---

## 数据流程

### 数据依赖关系

```
用户上传数据
    ↓
┌──────────────────────────────────────────────────┐
│ 数据预处理和标准化                                  │
├──────────────────────────────────────────────────┤
│ 1. 牧场母牛信息_processed.xlsx                     │
│ 2. 母牛性状数据.xlsx                               │
│ 3. 已配公牛_近交系数及隐性基因分析结果_*.xlsx         │
│ 4. 备选公牛数据.xlsx                               │
│ 5. 选配推荐结果.xlsx                               │
│ 6. 公牛库 (SQLite数据库)                          │
└──────────────────────────────────────────────────┘
    ↓
┌──────────────────────────────────────────────────┐
│ Excel报告生成                                      │
├──────────────────────────────────────────────────┤
│ Sheet 1-4:  牧场母牛信息_processed.xlsx           │
│ Sheet 5-8:  母牛性状数据.xlsx                      │
│ Sheet 9-10: 母牛指数计算结果.xlsx                  │
│ Sheet 11-13: 已配公牛_近交系数及隐性基因分析结果    │
│ Sheet 14-15: 配种记录 + 公牛库                     │
│ Sheet 16:   备选公牛数据.xlsx + 公牛库             │
│ Sheet 17:   选配推荐结果.xlsx                      │
└──────────────────────────────────────────────────┘
    ↓
生成Excel综合报告.xlsx
```

### 文件命名规范

**输入文件:**
- `牧场母牛信息_processed.xlsx` - 预处理后的母牛数据
- `母牛性状数据.xlsx` - 母牛育种值计算结果
- `已配公牛_近交系数及隐性基因分析结果_YYYYMMDD_HHMMSS.xlsx` - 配种记录分析结果（带时间戳）
- `母牛指数计算结果.xlsx` - 自定义母牛指数
- `备选公牛数据.xlsx` - 上传的备选公牛
- `选配推荐结果.xlsx` - 最终选配方案

**输出文件:**
- `[牧场名称]_遗传分析综合报告_YYYYMMDD.xlsx` - Excel报告

---

## 使用指南

### 生成Excel报告

#### 方法1: GUI界面生成

1. 打开系统主界面
2. 完成所有数据上传和处理步骤
3. 进入"报告生成"模块
4. 点击"生成Excel报告"按钮
5. 等待进度条完成
6. 报告保存在项目文件夹的 `reports/` 目录

#### 方法2: 代码调用

```python
from core.excel_report.generator import ExcelReportGenerator

# 创建生成器
generator = ExcelReportGenerator(project_folder="/path/to/project")

# 生成报告
try:
    report_path = generator.generate()
    print(f"报告生成成功: {report_path}")
except Exception as e:
    print(f"报告生成失败: {e}")
```

#### 方法3: 命令行调用

```bash
python -m core.excel_report.generator --project "/path/to/project"
```

### 查看报告

生成的Excel文件可以使用以下软件打开：
- **Microsoft Excel** (推荐版本 2016+)
- **WPS Office**
- **LibreOffice Calc**
- **Google Sheets** (部分图表可能显示异常)

### 常见问题

**Q1: 报告生成时间较长怎么办？**
- A: Excel报告包含17个Sheet和25+图表，生成需要1-3分钟，请耐心等待

**Q2: 某些Sheet为空或缺少数据？**
- A: 检查是否完成了相应的数据上传和处理步骤，参考数据依赖关系图

**Q3: 图表显示异常？**
- A: 建议使用 Microsoft Excel 2016+ 或 WPS Office 打开，避免使用 Google Sheets

**Q4: 如何自定义报告内容？**
- A: 修改对应的 Sheet Builder 代码，调整表格格式、图表样式等

---

## 开发说明

### 添加新的Sheet

如需添加新的Sheet（如Sheet 18），按以下步骤操作：

#### 1. 创建数据收集器

在 `core/excel_report/data_collectors/` 创建新文件 `new_sheet_collector.py`:

```python
import pandas as pd
from pathlib import Path

class NewSheetCollector:
    def __init__(self, project_folder):
        self.project_folder = Path(project_folder)

    def collect(self):
        """收集Sheet 18所需数据"""
        # 读取数据文件
        data_file = self.project_folder / "某个数据文件.xlsx"
        df = pd.read_excel(data_file)

        # 数据处理和统计
        result = self._process_data(df)

        return result

    def _process_data(self, df):
        """数据处理逻辑"""
        # 实现具体的数据处理
        pass
```

#### 2. 创建Sheet构建器

在 `core/excel_report/sheet_builders/` 创建新文件 `sheet18_builder.py`:

```python
from openpyxl.worksheet.worksheet import Worksheet
from openpyxl.styles import Font, Alignment, PatternFill
from .base_builder import BaseSheetBuilder

class Sheet18Builder(BaseSheetBuilder):
    def __init__(self, workbook, data):
        super().__init__(workbook)
        self.data = data

    def build(self):
        """构建Sheet 18"""
        sheet = self.workbook.create_sheet(title="Sheet18名称")

        # 写入表头
        self._write_header(sheet)

        # 写入数据
        self._write_data(sheet)

        # 创建图表（如果需要）
        self._create_charts(sheet)

        # 格式化
        self._apply_formatting(sheet)

        return sheet

    def _write_header(self, sheet):
        """写入表头"""
        pass

    def _write_data(self, sheet):
        """写入数据"""
        pass

    def _create_charts(self, sheet):
        """创建图表"""
        pass

    def _apply_formatting(self, sheet):
        """应用格式化"""
        pass
```

#### 3. 在生成器中注册

修改 `core/excel_report/generator.py`:

```python
from .data_collectors.new_sheet_collector import NewSheetCollector
from .sheet_builders.sheet18_builder import Sheet18Builder

class ExcelReportGenerator:
    def _generate_all_sheets(self):
        # ... 现有代码 ...

        # Sheet 18
        self._generate_sheet18()

    def _generate_sheet18(self):
        """生成Sheet 18"""
        collector = NewSheetCollector(self.project_folder)
        data = collector.collect()

        builder = Sheet18Builder(self.workbook, data)
        builder.build()
```

### 修改现有Sheet

1. 找到对应的 `data_collector` 和 `sheet_builder`
2. 修改数据收集逻辑或Sheet构建逻辑
3. 测试确保修改正确

### 调试技巧

**1. 单独测试数据收集器:**
```python
from core.excel_report.data_collectors.farm_info_collector import FarmInfoCollector

collector = FarmInfoCollector("/path/to/project")
data = collector.collect()
print(data)
```

**2. 单独测试Sheet构建器:**
```python
from openpyxl import Workbook
from core.excel_report.sheet_builders.sheet1_builder import Sheet1Builder

workbook = Workbook()
builder = Sheet1Builder(workbook, test_data)
sheet = builder.build()
workbook.save("test_output.xlsx")
```

**3. 使用日志:**
```python
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

logger.debug("开始生成Sheet 1")
logger.info(f"收集到 {len(data)} 条数据")
```

### 代码规范

- 遵循 PEP 8 编码规范
- 类名使用大驼峰命名法 (CamelCase)
- 函数名使用小写下划线命名法 (snake_case)
- 添加详细的文档字符串 (docstring)
- 异常处理要明确且友好

---

## 版本变更历史

### v2.0 (合并版) - 2025-11-02

**主要变更:**
- ✅ 合并 `Excel报告最终需求.md` 和 `Excel报告生成实施方案_v1.2.md` 为一个综合指南
- ✅ 保留所有重要技术细节、需求说明、实现状态
- ✅ 更新完成状态：17个Sheet 100%完成
- ✅ 完善使用指南和开发说明

### v1.2 - 2025-10-28

**主要变更:**
- ✅ Sheet 14-17 全部实现完成
- ✅ 已用公牛性状汇总分析（按年份+折线图）
- ✅ 已用公牛性状明细（按年份/类型分组）
- ✅ 备选公牛排名
- ✅ 选配推荐结果
- ✅ Excel报告功能 100% 完成

**技术改进:**
- 动态折线图生成（根据性状数量自动分组）
- 按年份-类型分组的多表格生成
- 配种记录时间线散点图

### v1.1 - 2025-10-08

**主要变更:**
- ✅ Sheet 11-13 实现完成
- ✅ 配种记录-隐性基因分析（16个基因）
- ✅ 配种记录-近交系数分析（4个风险等级）
- ✅ 配种记录明细（57列完整数据）

**修改记录（v1.1的12条修改）:**

1. ⭐修改1: Sheet 6、Sheet 7 添加分位数分析
2. ⭐修改2: Sheet 11 标题显示总配次
3. ⭐修改3: Sheet 11 添加基因中文翻译列
4. ⭐修改4: Sheet 11 不需要合计行
5. ⭐修改5: Sheet 11 近12个月标题显示日期范围和总配次
6. ⭐修改6: Sheet 12 标题显示总配次
7. ⭐修改7: Sheet 12 近12个月标题显示日期范围和总配次
8. ⭐修改8: Sheet 12 年份趋势表只显示高风险和极高风险
9. ⭐修改9: Sheet 14 性状进展表格式调整（逐年增长、年均增长、累计增长）
10. ⭐修改10: Sheet 14 添加两个时间线散点图（全部+近12个月）
11. ⭐修改11: Sheet 14 折线图数量根据性状动态生成
12. ⭐修改12: Sheet 15 添加数据库最高值、最低值、本组平均值行

### v1.0 - 2025-09-25

**初始版本:**
- ✅ Sheet 1-10 实现完成
- ✅ 牧场基础分析（Sheet 1-4）
- ✅ 育种性状分析（Sheet 5-8）
- ✅ 母牛指数分析（Sheet 9-10）

---

## 总结

Excel综合报告是系统的核心输出之一，提供全面的牛群遗传分析和决策支持。17个Sheet覆盖从牧场基础信息到选配推荐的完整流程，25+图表直观展示数据趋势。

**功能完成度: 100%**

**开发时间线:**
- 2025-09: v1.0 (Sheet 1-10完成)
- 2025-10: v1.1 (Sheet 11-13完成)
- 2025-10: v1.2 (Sheet 14-17完成)
- 2025-11: v2.0 (文档整合完成)

**关键特性:**
- 17个Sheet，覆盖所有分析维度
- 25+图表，数据可视化
- 自动化生成，格式统一
- 风险提示，决策支持

**后续改进方向:**
- 增加更多自定义配置选项
- 支持多语言报告（中英文）
- 优化大数据量下的生成性能
- 增加报告模板系统

---

**文档维护:** 本文档是 `Excel报告最终需求.md` 和 `Excel报告生成实施方案_v1.2.md` 的合并版本，保留了所有重要内容。
**最后更新:** 2025-11-02
