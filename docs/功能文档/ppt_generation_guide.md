# PPT生成功能使用指南

## 概述

PPT生成功能能够自动生成牧场遗传改良项目专项服务报告，包含系谱分析、遗传评估、体型评定和公牛使用分析等内容。

## 使用前准备

### 1. 必要的数据文件

在生成PPT之前，需要确保以下源数据文件存在于项目的 `analysis_results` 文件夹中：

- **牛只信息.xlsx** - 母牛基本信息（必需）
- **公牛性状数据.xlsx** - 公牛性状评估数据（必需）
- **系谱信息.xlsx** - 牛只系谱信息（必需）
- **母牛性状数据.xlsx** - 母牛性状评估数据（必需）
- **配种记录.xlsx** - 配种记录数据（可选）
- **育种指数得分.xlsx** - 母牛育种指数计算结果（可选）
- **母牛关键性状合并.xlsx** - 合并的母牛关键性状数据（可选）
- **selected_traits_key_traits.txt** - 选中的性状列表（可选）

### 2. 数据格式要求

各数据文件必须包含以下关键列：

#### 牛只信息.xlsx
- cow_id - 牛只编号
- birth_date - 出生日期
- lac - 胎次
- 是否在场 - 在场状态（是/否）
- sex - 性别

#### 公牛性状数据.xlsx
- NAAB - 公牛编号
- TPI, NM$, MILK, FAT, PROT 等性状值

#### 系谱信息.xlsx
- cow_id - 牛只编号
- sire_id - 父号
- dam_id - 母号
- birth_year - 出生年份
- sire_identified - 父号识别状态
- mgs_identified - 外祖父识别状态

## 使用步骤

### 在主程序中使用

1. **启动程序并选择项目**
   - 打开遗传改良程序
   - 选择或创建一个项目

2. **准备数据**
   - 确保已完成必要的数据分析
   - 可以通过以下分析功能生成部分数据：
     - 系谱识别情况分析
     - 母牛关键性状计算
     - 母牛育种指数计算

3. **生成PPT**
   - 切换到"生成报告"页面
   - 点击"生成PPT报告"按钮
   - 如果缺少数据，系统会提示是否自动生成

4. **输入牧场名称**
   - 在弹出的对话框中输入牧场名称
   - 这将作为PPT的标题

5. **等待生成完成**
   - 系统会显示进度条
   - 生成完成后会提示是否立即打开查看

### 程序化使用

```python
from core.report.ppt_generator import PPTGenerator

# 创建PPT生成器
generator = PPTGenerator(
    output_folder="./analysis_results",
    username="张三"
)

# 设置牧场名称
generator.farm_name = "示例牧场"

# 生成报告
success = generator.generate_report()

if success:
    print("PPT生成成功！")
```

## PPT内容结构

生成的PPT包含以下内容：

### 1. 封面和目录
- 标题页 - 包含牧场名称、用户和日期
- 目录页 - 四大模块导航

### 2. 牧场系谱记录分析（第1部分）
- 1.1 系谱完整性分析 - 自动生成的识别率统计表
- 1.2 未识别牛只明细 - 需手动填写
- 1.3 系谱记录准确性 - 需手动填写

### 3. 牛群遗传数据评估（第2部分）
- 2.1 关键育种性状分析 - 自动生成的年度变化表
- 2.2 净利润值(NM$)分布分析 - 自动生成的分布图表
- 2.3 NM$正态分布分析 - 自动生成的正态分布图
- 2.4 育种指数正态分布分析 - 自动生成的正态分布图
- 2.5 关键性状进展分析 - 自动生成的各性状进展图

### 4. 牛群体型外貌评定（第3部分）
- 3.1 体型外貌线性评分 - 需手动制作
- 3.2 体型外貌缺陷性状占比 - 需手动制作
- 3.3 缺陷性状具体情况 - 需手动制作
- 3.4 体型外貌进展情况 - 需手动制作

### 5. 牧场公牛使用分析（第4部分）
- 4.1 公牛使用整体情况 - 基于配种记录
- 4.2 公牛使用明细 - 分年份展示
- 4.3 公牛使用进展 - 趋势图
- 4.4 公牛使用单值图 - 散点图

## 自定义配置

### 修改性状翻译

编辑 `config/trait_translations.json` 文件：

```json
{
  "traits": {
    "TPI": "育种综合指数",
    "NM$": "净利润值",
    // 添加或修改性状翻译
  }
}
```

### 修改识别率阈值

在同一配置文件中：

```json
{
  "thresholds": {
    "父号识别率": {
      "warning": 90.0,  // 低于此值显示红色
      "unit": "%"
    }
  }
}
```

## 常见问题

### Q: 提示缺少数据文件怎么办？

A: 有三种解决方案：
1. 手动准备相应的Excel文件
2. 通过主程序的分析功能生成
3. 在提示时选择"是"让系统自动生成（如果支持）

### Q: 生成的PPT中有些页面显示"需手动整理"？

A: 这些内容目前需要手动制作：
- 未识别牛只明细
- 系谱记录准确性分析
- 体型外貌评定全部内容
- 各部分的分析文本

### Q: 如何使用自定义PPT模板？

A: 将您的PPT模板文件放在输出文件夹中，文件名包含"template"即可。系统会自动识别并使用该模板。

### Q: 图表中的中文显示为方块？

A: 这是字体问题，解决方法：
- Windows: 确保安装了SimHei或微软雅黑字体
- macOS: 系统已自动配置Arial Unicode MS
- Linux: 安装中文字体包

### Q: 生成速度很慢？

A: PPT生成涉及大量数据处理和图表生成，建议：
- 减少选中的性状数量
- 确保数据文件不要过大
- 关闭其他占用资源的程序

## 技术支持

如遇到问题，请检查：
1. 日志文件 - 查看详细错误信息
2. 数据文件格式 - 确保符合要求
3. 文件权限 - 确保有写入权限

需要帮助请联系技术支持团队。