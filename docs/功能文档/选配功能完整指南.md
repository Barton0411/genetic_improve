# 选配功能完整指南

**项目名称:** 伊利奶牛选配系统 - 个体选配功能
**文档版本:** v2.0 (合并版)
**更新时间:** 2025-11-02
**完成状态:** ✅ 已完成

---

## 📋 目录

1. [功能概述](#功能概述)
2. [使用指南](#使用指南)
3. [业务逻辑详解](#业务逻辑详解)
   - [分组逻辑](#分组逻辑)
   - [分配逻辑](#分配逻辑)
4. [选配报告](#选配报告)
5. [技术实现](#技术实现)
6. [系统参数配置](#系统参数配置)
7. [版本更新记录](#版本更新记录)

---

## 功能概述

### 核心功能

个体选配系统是牛群育种管理的核心功能，通过智能算法为每头母牛推荐最优公牛组合，实现遗传改良目标。

**主要特点:**
- ✅ **一键完成**: 将原来的两步操作（生成推荐 + 选配分配）合并为一键执行
- ✅ **智能分组**: 自动识别母牛状态，按周期和策略表智能分组
- ✅ **多选推荐**: 每头母牛提供6个选配位（性控3选 + 常规3选）
- ✅ **风险控制**: 近交系数和隐性基因风险实时监控
- ✅ **库存管理**: 按库存比例智能分配，避免浪费
- ✅ **灵活配置**: 支持用户自定义参数和策略表

### 业务价值

- **提高遗传进展**: 为每头母牛匹配最优公牛，最大化后代育种值
- **降低风险**: 自动避免近交和隐性基因纯合风险
- **优化库存**: 按比例分配冻精，避免库存积压
- **节省时间**: 一键完成，从几小时手工选配缩短到几分钟

---

## 使用指南

### 操作流程

#### 1. 准备工作

**1.1 选择项目**
- 在主界面选择要进行选配的牧场项目
- 确认已上传并处理完成以下数据：
  - 母牛基础信息
  - 公牛库数据
  - 系谱信息
  - 母牛指数计算结果

**1.2 分组预览**
- 进入"个体选配"模块
- 系统自动显示分组预览
- 勾选需要参与选配的组（如"后备牛第1周期+性控"）
- 可以选择部分组或全选

**1.3 冻精预览**
- 在冻精预览表中设置各公牛的可用库存
- 可以直接输入数量或从库存文件导入
- 库存设为0的公牛不参与选配

#### 2. 执行选配

**2.1 点击"执行个体选配"按钮**

系统自动执行以下步骤，显示实时进度：

| 步骤 | 进度 | 说明 |
|-----|-----|------|
| 1. 加载数据 | 10% | 读取母牛、公牛、系谱数据 |
| 2. 母牛分组 | 20% | 根据状态和周期自动分组 |
| 3. 生成推荐矩阵 | 40% | 计算所有母牛与公牛的配对得分 |
| 4. 执行选配分配 | 60% | 基于推荐矩阵和库存进行分配 |
| 5. 生成最终报告 | 80% | 整合分配结果和母牛信息 |
| 6. 保存报告 | 90% | 保存为Excel文件 |
| 7. 完成 | 100% | 选配完成 |

**2.2 等待完成**
- 选配时间根据母牛数量和公牛数量而定
- 一般情况：1000头母牛 × 50头公牛 ≈ 2-5分钟

#### 3. 查看结果

**3.1 选配报告**
- 选配完成后，自动弹出提示
- 报告保存在项目文件夹的 `选配结果/` 目录
- 文件名：`[牧场名称]_个体选配报告_YYYYMMDD.xlsx`

**3.2 打开报告**
- 可选择立即打开查看
- 或稍后从项目文件夹中找到

**3.3 报告内容**
- 包含所有参与选配的母牛
- 每头母牛的6个选配位（性控3选 + 常规3选）
- 按分组顺序排列
- 包含母牛基础信息和育种指数

### 与旧版本的区别

#### 旧版本（两步操作）
1. 第一步：点击"生成选配推荐" → 生成推荐矩阵（中间结果）
2. 第二步：点击"选配分配" → 基于推荐进行分配（最终结果）
3. 需要人工确认中间结果
4. 容易在两步之间出现数据不一致

#### 新版本（一键完成）
1. 点击"执行个体选配" → 自动完成全流程
2. 无需中间确认，一步到位
3. 确保数据一致性
4. 操作简化，用户体验更好

#### 优势总结
- ✅ 操作简化：从2步变为1步
- ✅ 避免出错：无中间步骤，减少错误机会
- ✅ 数据一致：确保推荐和分配使用相同数据
- ✅ 符合需求：直接生成符合要求的最终报告

---

## 业务逻辑详解

### 业务流程概述

个体选配系统分为两个主要阶段：
1. **推荐生成阶段**: 计算所有母牛与所有公牛的配对得分，生成配对矩阵
2. **选配分配阶段**: 基于配对矩阵和库存，为每头母牛分配具体的公牛

```
筛选在场母牛 → 识别特殊状态 → 周期分组 → 策略表分配 → 确定性控/非性控 → 生成推荐矩阵 → 按库存分配 → 生成选配报告
```

---

### 分组逻辑

#### 1. 分组流程

```
筛选在场母牛 → 识别特殊状态 → 周期分组 → 策略表分配 → 确定性控/非性控
```

#### 2. 分组维度

##### 2.1 基础筛选

**筛选条件:**
- `是否在场 = '是'`
- `sex = '母'`

只有符合这两个条件的母牛才参与选配。

##### 2.2 牛只类型

| 类型 | 识别条件 | 说明 |
|-----|----------|------|
| **后备牛** | `lac = 0` | 未产犊的青年母牛 |
| **成母牛** | `lac > 0` | 已产犊的成年母牛 |

##### 2.3 特殊状态（优先处理）

识别以下4种特殊状态，优先分组：

| 类型 | 识别条件 | 分组名称 | 配种策略 |
|------|----------|----------|---------|
| **后备牛已孕** | `lac=0 AND repro_status IN ('初检孕','复检孕')` | 后备牛已孕牛+非性控 | 仅常规冻精 |
| **后备牛难孕** | `lac=0 AND 日龄≥554天(18个月) AND 未孕` | 后备牛难孕牛+非性控 | 仅常规冻精 |
| **成母牛已孕** | `lac>0 AND repro_status IN ('初检孕','复检孕')` | 成母牛已孕牛+非性控 | 仅常规冻精 |
| **成母牛难孕** | `lac>0 AND DIM≥150天 AND 未孕` | 成母牛难孕牛+非性控 | 仅常规冻精 |

**说明:**
- 已孕牛和难孕牛统一使用常规冻精（不使用性控）
- 难孕标准可配置（默认：后备牛18个月、成母牛150天未孕）

##### 2.4 周期分组（普通牛）

**后备牛周期分组**（基于日龄）：

**参数:**
- 开配日龄：用户可设置，默认420天（约14个月）
- 选配周期：用户可设置，默认21天（发情周期）

**计算公式:**
```
第1周期：[开配日龄-21天, 开配日龄)
第2周期：[开配日龄-42天, 开配日龄-21天)
第3周期：[开配日龄-63天, 开配日龄-42天)
第4周期：[开配日龄-84天, 开配日龄-63天)
```

**示例:**（开配日龄=420天，周期=21天）
- 第1周期：399-420天（最接近开配日龄，优先配种）
- 第2周期：378-399天
- 第3周期：357-378天
- 第4周期：336-357天（最远离开配日龄）

**成母牛分组:**
- 所有非已孕、非难孕的成母牛统一标记为"成母牛未孕牛"
- 不按周期细分（因为成母牛已经开始产奶，按产后天数管理）

##### 2.5 策略表分配（A/B/C组）

**分配流程:**
1. 对每个周期组内的母牛按 `ranking`（母牛指数排名）升序排序
   - 数值越小排名越靠前（排名1是最好的牛）
2. 根据策略表比例分配到A/B/C组

**示例:**
- 策略表比例：A组30%、B组40%、C组30%
- 某周期有100头母牛
- 分配结果：
  - 前30头（排名1-30） → A组
  - 中间40头（排名31-70） → B组
  - 最后30头（排名71-100） → C组

**策略表配置:**
- 用户可自定义各组占比
- 各组配种方法列表可配置
- 常见配置：A组使用优质公牛，C组使用普通公牛

##### 2.6 性控/非性控判定

**配种方式分类:**
- **性控**: 普通性控、超级性控
- **非性控**: 常规冻精、肉牛冻精、胚胎

**判定逻辑:**
根据母牛 `services_time`（已配种次数）确定下次使用什么配种方式。

**策略表示例:**
```python
breeding_methods = ["普通性控", "普通性控", "常规冻精", "常规冻精"]
```

**判定规则:**
```python
# services_time 表示已经配种的次数（0表示未配过）

if services_time == 0 或 null:
    # 还没配过，下次是第1次配种
    使用 breeding_methods[0]  → "普通性控"

elif services_time == 1:
    # 已配1次，下次是第2次配种
    使用 breeding_methods[1]  → "普通性控"

elif services_time == 2:
    # 已配2次，下次是第3次配种
    使用 breeding_methods[2]  → "常规冻精"

else:
    # 已配3次或更多，下次使用最后一个方法
    使用 breeding_methods[len(breeding_methods)-1]  → "常规冻精"

# 代码实现
method_idx = min(services_time, len(breeding_methods) - 1)
method = breeding_methods[method_idx]
```

**说明:**
- 前2次配种使用性控精液（提高母犊出生率）
- 第3次及以后使用常规精液（提高受胎率）
- 策略表可根据牧场实际情况调整

##### 2.7 最终分组格式

**格式:**
```
{牛只类型}+{状态/周期}+{性控/非性控}
```

**示例:**
- 后备牛第1周期+性控
- 后备牛第1周期+非性控
- 后备牛第2周期+性控
- 后备牛第2周期+非性控
- 成母牛未孕牛+性控
- 成母牛未孕牛+非性控
- 后备牛难孕牛+非性控
- 成母牛难孕牛+非性控
- 后备牛已孕牛+非性控
- 成母牛已孕牛+非性控

---

### 分配逻辑

#### 1. 分配优先级顺序

选配按以下顺序依次处理各组：

```
1.  后备牛第1周期+性控
2.  后备牛第1周期+非性控
3.  后备牛第2周期+性控
4.  后备牛第2周期+非性控
5.  后备牛第3周期+性控
6.  后备牛第3周期+非性控
7.  后备牛第4周期+性控
8.  后备牛第4周期+非性控
9.  成母牛未孕牛+性控
10. 成母牛未孕牛+非性控
11. 后备牛难孕牛+非性控
12. 成母牛难孕牛+非性控
13. 后备牛已孕牛+非性控
14. 成母牛已孕牛+非性控
```

**优先级原则:**
- 后备牛优先于成母牛（遗传改良重点）
- 第1周期优先于后续周期（接近开配日龄）
- 性控组优先于非性控组（母犊价值高）
- 普通牛优先于难孕牛和已孕牛

#### 2. 分配策略

##### 2.1 分组与可分配冻精类型

**性控组**（如"后备牛第1周期+性控"）：
- 可分配：性控冻精（1选、2选、3选）
- 可分配：常规冻精（1选、2选、3选）
- 共6个选配位

**非性控组**（如"后备牛第1周期+非性控"）：
- 只分配：常规冻精（1选、2选、3选）
- 性控位留空
- 共3个选配位

##### 2.2 库存比例分配

**1选分配策略：严格按库存比例分配（含最小分配保证）**

**基本原理:**
```
例如：A公牛库存100，B公牛库存50，C公牛库存20
总库存：100 + 50 + 20 = 170
比例：A=58.8%，B=29.4%，C=11.8%

100头母牛需要分配1选：
- A公牛：100 × 58.8% ≈ 59头
- B公牛：100 × 29.4% ≈ 29头
- C公牛：100 × 11.8% ≈ 12头
```

**最小分配保证:**
当某公牛按比例计算分配为0时，确保至少分配1头。

```
例如：A:B:C = 1000:10:1，需要分配100头母牛

不保证时：
- A得 100 × (1000/1011) ≈ 99头
- B得 100 × (10/1011) ≈ 1头
- C得 100 × (1/1011) ≈ 0头  ← C公牛被忽略

保证时：
- C公牛先保证分配1头
- 剩余99头在A和B之间按比例分配
- A得 99 × (1000/1010) ≈ 98头
- B得 99 × (10/1010) ≈ 1头
- C得 1头  ← 确保小库存公牛也能使用
```

**优势:**
- 避免小库存公牛完全无法使用
- 帮助测试新引进公牛的配种效果
- 库存数据更真实反映牧场使用情况

**2选、3选分配策略：平均分配给库存>0的公牛**

```
例如：3头公牛都有库存，100头母牛需要分配2选

平均分配：
- A公牛：100 ÷ 3 ≈ 33头
- B公牛：100 ÷ 3 ≈ 33头
- C公牛：100 ÷ 3 ≈ 34头

说明：
- 2选和3选是备选方案
- 平均分配更公平
- 给每头公牛均等的备选机会
```

##### 2.3 约束条件

**约束1: 近交系数**
- 阈值：用户设定（默认3.125%，即1/32）
- 检查：预测后代近交系数 ≤ 阈值
- 超标处理：该公牛不可分配给该母牛

**约束2: 隐性基因**
- 控制：用户可选择是否控制
- 检查：母牛父亲和公牛是否都携带同一隐性基因
- 风险处理：纯合风险（25%发病概率）不可分配

**约束优先级:**
- 近交系数约束 > 隐性基因约束
- 如果所有公牛都不满足约束，该选位空缺

##### 2.4 未分配处理

**空缺原因记录:**
- "近交系数超标" - 所有公牛都导致高近交
- "隐性基因风险" - 所有公牛都有基因纯合风险
- "无可用公牛" - 库存耗尽或无公牛可选

**空缺显示:**
- 选配报告中该选位显示为空
- 备注栏标注未分配原因
- 建议牧场人工介入处理

#### 3. 注意事项

**关于库存扣减:**
- ✅ 系统只生成选配方案，**不实际扣减库存**
- ✅ 分配时基于当前库存比例计算
- ✅ 最终实际使用需要牧场在实践中记录

**关于小库存公牛:**
- ✅ 1选时有最小分配保证（至少1头）
- ✅ 帮助测试新引进公牛
- ✅ 避免库存长期积压

---

## 选配报告

### 报告文件

**文件名格式:**
```
[牧场名称]_个体选配报告_YYYYMMDD.xlsx
```

**保存位置:**
```
项目文件夹/选配结果/[牧场名称]_个体选配报告_YYYYMMDD.xlsx
```

### 报告表头结构

| 字段 | 来源 | 说明 |
|------|------|------|
| **母牛号** | cow_id | 母牛标识 |
| **分组** | 自动分组结果 | 分组名称（如"后备牛第1周期+性控"） |
| **1选性控** | 分配计算 | 性控公牛1选（非性控组为空） |
| **2选性控** | 分配计算 | 性控公牛2选（非性控组为空） |
| **3选性控** | 分配计算 | 性控公牛3选（非性控组为空） |
| **1选常规** | 分配计算 | 常规公牛1选 |
| **2选常规** | 分配计算 | 常规公牛2选 |
| **3选常规** | 分配计算 | 常规公牛3选 |
| **胎次** | lac | 泌乳次数 |
| **本胎次奶厅高峰产量** | peak_milk | 峰值产奶量（kg） |
| **305奶量** | milk_305 | 305天产奶量（kg） |
| **泌乳天数** | DIM | 产后天数 |
| **繁育状态** | repro_status | 繁殖状态（如"空怀"、"初检孕"） |
| **母牛指数得分** | 计算结果 | 育种指数（0-100分） |
| **品种** | breed | 品种信息（如"荷斯坦"） |
| **父亲** | sire | 父亲NAAB号 |
| **外祖父** | mgs | 母外祖父NAAB号 |
| **母亲** | dam | 母亲编号 |
| **外曾外祖父** | mmgs | 母外曾外祖父NAAB号 |
| **产犊日期** | calving_date | 最近产犊日期 |
| **出生日期** | birth_date | 出生日期 |
| **数据提取日期** | 系统生成 | 报告生成日期 |
| **月龄** | 计算 | (当前日期-出生日期)/30.5 |
| **配次** | services_time | 已配种次数 |

### 数据来源

1. **母牛基础信息**: 从 `牧场母牛信息_processed.xlsx` 获取
2. **指数得分**: 从 `母牛指数计算结果.xlsx` 获取
3. **分配结果**: 从分配算法计算获得

### 分组排序顺序

报告中的数据按以下顺序排序（与分配优先级一致）：

```
1.  后备牛第1周期+性控
2.  后备牛第1周期+非性控
3.  后备牛第2周期+性控
4.  后备牛第2周期+非性控
5.  后备牛第3周期+性控
6.  后备牛第3周期+非性控
7.  后备牛第4周期+性控
8.  后备牛第4周期+非性控
9.  成母牛未孕牛+性控
10. 成母牛未孕牛+非性控
11. 后备牛难孕牛+非性控
12. 成母牛难孕牛+非性控
13. 后备牛已孕牛+非性控
14. 成母牛已孕牛+非性控
```

---

## 技术实现

### 核心模块

#### 1. CompleteMatingExecutor
**完整的选配执行器**，整合了所有选配流程。

**职责:**
- 协调各个模块的执行
- 管理数据流转
- 生成最终报告
- 错误处理和进度反馈

**依赖模块:**
- `GroupManager` - 分组管理
- `MatrixRecommendationGenerator` - 推荐生成
- `CycleBasedMatcher` - 选配分配

#### 2. GroupManager
**母牛分组管理器**

**职责:**
- 识别母牛特殊状态
- 按周期分组
- 策略表分配
- 性控/非性控判定

**输出:**
```python
{
    "后备牛第1周期+性控": [cow1, cow2, ...],
    "后备牛第1周期+非性控": [cow3, cow4, ...],
    ...
}
```

#### 3. MatrixRecommendationGenerator
**推荐矩阵生成器**

**职责:**
- 计算母牛-公牛配对得分
- 生成配对矩阵
- 应用约束条件（近交、基因）

**输出:**
```python
{
    "cow1": {
        "bull1": score1,
        "bull2": score2,
        ...
    },
    "cow2": {
        ...
    }
}
```

#### 4. CycleBasedMatcher
**选配分配器**

**职责:**
- 按优先级顺序分配各组
- 根据库存比例分配1选
- 平均分配2选和3选
- 处理未分配情况

**输出:**
```python
DataFrame([
    {"cow_id": "C001", "group": "后备牛第1周期+性控", "1选性控": "001HO12345", ...},
    {"cow_id": "C002", "group": "后备牛第1周期+性控", "1选性控": "001HO23456", ...},
    ...
])
```

### 核心流程

```python
def execute(self, bull_inventory, ...):
    """执行完整选配流程"""

    # 1. 加载数据（10%）
    self.progress_callback(10, "加载数据...")
    recommendation_generator.load_data()

    # 2. 执行分组（20%）
    self.progress_callback(20, "母牛分组...")
    grouped_cows = group_manager.group_cows(
        cows_df=cows_df,
        strategy_table=strategy_table,
        heifer_start_age=heifer_start_age,
        cycle_days=cycle_days
    )

    # 3. 生成推荐矩阵（40%）
    self.progress_callback(40, "生成推荐矩阵...")
    matrices = recommendation_generator.generate_matrices(
        cows_df=cows_df,
        bulls_df=bulls_df,
        pedigree_data=pedigree_data,
        inbreeding_threshold=inbreeding_threshold,
        control_recessive=control_recessive
    )

    # 4. 执行分配（60%）
    self.progress_callback(60, "执行选配分配...")
    allocation_df = matcher.perform_allocation(
        grouped_cows=grouped_cows,
        matrices=matrices,
        bull_inventory=bull_inventory,
        priority_order=priority_order
    )

    # 5. 生成最终报告（80%）
    self.progress_callback(80, "生成最终报告...")
    final_report = self._generate_final_report(
        allocation_df=allocation_df,
        cows_df=cows_df,
        cow_indices=cow_indices
    )

    # 6. 保存报告（90%）
    self.progress_callback(90, "保存报告...")
    report_path = self._save_report(final_report)

    # 7. 完成（100%）
    self.progress_callback(100, "选配完成！")

    return report_path
```

### 关键算法

#### 库存比例分配算法

```python
def allocate_by_inventory(cows, bulls, inventory):
    """按库存比例分配1选"""

    # 1. 计算总库存和比例
    total_inventory = sum(inventory.values())
    ratios = {bull: count / total_inventory for bull, count in inventory.items()}

    # 2. 计算初步分配数量
    allocation_counts = {}
    for bull, ratio in ratios.items():
        allocation_counts[bull] = int(len(cows) * ratio)

    # 3. 最小分配保证
    for bull in bulls:
        if inventory[bull] > 0 and allocation_counts[bull] == 0:
            allocation_counts[bull] = 1  # 至少分配1头

    # 4. 调整总数（确保总数等于母牛数）
    diff = len(cows) - sum(allocation_counts.values())
    if diff > 0:
        # 不足，分配给库存最多的公牛
        max_bull = max(inventory, key=inventory.get)
        allocation_counts[max_bull] += diff
    elif diff < 0:
        # 超出，从库存最多的公牛减少
        max_bull = max(inventory, key=inventory.get)
        allocation_counts[max_bull] += diff  # diff是负数

    # 5. 执行分配
    assignments = {}
    cow_idx = 0
    for bull, count in allocation_counts.items():
        for _ in range(count):
            if cow_idx < len(cows):
                assignments[cows[cow_idx]] = bull
                cow_idx += 1

    return assignments
```

---

## 系统参数配置

### 用户可配置参数

| 参数 | 默认值 | 说明 | 配置位置 |
|-----|--------|------|---------|
| **后备牛开配日龄** | 420天 | 后备牛开始配种的目标日龄 | 选配参数设置 |
| **选配周期** | 21天 | 发情周期长度 | 选配参数设置 |
| **近交系数阈值** | 3.125% | 允许的最大近交系数（1/32） | 选配约束设置 |
| **是否控制隐性基因** | 是 | 是否避免隐性基因纯合风险 | 选配约束设置 |
| **难孕后备牛日龄** | 554天 | 后备牛超过此日龄未孕视为难孕（18个月） | 分组参数设置 |
| **难孕成母牛DIM** | 150天 | 成母牛产后超过此天数未孕视为难孕 | 分组参数设置 |

### 策略表配置

**策略表结构:**
```python
{
    "group_name": "后备牛A",
    "percentage": 30,  # 占比30%
    "breeding_methods": [
        "普通性控",    # 第1次配种
        "普通性控",    # 第2次配种
        "常规冻精",    # 第3次配种
        "常规冻精"     # 第4次及以后配种
    ]
}
```

**常见配置示例:**

**配置1: 三组策略（A/B/C = 30%/40%/30%）**
```python
[
    {
        "group_name": "后备牛A",
        "percentage": 30,
        "breeding_methods": ["普通性控", "普通性控", "常规冻精", "常规冻精"]
    },
    {
        "group_name": "后备牛B",
        "percentage": 40,
        "breeding_methods": ["普通性控", "常规冻精", "常规冻精", "常规冻精"]
    },
    {
        "group_name": "后备牛C",
        "percentage": 30,
        "breeding_methods": ["常规冻精", "常规冻精", "常规冻精", "常规冻精"]
    }
]
```

**配置2: 两组策略（A/B = 50%/50%）**
```python
[
    {
        "group_name": "后备牛A",
        "percentage": 50,
        "breeding_methods": ["普通性控", "普通性控", "常规冻精", "常规冻精"]
    },
    {
        "group_name": "后备牛B",
        "percentage": 50,
        "breeding_methods": ["常规冻精", "常规冻精", "常规冻精", "常规冻精"]
    }
]
```

### 配置文件位置

**配置文件:**
```
项目文件夹/config/mating_config.json
```

**配置格式:**
```json
{
    "heifer_start_age_days": 420,
    "cycle_days": 21,
    "inbreeding_threshold": 3.125,
    "control_recessive_genes": true,
    "difficult_heifer_age_days": 554,
    "difficult_cow_dim_days": 150,
    "strategy_tables": [
        {
            "group_name": "后备牛A",
            "percentage": 30,
            "breeding_methods": ["普通性控", "普通性控", "常规冻精", "常规冻精"]
        },
        ...
    ]
}
```

---

## 版本更新记录

### v2.0 - 2025-11-02 (合并版)

**主要变更:**
- ✅ 合并 `个体选配业务逻辑说明.md` 和 `一键选配功能说明.md` 为一个综合指南
- ✅ 保留所有业务逻辑细节和技术实现说明
- ✅ 完善使用指南，增加操作流程图示
- ✅ 补充系统参数配置章节

### v1.2 - 2024-01-30

**主要变更:**
- ✅ 增加小库存公牛最小分配保证
  - 1选分配时，库存>0的公牛至少分配1头
  - 避免小库存公牛无法使用
  - 帮助测试新引进公牛效果

**优化:**
- 改进库存比例分配算法
- 增加分配结果验证

### v1.1 - 2024-01-30

**主要变更:**
- ✅ 修正配种方式判断逻辑
  - 明确 `services_time` 表示已配种次数（非下次配种次数）
  - 0或null表示未配过，下次是第1次
  - 1表示已配1次，下次是第2次
  - 依此类推

**优化:**
- 更新文档说明，澄清配种次数概念
- 增加示例和公式说明

### v1.0 - 2024-01-30 (一键选配功能)

**主要变更:**
- ✅ 实现"一键执行个体选配"功能
  - 合并推荐生成和选配分配为一步
  - 简化操作流程
  - 提升用户体验

**核心功能:**
- ✅ CompleteMatingExecutor 总执行器
- ✅ 实时进度反馈（7个步骤）
- ✅ 自动生成最终选配报告
- ✅ 数据一致性保证

### v0.9 - 2024-01-15 (基础版本)

**初始功能:**
- ✅ 母牛自动分组（周期+状态+性控）
- ✅ 配对矩阵生成
- ✅ 库存比例分配
- ✅ 近交系数和隐性基因约束
- ✅ 选配报告生成

---

## 常见问题

### Q1: 为什么有些母牛的某些选位是空的？

**A:** 可能原因：
1. **近交系数超标**: 所有可选公牛都会导致后代近交系数超过阈值
2. **隐性基因风险**: 所有可选公牛都与母牛父亲携带相同隐性基因
3. **库存耗尽**: 该类型冻精库存已用完（在前面的组中用完）

**建议:**
- 检查近交系数阈值设置是否过于严格
- 考虑适当放宽约束条件
- 增加公牛库存或引进新公牛

### Q2: 为什么1选分配不完全按库存比例？

**A:** 最小分配保证机制：
- 库存>0的公牛至少分配1头（1选时）
- 避免小库存公牛完全无法使用
- 帮助测试新引进公牛的配种效果

**示例:** 库存1000:10:1，100头牛
- 不保证：99头、1头、0头
- 保证：98头、1头、1头 ← C公牛确保有1头

### Q3: 如何调整后备牛周期分组？

**A:** 修改两个参数：
1. **开配日龄**: 默认420天，可根据牧场实际情况调整（如390-450天）
2. **选配周期**: 默认21天，通常保持不变（发情周期）

**影响:**
- 开配日龄越大，第1周期母牛越成熟
- 周期天数越长，每个周期包含的母牛越多

### Q4: 策略表如何配置？

**A:** 策略表包含3个要素：
1. **分组名称**: 如"后备牛A"、"成母牛B"
2. **组占比**: 各组百分比（总和100%）
3. **配种方法列表**: 按配种次数顺序（第1次、第2次...）

**配置建议:**
- A组（优质牛）：多用性控，使用优质公牛
- B组（中等牛）：适量性控，使用中等公牛
- C组（普通牛）：少用性控，使用普通公牛

### Q5: 选配报告如何与生产系统对接？

**A:** 报告对接方式：
1. **手动导入**: 将Excel报告导入牧场管理系统
2. **API推送**: 使用系统API接口自动推送（需开发）
3. **数据库集成**: 直接写入牧场数据库（需配置）

**当前支持**: 生成Excel报告，手动导入

---

## 总结

个体选配是系统的核心功能，通过智能算法实现：
- ✅ 自动分组（14种组合）
- ✅ 智能推荐（配对矩阵）
- ✅ 优化分配（库存比例）
- ✅ 风险控制（近交+基因）
- ✅ 一键完成（操作简化）

**功能完成度: 100%**

**开发时间线:**
- 2024-01: v0.9 基础版本
- 2024-01: v1.0 一键选配功能
- 2024-01: v1.1 修正配种次数逻辑
- 2024-01: v1.2 小库存公牛保证
- 2025-11: v2.0 文档整合

**关键优势:**
- 操作简化：一键完成
- 智能分组：14种组合
- 风险控制：近交+基因
- 库存优化：比例分配
- 灵活配置：参数可调

---

**文档维护:** 本文档是 `个体选配业务逻辑说明.md` 和 `一键选配功能说明.md` 的合并版本，保留了所有重要内容。
**最后更新:** 2025-11-02
