# 缺失公牛自动上传功能完整指南

**项目名称:** 伊利奶牛选配系统 - 缺失公牛上传功能
**文档版本:** v2.0 (合并版)
**更新时间:** 2025-11-02
**完成状态:** ✅ 已完成
**适用版本:** v1.2.0.4+

---

## 📋 目录

1. [功能概述](#功能概述)
2. [使用指南](#使用指南)
3. [技术实现](#技术实现)
4. [测试指南](#测试指南)
5. [故障排查](#故障排查)
6. [API详情](#api详情)
7. [常见问题](#常见问题)
8. [版本历史](#版本历史)

---

## 功能概述

### 核心功能

当您上传备选公牛数据或进行育种计算时，系统会**自动检测本地数据库中不存在的公牛**，并将其上传到云端的缺失公牛记录表（miss_bull），帮助管理员追踪和补充缺失的公牛遗传数据。

### 功能特点

| 特点 | 说明 |
|-----|------|
| ✅ **自动检测** | 无需手动操作，上传即检测 |
| ✅ **智能保留** | 格式异常的NAAB号也会保留并上传 |
| ✅ **详细提醒** | 多处提示确保用户了解异常情况 |
| ✅ **不阻断流程** | 即使上传失败也不影响主要操作 |
| ✅ **多场景支持** | 支持备选公牛上传、指数排序、近交分析等多个场景 |
| ✅ **无需认证** | API端点无需JWT认证，简化流程 |

### 业务价值

- **数据补全**: 及时发现和记录缺失的公牛数据
- **追踪需求**: 管理员可以了解哪些公牛需要添加到数据库
- **用户提醒**: 用户知晓哪些公牛缺少遗传评估数据
- **数据质量**: 帮助提升系统数据完整性

---

## 使用指南

### 操作流程

```
步骤1: 准备备选公牛Excel文件
  ↓
步骤2: 在软件中选择"数据上传" → "备选公牛数据"
  ↓
步骤3: 选择Excel文件并上传
  ↓
【自动执行】数据标准化处理
  ├─ 格式化NAAB号
  └─ 如有格式异常 → 🔔 提醒1: 格式异常警告
  ↓
【自动执行】检查本地数据库
  ├─ 查询每个公牛是否存在
  └─ 收集缺失公牛列表
  ↓
【自动执行】上传缺失公牛到云端
  ├─ 成功 → 🔔 提醒2: 上传成功通知
  └─ 失败 → 🔔 提醒3: 上传失败警告
  ↓
步骤4: 完成！可以继续进行选配计算
```

### 用户提醒机制

#### 提醒1: NAAB号格式异常警告

**触发时机:** 上传备选公牛时，发现格式不符合标准的冻精号

**提示内容:**
```
【窗口标题】公牛NAAB号格式异常

【主要信息】
发现 X 个格式异常的冻精号

【详细说明】
这些冻精号不符合标准NAAB格式，已保留原值并将上传到云端缺失公牛记录。

建议您检查原始数据是否正确。

【详细信息】（点击"详细信息"查看）
• NAAB号中未找到品种字母: 13113261
• NAAB公牛号的站号超过3位: 123456HO12345
... 更多错误
```

**标准NAAB格式说明:**
- 正确格式: `站号(1-3位) + 品种字母(1-2位) + 编号(1-5位)`
- 示例: `007HO16284` (站号007 + 品种HO + 编号16284)
- 品种代码: HO(荷斯坦)、JE(娟姗)、BS(瑞士褐牛)等

**建议操作:**
1. 检查原始Excel文件中的bull_id列
2. 核对是否有输入错误（如缺少品种字母、站号过长等）
3. 如果确认数据正确，可点击"确定"继续

---

#### 提醒2: 缺失公牛上传成功通知

**触发时机:** 成功将缺失公牛上传到云端后

**提示内容:**
```
【窗口标题】缺失公牛已上传

【主要信息】
在本地数据库中未找到 X 个公牛

【详细说明】
这些公牛的信息已自动上传到云端缺失公牛记录表。

建议您稍后更新本地数据库，或联系管理员添加这些公牛的完整信息。

【详细信息】（点击"详细信息"查看）
缺失公牛列表：

• 007HO16284
• 007HO16385
• 151HO04449
• 13113261
... 更多公牛
```

**建议操作:**
1. 记录缺失公牛的NAAB号
2. 通过"数据管理" → "更新本地数据库"功能更新数据库
3. 或联系管理员，请求添加这些公牛的完整遗传评估数据

---

#### 提醒3: 缺失公牛上传失败警告

**触发时机:** 检测到缺失公牛，但上传到云端失败

**提示内容:**
```
【窗口标题】缺失公牛上传失败

【主要信息】
发现 X 个缺失公牛，但上传到云端失败

【详细说明】
请检查网络连接后重试，或联系技术支持。

缺失的公牛信息可能影响后续的选配计算结果。
```

**可能原因:**
- 网络连接问题
- 云端API服务暂时不可用
- 请求超时

**建议操作:**
1. 检查网络连接是否正常
2. 稍后重新上传备选公牛数据
3. 如问题持续，联系技术支持查看API服务状态

### 日志输出示例

控制台会输出详细的处理日志，便于追踪：

```
[DEBUG-BULL-PREPROCESS] 开始处理 37 条备选公牛记录
[DEBUG-BULL-PREPROCESS] 保留格式异常的NAAB号: 13113261
[DEBUG-BULL-PREPROCESS] ⚠️ 发现 1 个格式异常的NAAB号，将保留原值
[DEBUG-BULL-PREPROCESS] 这些公牛在查询时会被识别为缺失公牛并上传到云端
[DEBUG-BULL-PREPROCESS]   - NAAB号中未找到品种字母: 13113261
[DEBUG-BULL-PREPROCESS] 处理完成，保留所有 37 条记录

[检查点-上传] 开始检查本地数据库中的缺失公牛...
[检查点-上传] 本地数据库路径: /Users/xxx/.genetic_improve/local_bull_library.db
[检查点-上传] 需要检查 37 个公牛
[检查点-上传] 缺失公牛: 007HO16284
[检查点-上传] 缺失公牛: 007HO16385
[检查点-上传] 缺失公牛: 151HO04449
... (更多缺失公牛)
[检查点-上传] 共发现 30 个缺失公牛
[检查点-上传] 准备上传缺失公牛到云端...
[检查点-上传] 用户名: cs
[检查点-上传] 调用API上传 30 条记录...
成功上传 30 条缺失公牛记录到云端
[检查点-上传] ✅ 成功上传 30 个缺失公牛到云端
[检查点-上传] 缺失公牛检查完成
```

---

## 技术实现

### 触发场景

缺失公牛上传功能在以下3个场景中自动触发：

#### 场景1: 指数排序计算

**触发位置:** `core/breeding_calc/index_calculation.py:335-338`

**触发条件:**
- 用户上传备选公牛数据
- 选择性状权重进行指数排序
- 查询公牛性状时，公牛ID在bull_library数据库中不存在

**调用链:**
```
index_calculation.py:338
  → self.process_missing_bulls() (继承自base_calculation.py)
    → api_client.upload_missing_bulls()
      → POST https://api.genepop.com/api/data/missing_bulls
```

**日志标识:** `[检查点-指数]` → `[检查点]`

---

#### 场景2: 近交系数分析

**触发位置:** `core/inbreeding/inbreeding_page.py:3166`

**触发条件:**
- 进行隐性基因筛查分析
- 查询公牛基因信息时，公牛ID在云端PolarDB中不存在

**调用链:**
```
inbreeding_page.py:3166
  → self.process_missing_bulls()
    → upload_missing_bulls_to_cloud() (来自data_client.py)
      → DataAPIClient.upload_missing_bulls()
        → POST https://api.genepop.com/api/data/missing_bulls
```

**日志标识:** `[检查点-近交]` → `[检查点-DataClient]`

---

#### 场景3: 其他育种计算

**触发位置:** 任何继承自 `BaseCowCalculation` 的计算类

**调用链:**
```
任意计算类
  → self.process_missing_bulls() (继承自base_calculation.py)
    → api_client.upload_missing_bulls()
      → POST https://api.genepop.com/api/data/missing_bulls
```

**说明:** 所有育种计算类都继承自 `BaseCowCalculation`，共享缺失公牛处理逻辑。

### 核心模块

#### 1. BaseCowCalculation.process_missing_bulls()
**位置:** `core/breeding_calc/base_calculation.py:105-167`

**职责:**
- 检测缺失公牛
- 收集缺失公牛信息
- 调用API上传

**关键代码:**
```python
def process_missing_bulls(self, missing_bulls, source="bull_index"):
    """处理缺失公牛上传"""
    print("========== [检查点] 缺失公牛上传流程开始 ==========")
    print(f"[检查点] 检测到 {len(missing_bulls)} 个缺失公牛")
    print(f"[检查点] 数据来源: {source}")

    # 准备上传数据
    upload_data = []
    for bull_id in missing_bulls:
        upload_data.append({
            "bull": bull_id,
            "source": source,
            "time": datetime.now().isoformat(),
            "user": self.username
        })

    # 调用API上传
    from api.api_client import APIClient
    client = APIClient()
    success = client.upload_missing_bulls(upload_data)

    if success:
        print(f"[检查点] ✅ 上传成功！已上传 {len(missing_bulls)} 条缺失公牛记录")
    else:
        print(f"[检查点] ❌ 上传失败")

    print("========== [检查点] 缺失公牛上传流程结束 ==========")
    return success
```

#### 2. APIClient.upload_missing_bulls()
**位置:** `api/api_client.py:356-373`

**职责:**
- 发送HTTP POST请求到API端点
- 处理响应和错误

**关键修复（v1.2.0.4）:**
```python
def upload_missing_bulls(self, bulls_data):
    """上传缺失公牛数据（无需认证）"""
    # 重要：此API无需认证，直接请求即可
    data = {"bulls": bulls_data}
    success, response = self._make_request('POST', '/api/data/missing_bulls', data)

    if success:
        logger.info(f"成功上传 {len(bulls_data)} 条缺失公牛记录到云端")
        return True
    else:
        logger.error("上传缺失公牛数据失败")
        return False
```

**修复说明:** 移除了错误的JWT token验证要求（v1.2.0.3及之前版本有此问题）。

#### 3. DataAPIClient.upload_missing_bulls()
**位置:** `api/data_client.py:299-326`

**职责:**
- 近交分析专用的上传接口
- 与APIClient功能相同，但日志标识不同

**使用场景:** 近交系数分析和隐性基因筛查

---

## 测试指南

### 测试1: 指数排序触发上传

**步骤:**
1. 准备一个备选公牛Excel文件，包含本地bull_library数据库中**不存在**的NAAB编号
2. 在软件中上传该备选公牛文件
3. 进入"育种计算" → "指数排序"
4. 选择权重方案，点击"开始计算"

**预期日志输出:**
```
[检查点-指数] 在指数排序中发现 X 个缺失公牛
[检查点-指数] 调用 process_missing_bulls 进行上传...

========== [检查点] 缺失公牛上传流程开始 ==========
[检查点] 检测到 X 个缺失公牛
[检查点] 数据来源: bull_index
[检查点] 用户名: xxx
[检查点] 缺失公牛列表: ['NAAB001', 'NAAB002']
[检查点] 已准备 X 条数据记录
[检查点] 正在导入 api_client...
[检查点] API客户端已初始化，base_url: https://api.genepop.com
[检查点] 正在调用 upload_missing_bulls...
[检查点] ✅ 上传成功！已上传 X 条缺失公牛记录
========== [检查点] 缺失公牛上传流程结束 ==========
```

**数据库验证:**
```sql
-- 连接PolarDB
mysql -h defectgene-new.mysql.polardb.rds.aliyuncs.com -u doadmin -p

USE defaultdb;
SELECT * FROM miss_bull ORDER BY time DESC LIMIT 10;
```

---

### 测试2: 近交分析触发上传

**步骤:**
1. 准备配种记录，包含云端PolarDB基因数据库中**不存在**的公牛NAAB编号
2. 在软件中上传该配种记录
3. 进入"隐性基因筛查" → "分析已配公牛对"
4. 点击"开始分析"

**预期日志输出:**
```
========== [检查点-近交] 缺失公牛上传流程开始 ==========
[检查点-近交] 检测到 X 个缺失公牛
[检查点-近交] 分析类型: mated
[检查点-近交] 缺失的公牛号: ['NAAB003', 'NAAB004']
[检查点-近交] 用户名: xxx
[检查点-近交] USE_API 标志: True
[检查点-近交] 正在通过 data_client 上传...
[检查点-近交] 已准备 X 条数据记录

[检查点-DataClient] upload_missing_bulls_to_cloud 被调用
[检查点-DataClient] 接收到 X 条记录
[检查点-DataClient] DataAPIClient base_url: https://api.genepop.com
[检查点-DataClient.upload] 准备向 https://api.genepop.com/api/data/missing_bulls 发送POST请求
[检查点-DataClient.upload] 请求数据: X 条记录
[检查点-DataClient.upload] HTTP状态码: 200
[检查点-DataClient.upload] 响应数据: {'success': True, ...}
[检查点-DataClient] ✅ 成功上传X条缺失公牛记录

[检查点-近交] ✅ 上传成功！已上传 X 个缺失公牛记录
========== [检查点-近交] 缺失公牛上传流程结束 ==========
```

---

### 测试3: 手动API测试（无需软件）

**直接调用API:**
```bash
curl -X POST 'https://api.genepop.com/api/data/missing_bulls' \
  -H 'Content-Type: application/json' \
  -d '{
    "bulls": [{
      "bull": "TEST_NAAB_999",
      "source": "manual_test",
      "time": "2025-01-07T15:30:00",
      "user": "test_user"
    }]
  }'
```

**预期响应:**
```json
{
  "success": true,
  "message": "成功上传1条缺失公牛记录",
  "data": {
    "uploaded_count": 1
  },
  "timestamp": 1704629400
}
```

### 测试成功标准

✅ **指数排序测试通过:**
- 日志显示完整检查点流程
- 返回"上传成功"消息
- PolarDB中能查询到新记录

✅ **近交分析测试通过:**
- 日志显示完整检查点流程
- USE_API标志为True
- DataAPIClient成功调用
- PolarDB中能查询到新记录

✅ **无认证错误:**
- 不再显示"未登录"或"令牌无效"
- 日志中无token相关错误

✅ **网络正常:**
- HTTP状态码200
- 响应数据包含success:true

---

## 故障排查

### 问题1: 仍然显示"未登录"错误

**现象:** 日志显示"未登录或令牌无效，无法上传缺失公牛数据"

**可能原因:** 使用了旧版本代码（v1.2.0.3及之前）

**解决方法:**
1. 确认 `api/api_client.py` 已更新到 v1.2.0.4+（检查356-373行）
2. 重启应用程序
3. 检查是否使用了缓存的.pyc文件
   ```bash
   # 清理缓存
   find . -name "*.pyc" -delete
   find . -name "__pycache__" -delete
   ```

---

### 问题2: USE_API 为 False

**现象:** 日志显示 `[检查点-近交] USE_API 标志: False`

**原因:** `api/data_client.py` 导入失败

**解决方法:**
1. 检查文件是否存在: `api/data_client.py`
2. 检查Python路径配置
3. 查看应用启动日志中的ImportError
   ```python
   import sys
   print(sys.path)
   ```
4. 尝试手动导入验证:
   ```python
   from api.data_client import DataAPIClient
   ```

---

### 问题3: 网络连接失败

**现象:** 日志显示 `ConnectionError` 或 `Timeout`

**解决方法:**
1. 测试网络连接:
   ```bash
   ping api.genepop.com
   ```
2. 检查防火墙规则
3. 检查SSL证书:
   ```bash
   curl -I https://api.genepop.com/api/health
   ```
4. 查看 `verify_ssl` 配置（当前为False，用于测试环境）

---

### 问题4: 数据格式错误

**现象:** 响应数据: `{'success': False, 'message': '数据格式错误'}`

**原因:** 时间字段格式不正确

**解决方法:**
- 确保时间字段为ISO格式字符串: `"2025-01-07T15:30:00"`
- 不要使用pandas的Timestamp对象
- 使用 `datetime.now().isoformat()` 生成时间字符串

**代码示例:**
```python
# ✅ 正确
"time": datetime.now().isoformat()  # "2025-01-07T15:30:00"

# ❌ 错误
"time": pd.Timestamp.now()  # Timestamp对象
"time": "2025-01-07 15:30:00"  # 非ISO格式
```

---

### 问题5: 大量格式异常的NAAB号

**现象:** 超过50%的NAAB号格式异常

**可能原因:**
1. 原始数据源有问题
2. 导入时列映射错误
3. 使用了非标准的公牛编号系统

**解决方法:**
1. 检查原始Excel文件的bull_id列
2. 确认列映射是否正确
3. 如果使用国产公牛或非NAAB编号，与管理员协商添加支持
4. 暂时手动修正数据后重新上传

---

## API详情

### 端点信息

**端点:** `POST /api/data/missing_bulls`

**完整URL:** `https://api.genepop.com/api/data/missing_bulls`

**认证:** ✅ 无需认证（公开端点）

**Content-Type:** `application/json`

### 请求格式

```json
{
  "bulls": [
    {
      "bull": "NAAB编号",
      "source": "数据来源标识",
      "time": "ISO格式时间",
      "user": "用户名"
    },
    {
      "bull": "007HO16284",
      "source": "bull_index",
      "time": "2025-01-07T15:30:00",
      "user": "张三"
    }
  ]
}
```

**字段说明:**

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| `bulls` | Array | ✅ | 缺失公牛列表 |
| `bulls[].bull` | String | ✅ | 公牛NAAB编号 |
| `bulls[].source` | String | ✅ | 数据来源（如`bull_index`, `mated`, `candidate`） |
| `bulls[].time` | String | ✅ | 上传时间（ISO 8601格式） |
| `bulls[].user` | String | ✅ | 用户名 |

### 响应格式

**成功响应:**
```json
{
  "success": true,
  "message": "成功上传N条缺失公牛记录",
  "data": {
    "uploaded_count": N
  },
  "timestamp": 1704629400
}
```

**失败响应:**
```json
{
  "success": false,
  "message": "错误描述",
  "error": "详细错误信息",
  "timestamp": 1704629400
}
```

### 服务器配置

| 配置项 | 值 |
|-------|---|
| **域名** | https://api.genepop.com |
| **端口** | 443 (HTTPS) |
| **反向代理** | Nginx → 内部端口8082 |
| **数据库** | PolarDB MySQL |
| **表名** | `miss_bull` |
| **超时设置** | 30秒 |

### 数据库表结构

```sql
CREATE TABLE miss_bull (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '自增主键',
  bull VARCHAR(50) NOT NULL COMMENT '公牛NAAB编号',
  source VARCHAR(100) COMMENT '数据来源',
  time DATETIME COMMENT '上传时间',
  user VARCHAR(50) COMMENT '用户名',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '记录创建时间',
  INDEX idx_bull (bull),
  INDEX idx_time (time),
  INDEX idx_user (user)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='缺失公牛记录表';
```

**查询示例:**
```sql
-- 查看今天上传的缺失公牛
SELECT bull, source, time, user
FROM miss_bull
WHERE DATE(time) = CURDATE()
ORDER BY time DESC;

-- 统计某个用户上传的缺失公牛数量
SELECT COUNT(*) as total
FROM miss_bull
WHERE user = 'cs'
  AND source = 'bull_upload';

-- 查找特定公牛的上传记录
SELECT * FROM miss_bull
WHERE bull = '007HO16284'
ORDER BY time DESC;

-- 按来源统计缺失公牛
SELECT source, COUNT(*) as count
FROM miss_bull
GROUP BY source
ORDER BY count DESC;
```

---

## 常见问题

### Q1: 为什么会有格式异常的NAAB号？

**A:** 可能原因：
1. **原始数据录入错误**: 遗漏品种字母（如"00716284"应为"007HO16284"）
2. **非标准格式的公牛编号**: 国产公牛或其他国家的编号系统
3. **Excel复制粘贴问题**: 格式丢失或字符编码问题
4. **历史数据**: 旧的编号系统与现行NAAB标准不一致

**判断方法:**
- 标准格式: `站号(1-3位) + 品种字母(1-2位) + 编号(1-5位)`
- 常见品种: HO(荷斯坦), JE(娟姗), BS(瑞士褐牛), GU(更赛), AY(爱尔夏)

---

### Q2: 格式异常的NAAB号会影响后续计算吗？

**A:**
- ✅ **会保留**: 异常数据会保留在项目文件中
- ✅ **会上传**: 会标记为缺失公牛并上传到云端
- ⚠️ **影响计算**: 在性状评估和选配计算中，这些公牛的遗传数据会显示为缺失，影响该公牛的评分和排名
- ⚠️ **无法匹配**: 无法与本地bull_library数据库中的公牛匹配，无法获取育种值

**影响程度:**
- 指数排序: 该公牛排名靠后（因为缺少育种值）
- 选配推荐: 无法精确计算后代育种值
- 近交分析: 可能无法计算近交系数

---

### Q3: 如何解决缺失公牛的问题？

**A:** 两种方式：

**方式1: 更新本地数据库**
1. 进入"数据管理" → "更新本地数据库"
2. 系统从云端同步最新的公牛库数据
3. 如果云端已有该公牛数据，会自动下载到本地

**方式2: 联系管理员添加数据**
1. 提供缺失公牛的NAAB号列表
2. 管理员从CDCB等官方渠道获取遗传评估数据
3. 管理员将数据添加到云端bull_library表
4. 用户更新本地数据库即可获取

**最佳实践:**
- 定期更新本地数据库（每月1次）
- 使用最新的公牛数据进行选配
- 遇到新公牛及时反馈给管理员

---

### Q4: 上传失败怎么办？

**A:**

**步骤1: 检查网络连接**
```bash
# 测试域名解析
ping api.genepop.com

# 测试HTTPS连接
curl -I https://api.genepop.com/api/health
```

**步骤2: 查看详细日志**
- 检查控制台输出
- 查找错误信息（ConnectionError, Timeout, HTTP 4xx/5xx）

**步骤3: 重试**
- 稍后重新上传备选公牛数据
- 系统会再次检测并上传缺失公牛

**步骤4: 联系技术支持**
如果问题持续，提供以下信息：
1. 完整的日志输出
2. 网络环境描述（公司内网/家庭网络/移动网络）
3. 错误发生时间
4. 系统版本号

---

### Q5: 能否批量导入缺失公牛的完整数据？

**A:**
- ❌ **当前不支持**: 缺失公牛功能只记录NAAB编号，不包含遗传评估数据
- ✅ **完整数据来源**: 需要从CDCB、NAAB等官方渠道获取
- ✅ **管理员操作**: 管理员可以通过后台批量导入到bull_library表

**数据获取渠道:**
1. **CDCB**: Council on Dairy Cattle Breeding (美国奶牛育种委员会)
2. **NAAB**: National Association of Animal Breeders (美国动物育种协会)
3. **DHI**: Dairy Herd Improvement (奶牛生产改进协会)

---

### Q6: 缺失公牛记录会定期清理吗？

**A:**
- ❌ **不会自动清理**: miss_bull表会永久保留所有记录
- ✅ **去重处理**: 系统会自动去重，同一公牛多次上传只保留最新记录
- ✅ **数据分析**: 管理员可以通过缺失公牛记录分析哪些公牛需要优先添加

**管理员查询示例:**
```sql
-- 查找被多次上传的缺失公牛（说明需求高）
SELECT bull, COUNT(*) as upload_count
FROM miss_bull
GROUP BY bull
HAVING upload_count > 5
ORDER BY upload_count DESC;

-- 查找最近30天最常见的缺失公牛
SELECT bull, COUNT(*) as count
FROM miss_bull
WHERE time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY bull
ORDER BY count DESC
LIMIT 20;
```

---

## 版本历史

### v2.0 - 2025-11-02 (合并版)

**主要变更:**
- ✅ 合并 `缺失公牛上传功能测试指南.md` 和 `缺失公牛上传功能使用说明.md`
- ✅ 保留所有技术细节和用户说明
- ✅ 完善API详情和数据库结构
- ✅ 增加更多常见问题解答

---

### v1.2.0.4 - 2025-01-07

**主要变更:**
- ✅ **修复认证问题**: 移除upload_missing_bulls()的JWT token验证要求
- ✅ **添加详细检查点**: 在所有触发场景添加详细日志
- ✅ **时间格式修复**: 统一使用ISO 8601格式

**修复的问题:**
- ❌ **问题**: 缺失公牛未成功上传到PolarDB的miss_bull表
- ✅ **根本原因**: API客户端错误地要求JWT认证，但服务器端API无需认证
- ✅ **解决方案**: 移除token验证，直接调用API

**修复位置:**
- `api/api_client.py:356-373` - 移除token验证
- `core/breeding_calc/base_calculation.py:105-167` - 添加检查点
- `core/inbreeding/inbreeding_page.py:2456-2527` - 添加检查点
- `core/breeding_calc/index_calculation.py:335-340` - 添加检查点
- `api/data_client.py:127-163, 299-326` - 添加检查点

---

### v1.0 - 2024-12-01 (初始版本)

**初始功能:**
- ✅ 自动检测缺失公牛
- ✅ 上传到云端miss_bull表
- ✅ 用户提醒机制（3种提醒）
- ✅ 格式异常NAAB号保留
- ✅ 日志输出

---

## 技术支持

### 联系方式

如遇到以下情况，请联系技术支持：
- 多次上传失败
- 大量格式异常的NAAB号（超过50%）
- 需要批量添加缺失公牛的完整数据
- 其他异常情况

### 提供信息

提交问题时，请提供：
1. **完整的日志输出**（包含所有检查点信息）
2. **操作步骤描述**（详细重现步骤）
3. **输入数据样本**（脱敏处理敏感信息）
4. **数据库查询结果**（如果可以访问PolarDB）
5. **系统版本号**（帮助→关于中查看）
6. **错误截图**（如果有弹窗错误）

---

**文档维护:** 本文档是 `缺失公牛上传功能测试指南.md` 和 `缺失公牛上传功能使用说明.md` 的合并版本，保留了所有重要内容。
**最后更新:** 2025-11-02
