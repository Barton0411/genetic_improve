# Excel综合报告最终需求文档

**文档版本:** v1.1 Final
**创建时间:** 2025-10-07
**最后更新:** 2025-10-07
**状态:** ✅ 需求已确认（v1.1修订版）

---

## 📋 Sheet结构总览

| Sheet | 名称 | 包含汇总表 | 包含明细表 | 包含图表 |
|-------|------|-----------|-----------|---------|
| 1 | 牧场基础信息 | ✅ | ❌ | ✅ (2个饼图) ⭐修改1 |
| 2 | 系谱识别分析 | ✅ | ✅ | ✅ (3个饼图) |
| 3 | 关键育种性状分析 | ✅ | ✅ | ✅ (分布图+折线图+对比) ⭐修改3,5 |
| 4 | 公牛使用情况 | ✅ | ✅ | ✅ (热力图) ⭐修改7 |
| 5 | 隐性基因分析 | ✅ | ✅ | ❌ ⭐修改8,9 |
| 6 | 近交系数分析 | ✅ | ✅ | ❌ |
| 7 | 备选公牛排名 | ✅ | ❌ | ❌ ⭐修改10 |
| 7A | 备选公牛预测分析 | ✅ | ✅ | ❌ ⭐修改11新增 |
| 8 | 个体选配结果 | ❌ | ✅ | ❌ ⭐修改12 |

---

## 📊 详细需求

### Sheet 1: 牧场基础信息

#### 1.1 基本信息
```
- 牧场名称
- 报告生成时间
- 数据统计周期
- 报告版本
```

#### 1.2 牛群结构统计

**总体统计:**
```
- 总牛头数
- 成母牛头数 (占比)
- 后备牛头数 (占比)
- 平均胎次 ⭐新增
- 其他 (占比)
```

**⭐修改1: 成母牛/后备牛占比饼图**
- 成母牛 vs 后备牛 vs 其他
- 显示占比百分比

**按胎次分布:** ⭐已修改
```
- 0胎牛头数 (占比)
- 1胎牛头数 (占比)
- 2胎牛头数 (占比)
- 3胎及以上牛头数 (占比)
```

**⭐修改1: 按胎次分布饼图**
- 0胎 / 1胎 / 2胎 / 3胎及以上
- 显示占比百分比

~~**按年龄分布:**~~ ❌ 已删除

#### 1.3 上传数据概览 ⭐已重命名 ⭐修改2

```
显示每条上传数据的条数:
- 上传母牛信息数据: XXX条（在群牛XXX条、离群牛XXX条）⭐修改2
- 配种记录数: XXX条
- 上传备选公牛条数: XXX条 ⭐修改2
- 上传体型外貌数据条数: XXX条 ⭐修改2
- 上传基因组检测数据条数: XXX条 ⭐修改2
- 最后更新时间: YYYY-MM-DD HH:MM:SS
```

**数据来源:** `项目文件夹/上传数据/` 各Excel文件行数统计

---

### Sheet 2: 系谱识别情况分析

#### 2.1 汇总表（按出生年份）

**表格格式:**
| 出生年份 | 总头数 | 可识别父号牛数 | 可识别父号占比 | 可识别外祖父牛数 | 可识别外祖父占比 | 可识别外曾外祖父牛数 | 可识别外曾外祖父占比 |
|---------|-------|--------------|--------------|----------------|----------------|-------------------|-------------------|
| 2020及以前 | xxx | xxx | xx.x% | xxx | xx.x% | xxx | xx.x% |
| 2021年 | xxx | xxx | xx.x% | xxx | xx.x% | xxx | xx.x% |
| 2022年 | xxx | xxx | xx.x% | xxx | xx.x% | xxx | xx.x% |
| 2023年 | xxx | xxx | xx.x% | xxx | xx.x% | xxx | xx.x% |
| 2024年 | xxx | xxx | xx.x% | xxx | xx.x% | xxx | xx.x% |
| **合计** | **xxx** | **xxx** | **xx.x%** | **xxx** | **xx.x%** | **xxx** | **xx.x%** |

**格式化规则:**
- 占比显示为百分比（1位小数）
- 合计行加粗
- 识别率 < 80% 标红色背景

**⭐新增图表:** 三个饼图（并排或上下排列）
1. 父号识别情况饼图
   - 已识别 vs 未识别
2. 外祖父识别情况饼图
   - 已识别 vs 未识别
3. 外曾外祖父识别情况饼图
   - 已识别 vs 未识别

#### 2.2 明细表

**表格格式:**
| 牛号 | 出生日期 | 父号(NAAB) | 父号识别状态 | 外祖父号 | 外祖父识别状态 | 外曾外祖父号 | 外曾外祖父识别状态 | 备注 |
|-----|---------|-----------|------------|---------|--------------|------------|------------------|-----|
| ... | ... | ... | ... | ... | ... | ... | ... | ... |

**数据来源:** `分析结果/系谱识别分析结果.xlsx`

---

### Sheet 3: 牧场关键育种性状分析

#### 3.1 按出生年份汇总表

**表格格式:**
| 出生年份 | 头数 | 平均NM$ | 平均TPI | 平均产奶 | 平均乳脂率 | 平均乳蛋白率 | ... (用户选择的性状) |
|---------|-----|---------|---------|---------|-----------|------------|---------------------|
| 2020及以前 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| 2021年 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| 2022年 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| 2023年 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| 2024年 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| **合计** | **xxx** | **xxx** | **xxx** | **xxx** | **xxx** | **xxx** | **...** |
| | | | | | | | |
| **对比牧场A** | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| **对比牧场B** | xxx | xxx | xxx | xxx | xxx | xxx | ... |

⭐ **重要:** 合计行下方显示对比牧场数据

#### 3.2 育种指数分布

**3.2.1 NM$分布统计** ⭐已修改间隔

| 分布区间 | 头数 | 占比 |
|---------|-----|-----|
| <0 | xxx | xx.x% |
| 0-200 | xxx | xx.x% |
| 200-400 | xxx | xx.x% |
| 400-600 | xxx | xx.x% |
| 600-800 | xxx | xx.x% |
| 800-1000 | xxx | xx.x% |
| **>1000** | xxx | xx.x% |

**附加图表:**
- 柱状图（展示各区间头数）
- 饼图（展示占比）

**3.2.2 TPI分布统计** ⭐已修改间隔

| 分布区间 | 头数 | 占比 |
|---------|-----|-----|
| <1500 | xxx | xx.x% |
| 1500-2000 | xxx | xx.x% |
| 2000-2500 | xxx | xx.x% |
| 2500-3000 | xxx | xx.x% |
| 3000-3500 | xxx | xx.x% |
| **>3500** | xxx | xx.x% |

**附加图表:**
- 柱状图（展示各区间头数）
- 饼图（展示占比）

**3.2.3 正态分布图**（嵌入）⭐修改3
- NM$正态分布曲线
- TPI正态分布曲线
- 育种指数正态分布曲线 ⭐修改3新增

#### 3.3 性状进展分析 ⭐已修改 ⭐修改5

**单性状进展折线图:**
- X轴: 年份（最近5年）
- Y轴: 性状值
- 多条折线: 各性状（NM$、TPI、产奶、乳脂、乳蛋白等）
- **叠加对比牧场的性状折线** ⭐修改5新增
- 数据标签: 显示年均增长率

**表格补充:**
| 性状 | 2020 | 2021 | 2022 | 2023 | 2024 | 年均进展 |
|-----|------|------|------|------|------|---------|
| NM$ | xxx | xxx | xxx | xxx | xxx | +xx |
| TPI | xxx | xxx | xxx | xxx | xxx | +xx |
| ... | ... | ... | ... | ... | ... | ... |

#### 3.4 多牧场对比功能 ⭐新功能 ⭐修改4,6

**UI设计:** ⭐修改4
```
[生成Excel综合报告]  （直接生成完整版，不需要下拉选择）⭐修改4

[📁 导入对比牧场数据]  [📥 下载模板]

对比牧场列表:
  ☑ 牧场A (NM$: 450, TPI: 2350, 产奶: 12500)
  ☑ 牧场B (NM$: 420, TPI: 2280, 产奶: 12000)
  ☐ 牧场C (NM$: 480, TPI: 2400, 产奶: 13000)

[预览数据] [删除选中] [清空全部]
```

**模板格式:** ⭐修改6（只保留对比牧场性状明细表）

| 牧场名称 | 牛群规模 | 平均NM$ | 平均TPI | 平均产奶 | 平均乳脂率 | 平均乳蛋白率 | ... (其他性状) |
|---------|---------|---------|---------|---------|-----------|-----------|--------------|
| 对比牧场A | 1200 | 450 | 2350 | 12500 | 3.80 | 3.20 | ... |
| 对比牧场B | 800 | 420 | 2280 | 12000 | 3.90 | 3.30 | ... |

**⭐Excel中对比牧场性状明细表**（完整显示）

| 牧场名称 | 牛群规模 | 平均NM$ | 平均TPI | 平均产奶 | 平均乳脂率 | 平均乳蛋白率 | ... |
|---------|---------|---------|---------|---------|-----------|-----------|-----|
| 本场 | 1500 | 450 | 2350 | 12500 | 3.80 | 3.20 | ... |
| 对比牧场A | 1200 | 420 | 2280 | 12000 | 3.70 | 3.10 | ... |
| 对比牧场B | 800 | 480 | 2400 | 13000 | 3.85 | 3.25 | ... |

#### 3.5 本场性状明细表

| 牛号 | 出生日期 | 胎次 | NM$ | TPI | 产奶PTA | 乳脂PTA | 乳蛋白PTA | ... | 场内排名 |
|-----|---------|-----|-----|-----|---------|---------|----------|-----|---------|
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

**数据来源:** `分析结果/关键育种性状分析结果.xlsx`

---

### Sheet 4: 公牛使用情况分析

#### 4.1 按年度汇总表（最近5年）

**表格格式:**

| 年份 | 支数 | 平均NM$ | 平均TPI | 平均产奶 | 平均乳脂 | 平均乳蛋白 | ... (其他性状) |
|-----|-----|---------|---------|---------|---------|-----------|--------------|
| 2020 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| 2021 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| 2022 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| 2023 | xxx | xxx | xxx | xxx | xxx | xxx | ... |
| 2024 | xxx | xxx | xxx | xxx | xxx | xxx | ... |

⭐ **不需要合计行**

#### 4.2 冻精使用情况图

**常规冻精使用热力图:**
- 纵轴: 配种日期（按季度分组）
- 横轴: 公牛NAAB号
- 颜色深浅: 使用频次

**性控冻精使用热力图:**
- 纵轴: 配种日期（按季度分组）
- 横轴: 公牛NAAB号
- 颜色深浅: 使用频次

~~**4.3 公牛使用排名**~~ ❌ 已删除

#### 4.3 公牛各年份使用明细表 ⭐已修改 ⭐修改7

**表格结构:**

**2024年使用公牛明细**

| 类型 | 公牛NAAB号 | 使用支数 ⭐修改7新增 | NM$ | TPI | 产奶PTA | 乳脂PTA | 乳蛋白PTA | ... |
|-----|-----------|---------|-----|-----|---------|---------|----------|-----|
| 常规 | 001HO12345 | 50 | 450 | 2350 | 1200 | 50 | 45 | ... |
| 常规 | 001HO23456 | 35 | 480 | 2400 | 1300 | 55 | 48 | ... |
| 性控 | 001HO34567 | 28 | 420 | 2300 | 1150 | 48 | 42 | ... |
| ... | ... | ... | ... | ... | ... | ... | ... | ... |
| **数据库最高值** | - | - | **650** | **3000** | **1800** | **80** | **70** | **...** |
| **数据库最低值** | - | - | **-50** | **1200** | **500** | **10** | **5** | **...** |

⭐ **重要:** 每年单独一个表，最后两行显示数据库中的最高值和最低值

**2023年使用公牛明细** (同上格式)
...

**数据来源:**
- `分析结果/已配公牛育种性状分析结果.xlsx`
- `bull_library_cache.db` (最高/最低值)

---

### Sheet 5: 已配公牛隐性基因分析

#### 5.1 隐性基因汇总表

| 基因名称 | 携带公牛数 | 配种头次 | 占总配种比例 |
|---------|----------|---------|------------|
| HH1 | xxx | xxx | xx.x% |
| HH2 | xxx | xxx | xx.x% |
| HH3 | xxx | xxx | xx.x% |
| HH4 | xxx | xxx | xx.x% |
| HH5 | xxx | xxx | xx.x% |
| BL | xxx | xxx | xx.x% |
| ... | ... | ... | ... |

#### 5.2 后代遗传缺陷风险预测 ⭐已修改 ⭐修改8

**根据配种记录预测后代情况:**

| 风险等级 | 头次 | 占比 | 说明 |
|---------|-----|-----|-----|
| 安全 | xxx | xx.x% | 母牛和公牛均为FREE ⭐修改8 |
| 低风险 | xxx | xx.x% | 母牛和公牛一方为FREE ⭐修改8新增 |
| 高风险 | xxx | xx.x% | 母牛和公牛均为CARRIER |
| 数据不完整 | xxx | xx.x% | 母牛或公牛基因状态未知 |

**格式化:**
- 高风险行标红色背景
- 数据不完整行标黄色背景
- 低风险行标浅绿色背景

#### 5.3 隐性基因明细表 ⭐修改9

**表头格式（参考实际文件）:**

| 母牛号 | 父号 | 原始父号 | 配种公牛号 | 原始公牛号 | HH1 | HH1(母) | HH1(公) | HH2 | HH2(母) | HH2(公) | HH3 | HH3(母) | HH3(公) | HH4 | HH4(母) | HH4(公) | HH5 | HH5(母) | HH5(公) | HH6 | HH6(母) | HH6(公) | BLAD | BLAD(母) | BLAD(公) | ... |
|-------|-----|---------|----------|----------|-----|---------|---------|-----|---------|---------|-----|---------|---------|-----|---------|---------|-----|---------|---------|-----|---------|---------|------|---------|---------|-----|

**示例数据:**
| 母牛号 | 父号 | 原始父号 | 配种公牛号 | 原始公牛号 | HH1 | HH1(母) | HH1(公) | ... |
|-------|-----|---------|----------|----------|-----|---------|---------|-----|
| 21121 | HO840003141494450 | 029HO18740 | HO840003143701916 | 151HO04221 | - | F | F | ... |
| 21056 | HO840003141494450 | 029HO18740 | HO840003143701916 | 551HO04221 | - | F | F | ... |
| ... | ... | ... | ... | ... | ... | ... | ... | ... |

**列说明:**
- 母牛号: 母牛标识
- 父号: 母牛父亲的NAAB号
- 原始父号: 母牛父亲的原始号码
- 配种公牛号: 配种公牛的NAAB号
- 原始公牛号: 配种公牛的原始号码
- HH1, HH2, HH3等: 后代基因状态（- 表示安全，F表示FREE，C表示CARRIER）
- HH1(母), HH2(母)等: 母牛基因状态
- HH1(公), HH2(公)等: 公牛基因状态

**数据来源:** `分析结果/已配公牛_近交系数及隐性基因分析结果.xlsx`

---

### Sheet 6: 已配公牛近交系数分析

#### 6.1 近交系数分布汇总

| 近交区间 | 配种头次 | 占比 | 风险等级 |
|---------|---------|-----|---------|
| >12.5% | xxx | xx.x% | 高风险 🔴 |
| 6.25%-12.5% | xxx | xx.x% | 中风险 🟡 |
| 3.125%-6.25% | xxx | xx.x% | 低风险 🟢 |
| <3.125% | xxx | xx.x% | 安全 🟢 |
| **合计** | **xxx** | **100.0%** | |

**格式化:**
- >12.5% 行：红色背景 (#FFE6E6)
- 6.25-12.5% 行：黄色背景 (#FFF9E6)
- 低风险和安全：绿色背景 (#E6F9E6)
- 合计行加粗

#### 6.2 高近交风险汇总表 (>6.25%)

| 母牛号 | 公牛NAAB号 | 近交系数 | 配种日期 | 风险等级 |
|-------|-----------|---------|---------|---------|
| 001 | 001HO12345 | 15.2% | 2024-01-15 | 高风险 |
| 002 | 001HO23456 | 8.5% | 2024-01-16 | 中风险 |
| ... | ... | ... | ... | ... |

**排序:** 按近交系数降序

#### 6.3 近交系数明细表（全部配种事件）

| 配种日期 | 母牛号 | 公牛NAAB号 | 近交系数 | 风险等级 |
|---------|-------|-----------|---------|---------|
| 2024-01-15 | 001 | 001HO12345 | 15.2% | 高风险 |
| 2024-01-16 | 002 | 001HO23456 | 8.5% | 中风险 |
| 2024-01-17 | 003 | 001HO34567 | 2.1% | 安全 |
| ... | ... | ... | ... | ... |

**条件格式:**
- >12.5%: 红色背景
- 6.25-12.5%: 黄色背景
- 3.125-6.25%: 浅绿色背景
- <3.125%: 白色背景

**数据来源:** `分析结果/已配公牛近交系数分析结果.xlsx`

---

### Sheet 7: 备选公牛排名

#### 7.1 综合排名表 ⭐已合并 ⭐修改10

**包含所有信息的单一表格:**

| 排名 | NAAB号 | 育种指数得分 | NM$ | TPI | 产奶PTA | 乳脂PTA | 乳蛋白PTA | ... | HH1 | HH2 | HH3 | HH4 | HH5 | BL | ... | 可用性 |
|-----|--------|------------|-----|-----|---------|---------|----------|-----|-----|-----|-----|-----|-----|----|----|-------|
| 1 | 001HO12345 | 95.2 | 650 | 3000 | 1800 | 80 | 70 | ... | FREE | FREE | FREE | FREE | FREE | FREE | ... | 可用 |
| 2 | 001HO23456 | 94.8 | 620 | 2950 | 1750 | 78 | 68 | ... | FREE | CARRIER | FREE | FREE | FREE | FREE | ... | 可用 |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

**列说明:**
- 排名: 按育种指数得分排序
- 基础性状: NM$, TPI, 产奶PTA, 乳脂PTA, 乳蛋白PTA, ...
- ~~公牛信息: 品种, 出生日期~~ ❌ 已删除 ⭐修改10
- 隐性基因: HH1-HH5, BL, ...
- 可用性: 可用/不可用

~~**7.2 按性状排名**~~ ❌ 已删除
~~**7.3 公牛详细信息**~~ ❌ 已合并到7.1

**数据来源:** `分析结果/备选公牛排名_*.xlsx`

---

### Sheet 7A: 备选公牛与在群母牛预测分析 ⭐修改11新增

**功能说明:**
对备选公牛与所有在群母牛进行预测分析，包括隐性基因配对分析和近交系数预测。

#### 7A.1 隐性基因配对分析汇总

**按风险等级统计:**

| 风险等级 | 配对头次 | 占比 | 说明 |
|---------|---------|-----|-----|
| 安全 | xxx | xx.x% | 母牛和公牛均为FREE |
| 低风险 | xxx | xx.x% | 母牛和公牛一方为FREE |
| 高风险 | xxx | xx.x% | 母牛和公牛均为CARRIER |
| 数据不完整 | xxx | xx.x% | 母牛或公牛基因状态未知 |

**格式化:**
- 高风险行标红色背景
- 数据不完整行标黄色背景
- 低风险行标浅绿色背景

#### 7A.2 近交系数预测分析汇总

| 近交区间 | 配对头次 | 占比 | 风险等级 |
|---------|---------|-----|---------|
| >12.5% | xxx | xx.x% | 高风险 🔴 |
| 6.25%-12.5% | xxx | xx.x% | 中风险 🟡 |
| 3.125%-6.25% | xxx | xx.x% | 低风险 🟢 |
| <3.125% | xxx | xx.x% | 安全 🟢 |
| **合计** | **xxx** | **100.0%** | |

**格式化:**
- >12.5% 行：红色背景
- 6.25-12.5% 行：黄色背景
- 低风险和安全：绿色背景

#### 7A.3 预测明细表

**表头格式（参考已配公牛格式）:**

| 母牛号 | 父号 | 原始父号 | 备选公牛号 | 原始公牛号 | 近交系数 | 后代近交系数 | HH1 | HH1(母) | HH1(公) | HH2 | HH2(母) | HH2(公) | ... | 后代风险 |
|-------|-----|---------|----------|----------|---------|------------|-----|---------|---------|-----|---------|---------|-----|---------|
| ... | ... | ... | ... | ... | x.x% | x.x% | - | F | F | - | F | F | ... | 安全 |

**数据来源:** `分析结果/备选公牛_近交系数及隐性基因分析结果.xlsx`

---

### Sheet 8: 个体选配推荐结果 ⭐已简化 ⭐修改12

**直接完整导入选配结果表（参考"个体选配报告.xlsx"格式）**

**表头格式:**

| 母牛号 | 分组 | 1选性控 | 2选性控 | 3选性控 | 性控备注 | 1选常规 | 2选常规 | 3选常规 | 常规备注 | 胎次 | 本胎次奶厅高峰产量 | 305奶量 | 泌乳天数 | 繁育状态 | 母牛指数得分 | 品种 | 父亲 | 外祖父 | 母亲 | 外曾外祖父 | 产犊日期 | 出生日期 | 数据提取日期 | 月龄 | 配次 |
|-------|-----|--------|--------|--------|---------|--------|--------|--------|---------|-----|---------------|--------|--------|---------|------------|-----|-----|-------|-----|----------|--------|--------|------------|-----|-----|

**示例数据:**

| 母牛号 | 分组 | 1选性控 | 2选性控 | 3选性控 | 性控备注 | 1选常规 | 2选常规 | 3选常规 | 常规备注 | 胎次 | 本胎次奶厅高峰产量 | 305奶量 | 泌乳天数 | 繁育状态 | 母牛指数得分 | ... |
|-------|-----|--------|--------|--------|---------|--------|--------|--------|---------|-----|---------------|--------|--------|---------|------------|-----|
| 213397 | 后备牛第1周期+性控 | 001HO09154 | 001HO09162 | 001HO09174 | | 007HO16385 | 007HO16443 | 007HO16284 | | 0 | | | | 出生 | -78.99 | ... |
| 213399 | 后备牛第1周期+性控 | | | | 无性控推荐：与001HO09154公牛存在HH5基因纯合高风险 | 151HO04449 | 007HO16443 | 007HO16284 | | 0 | | | | 出生 | 75.53 | ... |

**格式化:**
- 性控备注不为空时标黄色背景
- 常规备注不为空时标黄色背景

~~**8.1 选配结果汇总**~~ ❌ 已删除
~~**8.2 选配方案详细表**~~ ❌ 已删除（与8合并）
~~**8.3 未选配母牛明细**~~ ❌ 已删除

**数据来源:** `分析结果/个体选配报告.xlsx` (完整导入) ⭐修改12

---

## 🎨 格式规范（保持不变）

### 通用格式
```
标题行:
  - 背景色: 深蓝色 (#2E5C8A)
  - 字体: 白色、加粗、12pt、微软雅黑
  - 对齐: 居中
  - 边框: 全边框

数据行:
  - 奇数行: 白色背景
  - 偶数行: 浅灰色 (#F5F5F5)
  - 字体: 10pt、微软雅黑
  - 边框: 细边框

合计行:
  - 背景色: 浅蓝色 (#D6E9F8)
  - 字体: 加粗、10pt、微软雅黑
  - 对齐: 居中

数值格式:
  - 整数: 使用千分位分隔符 (1,234)
  - 小数: 保留1-2位 (12.34)
  - 百分比: 1位小数 + % (12.3%)
  - 日期: YYYY-MM-DD
  - 近交系数: 1位小数 + % (6.3%)
```

### 条件格式
```
风险标识:
  - 高风险: 红色背景 (#FFE6E6)
  - 中风险: 黄色背景 (#FFF9E6)
  - 低风险/安全: 绿色背景 (#E6F9E6)

系谱识别率:
  - <80%: 红色背景 (#FFE6E6)

近交系数:
  - >12.5%: 红色背景
  - 6.25-12.5%: 黄色背景
  - 3.125-6.25%: 浅绿色背景
  - <3.125%: 白色背景
```

### 图表样式
```
饼图:
  - 尺寸: 宽6列 × 高20行
  - 显示数据标签（百分比）
  - 图例位置: 右侧

柱状图:
  - 尺寸: 宽8列 × 高20行
  - 显示数据标签
  - 坐标轴标题

折线图:
  - 尺寸: 宽10列 × 高25行
  - 显示数据标签
  - 网格线
  - 图例位置: 下方

热力图:
  - 尺寸: 宽12列 × 高30行
  - 颜色渐变: 白色→深蓝色
  - 显示值（可选）
```

---

## 🔧 技术实现

### 数据来源策略

**优先级1:** 从项目文件夹读取已生成的Excel文件
```
路径: {project_folder}/分析结果/
文件:
  - 系谱识别分析结果.xlsx
  - 关键育种性状分析结果.xlsx
  - 已配公牛育种性状分析结果.xlsx
  - 已配公牛隐性基因分析结果.xlsx
  - 已配公牛近交系数分析结果.xlsx
  - 备选公牛排名_按NM$.xlsx
  - 备选公牛排名_按TPI.xlsx
  - 个体选配推荐结果.xlsx (可选)
```

**优先级2:** 如果文件不存在
```
提示用户:
  "缺少以下分析结果文件：
   - 系谱识别分析结果.xlsx

   请先完成对应的分析模块。"

按钮:
  [前往分析] [取消]
```

### 生成流程 ⭐修改4

```
1. 用户点击"生成Excel综合报告"（直接生成完整版）⭐修改4

2. (可选) 导入对比牧场数据
   └─ 上传Excel文件
   └─ 预览并勾选需要对比的牧场

3. 检查必要文件是否存在
   └─ 如缺少，提示用户并终止

4. 显示进度对话框
   └─ 正在生成Sheet 1...
   └─ 正在生成Sheet 2...
   └─ ...

5. 依次生成9个Sheet（包括Sheet 7A）⭐修改11
   └─ 读取源数据
   └─ 应用格式化
   └─ 嵌入图表（如需要）

6. 保存文件
   └─ 路径: {project_folder}/分析结果/
   └─ 文件名: 育种分析综合报告_{时间戳}.xlsx

7. 提示用户完成
   └─ "报告已生成！是否打开？"
   └─ [打开文件] [打开文件夹] [关闭]
```

### 对比牧场数据管理

**存储位置:**
```
{project_folder}/对比数据/多牧场对比数据.json
```

**数据格式:**
```json
{
  "farms": [
    {
      "name": "牧场A",
      "enabled": true,
      "data": {
        "NM$": 450,
        "TPI": 2350,
        "产奶": 12500,
        "乳脂率": 3.80,
        "乳蛋白率": 3.20,
        ...
      },
      "import_date": "2025-10-07"
    },
    {
      "name": "牧场B",
      "enabled": false,
      "data": {...},
      "import_date": "2025-10-05"
    }
  ]
}
```

**UI功能:**
- 导入: 读取Excel模板 → 解析 → 添加到列表
- 勾选: 控制哪些牧场参与对比
- 预览: 显示牧场数据表格
- 删除: 从列表中移除
- 清空: 删除所有对比数据

---

## 📊 报告版本 ⭐修改4

~~### 精简版~~ ❌ 已删除
~~**包含内容:**~~
~~- ✅ 所有汇总表~~
~~- ✅ 所有嵌入图表~~
~~- ❌ 不包含明细表~~

### 完整版（唯一版本）⭐修改4
**包含内容:**
- ✅ 所有汇总表
- ✅ 所有明细表
- ✅ 所有嵌入图表
- ✅ 包含9个Sheet（Sheet 1-8 + Sheet 7A）

**文件大小:** 约 2-5 MB

**适用场景:**
- 深度分析
- 存档备查
- 详细审计
- 汇报展示

---

## ✅ 验收标准

### 功能验收 ⭐v1.1更新
- [ ] 能够生成完整版报告（唯一版本）⭐修改4
- [ ] Sheet 1: 牧场基础信息完整（包含2个饼图）⭐修改1,2
- [ ] Sheet 2: 系谱识别汇总表 + 3个饼图 + 明细表
- [ ] Sheet 3: 育种性状汇总表（含对比牧场数据） + 分布图（含育种指数）+ 折线图（含对比） + 明细表 ⭐修改3,5
- [ ] Sheet 4: 公牛使用汇总表 + 热力图 + 各年份明细表（含使用支数、最高/最低值）⭐修改7
- [ ] Sheet 5: 隐性基因汇总表（4级风险） + 后代风险预测 + 明细表（新格式）⭐修改8,9
- [ ] Sheet 6: 近交系数汇总表 + 高风险表 + 明细表
- [ ] Sheet 7: 备选公牛综合排名表（删除品种、出生日期）⭐修改10
- [ ] Sheet 7A: 备选公牛预测分析（新增）⭐修改11
- [ ] Sheet 8: 个体选配结果完整表（新格式）⭐修改12
- [ ] 多牧场对比功能: 导入/预览/勾选/删除正常工作（仅对比牧场性状明细表）⭐修改6
- [ ] 所有表格格式正确
- [ ] 所有条件格式正确应用
- [ ] 所有图表正确嵌入
- [ ] 生成速度可接受（<60秒）

### UI验收 ⭐v1.1更新
- [ ] "生成Excel综合报告"按钮显示正常（不需要下拉菜单）⭐修改4
- [ ] "导入对比牧场数据"按钮正常
- [ ] "下载模板"按钮正常
- [ ] 对比牧场列表显示正常
- [ ] 勾选框正常工作
- [ ] 进度对话框友好
- [ ] 生成完成后提示友好
- [ ] 错误提示清晰

### 代码质量
- [ ] 代码结构清晰，模块化
- [ ] 每个Sheet有独立的Builder
- [ ] 数据收集器分离
- [ ] 样式管理器统一
- [ ] 添加必要的日志
- [ ] 异常处理完善
- [ ] 代码注释充分

---

## 📅 开发计划

### Phase 1: 基础框架 + Sheet 1,2,8 (3-4天)
**目标:** 建立完整框架，实现3个最简单的Sheet

**Day 1:**
- [ ] 创建项目结构
- [ ] 实现 ExcelReportGenerator 主类
- [ ] 实现 StyleManager
- [ ] 实现 BaseSheetBuilder
- [ ] 实现 UI按钮和下拉菜单

**Day 2:**
- [ ] 实现 farm_info_collector
- [ ] 实现 Sheet1Builder
- [ ] 测试 Sheet 1 生成

**Day 3:**
- [ ] 实现 pedigree_collector
- [ ] 实现 Sheet2Builder（汇总表 + 3个饼图）
- [ ] 测试 Sheet 2 生成

**Day 4:**
- [ ] 实现 Sheet2Builder 明细表（完整版）
- [ ] 实现 mating_collector
- [ ] 实现 Sheet8Builder（直接导入）
- [ ] 测试 Phase 1 完整流程

**验收:** 能生成包含Sheet 1, 2, 8的报告

---

### Phase 2: 复杂Sheet + 对比功能 (4-5天)
**目标:** 实现Sheet 3-7，完成多牧场对比功能

**Day 5:**
- [ ] 实现 traits_collector
- [ ] 实现 Sheet3Builder（汇总表 + 分布图）
- [ ] 测试 Sheet 3 基础功能

**Day 6:**
- [ ] 实现多牧场对比UI
- [ ] 实现模板下载功能
- [ ] 实现数据导入和存储
- [ ] Sheet 3添加对比牧场数据
- [ ] 测试对比功能

**Day 7:**
- [ ] 实现 bull_usage_collector
- [ ] 实现 Sheet4Builder（汇总表 + 热力图）
- [ ] 实现各年份明细表（含最高/最低值）
- [ ] 测试 Sheet 4

**Day 8:**
- [ ] 实现 gene_collector
- [ ] 实现 Sheet5Builder（汇总 + 后代风险预测 + 明细）
- [ ] 实现 inbreeding_collector
- [ ] 实现 Sheet6Builder（3个表）
- [ ] 测试 Sheet 5, 6

**Day 9:**
- [ ] 实现 bull_ranking_collector
- [ ] 实现 Sheet7Builder（综合排名表）
- [ ] 测试 Sheet 7
- [ ] 测试 Phase 2 完整流程

**验收:** 能生成包含所有8个Sheet的完整报告

---

### Phase 3: 图表美化 + 优化 (2-3天)
**目标:** 完善所有图表，优化性能和用户体验

**Day 10:**
- [ ] 优化所有图表样式
- [ ] 添加性状进展折线图（Sheet 3）
- [ ] 添加正态分布图（Sheet 3）
- [ ] 测试所有图表显示

**Day 11:**
- [ ] 性能优化（大数据集处理）
- [ ] 错误处理完善
- [ ] 添加详细日志
- [ ] 用户提示优化

**Day 12:**
- [ ] 全面测试（小/中/大数据集）
- [ ] 修复bug
- [ ] 文档完善
- [ ] 最终验收

**验收:** 所有功能正常，性能良好，用户体验友好

---

## 📝 待开发功能清单

### 必需功能（Phase 1-2）
- [ ] Excel报告生成主框架
- [ ] 样式管理器
- [ ] Sheet 1: 牧场基础信息
- [ ] Sheet 2: 系谱识别分析（含3个饼图）
- [ ] Sheet 3: 育种性状分析（含分布图、折线图）
- [ ] Sheet 4: 公牛使用情况（含热力图）
- [ ] Sheet 5: 隐性基因分析
- [ ] Sheet 6: 近交系数分析
- [ ] Sheet 7: 备选公牛排名
- [ ] Sheet 8: 个体选配结果
- [ ] 多牧场对比功能（UI + 数据管理）
- [ ] 精简版/完整版选择
- [ ] 缺失文件检查和提示

### 扩展功能（Phase 3或后续）
- [ ] 报告模板自定义
- [ ] 导出为PDF
- [ ] 报告历史版本管理
- [ ] 批量生成多个项目的报告
- [ ] 自动发送邮件功能

---

**预计总开发时间:** 10-12天

**开始日期:** 2025-10-08
**预计完成日期:** 2025-10-18

**开发团队:** Development Team
**文档维护:** Claude Code Assistant

---

**最后更新:** 2025-10-07
**文档状态:** ✅ 最终确认版本 v1.1

---

## 📝 v1.1 修改记录（2025-10-07）

### 修改汇总
本次更新包含12条用户反馈修改：

1. ⭐修改1: Sheet 1 添加2个饼图（成母牛/后备牛占比 + 按胎次分布）
2. ⭐修改2: Sheet 1 上传数据概览格式调整（添加体型外貌、基因组等数据）
3. ⭐修改3: Sheet 3 添加育种指数正态分布图
4. ⭐修改4: 取消精简版/完整版选择，直接生成完整版
5. ⭐修改5: Sheet 3 折线图叠加对比牧场数据
6. ⭐修改6: 多牧场对比模板简化（只保留对比牧场性状明细表）
7. ⭐修改7: Sheet 4 公牛明细表添加"使用支数"列
8. ⭐修改8: Sheet 5 隐性基因风险等级调整为4级（安全/低风险/高风险/数据不完整）
9. ⭐修改9: Sheet 5 隐性基因明细表表头格式大幅调整（参考实际文件）
10. ⭐修改10: Sheet 7 删除"品种"和"出生日期"列
11. ⭐修改11: 新增Sheet 7A - 备选公牛与在群母牛预测分析
12. ⭐修改12: Sheet 8 格式调整（参考"个体选配报告.xlsx"）

### 主要变更
- **Sheet数量**: 从8个增加到9个（新增Sheet 7A）
- **报告版本**: 取消精简版，只保留完整版
- **图表数量**: Sheet 1新增2个饼图，Sheet 3新增育种指数正态分布
- **对比功能**: 简化模板格式，折线图支持对比牧场叠加显示
- **数据格式**: Sheet 5和Sheet 8的表头格式大幅调整，更贴近实际使用
