# 个体选配业务逻辑说明文档

## 一、业务流程概述

个体选配系统分为两个主要阶段：
1. **推荐生成阶段**：计算所有母牛与所有公牛的配对得分，生成配对矩阵
2. **选配分配阶段**：基于配对矩阵和库存，为每头母牛分配具体的公牛

## 二、分组逻辑

### 2.1 分组流程
```
筛选在场母牛 → 识别特殊状态 → 周期分组 → 策略表分配 → 确定性控/非性控
```

### 2.2 分组维度

#### 2.2.1 基础筛选
- 条件：`是否在场 = '是' AND sex = '母'`

#### 2.2.2 牛只类型
- **后备牛**：`lac = 0`（未产犊）
- **成母牛**：`lac > 0`（已产犊）

#### 2.2.3 特殊状态（优先处理）

| 类型 | 识别条件 | 分组名称 |
|------|----------|----------|
| 后备牛已孕 | `lac=0 AND repro_status IN ('初检孕','复检孕')` | 后备牛已孕牛+非性控 |
| 后备牛难孕 | `lac=0 AND 日龄≥554天(18个月) AND 未孕` | 后备牛难孕牛+非性控 |
| 成母牛已孕 | `lac>0 AND repro_status IN ('初检孕','复检孕')` | 成母牛已孕牛+非性控 |
| 成母牛难孕 | `lac>0 AND DIM≥150天 AND 未孕` | 成母牛难孕牛+非性控 |

#### 2.2.4 周期分组（普通牛）

**后备牛周期**（基于日龄）：
- 参数：开配日龄（用户可设置，默认420天）、选配周期（用户可设置，默认21天）
- 计算公式：
  ```
  第1周期：[开配日龄-21天, 开配日龄)
  第2周期：[开配日龄-42天, 开配日龄-21天)
  第3周期：[开配日龄-63天, 开配日龄-42天)
  第4周期：[开配日龄-84天, 开配日龄-63天)
  ```

**成母牛分组**：
- 所有非已孕、非难孕的成母牛统一标记为"成母牛未孕牛"

#### 2.2.5 策略表分配（A/B/C组）

1. 对每个周期组内的母牛按`ranking`升序排序（数值越小排名越靠前）
2. 根据策略表比例分配：
   - 例如：A组30%、B组40%、C组30%
   - 前30%的牛分到A组，接下来40%分到B组，最后30%分到C组

#### 2.2.6 性控/非性控判定

**配种方式分类**：
- **性控**：普通性控、超级性控
- **非性控**：常规冻精、肉牛冻精、胚胎

**判定逻辑**：
```python
# 根据母牛已配种次数(services_time)确定下次使用什么
# 策略表示例：["普通性控", "普通性控", "常规冻精", "常规冻精"]
# services_time 表示已经配种的次数

if services_time == 0 或 null:
    # 还没配过，下次是第1次配种
    使用 breeding_methods[0]
elif services_time == 1:
    # 已配1次，下次是第2次配种
    使用 breeding_methods[1]
elif services_time == 2:
    # 已配2次，下次是第3次配种
    使用 breeding_methods[2]
else:
    # 已配3次或更多，下次使用最后一个方法
    使用 breeding_methods[len(breeding_methods)-1]

# 代码实现
method_idx = min(services_time, len(breeding_methods) - 1)
method = breeding_methods[method_idx]
```

### 2.3 最终分组格式
`{牛只类型}+{状态/周期}+{性控/非性控}`

示例：
- 后备牛第1周期+性控
- 后备牛第1周期+非性控
- 成母牛未孕牛+性控
- 后备牛难孕牛+非性控

## 三、分配逻辑

### 3.1 分配优先级顺序
```
1.  后备牛第1周期+性控
2.  后备牛第1周期+非性控
3.  后备牛第2周期+性控
4.  后备牛第2周期+非性控
5.  后备牛第3周期+性控
6.  后备牛第3周期+非性控
7.  后备牛第4周期+性控
8.  后备牛第4周期+非性控
9.  成母牛未孕牛+性控
10. 成母牛未孕牛+非性控
11. 后备牛难孕牛+非性控
12. 成母牛难孕牛+非性控
13. 后备牛已孕牛+非性控
14. 成母牛已孕牛+非性控
```

### 3.2 分配策略

#### 3.2.1 分组与可分配冻精类型
- **性控组**（如"后备牛第1周期+性控"）
  - 可分配：性控冻精（1选、2选、3选）
  - 可分配：常规冻精（1选、2选、3选）
  - 共6个选配位

- **非性控组**（如"后备牛第1周期+非性控"）
  - 只分配：常规冻精（1选、2选、3选）
  - 性控位留空
  - 共3个选配位

#### 3.2.2 库存比例分配
- **1选**：严格按库存比例分配（含最小分配保证）
  ```
  例如：A:B:C = 100:50:20
  比例：58.8% : 29.4% : 11.8%
  100头母牛分配：A得59头，B得29头，C得12头
  
  最小分配保证：
  - 当某公牛按比例计算分配为0时，确保至少分配1头
  - 例如：A:B:C = 1000:10:1，100头母牛
  - 不保证时：A得99头，B得1头，C得0头
  - 保证时：A得98头，B得1头，C得1头
  ```
- **2选、3选**：平均分配给库存>0的公牛
  ```
  例如：3头公牛都有库存
  100头母牛平均分配：每头公牛约33-34头
  ```

#### 3.2.3 约束条件
- **近交系数**：≤ 用户设定阈值（如3.125%）
- **隐性基因**：用户可选择是否控制

#### 3.2.4 未分配处理
- 如果母牛与所有公牛都不满足约束，则该选位空缺
- 记录未分配原因：
  - "近交系数超标"
  - "隐性基因风险"
  - "无可用公牛"

### 3.3 注意事项
- 不需要实际扣减库存（只是分配方案）
- 小库存公牛在1选时有最小分配保证（至少1头）

## 四、选配报告输出

### 4.1 报告表头结构
| 字段 | 来源 | 说明 |
|------|------|------|
| 母牛号 | cow_id | 母牛标识 |
| 分组 | 自动分组结果 | 分组名称 |
| 1选性控 | 分配计算 | 性控公牛1选（非性控组为空） |
| 2选性控 | 分配计算 | 性控公牛2选（非性控组为空） |
| 3选性控 | 分配计算 | 性控公牛3选（非性控组为空） |
| 1选常规 | 分配计算 | 常规公牛1选 |
| 2选常规 | 分配计算 | 常规公牛2选 |
| 3选常规 | 分配计算 | 常规公牛3选 |
| 胎次 | lac | 泌乳次数 |
| 本胎次奶厅高峰产量 | peak_milk | 峰值产奶量 |
| 305奶量 | milk_305 | 305天产奶量 |
| 泌乳天数 | DIM | 产后天数 |
| 繁育状态 | repro_status | 繁殖状态 |
| 母牛指数得分 | 计算结果 | 育种指数 |
| 品种 | breed | 品种信息 |
| 父亲 | sire | 父亲ID |
| 外祖父 | mgs | 母外祖父ID |
| 母亲 | dam | 母亲ID |
| 外曾外祖父 | mmgs | 母外曾外祖父ID |
| 产犊日期 | calving_date | 最近产犊日期 |
| 出生日期 | birth_date | 出生日期 |
| 数据提取日期 | 系统生成 | 报告生成日期 |
| 月龄 | 计算 | (当前日期-出生日期)/30.5 |
| 配次 | services_time | 已配种次数 |

### 4.2 数据来源
1. **母牛基础信息**：从`processed_cow_data.xlsx`获取
2. **指数得分**：从`processed_index_cow_index_scores.xlsx`获取
3. **分配结果**：从分配算法计算获得

## 五、系统参数配置

### 5.1 用户可配置参数
- 后备牛开配日龄（默认420天）
- 选配周期（默认21天）
- 近交系数阈值（默认3.125%）
- 是否控制隐性基因（默认是）

### 5.2 策略表配置
- 分组名称（如后备牛A、成母牛B）
- 组占比（百分比）
- 配种方法列表（按配种次数顺序）

---
更新日期：2024-01-30
版本：1.2

## 更新记录
- v1.2 (2024-01-30)：增加小库存公牛最小分配保证（1选时至少分配1头）
- v1.1 (2024-01-30)：修正配种方式判断逻辑，明确services_time表示已配种次数
- v1.0 (2024-01-30)：初始版本