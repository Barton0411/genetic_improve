# 系谱识别分析自动生成功能说明

**创建时间：** 2025-10-08
**版本：** v1.0
**状态：** ✅ 已实现

---

## 📋 功能概述

在生成 `processed_cow_data_key_traits_detail.xlsx` 后，自动生成系谱识别分析结果文件 `系谱识别分析结果.xlsx`。

---

## 🎯 实现目的

### 问题
之前的系谱识别分析功能 `PedigreeAnalysis.analyze_pedigree_completeness()` 存在以下问题：
1. 需要重新连接数据库查询公牛库
2. 没有在工作流中自动触发
3. 可能导致 `系谱识别分析结果.xlsx` 文件不存在

### 解决方案
创建新函数 `generate_pedigree_analysis_result()`，直接基于已有的 `processed_cow_data_key_traits_detail.xlsx` 文件生成系谱识别分析结果。

---

## ✨ 功能优势

1. **简单高效**：直接使用已有数据，不需要重新连接数据库查询公牛库
2. **自动化**：在生成关键性状分析后自动生成系谱识别分析
3. **数据一致**：使用同一份数据源，保证数据一致性
4. **性能好**：只需要简单的分组统计，无需复杂查询

---

## 🔧 技术实现

### 核心文件
- **新文件**：`core/breeding_calc/generate_pedigree_analysis.py`
- **集成位置**：`core/breeding_calc/key_traits_page.py` (第748-756行)

### 数据来源
从 `processed_cow_data_key_traits_detail.xlsx` 读取以下列：
- `sex`：性别（只保留母牛）
- `是否在场`：在场状态
- `birth_year`：出生年份
- `sire_identified`：父号是否识别（True/False）
- `mgs_identified`：外祖父是否识别（True/False）
- `mmgs_identified`：外曾外祖父是否识别（True/False）

### 生成逻辑

```python
def generate_pedigree_analysis_result(project_path: Path) -> bool:
    """
    基于processed_cow_data_key_traits_detail.xlsx生成系谱识别分析结果

    步骤：
    1. 读取 processed_cow_data_key_traits_detail.xlsx
    2. 过滤母牛数据（排除公牛）
    3. 按出生年份分组（2020年及以前、2021、2022、2023、2024）
    4. 按是否在场分组（是、否、总计）
    5. 统计每组的识别情况
    6. 保存到 分析结果/系谱识别分析结果.xlsx
    """
```

### 输出格式

| 是否在场 | birth_year_group | 头数 | 父号可识别头数 | 父号识别率 | 外祖父可识别头数 | 外祖父识别率 | 外曾外祖父可识别头数 | 外曾外祖父识别率 |
|---------|-----------------|-----|--------------|-----------|----------------|------------|-------------------|----------------|
| 是      | 2020年及以前     | 164 | 143          | 87.20%    | 0              | 0.00%      | 0                 | 0.00%          |
| 是      | 2021            | 75  | 75           | 100.00%   | 0              | 0.00%      | 0                 | 0.00%          |
| ...     | ...             | ... | ...          | ...       | ...            | ...        | ...               | ...            |
| 总计    | 2020年及以前     | 1023| 396          | 38.71%    | 0              | 0.00%      | 0                 | 0.00%          |
| 总计    | 2021            | 202 | 202          | 100.00%   | 0              | 0.00%      | 0                 | 0.00%          |

---

## 🔄 工作流程集成

### 触发时机
在关键性状分析流程中，保存 `processed_cow_data_key_traits_detail.xlsx` 后立即触发。

### 代码位置
`core/breeding_calc/key_traits_page.py` 第748-756行：

```python
# 6. 保存详细结果
detail_output_path = main_window.selected_project_path / "analysis_results" / "processed_cow_data_key_traits_detail.xlsx"
if not self.save_results_with_retry(cow_df, detail_output_path):
    return False, "用户取消了保存操作"

# 6.5 自动生成系谱识别分析结果
try:
    from core.breeding_calc.generate_pedigree_analysis import generate_pedigree_analysis_result
    print("自动生成系谱识别分析结果...")
    generate_pedigree_analysis_result(main_window.selected_project_path)
    print("✓ 系谱识别分析结果已生成")
except Exception as e:
    print(f"生成系谱识别分析结果失败: {e}")
    # 不影响主流程，继续执行
```

---

## 📊 用于Excel综合报告

生成的 `系谱识别分析结果.xlsx` 文件用于：
- **Sheet 2: 系谱识别分析**
  - 汇总表（按出生年份）
  - 3个饼图（父号/外祖父/外曾外祖父识别情况）
  - 明细表

---

## ✅ 测试验证

### 测试项目
- 项目：`/Users/bozhenwang/GeneticImprove/ll_2025_10_06_17_13`
- 结果：✅ 成功生成 `分析结果/系谱识别分析结果.xlsx`

### 测试结果
```
✓ ll项目系谱识别分析结果已生成
✓ 结果文件包含 15 行数据

总计行数据:
   birth_year_group    头数  父号可识别头数    父号识别率
10         2020年及以前  1023      396   38.71%
11             2021   202      202  100.00%
12             2022   227      227  100.00%
13             2023   219      191   87.21%
14             2024   182      145   79.67%
```

---

## 📝 注意事项

1. **异常处理**：生成失败不影响主流程，只打印错误信息
2. **数据依赖**：依赖 `processed_cow_data_key_traits_detail.xlsx` 文件存在
3. **覆盖规则**：每次执行会覆盖旧的 `系谱识别分析结果.xlsx` 文件

---

## 🔮 未来改进

1. 可以考虑将其他分析结果也采用类似方式自动生成
2. 添加进度提示和用户反馈
3. 支持增量更新而非完全覆盖

---

**最后更新：** 2025-10-08
**维护人员：** Development Team
