# Excel综合报告设计方案

**文档版本:** v1.1
**创建时间:** 2025-10-07
**最后更新:** 2025-10-07
**状态:** ✅ 需求已确认，准备开发

---

## 📊 报告结构

### Sheet 1: 牧场基础信息

#### 1.1 基本信息
```
- 牧场名称
- 报告生成时间
- 数据统计周期
- 报告版本
```

#### 1.2 牛群结构统计
```
总体统计:
  - 总牛头数
  - 成母牛头数 (占比)
  - 后备牛头数 (占比)
  - 其他 (占比)

按胎次分布:
  - 1胎牛头数 (占比)
  - 2胎牛头数 (占比)
  - 3胎牛头数 (占比)
  - 4胎及以上牛头数 (占比)
改为：
“”“
按胎次分布:
  - 0胎牛头数 (占比)
  - 1胎牛头数 (占比)
  - 2胎牛头数 (占比)
  - 3胎及以上牛头数 (占比)
  ”“”
按年龄分布:（不需要）
  - <1岁 (占比)
  - 1-2岁 (占比)
  - 2-3岁 (占比)
  - 3岁以上 (占比)
```

#### 1.3 数据质量概览
```
- 上传文件数量
- 数据记录总数
- 数据完整性评分
- 最后更新时间
```
数据质量概览改为 上传数据概览
改为每条上传数据的条数就行；

#### 补充建议：
- ✅ 在群牛平均产奶量
- ✅ 平均体细胞数
- ✅ 平均胎次
- ✅ 配种记录数
- ✅ 系谱完整度评分
#### 补充建议：
- ✅ 在群牛平均产奶量（不需要）
- ✅ 平均体细胞数（不需要）
- ✅ 平均胎次（添加到“总体统计”中）
- ✅ 配种记录数（添加到“上传数据概览”）
- ✅ 系谱完整度评分（不需要）
---

### Sheet 2: 系谱识别情况分析

#### 2.1 汇总表（按出生年份）

**格式参考你的截图：**
```
列:
  - 出生年份
  - 总头数
  - 可识别父号牛数
  - 可识别父号占比
  - 可识别外祖父牛数
  - 可识别外祖父占比
  - 可识别外曾外祖父牛数
  - 可识别外曾外祖父占比
以及三个饼图（三项的识别/未识别）
行:（根据数据展示最近4年的几5年以前的、还有合计）
  - 2020及以前年份
  - 2021年
  - 2022年
  - 2023年
  - 2024年
  - 合计
```

**格式化：**
- 占比显示为百分比（1位小数）
- 合计行加粗
- 低于80%的识别率标红

#### 2.2 趋势分析
```
- 系谱识别率年度变化趋势图
- 识别率改进建议
```

#### 2.3 明细表
```
列:
  - 牛号
  - 出生日期
  - 父号（NAAB）
  - 父号识别状态
  - 外祖父号
  - 外祖父识别状态
  - 外曾外祖父号
  - 外曾外祖父识别状态
  - 备注
```

---

### Sheet 3: 牧场关键育种性状分析

#### 3.1 按出生年份汇总表
```
列:
  - 出生年份
  - 头数
  - 平均NM$
  - 平均TPI
  - 平均产奶量
  - 平均乳脂率
  - 平均乳蛋白率
  - ... (用户选择的其他性状)

  最后一行是合计，然后下面是几个对比数据的各项关键性状的值
```

#### 3.2 育种指数分布

**3.2.1 NM$分布统计**
```
分布区间:（按照200作为间隔，上不封顶，也许有1000以上的）
  - <0
  - 0-200
  - 200-400
  - 400-600
  - 600-800
  - >800

显示: 头数 + 占比 + 柱状图（及饼图）
```

**3.2.2 TPI分布统计**（按照500作为间隔，上不封顶，也许有3500以上的）
```
分布区间:
  - <1500
  - 1500-2000
  - 2000-2500
  - 2500-3000
  - >3000

显示: 头数 + 占比 + 柱状图（及饼图）
```

**3.2.3 正态分布图**
- NM$正态分布曲线（嵌入图表）
- TPI正态分布曲线（嵌入图表）

#### 3.3 性状进展分析
```
各性状年度变化趋势表:(改成单性状的进展折线图)

- 显示最近5年数据
- 计算年均增长率（及平均进展值）
```

#### 3.4 多牧场对比 ⭐新功能

**3.4.1 对比数据上传功能**
```
界面设计:
  - "导入对比牧场数据" 按钮（这个按钮放到自动生成报告的界面中，不更新的时候使用默认值，用户可以预览，可以上传并勾选需要对比的牧场）
  - 下载模板按钮
  - 支持导入多个牧场数据

模板格式:
  列: 牧场名称 | NM$ | TPI | 产奶 | ...
```

**3.4.2 对比分析表**（这些对比都在前面的牧场关键育种性状分析中，这里不需要对比分析表），但是需要有一个对比牧场的性状明细表）
```
列:
  - 牧场名称
  - 牛群规模
  - 平均NM$
  - 平均TPI
  - 与本场差值
  - 排名
```

#### 3.5 明细表
```
列:
  - 牛号
  - 出生日期
  - 胎次
  - NM$
  - TPI
  - 产奶
  - 乳脂
  - 乳蛋白
  - ... (所有分析的性状)
  - 排名
```

---

### Sheet 4: 公牛使用情况分析

#### 4.1 按年度汇总表（最近5年）
```
![alt text](image.png)
年份	支数	净利润值	综合指数	产奶量	乳脂量  等性状
（不需要合计）
```

#### 4.2 冻精使用情况图

**4.2.1 常规冻精使用分布图**
```
纵轴: 配种日期（按季度）
横轴: 公牛NAAB号
显示: 散点图 + 使用频次热力图
```

**4.2.2 性控冻精使用分布图**
```
纵轴: 配种日期（按季度）
横轴: 公牛NAAB号
显示: 散点图 + 使用频次热力图
```

#### 4.3 公牛使用排名（不需要）
```
列:
  - 排名
  - 公牛NAAB号
  - 类型（常规/性控）
  - 育种指数得分
  - NM$
  - TPI
  - ... (其他性状)
```

#### 4.4 公牛各年份使用明细表（展示每年不同类型*常规、性控）使用的公牛有哪些，及歌关键形状；添加一个对比行为数据库中的最高值、最低值）
```
列:
  - 公牛NAAB号（各公牛号及最高值、最小值）
  - 冻精类型（常规/性控）
  - 公牛NM$
  - 公牛TPI
  - ... (其他性状)
  - 
```

---

### Sheet 5: 已配公牛隐性基因分析

#### 5.1 隐性基因汇总表
```
列:
  - 基因名称（HH1, HH2, HH3, HH4, HH5等）
  - 携带公牛数
  - 配种头次
  - 占总配种比例
```

#### 5.2 按基因分类统计（这个应该是根据配种记录预测的后代的情况）
```
这个就是按照印象基因分析里面的类型统计：如 安全、高风险、数据不完整

头次 + 占比
```

#### 5.3 隐性基因明细表
```
列:
  - 配种日期
  - 母牛号
  - 公牛NAAB号
  - HH1状态
  - HH2状态
  - HH3状态
  - HH4状态
  - HH5状态
  - BL状态
  - ... (其他基因)
```

---

### Sheet 6: 已配公牛近交系数分析

#### 6.1 近交系数分布汇总
```
近交区间          配种头次    占比      风险等级
>12.5%           xxx        xx%      高风险 (红色)
6.25%-12.5%      xxx        xx%      中风险 (黄色)
3.125%-6.25%     xxx        xx%      低风险 (绿色)
<3.125%          xxx        xx%      安全 (绿色)
合计             xxx        100%
```

**格式化：**
- >12.5% 行背景红色
- 6.25-12.5% 行背景黄色

#### 6.2 高近交风险汇总表 (>6.25%)
```
列:
  - 母牛号
  - 公牛NAAB号
  - 近交系数
  - 配种日期
```

#### 6.3 近交系数明细表（全部配种事件）
```
列:
  - 配种日期
  - 母牛号
  - 公牛NAAB号
  - 近交系数
  - 风险等级
```

---

### Sheet 7: 备选公牛排名

#### 7.1 综合排名表
```
列:
  - 排名（按照育种指数得分）
  - 公牛NAAB号
  - 育种指数得分
  - NM$
  - TPI
  - 产奶PTA
  - 乳脂PTA
  - 乳蛋白PTA
等性状
```

#### 7.2 按性状排名（不需要）
```
多个子表:
  - NM$ Top 50
  - TPI Top 50
  - 产奶 Top 50
  - 健康性状 Top 50
  - ...
```

#### 7.3 公牛详细信息（汇总到综合排名表就行，后面多家几列即可）
```
列:
  - 公牛NAAB号
  - 品种
  - 出生日期
  - 所有性状详细数据
  - 隐性基因状态
  - 可用性状态
  - 冻精库存
  - 价格等级
```

---

### Sheet 8: 个体选配推荐结果（直接把个体选配的结果表完整的放到这里就行）

#### 8.1 选配结果汇总（不需要）
```
统计信息:
  - 参与选配母牛数
  - 成功选配数
  - 未选配数
  - 平均后代预期NM$
  - 平均近交系数
  - 平均遗传进展
```

#### 8.2 选配方案详细表（不需要）
```
列:
  - 母牛号
  - 母牛当前胎次
  - 母牛NM$
  - 推荐公牛1 (NAAB号)
  - 公牛1 NM$
  - 后代预期NM$
  - 近交系数
  - 遗传缺陷风险
  - 推荐公牛2 (备选)
  - 公牛2信息
  - 推荐公牛3 (备选)
  - 公牛3信息
  - 选配原因
  - 注意事项
```

#### 8.3 未选配母牛明细（不需要）
```
列:
  - 母牛号
  - 未选配原因
  - 约束条件
  - 建议措施
```

---

## 🎨 格式规范

### 通用格式
```
标题行:
  - 背景色: 深蓝色 (#2E5C8A)
  - 字体: 白色、加粗、12pt
  - 边框: 全边框

数据行:
  - 奇数行: 白色背景
  - 偶数行: 浅灰色 (#F5F5F5)
  - 边框: 细边框

合计行:
  - 背景色: 浅蓝色 (#D6E9F8)
  - 字体: 加粗

数值格式:
  - 整数: 千分位分隔符
  - 小数: 保留1-2位
  - 百分比: 1位小数 + %
  - 日期: YYYY-MM-DD
```

### 条件格式
```
风险标识:
  - 高风险: 红色背景 (#FFE6E6)
  - 中风险: 黄色背景 (#FFF9E6)
  - 低风险: 绿色背景 (#E6F9E6)

性能标识:
  - 优秀 (>平均+1SD): 深绿色
  - 良好 (>平均): 浅绿色
  - 一般 (平均±1SD): 白色
  - 较差 (<平均): 浅红色
```

### 图表嵌入
```
- 柱状图: 宽度8列，高度20行
- 折线图: 宽度10列，高度25行
- 散点图: 宽度12列，高度30行
- 正态分布图: 宽度10列，高度25行
```

---

## 🔧 技术实现

### 数据来源
```
优先级1: 从项目文件夹读取已生成的Excel文件
  - 路径: {project_folder}/分析结果/
  - 优势: 快速、一致、无需重算

优先级2: 如果文件不存在，（提醒用户缺少什么，需要干什么）

```

### 生成流程
```
1. 用户点击"生成Excel报告"按钮
2. 检查项目文件夹完整性
3. 读取各分析模块的结果文件
4. 按Sheet顺序生成数据
5. 应用格式化规则
6. 嵌入图表（可选）
7. 保存到项目文件夹
8. 提示用户完成
```

### 性能优化
```
- 使用openpyxl库
- 分Sheet并行写入
- 图表按需生成
- 大数据集分页显示
```

---


---

## ❓ 待确认问题

1. **图表嵌入**：Excel中是否需要嵌入图表（柱状图、折线图等）？（需要）


2. **数据更新**：如果用户重新分析了某个模块，Excel是否自动更新？（不需要考虑）
   - 建议：手动重新生成，避免数据不一致

3. **多牧场对比**：对比数据的模板格式需要详细定义（牧场名+关键性状分析中的各性状）
   - 建议：先提供一个简化版本，后续迭代

4. **文件大小**：包含所有明细数据可能导致文件很大（包括明细表，这些明细表应该都是把已生成的表的数据直接使用的，大部分不需要重新计算）
  

---

**最后更新:** 2025-10-07
**文档状态:** 待确认
