# 缺失公牛自动上传功能使用说明

## 📋 功能概述

当您上传备选公牛数据时，系统会**自动检测本地数据库中不存在的公牛**，并将其上传到云端的缺失公牛记录表（miss_bull）。

## ✨ 功能特点

1. ✅ **自动检测** - 无需手动操作，上传即检测
2. ✅ **智能保留** - 格式异常的NAAB号也会保留并上传
3. ✅ **详细提醒** - 多处提示确保用户了解异常情况
4. ✅ **不阻断流程** - 即使上传失败也不影响主要操作

## 🔔 用户提醒机制

### 提醒1: NAAB号格式异常警告

**触发时机**: 上传备选公牛时，发现格式不符合标准的冻精号

**提示内容**:
```
【窗口标题】公牛NAAB号格式异常

【主要信息】
发现 X 个格式异常的冻精号

【详细说明】
这些冻精号不符合标准NAAB格式，已保留原值并将上传到云端缺失公牛记录。

建议您检查原始数据是否正确。

【详细信息】（点击"详细信息"查看）
• NAAB号中未找到品种字母: 13113261
• NAAB公牛号的站号超过3位: 123456HO12345
... 更多错误
```

**标准NAAB格式说明**:
- 正确格式: `站号(1-3位) + 品种字母(1-2位) + 编号(1-5位)`
- 示例: `007HO16284` (站号007 + 品种HO + 编号16284)
- 品种代码: HO(荷斯坦)、JE(娟姗)、BS(瑞士褐牛)等

**建议操作**:
1. 检查原始Excel文件中的bull_id列
2. 核对是否有输入错误（如缺少品种字母、站号过长等）
3. 如果确认数据正确，可点击"确定"继续

---

### 提醒2: 缺失公牛上传成功通知

**触发时机**: 成功将缺失公牛上传到云端后

**提示内容**:
```
【窗口标题】缺失公牛已上传

【主要信息】
在本地数据库中未找到 X 个公牛

【详细说明】
这些公牛的信息已自动上传到云端缺失公牛记录表。

建议您稍后更新本地数据库，或联系管理员添加这些公牛的完整信息。

【详细信息】（点击"详细信息"查看）
缺失公牛列表：

• 007HO16284
• 007HO16385
• 151HO04449
• 13113261
... 更多公牛
```

**建议操作**:
1. 记录缺失公牛的NAAB号
2. 通过"数据管理" → "更新本地数据库"功能更新数据库
3. 或联系管理员，请求添加这些公牛的完整遗传评估数据

---

### 提醒3: 缺失公牛上传失败警告

**触发时机**: 检测到缺失公牛，但上传到云端失败

**提示内容**:
```
【窗口标题】缺失公牛上传失败

【主要信息】
发现 X 个缺失公牛，但上传到云端失败

【详细说明】
请检查网络连接后重试，或联系技术支持。

缺失的公牛信息可能影响后续的选配计算结果。
```

**可能原因**:
- 网络连接问题
- 云端API服务暂时不可用
- 请求超时

**建议操作**:
1. 检查网络连接是否正常
2. 稍后重新上传备选公牛数据
3. 如问题持续，联系技术支持查看API服务状态

## 📊 完整操作流程

```
步骤1: 准备备选公牛Excel文件
  ↓
步骤2: 在软件中选择"数据上传" → "备选公牛数据"
  ↓
步骤3: 选择Excel文件并上传
  ↓
【自动执行】数据标准化处理
  ├─ 格式化NAAB号
  └─ 如有格式异常 → 🔔 提醒1: 格式异常警告
  ↓
【自动执行】检查本地数据库
  ├─ 查询每个公牛是否存在
  └─ 收集缺失公牛列表
  ↓
【自动执行】上传缺失公牛到云端
  ├─ 成功 → 🔔 提醒2: 上传成功通知
  └─ 失败 → 🔔 提醒3: 上传失败警告
  ↓
步骤4: 完成！可以继续进行选配计算
```

## 🔍 日志输出示例

控制台会输出详细的处理日志，便于追踪：

```
[DEBUG-BULL-PREPROCESS] 开始处理 37 条备选公牛记录
[DEBUG-BULL-PREPROCESS] 保留格式异常的NAAB号: 13113261
[DEBUG-BULL-PREPROCESS] ⚠️ 发现 1 个格式异常的NAAB号，将保留原值
[DEBUG-BULL-PREPROCESS] 这些公牛在查询时会被识别为缺失公牛并上传到云端
[DEBUG-BULL-PREPROCESS]   - NAAB号中未找到品种字母: 13113261
[DEBUG-BULL-PREPROCESS] 处理完成，保留所有 37 条记录

[检查点-上传] 开始检查本地数据库中的缺失公牛...
[检查点-上传] 本地数据库路径: /Users/xxx/.genetic_improve/local_bull_library.db
[检查点-上传] 需要检查 37 个公牛
[检查点-上传] 缺失公牛: 007HO16284
[检查点-上传] 缺失公牛: 007HO16385
[检查点-上传] 缺失公牛: 151HO04449
... (更多缺失公牛)
[检查点-上传] 共发现 30 个缺失公牛
[检查点-上传] 准备上传缺失公牛到云端...
[检查点-上传] 用户名: cs
[检查点-上传] 调用API上传 30 条记录...
成功上传 30 条缺失公牛记录到云端
[检查点-上传] ✅ 成功上传 30 个缺失公牛到云端
[检查点-上传] 缺失公牛检查完成
```

## 📝 数据库记录

上传的缺失公牛会保存到云端PolarDB数据库的 `miss_bull` 表中：

**表结构**:
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 自增主键 |
| bull | VARCHAR(50) | 公牛NAAB编号 |
| source | VARCHAR(100) | 数据来源 (固定为 `bull_upload`) |
| time | DATETIME | 上传时间 |
| user | VARCHAR(50) | 用户名 |
| created_at | TIMESTAMP | 记录创建时间 |

**查询示例**:
```sql
-- 查看今天上传的缺失公牛
SELECT bull, time, user
FROM miss_bull
WHERE DATE(time) = CURDATE()
  AND source = 'bull_upload'
ORDER BY time DESC;

-- 统计某个用户上传的缺失公牛数量
SELECT COUNT(*) as total
FROM miss_bull
WHERE user = 'cs'
  AND source = 'bull_upload';
```

## ❓ 常见问题

### Q1: 为什么会有格式异常的NAAB号？

**A**: 可能原因：
1. 原始数据录入错误（如遗漏品种字母）
2. 非标准格式的公牛编号（如国产公牛编号）
3. Excel复制粘贴导致的格式问题

### Q2: 格式异常的NAAB号会影响后续计算吗？

**A**:
- **会保留**: 异常数据会保留在项目文件中
- **会上传**: 会标记为缺失公牛并上传到云端
- **影响计算**: 在性状评估和选配计算中，这些公牛的遗传数据会显示为缺失，影响该公牛的评分和排名

### Q3: 如何解决缺失公牛的问题？

**A**: 两种方式：
1. **更新本地数据库**: 通过"数据管理" → "更新本地数据库"，从云端同步最新的公牛库数据
2. **联系管理员**: 如果公牛确实是新引进的，需要联系管理员添加该公牛的完整遗传评估数据

### Q4: 上传失败怎么办？

**A**:
1. 检查网络连接
2. 稍后重新上传备选公牛数据（系统会再次检测并上传）
3. 如果问题持续，联系技术支持

### Q5: 能否批量导入缺失公牛的完整数据？

**A**:
- 目前缺失公牛只记录NAAB编号，不包含遗传评估数据
- 完整数据需要从CDCB等官方渠道获取
- 管理员可以通过后台批量导入到 bull_library 表

## 📞 技术支持

如遇到以下情况，请联系技术支持：
- 多次上传失败
- 大量格式异常的NAAB号（超过50%）
- 需要批量添加缺失公牛的完整数据
- 其他异常情况

---

**文档版本**: v1.0
**最后更新**: 2025-01-07
**适用版本**: v1.2.0.4+
