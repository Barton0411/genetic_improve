# RPD: 选配策略设计与未来牛群预测系统（这个不是系统，是嵌入到选配系统中的一项功能）



**文档版本**: v0.1
**创建日期**: 2025-11-08
**作者**: 王波臻
**状态**: 草稿 - 待讨论确认

---

## 1. 项目概述

### 1.1 系统名称（这个不是系统，是嵌入到选配系统中的一项功能）
选配策略设计与未来牛群预测系统（Mating Strategy Design & Herd Forecast System）

### 1.2 项目目标
开发一个集成系统，帮助牧场管理者：
1. **设计选配策略**：根据牛群现状和育种目标，制定合理的选配方案
2. **预测牛群发展**：模拟未来5年牛群数量、结构、繁殖、经济效益的变化
3. **优化决策**：通过对比不同策略方案，选择最优的选配和管理策略
4. **资源规划**：预测冻精使用量、成本投入、收益产出

### 1.3 系统定位
- **用户群体**：牧场管理者、育种技术人员、技术服务团队
- **使用场景**：
  - 年度育种计划制定
  - 选配策略调整评估
  - 投资回报分析
  - 冻精采购计划
- **集成方式**：不需要独立GUI应用；继承到系统的核心模块

---

## 2. 核心需求

### 2.1 功能需求（基础数据能从原系统中已上传的数据的，直接提取，且运行修改；没有数据的允许使用UI录入和模板导入）（把几个关键的逻辑需要重新讨论一下，尤其是未来需求牛头数（成母牛、后备牛等）、使用选配方案后预测未来牛头数（每年的基础数据可以调整（如选配策略、淘汰、损失等））、未来每年牛头数的算法也需要调整（选配策略计算器的算法不是按照年度产出的、未来牛群规模预测不是按照受胎率预测的；我希望的是根据不同配次不同配种方式的受胎率计算，结合预测的配准日期、在胎天数，这样就知道什么时候产犊的了，通过这个计算得到未来每年的牛头数，但是对于预测方式我现在还是不知道哪种好，是根据每头牛现有的数据（配次、胎次、遗传水平、泌乳天数、在胎天数等数据）再结合群体数据淘汰率、受胎率等预测未来个体牛数据，然后确认预测牛头数还是怎么办，你的建议是什么？）

#### F1: 牛群基础数据管理
- **F1.1**: 支持输入/导入当前牛群基础数据
  - 成母牛数量、后备牛数量
  - 泌乳牛占比
  - 胎次分布
  - 各阶段牛只占比（哺乳犊牛、断奶犊牛、育成牛、青年牛）
- **F1.2**: 支持从Excel导入历史数据
- **F1.3**: 数据校验（合理性检查）

#### F2: 繁殖参数配置
- **F2.1**: 生理参数设置
  - 淘汰率（成母牛、后备牛）- 按年份可配置
  - 胚胎损失率
  - 受胎率（按冻精类型、配种次数、牛群类别）
  - 母犊率（按冻精类型）
  - 性成熟率、繁殖启动率
- **F2.2**: 支持参数随年份变化（5年独立配置）
- **F2.3**: 参数模板保存与加载

#### F3: 选配策略设计
- **F3.1**: 成母牛选配策略（A/B/C组）
  - 定义各组占比（A0, B0, C0）
  - 为各组分配冻精类型（常规/性控/肉牛）
  - 配置各组配种次数策略（1配-4配）
- **F3.2**: 后备牛选配策略（D/E/F组）
  - 定义各组占比（D0, E0, F0）
  - 为各组分配冻精类型
  - 配置配种次数策略
- **F3.3**: 多方案管理
  - 创建、保存、加载多个策略方案
  - 方案命名和描述
  - 方案对比功能

#### F4: 牛群预测模拟
- **F4.1**: 5年逐年模拟
  - 基于当前牛群数据
  - 应用选配策略
  - 应用繁殖参数
  - 模拟淘汰、配种、产犊、育成全过程
- **F4.2**: 输出年度预测数据
  - 各类牛只数量（总头数、泌乳牛、干奶牛、后备牛、各阶段犊牛）
  - 胎次分布
  - 配种情况（配种头次、受胎头数、受胎率）
  - 产犊情况（母犊、公犊、肉犊数量）
  - 淘汰情况
- **F4.3**: 累计数据统计
  - 5年累计产犊数
  - 5年累计淘汰数
  - 牛群增长率

#### F5: 冻精使用量计算
- **F5.1**: 按年度计算各类冻精使用量
  - 常规冻精
  - 性控冻精
  - 肉牛冻精
- **F5.2**: 按选配组统计使用量
- **F5.3**: 5年累计使用量汇总

#### F6: 成本与收益计算（成本这里就设计冻精使用和后备牛价值的预测就行，关于奶量、饲养、健康的不涉及）
- **F6.1**: 成本计算
  - 饲养成本（按牛只类别、饲养天数）
  - 冻精成本（按类型、使用量）
  - 配种操作成本
  - 健康管理成本（可选）
- **F6.2**: 收益计算
  - 牛奶销售收入（泌乳牛 × 日单产 × 泌乳天数 × 奶价）
  - 牛只销售收入（淘汰牛、公犊、肉犊）
- **F6.3**: 利润分析
  - 年度净利润
  - 5年累计利润
  - 投资回报率

#### F7: 策略对比分析（设计可以储存的，然后对比关键预设、录入等原策略信息，对比结果预测）
- **F7.1**: 多方案并行模拟
  - 同时运行2-5个策略方案
  - 使用相同的基础数据和繁殖参数
- **F7.2**: 对比指标
  - 第5年总头数
  - 5年累计产犊数
  - 5年累计收益/成本/利润
  - 冻精使用总量和成本
  - 牛群质量指标（平均TPI/NM$变化 - 可选扩展）
- **F7.3**: 对比结果可视化
  - 对比表格
  - 对比图表（柱状图、折线图）

#### F8: 结果展示与导出
- **F8.1**: 表格展示
  - 年度详细数据表
  - 可按年份、指标筛选
  - 可排序
- **F8.2**: 图表展示
  - 牛群数量趋势图
  - 收益成本趋势图（不需要）
  - 冻精使用量分布图
  - 策略对比图
- **F8.3**: 数据导出
  - 导出Excel报告（多sheet）
  - 导出PDF报告（可选）
  - 导出图表图片

### 2.2 非功能需求

#### NF1: 性能要求
- 单次5年模拟计算时间 < 2秒
- 5个方案并行对比计算时间 < 10秒
- 支持1万头以上牛群规模

#### NF2: 可用性要求
- 界面友好，操作直观
- 参数输入有合理默认值
- 参数输入有范围校验和提示
- 关键操作有确认提示

#### NF3: 可维护性要求
- 核心算法模块独立，可被其他系统调用
- 代码结构清晰，注释完善
- 参数可配置，避免硬编码

#### NF4: 扩展性要求
- 预留与Excel报告系统集成接口
- 预留与PPT报告系统集成接口
- 支持未来扩展到10年预测

---

## 3. 系统架构设计

### 3.1 整体架构（需要结合上面的修改重新调整，另外参数配置界面可能设计过多，是不是需要选项卡）

```
┌─────────────────────────────────────────────────┐
│           GUI Layer (PyQt6)                     │
│  ┌─────────────┬──────────────┬──────────────┐ │
│  │ 参数配置界面 │ 预测结果界面 │ 策略对比界面 │ │
│  └─────────────┴──────────────┴──────────────┘ │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│         Business Logic Layer                    │
│  ┌──────────────────────────────────────────┐  │
│  │   StrategyDesigner (选配策略设计器)       │  │
│  │   - 创建/编辑策略方案                     │  │
│  │   - 验证策略合理性                       │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │   HerdSimulator (牛群预测模拟器)          │  │
│  │   - 5年逐年模拟                          │  │
│  │   - 配种、产犊、淘汰计算                  │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │   StrategyComparator (策略对比器)         │  │
│  │   - 多方案并行模拟                        │  │
│  │   - 结果对比分析                         │  │
│  └──────────────────────────────────────────┘  │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│           Core Calculation Layer                │
│  ┌──────────────┬──────────────┬─────────────┐ │
│  │ 繁殖计算引擎  │ 冻精用量计算  │ 成本收益计算 │ │
│  │ BreedingCalc │ SemenCalc    │ FinanceCalc │ │
│  └──────────────┴──────────────┴─────────────┘ │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│            Data Layer                           │
│  ┌──────────────┬──────────────┬─────────────┐ │
│  │ 参数管理      │ 结果存储      │ 数据导入导出 │ │
│  │ ParamManager │ ResultStore  │ DataIO      │ │
│  └──────────────┴──────────────┴─────────────┘ │
└─────────────────────────────────────────────────┘
```

### 3.2 模块划分（前面逻辑讨论确定完再设计）

#### 模块1: 数据模型 (data_models.py)
```python
@dataclass
class HerdBaseData:
    """牛群基础数据"""
    cow_count: int              # 成母牛头数
    heifer_count: int           # 后备牛头数
    milking_cow_rate: float     # 泌乳牛占比
    parity_distribution: dict   # 胎次分布 {1: 比例, 2: 比例, 3+: 比例}
    stage_distribution: dict    # 阶段分布（后备牛细分）

@dataclass
class ReproductionParams:
    """繁殖参数"""
    culling_rate_cow: list[float]       # 成母牛淘汰率 [年1, 年2, ..., 年5]
    culling_rate_heifer: list[float]    # 后备牛淘汰率
    embryo_loss_rate: float             # 胚胎损失率
    female_rate_conventional: float     # 常规冻精母犊率
    female_rate_sexed: float            # 性控冻精母犊率
    conception_rates: dict              # 受胎率 {冻精类型: {牛群类别: [1配, 2配, 3配, 4配]}}
    breeding_heifer_rate: float         # 适配后备牛比例

@dataclass
class MatingStrategy:
    """选配策略"""
    strategy_name: str
    cow_groups: dict  # {"A": {"ratio": 0.2, "semen_type": "sexed", "attempts": [1,2,3,4]}, ...}
    heifer_groups: dict  # {"D": {...}, ...}

@dataclass
class CostParams:
    """成本参数"""
    feeding_costs: dict         # {牛只类别: 元/天}
    semen_costs: dict           # {冻精类型: 元/支}
    breeding_operation_cost: float  # 配种操作费 元/次
    milk_price: float           # 奶价 元/kg
    milk_production: list[float]  # 日单产 [年1, 年2, ..., 年5] kg/天

@dataclass
class YearlyResult:
    """年度预测结果"""
    year: int
    population: dict            # 各类牛只数量
    parity_distribution: dict   # 胎次分布
    breeding: dict              # 配种情况
    calving: dict               # 产犊情况
    culling: dict               # 淘汰情况
    semen_usage: dict           # 冻精使用量
    financials: dict            # 财务数据
```

#### 模块2: 繁殖计算引擎 (breeding_engine.py)
```python
class BreedingEngine:
    """繁殖计算核心逻辑"""

    def calculate_breeding(self,
                          breeding_population: int,
                          group_config: dict,
                          conception_rates: list,
                          female_rate: float) -> dict:
        """
        计算单个组的配种结果

        参数:
            breeding_population: 参与配种头数
            group_config: 组配置（占比、冻精类型、配种次数）
            conception_rates: 受胎率列表 [1配, 2配, 3配, 4配]
            female_rate: 母犊率

        返回:
            {
                "total_breedings": 配种总头次,
                "conceived": 受胎头数,
                "failed": 空怀头数,
                "female_calves": 母犊数,
                "male_calves": 公犊数,
                "semen_used": 冻精使用支数
            }
        """

    def calculate_calf_survival(self,
                                calves_born: int,
                                embryo_loss_rate: float) -> int:
        """计算存活犊牛数（扣除胚胎损失）"""

    def calculate_heifer_growth(self,
                               calves: dict,
                               stage_distribution: dict,
                               maturity_rate: float) -> dict:
        """计算后备牛生长流转（犊牛→育成牛→青年牛→成母牛）"""
```

#### 模块3: 牛群模拟器 (herd_simulator.py)
```python
class HerdSimulator:
    """5年牛群模拟器"""

    def __init__(self,
                 base_data: HerdBaseData,
                 reproduction_params: ReproductionParams,
                 mating_strategy: MatingStrategy,
                 cost_params: CostParams):
        self.base_data = base_data
        self.repro_params = reproduction_params
        self.strategy = mating_strategy
        self.cost_params = cost_params
        self.breeding_engine = BreedingEngine()
        self.finance_calc = FinanceCalculator()

    def simulate_5_years(self) -> dict[int, YearlyResult]:
        """
        运行5年模拟

        返回: {1: YearlyResult, 2: YearlyResult, ..., 5: YearlyResult}
        """
        results = {}
        current_herd = self._initialize_herd()

        for year in range(1, 6):
            yearly_result = self._simulate_one_year(current_herd, year)
            results[year] = yearly_result
            current_herd = self._prepare_next_year_herd(yearly_result)

        return results

    def _simulate_one_year(self, herd: dict, year: int) -> YearlyResult:
        """模拟单年"""
        # 1. 计算参与配种的牛只
        # 2. 按策略分组配种（A/B/C/D/E/F）
        # 3. 计算产犊
        # 4. 计算淘汰
        # 5. 计算后备牛流转
        # 6. 计算冻精使用量
        # 7. 计算成本收益
        # 8. 返回年度结果
```

#### 模块4: 策略对比器 (strategy_comparator.py)
```python
class StrategyComparator:
    """策略对比分析"""

    def compare_strategies(self,
                          base_data: HerdBaseData,
                          reproduction_params: ReproductionParams,
                          cost_params: CostParams,
                          strategies: list[MatingStrategy]) -> pd.DataFrame:
        """
        对比多个策略

        返回: 对比结果DataFrame
        """
        results = []
        for strategy in strategies:
            simulator = HerdSimulator(base_data, reproduction_params, strategy, cost_params)
            five_year_results = simulator.simulate_5_years()
            summary = self._summarize_results(strategy.strategy_name, five_year_results)
            results.append(summary)

        return pd.DataFrame(results)

    def _summarize_results(self, strategy_name: str, results: dict) -> dict:
        """汇总5年结果为对比指标"""
        return {
            "策略名称": strategy_name,
            "第5年总头数": results[5].population['total'],
            "5年累计产犊": sum(r.calving['total'] for r in results.values()),
            "5年累计收益(万元)": sum(r.financials['revenue'] for r in results.values()) / 10000,
            "5年累计成本(万元)": sum(r.financials['total_cost'] for r in results.values()) / 10000,
            "5年累计利润(万元)": sum(r.financials['net_profit'] for r in results.values()) / 10000,
            # ...
        }
```

---



----------------------（以下内容仍需根据以上内容修改）



## 4. 核心算法逻辑（待确认）

### 4.1 配种计算逻辑

**问题1**: 参考代码中的配种计算逻辑是否准确？

参考代码逻辑：
```python
# A组: 占比20%, 4次配种机会, 受胎率[0.58, 0.48, 0.38, 0.28]
breeding_cows_A = total_breeding_cows * 0.2

# 1配: 58%受胎, 42%未受胎
attempt1_conceived = breeding_cows_A * 0.58
attempt1_failed = breeding_cows_A * 0.42

# 2配: 对1配失败的42%再配, 48%受胎
attempt2_conceived = attempt1_failed * 0.48
attempt2_failed = attempt1_failed * 0.52

# ... 依此类推到4配

# 总受胎 = 1配受胎 + 2配受胎 + 3配受胎 + 4配受胎
# 冻精用量 = 1配用量 + 2配用量 + 3配用量 + 4配用量
```

**需要确认**:
- 这个逐次配种的概率计算逻辑是否符合实际？
- 是否需要考虑配种间隔时间（发情周期）？
- 是否需要考虑季节因素对受胎率的影响？

### 4.2 产犊与胚胎损失

**问题2**: 胚胎损失率如何应用？

参考代码逻辑：
```python
# 受胎后考虑胚胎损失
female_calves_born = total_conceived * female_rate * (1 - embryo_loss_rate)
male_calves_born = total_conceived * (1 - female_rate) * (1 - embryo_loss_rate)
```

**需要确认**:
- 胚胎损失率是一次性的还是孕期持续的？
- 是否需要区分早期流产、晚期流产、死胎？
- 产犊时间是否影响下一年的配种计划？

### 4.3 后备牛流转

**问题3**: 后备牛从犊牛到成母牛的流转周期如何计算？

```
母犊出生 → 哺乳犊牛(0-2月) → 断奶犊牛(2-6月) → 育成牛(6-13月)
         → 青年牛(13-24月,已配种) → 成母牛(产犊后)
```

**需要确认**:
- 各阶段的时间划分是否准确？
- 5年模拟中，是否需要精确到月份？还是简化为年度流转？
- 性成熟率、配种启动率如何设置？

### 4.4 淘汰计算

**问题4**: 淘汰发生在什么时间点？

**需要确认**:
- 成母牛淘汰是在配种前、配种后还是产犊后？
- 后备牛淘汰是因为生长不良还是配种失败？
- 淘汰率是否应该区分胎次？（1胎牛淘汰率 vs 3胎以上）

### 4.5 成本收益计算

**问题5**: 收益计算的细节

参考代码：
```python
milk_revenue = milking_cows * daily_production * 305 * milk_price
```

**需要确认**:
- 305天是标准泌乳天数，是否所有牛都按此计算？
- 是否需要考虑不同胎次的产奶量差异？
- 是否需要考虑淘汰牛、公犊、肉犊的销售收入？

---

## 5. 数据流设计

### 5.1 输入数据流

```
用户输入/Excel导入
    ↓
┌──────────────────┐
│  数据验证模块     │ → 校验范围、完整性、一致性
└────────┬─────────┘
         ↓
┌──────────────────┐
│  参数对象构建     │ → HerdBaseData, ReproductionParams, etc.
└────────┬─────────┘
         ↓
┌──────────────────┐
│  策略设计器       │ → MatingStrategy对象
└────────┬─────────┘
         ↓
    传递给模拟器
```

### 5.2 模拟计算流

```
模拟器初始化
    ↓
for year in 1..5:
    ├─ 1. 确定当年牛群结构
    │     - 成母牛数量和胎次分布
    │     - 后备牛数量和阶段分布
    │
    ├─ 2. 应用淘汰率
    │     - 计算淘汰头数
    │     - 更新牛群数量
    │
    ├─ 3. 确定配种牛群
    │     - 泌乳牛参配数量
    │     - 后备牛参配数量
    │
    ├─ 4. 执行配种计算
    │     - 按策略分组（A/B/C/D/E/F）
    │     - 逐次配种模拟（1配-4配）
    │     - 统计受胎头数和冻精用量
    │
    ├─ 5. 计算产犊
    │     - 应用胚胎损失率
    │     - 计算母犊、公犊、肉犊数量
    │
    ├─ 6. 后备牛流转
    │     - 犊牛→育成牛→青年牛→成母牛
    │     - 更新各阶段数量
    │
    ├─ 7. 成本收益计算
    │     - 饲养成本
    │     - 冻精和配种成本
    │     - 牛奶收入
    │     - 净利润
    │
    └─ 8. 保存年度结果
          ↓
    准备下一年初始牛群
    ↓
返回5年完整结果
```

### 5.3 输出数据流

```
模拟结果
    ↓
┌──────────────────┐
│  结果处理器       │ → 格式化、汇总、统计
└────────┬─────────┘
         ↓
    ┌────┴────┬──────────┬──────────┐
    ↓         ↓          ↓          ↓
  GUI展示  Excel导出   图表生成   策略对比
```

---

## 6. 界面设计（草图）

### 6.1 主界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  选配策略设计与未来牛群预测系统                   [最小化][关闭]│
├──────────────┬──────────────────────────────────────────────┤
│              │  当前方案: [默认方案 ▼]  [新建] [保存] [删除]  │
│  左侧导航     ├──────────────────────────────────────────────┤
│              │                                              │
│ □ 基础数据   │  [当前显示区域根据左侧导航切换]               │
│ □ 繁殖参数   │                                              │
│ □ 选配策略   │                                              │
│ □ 成本参数   │                                              │
│ ─────────    │                                              │
│ □ 开始预测   │                                              │
│ ─────────    │                                              │
│ □ 预测结果   │                                              │
│ □ 策略对比   │                                              │
│ ─────────    │                                              │
│ □ 数据导入   │                                              │
│ □ 结果导出   │                                              │
│              │                                              │
└──────────────┴──────────────────────────────────────────────┘
```

### 6.2 各界面详细设计

#### 界面1: 基础数据
```
┌─────────────────────────────────────────────┐
│  牛群基础数据配置                            │
├─────────────────────────────────────────────┤
│  当前牛群数量:                               │
│    成母牛头数: [5000      ] 头               │
│    后备牛头数: [2000      ] 头               │
│    泌乳牛占比: [80        ] %                │
│                                             │
│  胎次分布:                                   │
│    1胎牛占比: [35        ] %                 │
│    2胎牛占比: [30        ] %                 │
│    3胎+占比:  [35        ] %                 │
│                                             │
│  后备牛阶段分布:                             │
│    哺乳犊牛:   [20        ] %                │
│    断奶犊牛:   [25        ] %                │
│    育成牛:     [30        ] %                │
│    青年牛:     [25        ] %                │
│                                             │
│  [从Excel导入]            [重置为默认]       │
└─────────────────────────────────────────────┘
```

#### 界面2: 繁殖参数
```
┌─────────────────────────────────────────────┐
│  繁殖参数配置                                │
├─────────────────────────────────────────────┤
│  ☑ 启用多年差异化配置                        │
│                                             │
│  成母牛淘汰率:                               │
│    年份  | 1年  | 2年  | 3年  | 4年  | 5年  │
│    ─────┼──────┼──────┼──────┼──────┼───── │
│    淘汰率| 35%  | 32%  | 30%  | 30%  | 30%  │
│                                             │
│  后备牛淘汰率:                               │
│    年份  | 1年  | 2年  | 3年  | 4年  | 5年  │
│    ─────┼──────┼──────┼──────┼──────┼───── │
│    淘汰率| 10%  | 10%  | 10%  | 10%  | 10%  │
│                                             │
│  胚胎损失率: [18        ] %                  │
│                                             │
│  母犊率:                                     │
│    常规冻精: [47        ] %                  │
│    性控冻精: [88        ] %                  │
│                                             │
│  受胎率配置: [展开详细配置...]               │
│    (点击展开: 按冻精类型、牛群类别、配种次数) │
│                                             │
│  [加载模板] [保存为模板]      [重置为默认]   │
└─────────────────────────────────────────────┘
```

#### 界面3: 选配策略
```
┌─────────────────────────────────────────────┐
│  选配策略设计                                │
├─────────────────────────────────────────────┤
│  成母牛选配策略:                             │
│  ┌───┬──────┬──────────┬──────────────┐   │
│  │组 │ 占比 │ 冻精类型  │ 配种次数      │   │
│  ├───┼──────┼──────────┼──────────────┤   │
│  │ A │ 20%  │[性控▼]    │☑1 ☑2 ☑3 ☑4 │   │
│  │ B │ 50%  │[常规▼]    │☑1 ☑2 ☑3 ☐4 │   │
│  │ C │ 30%  │[肉牛▼]    │☑1 ☑2 ☐3 ☐4 │   │
│  └───┴──────┴──────────┴──────────────┘   │
│                              合计: 100%     │
│                                             │
│  后备牛选配策略:                             │
│  ┌───┬──────┬──────────┬──────────────┐   │
│  │组 │ 占比 │ 冻精类型  │ 配种次数      │   │
│  ├───┼──────┼──────────┼──────────────┤   │
│  │ D │ 60%  │[性控▼]    │☑1 ☑2 ☑3 ☐4 │   │
│  │ E │ 30%  │[常规▼]    │☑1 ☑2 ☐3 ☐4 │   │
│  │ F │ 10%  │[肉牛▼]    │☑1 ☐2 ☐3 ☐4 │   │
│  └───┴──────┴──────────┴──────────────┘   │
│                              合计: 100%     │
│                                             │
│  适配后备牛比例: [50        ] %              │
│    (未来一年参与配种的后备牛占总后备牛比例)   │
│                                             │
│  [验证策略合理性]                            │
└─────────────────────────────────────────────┘
```

#### 界面4: 预测结果
```
┌─────────────────────────────────────────────┐
│  5年牛群预测结果                             │
├─────────────────────────────────────────────┤
│  [年度数据表] [趋势图表] [冻精用量] [财务]   │
│  ──────────────────────────────────────────│
│  年度数据汇总:                               │
│  ┌────┬──────┬──────┬──────┬──────┬──────┐│
│  │指标│ 1年  │ 2年  │ 3年  │ 4年  │ 5年  ││
│  ├────┼──────┼──────┼──────┼──────┼──────┤│
│  │总数│ 7200 │ 7850 │ 8420 │ 8950 │ 9400 ││
│  │泌乳│ 3800 │ 4100 │ 4380 │ 4650 │ 4900 ││
│  │后备│ 2400 │ 2550 │ 2700 │ 2850 │ 3000 ││
│  │产犊│ 3500 │ 3750 │ 4000 │ 4200 │ 4380 ││
│  │淘汰│ 1400 │ 1350 │ 1280 │ 1250 │ 1220 ││
│  │收益│ 850  │ 920  │ 985  │1045  │1100  ││
│  │成本│ 620  │ 665  │ 710  │ 752  │ 790  ││
│  │利润│ 230  │ 255  │ 275  │ 293  │ 310  ││
│  └────┴──────┴──────┴──────┴──────┴──────┘│
│  * 收益/成本/利润单位: 万元                  │
│                                             │
│  [查看详细数据] [导出Excel] [导出图表]       │
└─────────────────────────────────────────────┘
```

#### 界面5: 策略对比
```
┌─────────────────────────────────────────────┐
│  选配策略对比分析                            │
├─────────────────────────────────────────────┤
│  选择对比方案:                               │
│    ☑ 保守策略  ☑ 均衡策略  ☑ 激进策略        │
│    ☐ 方案4     ☐ 方案5                       │
│                                             │
│  [开始对比计算]                              │
│  ──────────────────────────────────────────│
│  对比结果:                                   │
│  ┌────────┬──────┬──────┬──────┬──────┐   │
│  │  指标  │保守  │均衡  │激进  │ 最优 │   │
│  ├────────┼──────┼──────┼──────┼──────┤   │
│  │5年总数 │ 9200 │ 9400 │ 9650 │激进  │   │
│  │累计产犊│19800 │20500 │21200 │激进  │   │
│  │累计收益│ 4850 │ 5000 │ 5180 │激进  │   │
│  │累计成本│ 3520 │ 3650 │ 3820 │保守  │   │
│  │累计利润│ 1330 │ 1350 │ 1360 │激进  │   │
│  │性控用量│12500 │15800 │18600 │保守  │   │
│  │常规用量│ 8200 │ 7500 │ 6800 │激进  │   │
│  │肉牛用量│ 2800 │ 2200 │ 1800 │激进  │   │
│  │ROI     │37.8% │37.0% │35.6% │保守  │   │
│  └────────┴──────┴──────┴──────┴──────┘   │
│  * 收益/成本/利润单位: 万元, 冻精单位: 支     │
│                                             │
│  [查看对比图表] [导出对比报告]               │
└─────────────────────────────────────────────┘
```

---

## 7. 技术选型

### 7.1 开发语言
- **Python 3.9+**

### 7.2 核心库
- **PyQt6**: GUI框架
- **pandas**: 数据处理和结果存储
- **numpy**: 数值计算
- **openpyxl**: Excel读写
- **matplotlib**: 图表生成

### 7.3 代码组织
```
core/forecast/
├── __init__.py
├── models/
│   ├── __init__.py
│   ├── data_models.py          # 数据类定义
│   └── validators.py           # 数据验证
├── engines/
│   ├── __init__.py
│   ├── breeding_engine.py      # 繁殖计算引擎
│   ├── finance_calculator.py   # 财务计算
│   └── semen_calculator.py     # 冻精计算
├── simulators/
│   ├── __init__.py
│   ├── herd_simulator.py       # 牛群模拟器
│   └── strategy_comparator.py  # 策略对比器
├── utils/
│   ├── __init__.py
│   ├── data_io.py              # 数据导入导出
│   └── report_generator.py     # 报告生成
└── gui/
    ├── __init__.py
    ├── main_window.py          # 主窗口
    ├── widgets/                # 自定义控件
    │   ├── parameter_panel.py
    │   ├── result_table.py
    │   └── chart_panel.py
    └── dialogs/                # 对话框
        ├── import_dialog.py
        └── export_dialog.py
```

---

## 8. 开发计划

### 8.1 里程碑

#### Milestone 1: 核心算法实现 (3天)
- [ ] 数据模型定义
- [ ] 繁殖计算引擎实现
- [ ] 单年模拟逻辑实现
- [ ] 5年模拟逻辑实现
- [ ] 单元测试

#### Milestone 2: 计算器完善 (2天)
- [ ] 冻精用量计算
- [ ] 成本收益计算
- [ ] 策略对比功能
- [ ] 结果汇总和统计

#### Milestone 3: GUI开发 (3天)
- [ ] 主窗口框架
- [ ] 参数配置界面
- [ ] 结果展示界面
- [ ] 策略对比界面
- [ ] 数据导入导出

#### Milestone 4: 集成与测试 (2天)
- [ ] 模块集成
- [ ] 端到端测试
- [ ] 性能优化
- [ ] 用户文档

### 8.2 风险与依赖
- **风险1**: 繁殖计算逻辑复杂，需要仔细验证准确性
- **风险2**: 参数配置项多，界面设计需要平衡易用性和灵活性
- **依赖1**: 需要真实牧场数据进行测试验证
- **依赖2**: 需要领域专家确认算法逻辑

---

## 9. 待讨论问题清单

### 9.1 算法逻辑确认
- [ ] **Q1**: 配种计算逻辑（多次配种的概率计算）是否准确？
- [ ] **Q2**: 胚胎损失率的应用方式是否正确？
- [ ] **Q3**: 后备牛流转周期和各阶段时长如何定义？
- [ ] **Q4**: 淘汰发生在什么时间点？如何与配种、产犊协调？
- [ ] **Q5**: 收益计算是否需要考虑淘汰牛、公犊销售收入？
- [ ] **Q6**: 是否需要考虑季节因素、发情周期、配种间隔？

### 9.2 功能范围确认
- [ ] **Q7**: 第一版是否需要包含策略对比功能？还是作为二期？
- [ ] **Q8**: 是否需要支持从现有系统导入牛群数据？
- [ ] **Q9**: 是否需要数据库支持（保存历史方案、结果）？
- [ ] **Q10**: 导出功能需要哪些格式？（Excel必须，PDF可选？）

### 9.3 参数配置确认
- [ ] **Q11**: 5年的参数是全部独立配置，还是支持"使用第3年值"的简化模式？
- [ ] **Q12**: 受胎率参数矩阵很复杂（冻精类型×牛群类别×配种次数），是否需要简化输入方式？
- [ ] **Q13**: 默认参数值如何确定？是否有行业标准值？

### 9.4 界面设计确认
- [ ] **Q14**: 是否需要图表展示？需要哪些类型的图表？
- [ ] **Q15**: 是否需要支持方案模板（如"高产牧场模板"、"中小牧场模板"）？
- [ ] **Q16**: 是否需要"快速模式"（只输入关键参数，其他用默认值）？

---

## 10. 附录

### 10.1 术语表
- **成母牛**: 已产犊的母牛（胎次≥1）
- **后备牛**: 未产犊的母牛（胎次=0），包括犊牛、育成牛、青年牛
- **泌乳牛**: 正在产奶的成母牛
- **干奶牛**: 停止产奶的成母牛（怀孕后期或空怀）
- **胎次**: 母牛产犊次数
- **受胎率**: 配种后成功怀孕的比例
- **母犊率**: 产犊中母犊的比例
- **胚胎损失率**: 怀孕后流产、死胎的比例
- **淘汰率**: 因各种原因退出牛群的比例

### 10.2 参考资料
- 现有代码: `/Users/bozhenwang/projects/3. 编程项目/3. 选配策略计算器/`
  - `未来3年牛群预测-10.18.py`
  - `选配策略计算器-v2024.9.5-可储存数据.py`
- 需求文档: `docs/项目管理/新需求分析_2025-11-02.md`

### 10.3 变更记录
| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| v0.1 | 2025-11-08 | 初稿创建 | 王博真 |

---

**下一步**: 请审阅本RPD，确认或修改以下内容：
1. 功能范围是否完整？是否有遗漏或不需要的功能？
2. 核心算法逻辑部分的问题（Q1-Q6）
3. 界面设计是否符合预期？
4. 开发计划是否合理？

确认后我们可以开始详细的算法设计和编码实现。
