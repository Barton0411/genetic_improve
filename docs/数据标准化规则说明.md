# 数据标准化规则说明

## 支持的数据源系统

系统支持以下三种数据源格式，会根据列名自动识别：

| 系统 | 说明 |
|------|------|
| **伊起牛** | 默认数据格式 |
| **慧牧云** | 自动识别并转换列名 |
| **优源-DC305** | 自动识别并进行特殊数据清洗 |

---

## 一、母牛号（cow_id）

**处理方式：仅转为字符串，保持原值不变**

| 原始输入 | 标准化结果 |
|----------|------------|
| `151049230278` | `151049230278` |
| `12345` | `12345` |

---

## 二、公牛 NAAB 号

**适用字段：**
- 牛群信息表：`sire`（父号）、`mgs`（外祖父）、`mmgs`（外曾外祖父）
- 备选公牛表：`bull_id`
- 配种记录：`冻精编号`

**标准格式：`3位站号 + 2位品种码 + 5位序号`**（共10位）

示例：`029HO20616`

### 标准化步骤

| 步骤 | 规则 | 示例 |
|------|------|------|
| 0 | **去除前后缀标记** | `XK029HO20616` → `029HO20616` |
| 1 | 去除前导0 | `0029HO20616` → `29HO20616` |
| 2 | 站号补齐3位 | `29HO20616` → `029HO20616` |
| 3 | 品种码单字母→双字母 | `29H20616` → `029HO20616` |
| 4 | 品种码转大写 | `029ho20616` → `029HO20616` |
| 5 | 序号去除前导0后补齐5位 | `029HO616` → `029HO00616` |

### 自动去除的前后缀标记

以下标记会在格式化前自动去除（不区分大小写）：

| 标记 | 说明 |
|------|------|
| `XK` | 性控标记 |
| `SEX` | 性控标记 |
| `性控` | 中文性控标记 |
| `P` | 普通冻精标记 |
| `X` | 性控标记 |
| `S` | 性控标记 |
| `性` | 中文性控标记 |
| `普` | 中文普通冻精标记 |

**示例：**
| 原始输入 | 去除标记后 | 最终结果 |
|----------|-----------|----------|
| `XK029HO20616` | `029HO20616` | `029HO20616` |
| `SEX551HO04447` | `551HO04447` | `551HO04447` |
| `性控029HO19241` | `029HO19241` | `029HO19241` |
| `029HO20616P` | `029HO20616` | `029HO20616` |
| `029HO20616性控` | `029HO20616` | `029HO20616` |

### 品种码映射

| 单字母 | 双字母 | 品种 |
|--------|--------|------|
| H | HO | 荷斯坦 |
| J | JE | 娟姗 |
| B | BS | 瑞士褐牛 |
| A | AY | 爱尔夏 |
| G | GU | 更赛 |
| M | MO | 蒙贝利亚 |

### 标准化示例

| 原始输入 | 标准化结果 | 说明 |
|----------|------------|------|
| `29HO20616` | `029HO20616` | 站号补0 |
| `29H20616` | `029HO20616` | H→HO + 站号补0 |
| `029ho20616` | `029HO20616` | 转大写 |
| `29HO616` | `029HO00616` | 序号补0 |
| `0029HO20616` | `029HO20616` | 去除多余前导0 |
| `551HO04036` | `551HO04036` | 已是标准格式，不变 |

### 错误情况（标准化失败，返回空值）

| 情况 | 示例 | 说明 |
|------|------|------|
| 无品种字母 | `12345678` | 找不到品种码 |
| 站号超3位 | `1234HO12345` | 站号最多3位 |
| 序号超5位 | `029HO123456` | 序号最多5位 |
| 总长度超15位 | - | 异常数据 |

---

## 三、日期字段

**适用字段：** `birth_date`、`calving_date`、`配种日期`

**处理方式：** 转为标准日期格式

---

## 四、默认值填充规则

### 性别字段（sex）

| 原始值 | 处理结果 |
|--------|----------|
| 空值/NaN | 默认填充为 `母` |
| `母` | 保持不变 |
| `公` | 保持不变 |

### 品种字段（breed）

| 原始值 | 处理结果 |
|--------|----------|
| 空值/NaN | 默认填充为 `荷斯坦` |
| 其他值 | 保持不变 |

### 是否在场

**通用规则：**
| 原始值 | 处理结果 |
|--------|----------|
| 空值/NaN/空字符串 | 默认填充为 `是` |
| `是` | 保持不变 |
| `否` | 保持不变 |

**慧牧云特殊处理：** 根据"离场日期"字段推断

| 离场日期 | 是否在场 |
|----------|----------|
| 空/NaN/空字符串 | `是`（在场） |
| 有具体日期值 | `否`（离场） |

> 慧牧云系统没有"是否在场"字段，但有"离场日期"字段，系统会自动根据离场日期是否为空来推断牛只是否在场。

### 月龄（age）自动计算

当月龄字段为空时，系统会自动计算：

| 优先级 | 计算方式 | 公式 |
|--------|----------|------|
| 1 | 从日龄计算（DC305特有） | `月龄 = 日龄 / 30.44` |
| 2 | 从出生日期计算 | `月龄 = (当前年份 - 出生年份) × 12 + (当前月份 - 出生月份)` |

---

## 五、多系统列名映射

系统会自动识别以下不同系统的列名并转换为标准列名：

### 牛群信息表列名映射

| 标准列名 | 伊起牛 | 慧牧云 | 优源-DC305 |
|----------|--------|--------|------------|
| `cow_id` | 耳号 | 耳号 | 牛号 |
| `sire` | 父亲号 | 父号 | 公牛号 |
| `dam` | 母亲号 | 母号 | 母亲牛号 |
| `mgs` | 外祖父 | 外祖父 | 外祖父号 |
| `calving_date` | 最近产犊日期 | 产犊日期 | 产犊日期 |
| `birth_date` | 牛只出生日期 | 生日 | 生日 |
| `services_time` | 本胎次配次 | 配次 | 配种次数 |
| `milk_305` | 305奶量 | 305奶量 | 305ME |
| `repro_status` | 繁育状态 | 繁育状态 | 繁育代号 |
| `是否在场` | 是否在场 | **离场日期**（推断） | 是否在场 |

### 配种记录列名映射

| 标准列名 | 伊起牛 | 慧牧云 | 优源-DC305 |
|----------|--------|--------|------------|
| `耳号` | 耳号 | 耳号 | 牛号 |
| `配种日期` | 配种日期 | 事件日期 | 日期 |
| `冻精编号` | 冻精编号 | 冻精号 | 备注 |
| `冻精类型` | 冻精类型 | 是否性控* | 冻精类型 |

> *慧牧云的"是否性控"字段值会自动转换：`True/是/1` → `性控冻精`，其他 → `普通冻精`

---

## 六、DC305 特殊数据清洗

当数据来源为 **优源-DC305** 时，系统会进行以下特殊处理：

| 处理项 | 规则 |
|--------|------|
| 字符串去空格 | 所有字符串列去除首尾空格 |
| 空值识别 | `-` 和空字符串视为空值 |
| 母亲牛号 | `0` 视为空值 |
| 月龄计算 | 优先从日龄字段计算 |

---

## 七、慧牧云特殊处理

当数据来源为 **慧牧云** 时，系统会进行以下特殊处理：

| 处理项 | 规则 |
|--------|------|
| 是否在场 | 根据"离场日期"推断：空→在场，有值→离场 |
| 是否性控 | 自动转换为冻精类型：True/是/1→性控冻精 |

---

## 八、数据文件字段要求

### 1. 牛群信息表（必需）

| 标准字段名 | 伊起牛列名 | 慧牧云列名 | DC305列名 | 必填 | 说明 |
|------------|------------|------------|-----------|------|------|
| `cow_id` | 耳号 | 耳号 | 牛号 | ✅ | 牛只唯一标识 |
| `breed` | 品种 | 品种 | 品种 | | 空值默认"荷斯坦" |
| `sex` | 性别 | 性别 | 性别 | | 空值默认"母" |
| `sire` | 父亲号 | 父号 | 公牛号 | | NAAB号，自动标准化 |
| `mgs` | 外祖父 | 外祖父 | 外祖父号 | | NAAB号，自动标准化 |
| `dam` | 母亲号 | 母号 | 母亲牛号 | | 母亲耳号 |
| `mmgs` | 外曾外祖父 | 外曾外祖父 | 外曾外祖父 | | NAAB号，自动标准化 |
| `lac` | 胎次 | 胎次 | 胎次 | | 0=后备牛，≥1=成母牛 |
| `calving_date` | 最近产犊日期 | 产犊日期 | 产犊日期 | | 日期格式 |
| `birth_date` | 牛只出生日期 | 生日 | 生日 | ✅ | 日期格式 |
| `age` | 月龄 | 月龄 | 月龄 | | 空值时自动从日龄/出生日期计算 |
| `days_of_age` | - | - | 日龄 | | DC305特有，用于计算月龄 |
| `services_time` | 本胎次配次 | 配次 | 配种次数 | | 配种次数 |
| `DIM` | 泌乳天数 | 泌乳天数 | 泌乳天数 | | 数字 |
| `peak_milk` | 本胎次奶厅高峰产量 | - | - | | 数字 |
| `milk_305` | 305奶量 | 305奶量 | 305ME | | 数字 |
| `repro_status` | 繁育状态 | 繁育状态 | 繁育代号 | | 如：妊娠、空怀等 |
| `是否在场` | 是否在场 | **离场日期** | 是否在场 | | 慧牧云根据离场日期推断 |

### 2. 配种记录（可选）

| 标准字段名 | 伊起牛列名 | 慧牧云列名 | DC305列名 | 必填 | 说明 |
|------------|------------|------------|-----------|------|------|
| `耳号` | 耳号 | 耳号 | 牛号 | ✅ | 母牛耳号 |
| `配种日期` | 配种日期 | 事件日期 | 日期 | ✅ | 日期格式 |
| `冻精编号` | 冻精编号 | 冻精号 | 备注 | ✅ | NAAB号，自动标准化 |
| `冻精类型` | 冻精类型 | 是否性控 | 冻精类型 | ✅ | 常规/性控 |

### 3. 备选公牛（可选）

| 字段名 | 必填 | 说明 |
|--------|------|------|
| `bull_id` | ✅ | NAAB号，会自动标准化（含去除前后缀标记） |
| `semen_type` | | 冻精类型 |

### 4. 体型外貌数据（可选）

| 字段名 | 必填 | 说明 |
|--------|------|------|
| `牧场` | ✅ | 牧场名称 |
| `牛号` | ✅ | 牛只耳号 |
| `体高` ~ `棱角性` | ✅ | 各项体型评分（1-9分） |

### 5. 基因组检测数据（可选）

支持多种基因组报告格式，系统会自动识别。关键字段包括：
- 牛只标识：`cow_id` / `Animal ID` / `Farm ID`
- 育种值：`TPI`、`NM$`、`MILK`、`FAT`、`PROT` 等
- 隐性基因：`HH1`-`HH6`、`BLAD` 等
