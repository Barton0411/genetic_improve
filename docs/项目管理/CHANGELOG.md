# 版本更新历史 (CHANGELOG)

**项目名称:** 伊利奶牛选配系统
**当前版本:** v1.2.0.14
**更新时间:** 2025-11-02

---

## 版本说明

本文档记录了系统的所有重要版本更新，包括新功能、bug修复、性能优化等。

**版本命名规则:**
- 主版本号.次版本号.修订号 (v1.2.0)
- 主版本号：重大架构变更或不兼容更新
- 次版本号：新功能添加（向后兼容）
- 修订号：bug修复和小改进

---

## [Unreleased] - 未来计划

### 计划新增功能
- 未来五年牛头数预测模块
- 选配方案对比预测
- 执行力验证功能
- 体型外貌分析
- 5分法匹配生产数据
- 智能分析（多目标优化选配）
- 数据完整性检测
- 选配结果推送功能
- 权限管理

详细计划见 [TODO_LIST.md](TODO_LIST.md)

---

## [v1.2.0.14] - 2025-11-02

### 🐛 Bug 修复
- **修复分批选配时育种指数丢失问题**
  - 问题：分批次选配时（先选1组，再选2组），先选的组的育种指数会消失
  - 修复文件：`core/matching/complete_mating_executor.py`
  - 解决方案：
    - 保留旧报告中存在但新报告中不存在的列
    - 当新值为空时保留旧值（非选配相关列）
  - 影响范围：选配报告合并逻辑

### ✨ 改进
- **禁用夜间模式跟随系统**
  - 软件固定使用浅色模式，不再跟随系统深色模式变化
  - 修改文件：
    - `gui/theme_manager.py` - 固定返回浅色模式
    - `main.py` - 强制设置浅色调色板
  - 提升用户体验一致性

- **修复导航栏布局问题**
  - 问题：导航项和版本信息之间有大片空白
  - 修复文件：`gui/main_window.py`
  - 解决方案：移除 `addStretch()` 导航列表自动填充空间
  - 界面更加紧凑美观

### 📚 文档
- ✅ 更新 `COMPLETED_TASKS.md` - 添加Sheet 8-17完成记录和最新bug修复
- ✅ 创建 `CHANGELOG.md` - 版本更新历史记录
- ✅ 更新 `TODO_LIST.md` v3.0 - 整合8个新需求，重新规划开发优先级
- ✅ 创建 `新需求分析_2025-11-02.md` - 详细需求分析和开发计划

---

## [v1.2.0.13] - 2025-10-28

### ✨ 新功能
- **Excel报告Sheet 14-17完成** (报告功能100%完成)
  - Sheet 14: 已用公牛性状汇总分析
    - 按年份汇总表（使用公牛数、配种头次）
    - 动态性状进展折线图（多组图表）
    - 性状进展数据表（逐年增长、年均增长、累计增长）
    - 全部配种记录时间线散点图
    - 近12个月配种记录时间线散点图

  - Sheet 15: 已用公牛性状明细
    - 按年份分Sheet展示公牛明细
    - 按精液类型（性控/常规）分Sheet
    - 完整育种性状数据

  - Sheet 16: 备选公牛排名
    - 按育种指数（TPI/NM$等）排名
    - 主要性状值展示
    - 多维度排序

  - Sheet 17: 选配推荐结果
    - 选配推荐明细表
    - 性控/常规精液分配
    - 近交系数和隐性基因标记

- **GitHub Actions OSS自动上传完成**
  - 配置阿里云OSS Secrets
  - 修改CI/CD workflow
  - 自动更新 `latest/version.json`
  - 减少手动发布操作

### 📚 文档
- 完成Excel报告生成实施方案v1.2

---

## [v1.2.0.12] - 2025-10-12

### 🐛 Bug 修复
- **修复配种记录处理中配种日期丢失的bug**
  - 问题：`processed_breeding_data.xlsx` 中配种日期字段为空
  - 原因：fillna操作将NaT转换为空字符串
  - 修复文件：配种记录数据处理模块
  - 解决方案：跳过日期列的fillna操作
  - 影响范围：配种记录数据处理、Sheet 11-13报告生成

---

## [v1.2.0.11] - 2025-10-12

### 🐛 Bug 修复
- **修复复合键库存管理系统的列引用错误**
  - 修复所有选配模块的 `classification` 列引用错误
  - 修复文件：
    - `core/matching/complete_mating_executor.py`
    - `core/matching/simple_recommendation_generator.py`
    - `core/matching/recommendation_generator.py`
    - `core/matching/group_preview_updater.py`
    - `core/matching/matrix_recommendation_generator.py`
    - `core/matching/individual_matcher.py`
  - 统一使用 `semen_type` 列

- **清理开发测试文件**
  - 删除26个开发测试文件
  - 清理冗余代码

### ✨ 改进
- 修复UI弹窗按钮大小不一致问题

---

## [v1.2.0.10] - 2025-10-11

### 🐛 Bug 修复
- **修复复合键库存管理系统的字典覆盖问题**
  - 问题：使用 (bull_id, semen_type) 作为键时，字典被覆盖导致库存丢失
  - 修复文件：`core/matching/complete_mating_executor.py`
  - 解决方案：正确管理复合键字典

- **修复类型与库存不匹配的分配错误**
  - 确保性控精液只分配给性控母牛
  - 确保常规精液只分配给常规母牛

---

## [v1.2.0.9] - 2025-10-10

### ✨ 新功能
- **复合键库存管理系统重构**
  - 使用 `(bull_id, semen_type)` 复合键管理库存
  - 支持同一公牛多种冻精类型独立管理
  - 删除冗余 `classification` 列，统一使用 `semen_type`
  - 提升库存管理准确性

### 📚 文档
- 创建复合键库存管理系统设计文档

---

## [v1.2.0.8] - 2025-10-08

### ✨ 新功能
- **Excel报告Sheet 11-13完成**
  - Sheet 11: 配种记录-隐性基因分析
    - 全部年份隐性基因纯合汇总表
    - 近12个月隐性基因纯合汇总表
    - 16种遗传缺陷基因分析

  - Sheet 12: 配种记录-近交系数分析
    - 近交系数分布表（全部配种+近12个月）
    - 4个分布图表
    - 年份趋势分析表

  - Sheet 13: 配种记录明细
    - 配种记录原始数据明细表

---

## [v1.2.0.7] - 2025-10-08

### ✨ 新功能
- 完善Excel报告数据收集器
- 优化报告生成性能（数据缓存机制）

---

## [v1.2.0.6] - 2025-10-07

### 📚 文档
- 创建文档体系
  - `docs/README.md` - 文档导航
  - `docs/开发文档/ARCHITECTURE.md` - 系统架构
  - `docs/开发文档/API_REFERENCE.md` - API参考
  - `docs/部署文档/CLOUD_SERVICES.md` - 云服务配置
  - `docs/项目管理/COMPLETED_TASKS.md` - 已完成清单
  - `docs/项目管理/TODO_LIST.md` - 待办清单

---

## [v1.2.0.5] - 2025-10-07

### ✨ 改进
- 优化缺失公牛上传提示信息
- 合并重复弹窗
- 简化技术细节提示

---

## [v1.2.0.4] - 2025-10-07

### ✨ 新功能
- **API地址统一**
  - 统一域名：`https://api.genepop.com`
  - 更新所有API调用配置
  - 测试通过

### ✨ 改进
- **缺失公牛上传优化**
  - 上传时即时检查本地数据库
  - 自动上传缺失公牛到云端
  - 格式错误NAAB号保留处理

- **用户界面改进**
  - 数据库版本显示在侧边栏
  - 简化用户提示信息

### 📚 文档
- 启动文档体系建设

---

## [v1.2.0.3] - 2025-09-30

### ✨ 新功能
- Excel报告Sheet 9-10完成（母牛指数分析）

---

## [v1.2.0.2] - 2025-09-25

### ✨ 新功能
- **OSS数据库分发机制**
  - 从API下载改为OSS直接下载
  - 版本检查机制（JSON文件）
  - 断点续传支持
  - 自动重试机制（3次）
  - 下载进度显示（MB + 百分比）

### 🚀 性能优化
- 下载速度提升60%
- 降低服务器压力
- 降低运营成本

---

## [v1.2.0.1] - 2025-08-20

### ✨ 新功能
- **缺失公牛智能预估**
  - 基于遗传趋势的数据补全
  - TPI趋势分析
  - NM$趋势分析
  - 数据质量可视化标记
  - 缺失记录云端上传

---

## [v1.2.0] - 2025-09-01

### ✨ 新功能
- Excel报告生成功能（Sheet 1-8）
  - Sheet 1-4: 牧场和牛群基础分析
  - Sheet 5-8: 育种性状分析（4个子表）

### 🚀 性能优化
- 选配算法优化（性能提升60%）
- 多线程数据处理
- 系谱缓存机制
- 数据库查询优化

### ✨ 改进
- UI/UX全面改进
- 深色/浅色模式支持
- 启动画面优化（视频播放）
- 进度条和加载提示

---

## [v1.1.0] - 2025-08-01

### ✨ 新功能
- **API服务上线**
  - 认证API（8081端口）
  - 数据API（8082端口）
  - Nginx反向代理配置

- **用户认证系统**
  - JWT令牌认证
  - 登录/注册对话框
  - 邀请码验证
  - 自动登录恢复

- **数据库云端化**
  - PolarDB MySQL集成
  - 本地SQLite缓存
  - 自动版本检查
  - 增量更新机制

### 🔒 安全性
- HTTPS全站加密
- SSL证书自动续期
- JWT令牌认证
- 数据库IP白名单

---

## [v1.0.0] - 2025-07-01

### ✨ 新功能 (初始版本)
- **基础设施**
  - 阿里云ECS服务器部署
  - 域名配置（genepop.com）
  - 阿里云OSS对象存储
  - PolarDB MySQL数据库

- **核心功能**
  - 牛只信息上传
  - 公牛性状数据上传
  - 系谱信息上传
  - 配种记录上传
  - 数据标准化处理

- **育种计算**
  - 母牛关键性状计算
  - 公牛关键性状计算
  - 育种指数计算（TPI, NM$等）
  - 系谱识别率统计

- **近交分析**
  - 6代系谱通经法计算
  - 近交系数阈值过滤
  - 系谱可视化展示

- **选配推荐**
  - 个体选配功能
  - 一键选配功能
  - 自动分组（A/B/C组）
  - 手动分组模式
  - 近交系数控制
  - 遗传缺陷控制
  - 冻精库存管理

- **报告生成**
  - PPT自动生成
  - Excel数据导出
  - 数据可视化图表

- **CI/CD**
  - GitHub Actions自动构建
  - Windows自动打包（.exe + .zip）
  - macOS自动打包（.app + .dmg）
  - GitHub Release自动创建

### 🎨 UI/UX
- PyQt6现代化界面
- 启动画面
- 进度条和加载提示
- 多线程处理（避免UI卡顿）

---

## 版本统计

### 总发布版本数
- 主版本：1个（v1.x）
- 次版本：2个（v1.1, v1.2）
- 修订版本：14个

### 功能完成度
- v1.0.0: 60% (基础功能)
- v1.1.0: 75% (API和认证)
- v1.2.0: 85% (报告和优化)
- v1.2.0.13: 95% (Excel报告100%完成)
- v1.2.0.14: 95% (文档整理完成)

### 开发时间线
```
2025-07: v1.0.0 - 项目启动
2025-08: v1.1.0 - API服务上线
2025-09: v1.2.0 - 报告生成和性能优化
2025-10: v1.2.0.1-13 - 功能完善和bug修复
2025-11: v1.2.0.14 - 文档整理和bug修复
```

---

## 贡献者

- **开发团队** - 全栈开发、系统架构、运维部署

---

## 参考文档

- [TODO_LIST.md](TODO_LIST.md) - 待办事项和新需求
- [ROADMAP.md](ROADMAP.md) - 项目路线图
- [COMPLETED_TASKS.md](COMPLETED_TASKS.md) - 已完成工作清单
- [新需求分析_2025-11-02.md](新需求分析_2025-11-02.md) - 新需求详细分析

---

**维护说明:**
- 每次版本发布后更新此文档
- 按时间倒序排列（最新版本在前）
- 使用语义化版本号
- 分类记录：新功能、Bug修复、性能优化、文档等

**最后更新:** 2025-11-02
