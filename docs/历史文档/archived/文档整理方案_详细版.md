# 项目文档整理方案 - 详细版

## 📋 目标
- 统一文档位置和命名
- 包含所有关键配置信息（密钥、密码、端口等）
- 记录已完成和待完成的工作
- 为未来项目扩展提供完整依据

---

## 📁 推荐文档结构

```
genetic_improve/
├── README.md                          # 项目简介、快速开始
├── CHANGELOG.md                       # 版本更新历史
│
├── docs/                              # 📚 所有文档统一放这里
│   ├── README.md                      # 文档导航索引
│   │
│   ├── 01-开发文档/
│   │   ├── DEVELOPMENT_GUIDE.md       # 开发指南（主文档）
│   │   ├── ARCHITECTURE.md            # 系统架构说明（详细）
│   │   ├── API_REFERENCE.md           # API接口文档
│   │   ├── DATABASE_SCHEMA.md         # 数据库表结构
│   │   ├── CODE_STYLE.md              # 代码规范
│   │   └── PROJECT_CONTEXT.md         # 项目背景和上下文
│   │
│   ├── 02-部署文档/
│   │   ├── DEPLOYMENT_GUIDE.md        # 部署指南（整合所有部署信息）
│   │   ├── SERVER_CREDENTIALS.md      # 服务器凭证和密钥（⚠️敏感）
│   │   ├── CLOUD_SERVICES.md          # 云服务配置详情
│   │   ├── OSS_SETUP.md               # OSS配置
│   │   └── TROUBLESHOOTING.md         # 故障排查
│   │
│   ├── 03-功能文档/
│   │   ├── 选配系统.md                # 一键选配、个体选配
│   │   ├── 近交计算.md                # 6代系谱通经法
│   │   ├── PPT生成.md                 # 自动报告生成
│   │   ├── 数据处理.md                # 数据上传、标准化
│   │   └── 用户认证.md                # 登录、注册、权限
│   │
│   ├── 04-项目管理/
│   │   ├── ROADMAP.md                 # 项目路线图
│   │   ├── COMPLETED_TASKS.md         # 已完成工作清单
│   │   ├── TODO_LIST.md               # 待办事项清单
│   │   ├── KNOWN_ISSUES.md            # 已知问题
│   │   └── FUTURE_PLANS.md            # 未来扩展计划
│   │
│   └── 99-历史文档/                   # 废弃但保留的文档
│       └── archived/
│
└── .gitignore                         # 确保敏感信息不提交
```

---

## 📝 关键文档内容规划

### 1. **docs/02-部署文档/SERVER_CREDENTIALS.md** ⚠️ 最重要

```markdown
# 服务器凭证和密钥信息

⚠️ **重要提示**: 此文件包含敏感信息，请勿提交到公开仓库！
已添加到 .gitignore

---

## 🔑 SSH密钥

### 阿里云ECS访问密钥
```bash
位置: ~/Downloads/genetic_improvement.pem
权限: 600 (chmod 600)
用户: ecs-user
IP: 39.96.189.27

# 连接命令
ssh -i ~/Downloads/genetic_improvement.pem ecs-user@39.96.189.27

# 密钥备份位置
- 本地Mac: ~/Downloads/genetic_improvement.pem
- 备份云盘: [记录备份位置]
- 团队共享: [如需要，记录共享方式]
```

---

## 🗄️ 数据库凭证

### PolarDB MySQL (生产环境)
```yaml
主机: defectgene-new.mysql.polardb.rds.aliyuncs.com
IP: 8.147.221.122
端口: 3306
数据库名: bull_library
用户名: defect_genetic_checking
密码: Jaybz@890411

# 连接示例
mysql -h defectgene-new.mysql.polardb.rds.aliyuncs.com \
      -P 3306 \
      -u defect_genetic_checking \
      -p'Jaybz@890411' \
      bull_library

# 访问来源限制
允许IP:
  - ECS服务器内网: 172.23.188.168
  - [其他授权IP]
```

### 本地SQLite缓存
```yaml
位置: ~/.genetic_improve/bull_library_cache.db
大小: ~132MB
记录数: 247,192条
用途: 客户端本地缓存
更新方式: 从OSS自动下载
```

---

## ☁️ 阿里云OSS凭证

### OSS访问密钥
```yaml
AccessKey ID: [环境变量 OSS_ACCESS_KEY_ID]
AccessKey Secret: [环境变量 OSS_ACCESS_KEY_SECRET]

Bucket名称: genetic-improve
区域: 华北2（北京）oss-cn-beijing.aliyuncs.com
权限: 公共读

# 管理控制台
https://oss.console.aliyun.com/bucket/oss-cn-beijing/genetic-improve
```

### OSS目录结构
```
genetic-improve/
├── releases/
│   ├── bull_library/
│   │   ├── bull_library.db (132MB, 247,192条记录)
│   │   └── bull_library_version.json (版本: 1.0.4)
│   ├── v1.2.0.4/
│   │   ├── 伊利奶牛选配_v1.2.0.4_win.exe
│   │   ├── 伊利奶牛选配_v1.2.0.4_win.zip
│   │   └── 伊利奶牛选配_v1.2.0.4_mac.dmg
│   └── latest/
│       └── version.json
```

---

## 🌐 域名和SSL证书

### 域名信息
```yaml
主域名: genepop.com
注册商: [记录注册商]
DNS服务: [记录DNS服务商]
到期时间: [记录到期时间]

子域名:
  - www.genepop.com → 39.96.189.27
  - api.genepop.com → 39.96.189.27

DNS记录:
  @     A    39.96.189.27
  www   A    39.96.189.27
  api   A    39.96.189.27
```

### SSL证书
```yaml
提供商: Let's Encrypt
证书路径: /etc/letsencrypt/live/api.genepop.com/
  - fullchain.pem (证书链)
  - privkey.pem (私钥)
到期时间: 2025-12-15
自动续期: certbot renew (cron每天运行)

# 手动续期命令
sudo certbot renew
sudo systemctl reload nginx
```

---

## 🔐 API认证密钥

### JWT密钥配置
```yaml
JWT_SECRET_KEY: 'genetic-improve-api-secret-key'
JWT_ALGORITHM: 'HS256'
JWT_EXPIRE_HOURS: 24

# ⚠️ 安全建议
生产环境应使用更强的密钥，建议至少32位随机字符串
建议定期轮换密钥
```

---

## 🖥️ 服务器端口配置

### ECS服务器端口
```yaml
SSH: 22 (仅密钥认证)
HTTP: 80 (Nginx，重定向到HTTPS)
HTTPS: 443 (Nginx反向代理)

内部服务端口:
  - Auth API: 8081 (仅localhost)
  - Data API: 8082 (仅localhost)
  - Version API: 8080 (仅localhost)

安全组规则:
  入方向:
    - 22 (SSH, 限制IP)
    - 80 (HTTP)
    - 443 (HTTPS)
  出方向:
    - 全部允许
```

---

## 👥 GitHub仓库

### 仓库信息
```yaml
仓库地址: https://github.com/Barton0411/genetic_improve
访问令牌: [如需要，记录Personal Access Token位置]

GitHub Actions Secrets:
  - ALIYUN_ACCESS_KEY_ID (OSS上传，未配置)
  - ALIYUN_ACCESS_KEY_SECRET (OSS上传，未配置)

# 添加Secrets位置
https://github.com/Barton0411/genetic_improve/settings/secrets/actions
```

---

## 📋 密钥管理清单

### 已配置密钥
- ✅ SSH密钥 (~/Downloads/genetic_improvement.pem)
- ✅ 数据库密码 (Jaybz@890411)
- ✅ SSL证书 (Let's Encrypt自动管理)
- ✅ OSS访问密钥 (环境变量)

### 待配置密钥
- ⏸️ GitHub Actions Secrets (OSS自动上传)
- ⏸️ 更强的JWT密钥 (生产环境安全加固)
- ⏸️ API认证令牌 (缺失公牛上传接口)

---

## 🔒 安全建议

1. **永不提交敏感信息到Git**
   - 已添加 SERVER_CREDENTIALS.md 到 .gitignore
   - 定期检查提交历史

2. **定期更换密码**
   - 数据库密码每6个月更换
   - JWT密钥每年更换

3. **备份关键密钥**
   - SSH密钥至少2个位置备份
   - 数据库凭证安全保存

4. **访问控制**
   - 数据库限制IP访问
   - SSH仅密钥认证
   - 定期审计访问日志

---

## 📞 紧急联系信息

### 服务故障联系人
```
阿里云技术支持: [客服电话]
域名注册商: [客服电话]
项目负责人: [联系方式]
```

### 备用访问方案
```
1. SSH密钥丢失 → [恢复方案]
2. 数据库访问失败 → [备用连接]
3. 域名解析异常 → [备用IP访问]
```
```

---

### 2. **docs/02-部署文档/CLOUD_SERVICES.md**

```markdown
# 云服务配置详情

## 🌩️ 阿里云ECS服务器

### 基本信息
```yaml
实例ID: i-2ze0wkrma5my2k7a7zba (iZa5my2k7a7zbaZ)
规格: ecs.e-c1m1.large (2核2GB)
公网IP: 39.96.189.27
内网IP: 172.23.188.168
地域: 华北2(北京) Zone G
系统: Ubuntu 24.04 64位
付费模式: 按量付费
到期时间: 2025-12-16

# 登录
ssh -i ~/Downloads/genetic_improvement.pem ecs-user@39.96.189.27
```

### 已安装软件
```yaml
操作系统: Ubuntu 24.04 LTS
Python: 3.12.3
Nginx: 1.24.0
Certbot: [版本]
Git: [版本]

Python虚拟环境:
  - /home/ecs-user/venv (Data API)
  - /home/ecs-user/genetic_improve_auth/venv (Auth API)
```

### 系统服务
```bash
# 查看服务状态
sudo systemctl status genetic-auth-api
sudo systemctl status genetic-data-api
sudo systemctl status nginx

# 服务管理
sudo systemctl start|stop|restart|reload [服务名]

# 查看日志
sudo journalctl -u genetic-auth-api -f
sudo journalctl -u genetic-data-api -f
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 服务配置文件位置
```bash
# API服务
Auth API: /home/ecs-user/genetic_improve_auth/auth_api.py
Data API: /home/ecs-user/api/data_api.py

# Systemd服务
/etc/systemd/system/genetic-auth-api.service
/etc/systemd/system/genetic-data-api.service

# Nginx配置
/etc/nginx/sites-available/default
/etc/nginx/nginx.conf

# SSL证书
/etc/letsencrypt/live/api.genepop.com/
```

---

## 📦 阿里云OSS对象存储

### 基本信息
```yaml
套餐: 标准-本地冗余存储 100GB
价格: ¥118.99/年
Bucket: genetic-improve
EndPoint: oss-cn-beijing.aliyuncs.com
区域: 华北2(北京)
访问权限: 公共读
CDN加速: 未启用

控制台地址:
https://oss.console.aliyun.com/bucket/oss-cn-beijing/genetic-improve
```

### 存储统计
```yaml
总存储量: ~500MB
主要文件:
  - bull_library.db: 132MB (数据库)
  - 应用安装包: ~250MB/版本

月度流量估算:
  - 下载: ~100GB (假设100个用户)
  - 上传: ~10MB (版本发布)
  - 费用: ~¥50/月
```

### OSS SDK配置
```python
# Python SDK示例
import oss2

auth = oss2.Auth(
    access_key_id=os.getenv('OSS_ACCESS_KEY_ID'),
    access_key_secret=os.getenv('OSS_ACCESS_KEY_SECRET')
)
bucket = oss2.Bucket(
    auth,
    'oss-cn-beijing.aliyuncs.com',
    'genetic-improve'
)
```

---

## 🗄️ 阿里云PolarDB MySQL

### 基本信息
```yaml
实例类型: PolarDB MySQL
规格: [记录规格]
存储: [记录容量]
地域: 华北2(北京)
网络类型: 专有网络VPC

主库地址: defectgene-new.mysql.polardb.rds.aliyuncs.com
主库端口: 3306
内网IP: [记录内网IP]
公网IP: 8.147.221.122
```

### 数据库列表
```sql
-- 主数据库
bull_library

-- 核心表
SHOW TABLES;
+------------------------+
| bull_library          | -- 公牛遗传数据 (247,192条)
| id-pw                 | -- 用户认证
| invitation_codes      | -- 邀请码
| app_versions          | -- 应用版本
| miss_bull             | -- 缺失公牛记录
| report_push_logs      | -- 报告推送日志
+------------------------+
```

### 性能监控
```yaml
连接数限制: [记录限制]
QPS峰值: [记录峰值]
存储使用率: [记录使用情况]

监控指标位置:
https://polardb.console.aliyun.com/
```

---

## 💰 成本统计

### 年度成本明细
```yaml
ECS服务器 (2核2GB): ¥99/年
域名 genepop.com: ¥55/年
OSS存储 100GB: ¥118.99/年
OSS流量 (估算): ¥600/年
PolarDB (已有): ¥0/年
SSL证书 Let's Encrypt: ¥0/年

总计: ~¥873/年 (¥73/月)
```

### 成本优化建议
```
1. OSS流量优化
   - 启用CDN加速（降低回源流量）
   - 实施缓存策略

2. 数据库优化
   - 定期清理无用数据
   - 索引优化

3. 服务器优化
   - 考虑包年包月（更优惠）
   - 监控资源使用率
```

---

## 📊 服务监控

### 关键监控指标
```yaml
服务可用性:
  - API响应时间 < 500ms
  - 服务正常运行时间 > 99.5%

存储监控:
  - ECS磁盘使用率 < 80%
  - OSS存储增长趋势
  - 数据库存储使用

网络监控:
  - 带宽使用情况
  - OSS流量统计
  - API调用频率
```

### 监控工具
```
阿里云监控: https://cloudmonitor.console.aliyun.com/
日志服务: journalctl, /var/log/
自定义监控: [如有，记录位置]
```
```

---

### 3. **docs/04-项目管理/COMPLETED_TASKS.md**

```markdown
# 已完成工作清单

## 版本: v1.2.0.4 (2025-09-30)

---

## ✅ 基础设施 (100%)

### 服务器部署
- [x] 阿里云ECS服务器配置 (Ubuntu 24.04)
- [x] Nginx安装和配置
- [x] SSL证书申请和自动续期 (Let's Encrypt)
- [x] 域名解析配置 (genepop.com)
- [x] 防火墙规则设置
- [x] SSH密钥认证配置

### 云服务配置
- [x] 阿里云OSS对象存储 (100GB)
- [x] OSS公共读权限配置
- [x] PolarDB MySQL数据库连接
- [x] 数据库用户权限配置

---

## ✅ API服务 (90%)

### 认证API (8081端口)
- [x] FastAPI框架搭建
- [x] JWT令牌认证
- [x] 用户登录接口
- [x] 用户注册接口（邀请码验证）
- [x] 用户信息查询
- [x] 令牌验证接口
- [x] Systemd服务配置
- [x] 自动启动设置

### 数据API (8082端口)
- [x] FastAPI框架搭建
- [x] 数据库版本查询接口
- [x] 缺失公牛上传接口（无需认证）
- [x] Systemd服务配置
- [ ] ~~公牛库下载接口~~ (已废弃，改用OSS)
- [ ] 认证保护（缺失公牛接口未加认证）

### Nginx反向代理
- [x] HTTPS配置
- [x] /api/auth/ → 8081 路由
- [x] /api/data/ → 8082 路由
- [x] SSL证书自动续期

---

## ✅ 数据库系统 (100%)

### OSS数据库分发 (v1.2.0.2)
- [x] 从API改为OSS直接下载
- [x] 版本检查机制 (OSS JSON文件)
- [x] 断点续传支持
- [x] 自动重试机制 (3次)
- [x] 下载进度显示 (MB + 百分比)
- [x] 数据库文件: bull_library.db (132MB, 247,192条)

### 数据库结构
- [x] bull_library表 (公牛遗传数据)
- [x] id-pw表 (用户认证)
- [x] invitation_codes表 (邀请码)
- [x] app_versions表 (版本管理)
- [x] miss_bull表 (缺失公牛记录)

---

## ✅ 客户端功能 (95%)

### 用户认证
- [x] 登录对话框 (API认证)
- [x] 注册对话框 (邀请码)
- [x] 离线认证备用方案
- [x] JWT令牌管理
- [x] 自动登录恢复

### 数据处理
- [x] 牛只信息上传
- [x] 公牛性状数据上传
- [x] 系谱信息上传
- [x] 配种记录上传
- [x] 数据标准化处理
- [x] 字段映射配置
- [x] 数据质量验证

### 育种计算
- [x] 母牛关键性状计算
- [x] 公牛关键性状计算
- [x] 育种指数计算
- [x] 性状年度变化分析
- [x] 系谱识别率统计
- [x] NM$分布分析

### 近交分析
- [x] 6代系谱通经法计算
- [x] 近交系数阈值过滤
- [x] 系谱可视化
- [x] 系谱缓存优化 (pedigree_cache.pkl)

### 选配推荐
- [x] 个体选配功能
- [x] 一键选配功能
- [x] 自动分组 (A/B/C组)
- [x] 手动分组模式
- [x] 近交控制
- [x] 遗传缺陷控制
- [x] 冻精库存管理
- [x] 智能分配算法
- [x] 选配预览和统计
- [x] 选配结果导出

### 报告生成
- [x] PPT自动生成
- [x] Excel报告导出
- [x] 数据可视化图表
- [x] 缺失数据标记 (红色/灰黄)

### UI/UX
- [x] PyQt6现代化界面
- [x] 深色/浅色模式支持
- [x] 主题管理器
- [x] 启动画面 (视频)
- [x] 进度条和加载提示
- [x] 多线程处理 (避免UI卡顿)

---

## ✅ CI/CD自动化 (90%)

### GitHub Actions
- [x] Windows自动构建
  - [x] PyInstaller OneDir打包
  - [x] Inno Setup安装包
  - [x] ZIP便携版
- [x] macOS自动构建
  - [x] 图标转换 (ICO→ICNS)
  - [x] .app应用打包
  - [x] DMG安装包
- [x] 自动生成CHANGELOG
- [x] GitHub Release自动创建
- [ ] ~~OSS自动上传~~ (Secrets未配置)

### 版本管理
- [x] 语义化版本号 (version.py)
- [x] Git标签触发构建
- [x] 版本检查API
- [x] 客户端自动更新提示

---

## ✅ 数据质量优化 (v1.2.0.1)

### 缺失公牛智能预估
- [x] 基于遗传趋势的数据补全
- [x] TPI趋势分析
- [x] NM$趋势分析
- [x] 数据质量可视化标记
- [x] 缺失记录云端上传
- [x] 用户提示和警告

---

## ✅ 性能优化

### 计算性能
- [x] 选配算法优化 (提升60%)
- [x] 多线程数据处理
- [x] 系谱缓存机制
- [x] 数据库查询优化

### 网络性能
- [x] OSS CDN加速下载
- [x] 下载速度提升60%
- [x] 断点续传
- [x] 自动重试

---

## ✅ 安全性 (70%)

### 已完成
- [x] JWT令牌认证
- [x] HTTPS全站加密
- [x] SSH密钥认证
- [x] SSL证书自动续期
- [x] API跨域配置

### 待加强
- [ ] 数据库密码硬编码移除
- [ ] 更强的JWT密钥
- [ ] API接口认证加固
- [ ] 访问日志审计
- [ ] 定期密钥轮换

---

## ✅ 文档 (60%)

### 已完成文档
- [x] README.md (项目简介)
- [x] CHANGELOG.md (更新历史)
- [x] PROJECT_CONTEXT.md (项目背景)
- [x] DEVELOPMENT_GUIDE.md (开发指南)
- [x] 部署说明.md
- [x] 功能说明文档

### 待完善文档
- [ ] 文档统一整理
- [ ] 系统架构文档 (ARCHITECTURE.md)
- [ ] API参考文档 (API_REFERENCE.md)
- [ ] 数据库schema文档
- [ ] 服务器凭证文档 (敏感信息)
- [ ] 项目管理文档 (TODO, ROADMAP)

---

## 📊 完成度总览

```
基础设施:   ████████████████████ 100%
API服务:    ██████████████████░░  90%
数据库:     ████████████████████ 100%
客户端:     ███████████████████░  95%
CI/CD:      ██████████████████░░  90%
安全性:     ██████████████░░░░░░  70%
文档:       ████████████░░░░░░░░  60%

总体完成度: ████████████████░░░░  85%
```

---

## 🎯 下一步工作

参见 [TODO_LIST.md](TODO_LIST.md)
```

---

### 4. **docs/04-项目管理/TODO_LIST.md**

```markdown
# 待办事项清单

更新时间: 2025-10-06

---

## 🔴 高优先级 (本周完成)

### 1. API地址统一 ⏰ 30分钟
- [ ] 修改 config/api_config.json
- [ ] 修改 api/config.py
- [ ] 修改 api/api_client.py
- [ ] 修改 core/breeding_calc/base_calculation.py
- [ ] 测试验证所有API调用

### 2. 文档整理 ⏰ 3-5小时
- [ ] 创建文档目录结构
- [ ] 编写 SERVER_CREDENTIALS.md (敏感信息)
- [ ] 编写 CLOUD_SERVICES.md (云服务配置)
- [ ] 编写 ARCHITECTURE.md (系统架构)
- [ ] 编写 API_REFERENCE.md (API文档)
- [ ] 编写 COMPLETED_TASKS.md (已完成工作)
- [ ] 编写 TODO_LIST.md (待办清单)
- [ ] 编写 ROADMAP.md (项目路线图)
- [ ] 创建 docs/README.md (文档导航)
- [ ] 更新 .gitignore (排除敏感文件)

---

## 🟡 中优先级 (本月完成)

### 3. 选配结果推送
- [ ] 添加 result_farm_code 字段
- [ ] 设计推送数据格式
- [ ] 实现推送API接口
- [ ] 牧场系统对接测试
- [ ] 推送日志记录

### 4. 数据质量改进
- [ ] 体型外貌鉴定模块重构
- [ ] 缺陷性状分析
- [ ] 数据验证规则完善
- [ ] Excel报告生成优化

### 5. GitHub Actions优化
- [ ] 配置OSS Secrets
  - [ ] ALIYUN_ACCESS_KEY_ID
  - [ ] ALIYUN_ACCESS_KEY_SECRET
- [ ] 启用OSS自动上传
- [ ] 优化构建流程

---

## 🟢 低优先级 (项目后期)

### 6. 安全加固
- [ ] 移除数据库密码硬编码
- [ ] 生成更强的JWT密钥
- [ ] 缺失公牛接口添加认证
- [ ] 访问日志审计系统
- [ ] 定期密钥轮换机制

### 7. 性能优化
- [ ] 数据库索引优化
- [ ] API缓存策略
- [ ] 前端资源压缩
- [ ] OSS CDN启用

### 8. 代码质量
- [ ] 单元测试覆盖
- [ ] 代码重复检查
- [ ] 类型注解完善
- [ ] 代码规范统一

### 9. 用户体验
- [ ] 多语言支持准备
- [ ] 帮助文档完善
- [ ] 错误提示优化
- [ ] 性能监控面板

---

## 🔮 未来规划 (待评估)

### 10. 功能扩展
- [ ] 移动端应用 (React Native?)
- [ ] Web版本 (Vue.js?)
- [ ] 数据分析看板
- [ ] AI辅助选配
- [ ] 批量选配优化

### 11. 系统集成
- [ ] 牧场管理系统深度对接
- [ ] 第三方数据源接入
- [ ] 云备份系统
- [ ] 多牧场数据汇总

---

## ⏸️ 暂缓任务

### 12. 完全API化改造
- [ ] 移除所有数据库直连代码
- [ ] 删除 config/db_config.py
- [ ] 统一通过API访问数据

原因: 当前架构已够用，OSS下载性能优异

---

## ✅ 近期完成

- [x] 服务器API域名测试
- [x] 文档整理方案制定
- [x] 项目架构全面梳理
```

---

我创建了一个非常详细的文档整理方案，包含：

1. **SERVER_CREDENTIALS.md** - 所有敏感信息（密钥、密码、端口）
2. **CLOUD_SERVICES.md** - 云服务详细配置
3. **COMPLETED_TASKS.md** - 已完成工作清单（85%完成度）
4. **TODO_LIST.md** - 待办事项（分优先级）

**你觉得这个方案怎么样？需要补充什么内容吗？确认后我就开始创建这些文档！** 📝