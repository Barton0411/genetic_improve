# 开发者快速指南

## 环境设置

### 1. 安装依赖
```bash
# 激活虚拟环境
source .venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 2. 运行程序
```bash
python main.py
```

## 核心组件使用

### 1. 数据加载

```python
from core.data import DataLoader

# 创建数据加载器
loader = DataLoader(base_path, project_name="测试项目")

# 加载所有数据
data = loader.load_all_data()

# 单独加载某类数据
cow_df = loader.load_cow_data()
bull_df = loader.load_bull_data()
```

### 2. 使用统一选配服务

```python
from core.services import MatingService

# 创建服务实例
service = MatingService(base_path, project_name="测试项目")

# 执行完整选配流程
results = service.execute_complete_mating(
    inbreeding_threshold=3.125,
    control_defect_genes=True,
    heifer_age_days=420,
    cycle_days=21
)

# 检查结果
if results['success']:
    allocation_df = results['allocation']
    print(f"成功分配 {len(allocation_df)} 头母牛")
```

### 3. 单独使用推荐生成器

```python
from core.matching import MatrixRecommendationGenerator

# 创建生成器
generator = MatrixRecommendationGenerator(project_path)

# 设置数据
generator.cow_df = cow_df
generator.bull_df = bull_df
generator.inbreeding_threshold = 3.125

# 生成推荐矩阵
matrices = generator.generate_matrices()
summary_df = matrices['summary']
```

### 4. 单独使用分配器

```python
from core.matching import CycleBasedMatcher

# 创建匹配器
matcher = CycleBasedMatcher()

# 加载推荐数据
matcher.load_data(recommendations_df, bull_data_path)

# 设置库存
matcher.set_inventory(bull_inventory)

# 执行分配
result_df = matcher.perform_allocation(selected_groups)
```

## 添加新功能

### 1. 添加新的约束条件

在 `CycleBasedMatcher._meets_constraints()` 方法中添加：

```python
def _meets_constraints(self, bull_info: dict) -> bool:
    # 现有约束
    if self.inbreeding_threshold > 0:
        if bull_info.get('inbreeding_coefficient', 0) > self.inbreeding_threshold:
            return False
    
    # 添加新约束
    if self.your_new_constraint:
        if not self._check_your_constraint(bull_info):
            return False
    
    return True
```

### 2. 添加新的分组策略

在 `GroupManager.group_cows()` 方法中添加：

```python
# 现有分组逻辑
...

# 添加新的分组条件
if self._is_your_special_group(cow):
    cow_df.loc[idx, 'group'] = '您的特殊分组'
```

### 3. 自定义分配算法

创建新的分配函数并添加到 `allocation_utils.py`：

```python
def your_custom_allocation(
    bull_inventories: Dict[str, int],
    total_cows: int,
    **kwargs
) -> Dict[str, int]:
    """您的自定义分配算法"""
    # 实现您的分配逻辑
    allocation = {}
    # ...
    return allocation
```

## 测试指南

### 1. 单元测试

```python
# 创建测试文件 test_your_feature.py
import unittest
from core.your_module import YourClass

class TestYourFeature(unittest.TestCase):
    def test_something(self):
        # 测试代码
        pass
```

### 2. 集成测试

使用测试项目数据：

```python
# 使用测试项目
service = MatingService(base_path, project_name="测试项目")
# 运行测试流程
```

## 常见问题

### 1. 数据文件找不到
- 检查项目路径是否正确
- 确认数据文件在 `genetic_projects/项目名/standardized_data/` 目录下

### 2. 库存全为0
- 检查公牛数据文件中是否有"支数"列
- 使用 `matcher.set_inventory()` 手动设置库存

### 3. 分组结果为空
- 检查母牛数据中的必需字段
- 确认策略表配置正确

## 调试技巧

### 1. 启用详细日志

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### 2. 检查中间结果

```python
# 在关键步骤打印数据
print(f"分组结果: {grouped_df['group'].value_counts()}")
print(f"库存情况: {bull_inventory}")
```

### 3. 使用断点调试

在 VSCode 或 PyCharm 中设置断点，逐步调试代码。

## 代码规范

1. **命名规范**
   - 类名：CamelCase
   - 函数名：snake_case
   - 常量：UPPER_CASE

2. **文档字符串**
   - 所有公共方法都应有文档字符串
   - 说明参数类型和返回值

3. **错误处理**
   - 使用 try-except 捕获异常
   - 记录错误日志
   - 向用户显示友好的错误信息

---
更新日期：2024-01-30