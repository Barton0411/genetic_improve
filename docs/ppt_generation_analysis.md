# PPT生成逻辑分析文档

## 概述
本文档详细分析了原始项目（Genetic_Improve.py）中PPT生成的完整逻辑，包括数据来源、处理方式和生成流程。

## PPT生成主流程

### 1. 前置条件检查 (generate_ppt_report)
- 检查输出文件夹是否已选择
- 检查必要的Excel文件是否存在：
  - `结果-指数排名结果.xlsx`
  - `结果-母牛关键性状指数.xlsx`
- 获取牧场名称
- 查找PPT模板文件（如果存在则使用模板）

### 2. PPT结构
PPT包含以下主要部分：

#### 第1部分：基础信息
1. **标题页** (create_title_slide)
   - 显示：牧场名称 + "牧场遗传改良项目专项服务"
   - 作者信息：奶科院育种中心 + 用户名
   - 日期：当前日期

2. **目录页** (create_toc_slide)
   - 展示4个主要模块：
     - 01 牧场系谱记录分析
     - 02 牛群遗传数据评估  
     - 03 牛群体型外貌评定
     - 04 牧场公牛使用分析

#### 第2部分：牧场系谱记录分析
3. **标题分隔页** (create_pedigree_analysis_slide)
   - 显示"01 牧场系谱记录分析"

4. **系谱完整性分析** (create_pedigree_completeness_slide)
   - 数据源：`结果-系谱识别情况分析.xlsx`
   - 展示内容：
     - 按出生年份分组的系谱识别率统计表
     - 父号识别率（<90%标红）
     - 外祖父识别率（<70%标红）
     - 外曾外祖父识别率（<50%标红）
   - 手动填写：未识别原因分析

5. **未识别牛只明细** (create_unidentified_cattle_slide)
   - 需要手动整理（标注：暂不能自动化生成）

6. **系谱记录准确性** (create_pedigree_accuracy_slide)
   - 需要手动整理（基于基因组检测结果）

#### 第3部分：牛群遗传数据评估
7. **标题分隔页** (create_key_traits_analysis_slide)
   - 显示"02 牛群遗传数据评估"

8. **关键育种性状分析** (create_key_breeding_traits_slide)
   - 数据源：`结果-牛群关键性状年度变化.xlsx`
   - 展示内容：
     - 按出生年份分组的关键性状统计表
     - 包含所有育种性状的中英文对照
     - 手动填写：需关注的关键性状

9. **净利润值NM$分布分析** (create_nm_distribution_slide)
   - 数据源：`在群牛只净利润值分布.xlsx` (Sheet: NM$分布)
   - 展示内容：
     - 柱状图：各NM$区间的头数分布
     - 饼图：各区间占比
     - 表格：详细数据
   - 手动填写：分布情况分析

10. **净利润值正态分布分析** (create_nm_distribution_analysis_slide)
    - 数据源：`NM$_年份正态分布.png`（图片文件）
    - 手动填写：分布情况分析

11. **育种指数正态分布分析** (create_breeding_index_distribution_analysis_slide)
    - 数据源：`育种指数得分_年份正态分布.png`（图片文件）
    - 手动填写：分布情况分析

12. **关键育种性状进展分析** (create_key_traits_progress_slides)
    - 数据源：
      - `selected_traits_key_traits.txt`（选中的性状列表）
      - `结果-牛群关键性状进展图/`文件夹中的PNG图片
    - 为每个选中的性状生成一页幻灯片
    - 手动填写：性状进展情况分析

#### 第4部分：牛群体型外貌评定
13. **标题分隔页** (create_linear_score_title_slide)
    - 显示"03 牛群体型外貌评定"

14. **体型外貌线性评分** (create_linear_score_slide)
    - 需要手动整理

15. **体型外貌缺陷性状占比** (create_linear_defect_traits_slide)
    - 需要手动整理

16. **缺陷性状具体情况** (create_all_linear_defect_traits_slide)
    - 需要手动整理

17. **体型外貌进展情况** (create_linear_progress_slide)
    - 需要手动整理

#### 第5部分：牧场公牛使用分析
18. **标题分隔页** (create_used_bull_slide)
    - 显示"04 牧场公牛使用分析"

19. **公牛使用整体情况** (create_bull_usage_slide)
    - 基于配种记录数据

20. **公牛使用明细** (create_bull_usage_detail_slides)
    - 按年份和冻精类型分组展示

21. **公牛使用进展** (create_semen_usage_progress_slides)
    - 数据源：`结果-冻精使用趋势图.xlsx`

22. **公牛使用散点图** (create_semen_usage_scatter_plot_slide)
    - 展示公牛使用分布

23. **结束页** (create_bye_slide)

## 数据依赖汇总

### 必需的Excel文件：
1. `结果-指数排名结果.xlsx` - 母牛指数排名数据
2. `结果-母牛关键性状指数.xlsx` - 母牛关键性状数据
3. `结果-系谱识别情况分析.xlsx` - 系谱识别率统计
4. `结果-牛群关键性状年度变化.xlsx` - 性状年度变化数据
5. `在群牛只净利润值分布.xlsx` - NM$分布数据
6. `结果-冻精使用趋势图.xlsx` - 冻精使用趋势数据

### 必需的图片文件：
1. `NM$_年份正态分布.png` - NM$正态分布图
2. `育种指数得分_年份正态分布.png` - 育种指数正态分布图
3. `结果-牛群关键性状进展图/*.png` - 各性状进展图

### 其他文件：
1. `selected_traits_key_traits.txt` - 选中的关键性状列表
2. PPT模板文件（可选）

## 数据生成函数分析

### 1. 系谱识别情况分析 (generate_pedigree_identification_analysis)
- **功能**：分析牛群系谱识别率
- **输入**：table_c（包含牛只系谱信息）、cow_df（牛只基本信息）
- **输出**：`结果-系谱识别情况分析.xlsx`
- **分析维度**：
  - 按出生年份分组（最近5年）
  - 统计父号、外祖父、外曾外祖父的识别率
  - 区分在场/不在场牛只

### 2. 母牛关键性状计算 (calculate_key_traits_index)
- **功能**：计算母牛各项育种性状指数
- **输入**：牛只信息、公牛性状数据
- **输出**：
  - `结果-母牛关键性状指数.xlsx`
  - `结果-牛群关键性状年度变化.xlsx`
  - 正态分布图片文件

### 3. 正态分布图生成 (generate_normal_distribution_charts)
- **功能**：生成性状值的正态分布图
- **参数**：
  - df: 数据框
  - value_column: 要分析的值列（如"NM$"或"育种指数得分"）
  - file_prefix: 文件前缀
- **输出**：
  - `{file_prefix}_年份正态分布.png`
  - `{file_prefix}_胎次正态分布.png`
  - 对应的Excel数据文件
- **分组方式**：
  - 年份分组：最近5年
  - 胎次分组：成母牛/后备牛

### 4. NM$分布图表生成 (generate_nm_distribution_charts)
- **功能**：生成净利润值分布统计
- **输出**：`在群牛只净利润值分布.xlsx`
- **内容**：
  - NM$区间分布（柱状图数据）
  - 各区间占比（饼图数据）

### 5. 关键性状进展图生成
- **输出目录**：`结果-牛群关键性状进展图/`
- **为每个选中的性状生成**：`{trait}进展情况.png`

### 6. 指数排名计算 (run_index_ranking)
- **功能**：计算母牛育种指数并排名
- **输出**：`结果-指数排名结果.xlsx`

## 需要确认的问题

1. **体型外貌评定部分（第3部分）**：
   - 所有4个子页面都标注为"需要手动整理"
   - 请确认：是否有对应的数据源文件？还是完全手动制作？

2. **公牛使用分析部分（第4部分）**：
   - create_bull_usage_slide、create_bull_usage_detail_slides等函数的具体数据来源
   - 是否基于配种记录表？具体使用哪些字段？

3. **手动填写部分**：
   - 多处标注"暂不能自动化生成...需服务人员整理"
   - 这些部分是否需要在新系统中实现自动化？

4. **性状中英文对照表**：
   - 代码中包含完整的translation_dict
   - 是否需要将此字典抽取为配置文件？

5. **数据计算顺序**：
   - PPT生成前需要按特定顺序执行多个计算功能
   - 是否需要创建一个统一的数据准备流程？

## 建议的重构方案

1. **模块化设计**：
   - 将PPT生成拆分为独立的模块
   - 每个部分（系谱分析、遗传评估、体型评定、公牛使用）作为独立的子模块

2. **数据源管理**：
   - 统一管理所有数据源文件路径
   - 添加数据验证和错误处理

3. **配置化**：
   - 将性状翻译字典、阈值设置等抽取为配置文件
   - 支持自定义PPT模板

4. **自动化改进**：
   - 考虑将手动填写部分改为自动分析
   - 添加更多的数据可视化和分析功能