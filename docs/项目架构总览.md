# 遗传改良系统项目架构总览

## 项目概述

本项目是一个奶牛遗传改良系统，提供了完整的选配管理功能，包括数据管理、推荐生成、选配分配、报告生成等功能。

## 核心架构

### 1. 数据层 (core/data)

- **DataLoader**: 统一的数据加载器
  - 支持从项目路径加载数据
  - 包含数据验证功能
  - 处理母牛、公牛、近交系数、隐性基因等数据

### 2. 业务逻辑层 (core)

#### 2.1 分组管理 (core/grouping)
- **GroupManager**: 母牛分组管理器
  - 特殊状态识别（已孕牛、难孕牛）
  - 周期分组（后备牛1-4周期）
  - 策略表应用（A/B/C组分配）
  - 性控/非性控判定

#### 2.2 选配匹配 (core/matching)
- **MatrixRecommendationGenerator**: 推荐矩阵生成器
  - 生成完整配对矩阵
  - 计算后代预期指数
  - 近交系数检查
  - 隐性基因风险评估

- **CycleBasedMatcher**: 基于周期的选配分配器
  - 按周期优先级分配
  - 1选按库存比例分配（含最小分配保证）
  - 2选、3选平均分配
  - 动态库存管理

- **allocation_utils**: 分配工具函数
  - 按比例分配算法
  - 最小分配保证实现

#### 2.3 领域模型 (core/matching/models.py)
- **Cow**: 母牛实体
- **Bull**: 公牛实体
- **PairingResult**: 配对结果
- **AllocationResult**: 分配结果

### 3. 服务层 (core/services)

- **MatingService**: 统一的选配服务接口
  - 整合数据加载、推荐生成、分组、分配功能
  - 提供完整的选配流程API
  - 支持进度回调

### 4. 展示层 (gui)

- **MainWindow**: 主窗口
  - 项目管理
  - 数据导入/导出
  - 选配操作界面
  - 结果展示

- **Workers**: 后台工作线程
  - RecommendationWorker: 推荐生成
  - DBUpdateWorker: 数据库更新

## 业务流程

### 1. 数据准备阶段
```
用户选择项目 → 加载标准化数据 → 验证数据完整性
```

### 2. 推荐生成阶段
```
生成推荐按钮 → MatrixRecommendationGenerator 
→ 计算所有配对组合 → 生成推荐矩阵
→ 保存到 individual_mating_report.xlsx
```

### 3. 分组阶段
```
加载母牛数据 → GroupManager 执行分组
→ 特殊状态 → 周期分组 → 策略表分配 → 性控/非性控
```

### 4. 选配分配阶段
```
选配分配按钮 → CycleBasedMatcher
→ 按周期顺序分配 → 1选比例/2-3选平均
→ 保存到 individual_allocation_result.xlsx
```

## 关键改进

### 1. 小库存公牛最小分配保证
- 确保库存小的公牛在1选时至少分配1头母牛
- 通过 `allocation_utils.calculate_proportional_allocation` 实现

### 2. 配种方式判断逻辑
- 修正了 `services_time` 的理解
- `services_time` 表示已配种次数，下次使用方法索引 = services_time

### 3. 统一的选配服务
- 创建 `MatingService` 整合所有功能
- 提供简洁的API接口

### 4. 废弃代码清理
- 标记 `IndividualMatcher` 为废弃
- 迁移到 `CycleBasedMatcher`
- 保留向后兼容性

## 配置说明

### 用户可配置参数
- 后备牛开配日龄（默认420天）
- 选配周期（默认21天）
- 近交系数阈值（默认3.125%）
- 是否控制隐性基因（默认是）

### 策略表配置
- 分组名称和占比
- 配种方法列表（按次数顺序）

## 技术栈

- **后端**: Python 3.x
- **GUI框架**: PyQt6
- **数据处理**: pandas, numpy
- **数据存储**: Excel文件 + SQLite数据库

## 目录结构

```
genetic_improve/
├── core/               # 核心业务逻辑
│   ├── data/          # 数据管理
│   ├── grouping/      # 分组管理
│   ├── matching/      # 选配匹配
│   ├── services/      # 服务层
│   └── ...
├── gui/               # 图形界面
├── docs/              # 文档
├── templates/         # 数据模板
└── genetic_projects/  # 项目数据
```

## 未来改进建议

1. **性能优化**
   - 大规模数据的处理优化
   - 推荐矩阵生成的并行计算

2. **功能增强**
   - 更多的约束条件支持
   - 自定义分配策略
   - 历史数据分析

3. **架构改进**
   - 引入更多设计模式
   - 增强错误处理
   - 改善日志记录

---
更新日期：2024-01-30
版本：1.0