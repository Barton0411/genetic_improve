# 遗传改良系统 - 版本更新日志

所有重要的项目变更都会记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-cn/1.0.0/)，本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范。

## [1.2.0.8] - 2025-10-11 📊 Excel报告Sheet 5-7完成

### ✅ 完成功能
- **Sheet 5: 配种记录-隐性基因分析**
  - 2个汇总表（全部年份+近12个月）
  - 16个隐性基因自动识别和统计
  - 基因中文翻译映射
  - 风险等级颜色编码（纯合/仅公牛携带/仅母牛父亲携带/数据缺失）

- **Sheet 6: 配种记录-近交系数分析**
  - 2个分布汇总表（全部年份+近12个月）
  - 4个图表（2个柱状图+2个饼图）
  - 图表颜色与风险等级对应（浅蓝#9BC2E6、黄#FFEB9C、红#FFC7CE、深红#FF0000）
  - 柱状图宽度优化（高度×4/3）
  - 年份趋势表（区分高风险6.25%-12.5%和极高风险>12.5%）

- **Sheet 7: 配种记录-隐性基因及近交系数明细**
  - 直接复制原始分析结果文件（190行×57列）
  - 保留完整的基因和近交系数信息
  - 列宽自动调整

### 🔄 优化改进
- 自动化生成页面：切换时自动刷新对比牧场选择列表
- 修复近交系数区间定义：< 3.125%, 3.125%-6.25%, 6.25%-12.5%, >12.5%

### 📝 文档更新
- 更新《Excel报告生成实施方案v1.2》：标记Sheet 5-7为已完成状态
- 详细记录实现细节和数据结构

---

## [待发布] - 2025-10-10 📊 Excel报告生成系统重构 v1.2

### 🔄 重大变更
- Excel报告生成器升级到v1.2版本
  - Sheet结构从8个扩展到11个
  - 重新组织配种记录分析模块
  - 新增已用公牛性状分析模块

### 📋 Sheet结构重组
- **Sheet 5-7: 配种记录分析** (v1.2新规划)
  - Sheet 5: 配种记录-隐性基因分析（携带汇总表+图表+明细）
  - Sheet 6: 配种记录-近交系数分析（分布表+趋势图）
  - Sheet 7: 配种记录-隐性基因/近交系数明细（综合明细表）

- **Sheet 8-9: 已用公牛分析** (v1.2新增)
  - Sheet 8: 已用公牛性状汇总分析（过去5年汇总+性状折线图）
  - Sheet 9: 已用公牛性状明细（按年份/冻精类型分组明细表）

- **Sheet 10-11: 备选公牛和选配结果** (v1.2重命名)
  - Sheet 10: 备选公牛排名（原Sheet 7）
  - Sheet 11: 选配推荐结果（原Sheet 8）

### ✨ 新增Builder
- 创建Sheet9Builder（已用公牛性状明细）
- 创建Sheet10Builder（备选公牛排名）
- 创建Sheet11Builder（选配推荐结果）

### 🔧 技术改进
- 更新generator.py生成流程，支持15个Sheet（含子sheet）
- 重构数据收集方法，新增5个v1.2数据收集器接口
- 优化sheet_builders模块导入机制，向后兼容
- 实现智能数据收集（新收集器未实现时自动降级）

### 📝 文档更新
- 创建《Excel报告生成实施方案 v1.2》详细设计文档
- 定义各Sheet详细表格结构和格式化规则
- 明确4阶段实施计划（配种记录→已用公牛→排名结果→集成测试）
- 建立完整的文件命名规范和数据流程图

### 🎯 待实现功能
- [ ] 实现5个新数据收集器（breeding_genes、breeding_inbreeding等）
- [ ] 完整实现Sheet 5-11的构建逻辑
- [ ] 实现风险等级色彩标记系统
- [ ] 实现多种图表类型（饼图、柱状图、折线图、雷达图）

## [1.2.0.7] - 2025-10-10 🎨 对比牧场管理界面优化

### ✨ 新增功能
- 对比数据摘要列
  - 在对比牧场选择列表中新增"摘要"列
  - 对比牧场显示：在群母牛头数、年份范围、前3个性状值（保留2位小数）
  - 外部参考显示：性状数量、年份范围、最后年份平均数据及前3个性状值
- 确认按钮功能
  - 新增"确认"按钮，点击后自动刷新主窗口列表并关闭对话框
  - 统一确认（蓝色）和关闭（灰色）按钮样式，大小一致
- 表格双击编辑
  - 双击对比牧场表格行可直接打开编辑对话框
  - 提升编辑操作的便捷性

### 🔧 问题修复
- 修复对比牧场编辑后列表不更新的问题
  - 禁止表格单元格直接编辑
  - 强制使用"编辑牧场"按钮，确保修改正确保存到配置文件
- 修复配置文件缓存不同步问题
  - `save_selected_comparisons()` 方法在保存前重新加载配置
  - `load_farms()` 和 `load_reference_data()` 方法自动刷新配置缓存
  - 避免不同实例间的配置覆盖

### 🎨 界面优化
- 性状值统一显示格式
  - 摘要中的性状值自动保留2位小数
  - 外部参考摘要添加"{年份}年平均数据："前缀
- 按钮样式统一
  - 确认按钮和关闭按钮设置统一的 padding、font-size、min-width
  - 确保按钮大小视觉上完全一致

### 🔄 技术改进
- 优化BenchmarkManager缓存策略
  - 关键操作前自动重新加载配置文件
  - 只更新必要字段，避免覆盖其他更改
- 增强数据加载逻辑
  - 对比牧场管理对话框的所有数据加载操作都重新读取配置
  - 确保UI显示的数据始终与配置文件同步

## [1.2.0.5] - 2025-10-07 📚 文档体系建立与功能优化

### 📚 文档体系
- 建立完整的文档中心 (`docs/`)
  - 文档导航 (`docs/README.md`)
  - 系统架构文档 (`docs/开发文档/ARCHITECTURE.md`)
  - API参考文档 (`docs/开发文档/API_REFERENCE.md`)
  - 云服务配置文档 (`docs/部署文档/CLOUD_SERVICES.md`)
  - 已完成任务清单 (`docs/项目管理/COMPLETED_TASKS.md`)
  - 待办事项清单 (`docs/项目管理/TODO_LIST.md`)
  - 项目路线图 (`docs/项目管理/ROADMAP.md`)
- 整理文档目录结构
  - 功能文档分类归档到 `docs/功能文档/`
  - 历史文档归档到 `docs/历史文档/archived/`
  - 按开发、部署、功能、管理分类
- 更新 `.gitignore` 排除敏感信息

### ✨ 功能优化
- 缺失公牛上传功能改进
  - 上传公牛数据时即时检查本地数据库
  - 格式错误的NAAB号保留处理（不再拒绝）
  - 自动上传缺失公牛到云端 (无需认证)
- 用户提示信息简化
  - 移除"这些信息已记录到云端数据库"等技术细节
  - 移除"结果文件中这些公牛的性状值将显示为空"提示
  - 合并重复弹窗，只显示关键信息
- 数据库版本显示
  - 侧边栏显示数据库版本和更新时间
  - 格式：数据库版本: x.x.x\n数据库更新时间: YYYY-MM-DD

### 🔧 技术改进
- API地址统一为 `https://api.genepop.com`
  - 更新 `config/api_config.json`
  - 更新 `api/config.py`
  - 更新 `api/api_client.py`
  - 更新 `core/breeding_calc/base_calculation.py`
- 缺失公牛上传无需认证
  - `upload_missing_bulls()` 方法移除JWT token要求
  - 服务器端 `/api/data/missing_bulls` 接口公开访问

### 📝 文档内容
- **系统架构文档**: 整体架构图、数据流向、技术栈、架构演进、技术决策
- **API参考文档**: 认证API、数据API、请求响应示例、错误码说明
- **云服务配置**: ECS、OSS、PolarDB、Nginx、SSL证书配置详情
- **项目管理**: 85%完成度统计、待办事项分优先级、v1.3-v3.0路线图

## [1.2.0.4] - 2025-09-30 🔧 数据兼容性与深色模式优化

### 🔧 问题修复
- 修复母牛分配问题
  - 所有ID字段（cow_id、dam、mgd等）统一使用字符串类型
  - 解决类型不匹配导致的分配失败问题
  - 确保所有牛只都能正确参与分配
- 修复程序启动卡死问题
  - 优化数据库更新后的消息处理
  - 移除可能导致阻塞的事件过滤器
  - 改进启动流程的异步处理

### 🎨 界面优化
- 深色模式支持优化
  - 按钮在深色模式下显示正确颜色（启用时蓝色，禁用时深灰）
  - 表格、对话框等UI元素自适应系统主题
  - 遗传缺陷列在深色模式下使用黑色文本
- 新增主题管理器
  - 实现深色/浅色模式实时检测
  - 统一管理所有UI组件的主题样式
  - 优化深色模式下的对比度和可读性

### 💻 技术改进
- 数据处理优化
  - 在数据标准化阶段统一ID格式
  - 改进数据类型一致性检查
  - 增强错误处理和日志记录
- 代码质量提升
  - 清理重复代码
  - 优化事件处理逻辑
  - 改进异常处理机制

## [1.2.0.3] - 2025-09-27 🎯 选配系统优化升级

### ✨ 新增功能
- 分组模式切换功能
  - 手动分组和自动分组模式互斥切换
  - 切换时提示清除已有选配结果
  - 按钮状态视觉反馈（蓝色激活/灰色未激活）
- 清空选配功能
  - 可选择性清空指定组的选配结果
  - 支持清空常规和性控选配
  - 清空后自动更新未分配统计
- 选配预览框实时更新
  - 显示各组每个位置的未分配数量
  - 选配完成后自动刷新统计
  - 支持1选/2选/3选 × 常规/性控的详细统计

### 🔄 优化改进
- 累积报告更新逻辑优化
  - 实现智能合并，空值不覆盖已有数据
  - 基于首个选择判断是否替换整组
  - 保护已分配数据不被意外覆盖
- 分组显示优化
  - 修复数字分组显示为'未分组'问题
  - 修复空组不显示问题（使用fillna处理NaN）
  - 统一分组名称的字符串处理

### 🔧 问题修复
- 修复自动分组全部显示为'未分组'的问题
- 修复清空选配时的列名错误（兼容'group'和'分组'）
- 修复手动分组模式下空组不显示的问题
- 修复分组切换后预览未更新的问题

## [1.2.0.2] - 2025-09-22 🌐 OSS数据库分发系统

### 🚀 重大改进
- 数据库下载全面迁移到阿里云OSS
  - 移除API服务器依赖，直接从OSS下载132MB数据库（247,192条记录）
  - 下载速度提升60%，支持断点续传
  - 实现自动重试机制（最多3次）

### ✨ 新增功能
- 数据库下载进度条
  - 实时显示下载百分比和MB进度
  - 显示已下载/总大小（如：45.2MB / 132.5MB）
  - 完整的验证进度提示
- 智能版本管理
  - 自动检测OSS最新版本（当前v1.2.1）
  - 版本不一致时自动触发更新
  - 修复版本保存超时问题

### 🔧 问题修复
- 修复版本文件初始化为0的问题
- 修复下载后版本保存失败（网络超时）的问题
- 统一使用OSS版本，移除API版本检查混乱
- 修复数据库文件丢失但版本文件存在的边界情况

### 📁 系统优化
- 文件组织结构优化
  - 项目文件保留在项目目录
  - 用户配置和缓存在 `~/.genetic_improve/`
  - 日志文件统一到 `logs/` 目录
- GitHub Actions构建优化
  - 支持从OSS下载预装数据库
  - 优化打包流程和版本管理

## [1.2.0.1] - 2025-09-22 🚀 重大更新

### 🚀 重大更新
- 选配算法全面优化，改进育种指数加载机制
- 实现云数据库直接连接，大幅提升数据同步性能

### 🐛 问题修复
- 修复公牛育种指数加载时的KeyError('Index Score')问题
  - 原因：从数据库和文件重复加载导致列名冲突
  - 解决：选配时只使用用户计算的育种指数文件
- 修复processed_bull_data上传后仍提示缺失的问题

### ✨ 功能改进
- 选配时只使用用户自定义的育种指数（如NM$权重_index）
- 不再从数据库查询标准的NM$/TPI指数
- 确保选配结果符合用户设定的育种目标

### 🎯 错误提示优化
- 大幅改进错误提示系统，为每种缺失文件提供：
  - 缺失文件的完整路径
  - 具体的解决方法和操作指引
  - 需要执行的功能模块名称

### 🔐 数据库增强
- 实现从阿里云RDS MySQL直接同步数据到本地SQLite缓存
- 支持247,192条公牛记录的快速加载
- 包含完整的HH1-HH6隐性基因字段

### 🔧 技术改进
- 移除选配过程中的数据库依赖
- 优化_load_bull_traits函数，简化加载逻辑
- 增强数据完整性验证

## [1.1.0.6] - 2025-09-20

### 🐛 问题修复
- 修复dam列数据格式问题，保持原始ID格式不变
  - 问题：母亲号(dam)从Excel读取时前导零丢失（如'0960'变成960.0）
  - 原因：读取Excel时未正确指定中文列名的dtype
  - 解决：使用原始中文列名（"母亲号"）指定dtype为字符串
- 修复NAAB编号处理时的TypeError
  - 问题：invalid_naab_numbers列表包含float值导致join失败
  - 解决：在join前将所有值转换为字符串

### 🔧 优化改进
- 优化ID列数据类型处理逻辑
  - 读取时使用原始中文列名指定dtype
  - 保存时确保cow_id、dam等ID列保持字符串格式
- 保证ID数据的完整性，支持推送功能正常工作

## [1.1.0.1] - 2025-09-19

### 🐛 问题修复
- 修复个体选配中常规公牛无法分配的严重问题
  - 原因：部分公牛缺少Index Score数据导致推荐矩阵生成失败
  - 解决：在推荐生成阶段过滤无库存和无数据的公牛

### ✨ 功能增强
- 增强推荐矩阵生成时的数据验证机制
- 新增公牛数据质量检查报告，在加载数据后自动生成
- 提升系统容错性，防止无效数据导致分配失败

### 📊 数据处理改进
- 推荐矩阵生成时同时检查库存和数据完整性
- 只有同时满足"有库存"且"有数据"的公牛才进入推荐计算
- 记录并报告被过滤的公牛数量和原因

### 📝 日志优化
- 提供更详细的数据筛选信息
- 分类统计无库存、无数据的公牛数量
- 输出有效公牛的最终统计信息

## [1.1.0.0] - 2025-09-17 🚀 重大版本发布

### 🚀 核心功能更新
1. 重大版本发布：完整自动更新机制，用户无需自行下载
2. 支持跨平台运行（Windows/macOS）
3. 支持近交系数计算，采用6代系谱通经法计算
4. 支持个体选配自动分组
5. 支持备注选配时部分牛只无选配的原因呈现
6. 本次重构后，自动化生产报告模块，暂未开放
7. 本次重构后，体型外貌鉴定自动分析模块，暂未开放

### ✨ 技术特性
- 完整的应用内自动更新系统
- 强制更新确保关键逻辑更新不被跳过
- 智能下载、安装和重启机制
- 现代化更新对话框界面
- 多服务器支持和网络容错
- 完善的异常处理和日志记录

## [1.0.9.14] - 2025-09-17

### 🔧 修复
- 修正强制更新对话框关闭行为逻辑
- 关闭更新窗口现在正确退出整个程序，而不是跳过更新

### 📝 界面改进
- 更新确认对话框提示信息，明确说明关闭将退出程序
- 澄清强制更新的正确行为：必须更新或选择退出程序

### 🎯 行为调整
- 强制更新对话框关闭 = 退出整个应用程序
- 优化程序退出逻辑，确保资源正确释放
- 用户无法在不更新的情况下继续使用程序

### 💡 逻辑澄清
- 强制更新只有两个选择：立即更新 或 退出程序
- 移除了"跳过更新继续使用"的误导性描述

## [1.0.9.13] - 2025-09-17

### ✨ 新增功能
- 为强制更新对话框添加关闭按钮
- 支持ESC键关闭对话框（需确认）
- 增加关闭确认机制，防止意外跳过重要更新

### 🎯 用户体验改进
- 优化用户操作选择，提供更多灵活性
- 改进关闭提示信息，详细说明跳过更新的风险
- 确保用户在充分了解风险的情况下做出选择

### 🔒 安全考虑
- 保持强制更新的重要性，但给予用户最终选择权
- 在用户选择跳过更新时记录日志，便于追踪
- 防止下载线程泄漏，确保资源正确释放

## [1.0.9.12] - 2025-09-17

### 🔍 新增功能
- 增强版本更新检查日志记录系统
- 添加详细的版本检查流程跟踪
- 新增平台检测信息输出
- 实现全流程调试输出标记

### 🐛 问题修复
- 修复Windows平台版本检查问题诊断
- 优化版本管理器初始化流程
- 改进错误信息和调试输出
- 增强异常处理和错误报告

### 🛠️ 技术改进
- 添加开始和结束日志标记便于问题定位
- 完善异常捕获和堆栈跟踪记录
- 优化版本比较逻辑的日志输出
- 增强网络连接和API响应的调试信息

### 📝 文档更新
- 更新README.md至最新版本信息
- 完善安装指南和系统要求
- 更新GitHub仓库链接
- 新增CHANGELOG.md变更日志

## [1.0.9.11] - 2025-09-17

### 🔥 重大变更
- macOS改为手动拖拽安装，避免应用崩溃
- 移除自动删除复制逻辑，防止应用包损坏
- 利用macOS原生应用替换机制

### ✨ 新增功能
- 简化安装流程，提升用户体验
- 保持DMG挂载状态便于用户操作
- 优化手动安装指导显示

### 🔒 安全修复
- 修复QtCore模块内存访问崩溃问题
- 增强应用安装过程的稳定性

### 🚀 构建优化
- 同时支持Windows和macOS平台打包
- 优化GitHub Actions构建流程

## [1.0.9.10] - 2025-09-17

### 🔥 重大功能
- 完整实现应用内自动更新系统
- 真实下载功能替代模拟进度条
- 智能DMG挂载和应用识别机制

### 🎯 智能化改进
- 通用应用名称识别，无需硬编码
- 多重安全验证避免误操作其他应用
- 支持完全自动安装和重启

### 🌙 界面优化
- 修复暗色模式下手动安装指导显示问题
- 优化用户交互体验

### 🚀 系统验证
- 端到端自动更新流程验证完成
- 完善的更新机制测试

## [1.0.6] - 2025-09-16

### 🔥 强制更新系统
- 实现强制更新系统，确保关键更新必须安装
- 新增应用内智能更新功能，无需手动下载安装包
- 增强更新安全性，支持完整文件替换和回滚机制

### 🎨 用户界面
- 全新设计的更新对话框，支持深色/浅色模式自动适配
- 智能路径检测，支持任意安装位置的程序更新

### 🔒 数据保护
- 保护用户数据，更新过程中项目文件和配置安全不受影响
- 三阶段更新流程：准备→执行→验证，确保更新可靠性

### 💻 跨平台支持
- 跨平台兼容，完美支持Windows、macOS和Linux系统

## [1.0.5.2] - 2025-09-16

### ⚖️ 算法调整
- 调整近交系数默认阈值从3.125%改为6.25%
- 优化选配约束条件，提供更多选配组合

### 🖥️ 界面优化
- 更新GUI界面默认选择为6.25%阈值
- 完善个体选配和完整选配的默认参数

## [1.0.5.1] - 2025-09-16

### 🧪 测试验证
- 测试GitHub Actions自动构建流程
- 验证强制更新系统完整功能
- OSS自动扫描API集成测试

### 📊 自动化部署
- 自动生成changelog并上传到OSS
- 端到端自动化部署流程验证

## [1.0.5] - 2025-09-16

### ✨ 版本更新系统
- 完善版本自动更新系统，支持GUI对话框选择下载
- 修复版本检查服务器连接逻辑，增加备用服务器支持
- 优化下载URL获取机制，直接从版本信息API响应中提取

### 🔄 技术优化
- 更新PyQt6更新对话框，替换原有tkinter实现避免崩溃
- 更新全面的系统文档和部署指南
- 优化requirements.txt依赖版本和兼容性

### 🔒 安全准备
- 为明日API化数据库连接做准备，提升安全性

## [1.0.4] - 2025-09-15

### ⚡ 性能优化
- 优化个体选配报告生成性能，添加约束数据缓存机制
- 大幅提升报告生成速度，减少文件I/O操作

### ✨ 功能增强
- 实现选配备注系统，详细说明约束过滤情况
- 新增近交系数和隐性基因约束分析功能
- 增强约束分析准确性，支持跳过优质公牛的详细说明

### 🐛 问题修复
- 修复备注格式，去除冗余前缀文字

## [1.0.3] - 2025-08-27

### 🐛 重要修复
- 修复后代近交系数排序问题，优先按后代近交系数降序排序
- 修复血缘图滚轮缩放时图形消失问题，添加缩放边界检查
- 修复缩放中心固定为血缘图正中心，防止图形移动

### ✨ 新增功能
- 添加代数选择按钮，支持2-6代血缘图显示
- 禁止缩放血缘图标题，保持标题大小固定
- 扩展代数选择范围为2-6代，字体大小自动适配框的大小

### 🎨 界面优化
- 增大血缘图字体大小，提高可读性
- 降低滚轮缩放敏感度，减少单次缩放幅度
- 完全禁用简易系谱图的拖动功能，只保留双击查看详细视图
- 移除适应内容按钮，简化用户界面

## [1.0.2] - 2025-08-08

### 🧬 算法优化
- 优化冻精分配算法，先给排名高的母牛分配排名高的公牛
- 加载公牛指数得分用于计算后代得分
- 根据后代得分排序公牛，确保高分母牛优先获得高分公牛

### 🐛 界面修复
- 修复冻精预览表列宽问题，冻精编号显示完整

### ✨ 功能增强
- 添加育种项目管理文件双击打开和右键菜单功能

## [1.0.1] - 2025-07-29

### 🚀 PPT生成重大改进
- 重大改进PPT生成功能
- 新增母牛关键性状详情分析页
- 新增公牛育种指数排名页
- 新增年度遗传进展趋势页
- 新增近交系数风险分析页
- 新增隐性基因筛查统计页
- 新增选配推荐详情示例页
- 新增项目总结与改良建议页

### 🎨 界面优化
- 优化PPT页面布局和数据展示
- 增强PPT内容的完整性和专业性

### 🔧 技术修复
- 修复数据库DNS解析问题，使用IP地址直连
- 更新requirements.txt，添加所有缺失的依赖项
- 修复opencv-python、networkx、scikit-learn依赖缺失问题

## [1.0.0] - 2025-07-28

### 🎉 初始版本发布
- 实现育种项目管理功能
- 实现数据上传功能（母牛、公牛、配种记录、体型外貌、基因组数据）
- 实现关键育种性状分析
- 实现牛只指数计算排名
- 实现近交系数及隐性基因分析
- 实现个体选配功能
- 实现选配推荐报告生成（包含后代得分预测）
- 实现PPT自动报告生成
- 集成阿里云数据库
- 优化UI界面和用户体验

---

## 版本规则说明

### 版本号格式
- 格式：`主版本号.次版本号.修订号.构建号` (例如: 1.0.9.12)
- **主版本号**: 重大架构变更或功能重构
- **次版本号**: 新功能添加或重要改进
- **修订号**: 问题修复和小幅优化
- **构建号**: 日常构建和测试版本

### 更新类型
- 🔥 **重大变更**: 架构级别的重要更新
- ✨ **新增功能**: 全新功能模块
- ⚡ **性能优化**: 性能和效率提升
- 🐛 **问题修复**: Bug修复和错误纠正
- 🎨 **界面优化**: UI/UX改进
- 🔒 **安全修复**: 安全相关的修复
- 📝 **文档更新**: 文档和注释改进
- 🔧 **技术改进**: 代码质量和维护性提升
- 🚀 **构建优化**: 构建和部署流程改进

### 发布周期
- **稳定版本**: 每月发布，包含完整测试
- **修复版本**: 按需发布，快速修复关键问题
- **测试版本**: 每周发布，用于内部测试和验证