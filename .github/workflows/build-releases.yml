name: Build Cross-Platform Releases

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.4)'
        required: true
        default: '1.0.4'

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»ºReleaseå’Œä¸Šä¼ æ–‡ä»¶
  actions: read    # å…è®¸è¯»å–ActionsçŠ¶æ€

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        python -m PyInstaller GeneticImprove_win.spec --clean --noconfirm
    
    - name: Create Windows installer
      run: |
        # è·å–ç‰ˆæœ¬å·
        $VERSION = python -c "from version import get_version; print(get_version())"
        echo "Building version: $VERSION"
        
        # åˆ›å»ºå®‰è£…åŒ…ç›®å½•
        $INSTALLER_DIR = "installer_temp"
        New-Item -ItemType Directory -Force -Path $INSTALLER_DIR
        
        # å¤åˆ¶åº”ç”¨æ–‡ä»¶
        Copy-Item -Recurse -Force "dist\GeneticImprove" "$INSTALLER_DIR\GeneticImprove"
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        @"
        @echo off
        cd /d "%~dp0GeneticImprove"
        start "" "GeneticImprove.exe"
        "@ | Out-File -FilePath "$INSTALLER_DIR\å¯åŠ¨ Genetic Improve.bat" -Encoding ascii
        
        # åˆ›å»ºå¸è½½è„šæœ¬
        @"
        @echo off
        echo æ­£åœ¨å¸è½½ Genetic Improve...
        cd /d "%~dp0"
        rmdir /s /q GeneticImprove
        del "å¯åŠ¨ Genetic Improve.bat"
        del "%~f0"
        echo å¸è½½å®Œæˆï¼
        pause
        "@ | Out-File -FilePath "$INSTALLER_DIR\å¸è½½.bat" -Encoding ascii
        
        # åˆ›å»ºREADME
        @"
        Genetic Improve - ç‰›åªé—ä¼ æ”¹è‰¯ç³»ç»Ÿ v$VERSION
        
        å®‰è£…è¯´æ˜ï¼š
        1. å°†æ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶åˆ°æ‚¨æƒ³è¦å®‰è£…çš„ä½ç½®
        2. åŒå‡»"å¯åŠ¨ Genetic Improve.bat"è¿è¡Œç¨‹åº
        3. å¦‚éœ€å¸è½½ï¼ŒåŒå‡»"å¸è½½.bat"
        
        ç³»ç»Ÿè¦æ±‚ï¼š
        - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - è‡³å°‘ 2GB å¯ç”¨å†…å­˜
        - è‡³å°‘ 1GB å¯ç”¨ç£ç›˜ç©ºé—´
        
        æŠ€æœ¯æ”¯æŒï¼šè¯·è”ç³»å¼€å‘å›¢é˜Ÿ
        "@ | Out-File -FilePath "$INSTALLER_DIR\README.txt" -Encoding utf8
        
        # å‹ç¼©æˆZIPæ–‡ä»¶
        $ZIP_NAME = "GeneticImprove_v$VERSION" + "_win.zip"
        Compress-Archive -Path "$INSTALLER_DIR\*" -DestinationPath $ZIP_NAME -Force
        
        echo "Windows package created: $ZIP_NAME"
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        $size = (Get-Item $ZIP_NAME).Length / 1MB
        echo "Package size: $([math]::Round($size, 2)) MB"
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-release
        path: GeneticImprove_v*_win.zip
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS application
      run: |
        python -m PyInstaller GeneticImprove.spec --clean --noconfirm
    
    - name: Create macOS DMG
      run: |
        # è·å–ç‰ˆæœ¬å·
        VERSION=$(python -c "from version import get_version; print(get_version())")
        echo "Building version: $VERSION"
        
        DMG_NAME="GeneticImprove_v${VERSION}_mac"
        DMG_PATH="$DMG_NAME.dmg"
        
        # åˆ é™¤æ—§çš„ DMG
        rm -f "$DMG_PATH"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äº DMG å†…å®¹
        DMG_DIR="dmg_temp"
        rm -rf "$DMG_DIR"
        mkdir -p "$DMG_DIR"
        
        # å¤åˆ¶åº”ç”¨åˆ°ä¸´æ—¶ç›®å½•
        cp -R "dist/GeneticImprove.app" "$DMG_DIR/"
        
        # åˆ›å»ºåº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹çš„ç¬¦å·é“¾æ¥
        ln -s /Applications "$DMG_DIR/Applications"
        
        # ä½¿ç”¨ hdiutil åˆ›å»º DMG
        hdiutil create -volname "Genetic Improve" \
            -srcfolder "$DMG_DIR" \
            -ov -format UDZO \
            "$DMG_PATH"
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf "$DMG_DIR"
        
        echo "macOS DMG created: $DMG_PATH"
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        size=$(du -sh "$DMG_PATH" | cut -f1)
        echo "DMG size: $size"
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-release
        path: GeneticImprove_v*_mac.dmg
        retention-days: 30

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        name: Genetic Improve v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## Genetic Improve v${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸš€ æ–°åŠŸèƒ½å’Œæ”¹è¿›
          - ä¼˜åŒ–ä¸ªä½“é€‰é…æŠ¥å‘Šç”Ÿæˆæ€§èƒ½ï¼Œæ·»åŠ çº¦æŸæ•°æ®ç¼“å­˜æœºåˆ¶
          - å®ç°é€‰é…å¤‡æ³¨ç³»ç»Ÿï¼Œè¯¦ç»†è¯´æ˜çº¦æŸè¿‡æ»¤æƒ…å†µ
          - æ–°å¢è¿‘äº¤ç³»æ•°å’Œéšæ€§åŸºå› çº¦æŸåˆ†æåŠŸèƒ½
          - ä¿®å¤å¤‡æ³¨æ ¼å¼ï¼Œå»é™¤å†—ä½™å‰ç¼€æ–‡å­—
          - å¤§å¹…æå‡æŠ¥å‘Šç”Ÿæˆé€Ÿåº¦ï¼Œå‡å°‘æ–‡ä»¶I/Oæ“ä½œ
          
          ### ğŸ“¦ å®‰è£…åŒ…
          - **Windows**: GeneticImprove_v${{ steps.get_version.outputs.VERSION }}_win.zip
          - **macOS**: GeneticImprove_v${{ steps.get_version.outputs.VERSION }}_mac.dmg
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **macOS**: macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬
          - è‡³å°‘ 2GB å¯ç”¨å†…å­˜
          - è‡³å°‘ 1GB å¯ç”¨ç£ç›˜ç©ºé—´
          
          ### ğŸ”§ å®‰è£…è¯´æ˜
          **Windows**:
          1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
          2. åŒå‡»"å¯åŠ¨ Genetic Improve.bat"è¿è¡Œç¨‹åº
          
          **macOS**:
          1. ä¸‹è½½å¹¶æ‰“å¼€ DMG æ–‡ä»¶
          2. å°† Genetic Improve.app æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          3. ä»å¯åŠ¨å°æˆ–åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹å¯åŠ¨
        files: |
          ./windows-release/GeneticImprove_v${{ steps.get_version.outputs.VERSION }}_win.zip
          ./macos-release/GeneticImprove_v${{ steps.get_version.outputs.VERSION }}_mac.dmg
        draft: false
        prerelease: false