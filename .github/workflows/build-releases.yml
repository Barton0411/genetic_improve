name: Build Cross-Platform Releases

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.4)'
        required: true
        default: '1.0.4'

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»ºReleaseå’Œä¸Šä¼ æ–‡ä»¶
  actions: read    # å…è®¸è¯»å–ActionsçŠ¶æ€

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows executable (OneDir)
      run: |
        python -m PyInstaller GeneticImprove_win.spec --clean --noconfirm
    
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
    
    - name: Create Inno Setup script
      run: |
        # è·å–ç‰ˆæœ¬å·
        $VERSION = python -c "from version import get_version; print(get_version())"
        echo "Building version: $VERSION"
        
        # åˆ›å»ºInno Setupè„šæœ¬
        @"
        #define MyAppName "å¥¶ç‰›è‚²ç§æ™ºé€‰æŠ¥å‘Šä¸“å®¶"
        #define MyAppVersion "$VERSION"
        #define MyAppPublisher "Genetic Improve Team"
        #define MyAppURL "https://github.com/Barton0411/genetic_improve"
        #define MyAppExeName "GeneticImprove.exe"
        
        [Setup]
        AppId={{7133EFA4-A392-4138-BA22-2BEB199B5056}
        AppName={#MyAppName}
        AppVersion={#MyAppVersion}
        AppPublisher={#MyAppPublisher}
        AppPublisherURL={#MyAppURL}
        AppSupportURL={#MyAppURL}
        AppUpdatesURL={#MyAppURL}
        DefaultDirName={autopf}\{#MyAppName}
        UninstallDisplayIcon={app}\{#MyAppExeName}
        ArchitecturesAllowed=x64compatible
        ArchitecturesInstallIn64BitMode=x64compatible
        DisableProgramGroupPage=yes
        OutputBaseFilename=GeneticImprove_v{#MyAppVersion}_win
        ; SetupIconFile=_internal\icon.ico
        SolidCompression=yes
        WizardStyle=modern
        OutputDir=installer_output
        Compression=lzma2
        CompressionThreads=auto
        
        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"
        
        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
        
        [Files]
        Source: "dist\GeneticImprove\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        
        [Icons]
        Name: "{autoprograms}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; WorkingDir: "{app}"
        Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; WorkingDir: "{app}"; Tasks: desktopicon
        
        [Run]
        Filename: "{app}\{#MyAppExeName}"; WorkingDir: "{app}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
        "@ | Out-File -FilePath setup.iss -Encoding UTF8
        
        echo "Inno Setup script created"
    
    - name: Build installer with Inno Setup
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Force -Path installer_output
        
        # ç¼–è¯‘å®‰è£…åŒ…
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss
        
        # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
        Get-ChildItem installer_output
    
    - name: Create portable ZIP package
      run: |
        # è·å–ç‰ˆæœ¬å·
        $VERSION = python -c "from version import get_version; print(get_version())"
        
        # åˆ›å»ºä¾¿æºç‰ˆZIP
        $ZIP_NAME = "GeneticImprove_v$VERSION" + "_win.zip"
        Compress-Archive -Path "dist\GeneticImprove\*" -DestinationPath $ZIP_NAME -Force
        
        echo "Portable package created: $ZIP_NAME"
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        $size = (Get-Item $ZIP_NAME).Length / 1MB
        echo "Package size: $([math]::Round($size, 2)) MB"
    
    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: installer_output/*.exe
        retention-days: 30
    
    - name: Upload Windows portable
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable
        path: GeneticImprove_v*_win.zip
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        # å®‰è£…åˆ›å»ºDMGçš„å·¥å…·
        brew install create-dmg
    
    - name: Convert ICO to ICNS and build macOS application
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰icon.icoæ–‡ä»¶
        if [ -f "icon.ico" ]; then
          echo "Found icon.ico, converting to ICNS..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºå›¾æ ‡è½¬æ¢
          mkdir -p icon_temp.iconset
          
          # ä½¿ç”¨sipsè½¬æ¢ICOåˆ°PNGï¼Œç„¶ååˆ›å»ºICNS
          sips -z 16 16 "icon.ico" --out "icon_temp.iconset/icon_16x16.png" || echo "Failed to create 16x16 icon"
          sips -z 32 32 "icon.ico" --out "icon_temp.iconset/icon_16x16@2x.png" || echo "Failed to create 16x16@2x icon"
          sips -z 32 32 "icon.ico" --out "icon_temp.iconset/icon_32x32.png" || echo "Failed to create 32x32 icon"
          sips -z 64 64 "icon.ico" --out "icon_temp.iconset/icon_32x32@2x.png" || echo "Failed to create 32x32@2x icon"
          sips -z 128 128 "icon.ico" --out "icon_temp.iconset/icon_128x128.png" || echo "Failed to create 128x128 icon"
          sips -z 256 256 "icon.ico" --out "icon_temp.iconset/icon_128x128@2x.png" || echo "Failed to create 128x128@2x icon"
          sips -z 256 256 "icon.ico" --out "icon_temp.iconset/icon_256x256.png" || echo "Failed to create 256x256 icon"
          sips -z 512 512 "icon.ico" --out "icon_temp.iconset/icon_256x256@2x.png" || echo "Failed to create 256x256@2x icon"
          sips -z 512 512 "icon.ico" --out "icon_temp.iconset/icon_512x512.png" || echo "Failed to create 512x512 icon"
          sips -z 1024 1024 "icon.ico" --out "icon_temp.iconset/icon_512x512@2x.png" || echo "Failed to create 512x512@2x icon"
          
          # åˆ›å»ºICNSæ–‡ä»¶
          if iconutil -c icns icon_temp.iconset -o "icon.icns"; then
            echo "Successfully created icon.icns"
          else
            echo "Failed to create ICNS file, will proceed without icon"
            rm -f "icon.icns"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf icon_temp.iconset
        else
          echo "No icon.ico file found"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºäº†ICNSæ–‡ä»¶
        if [ -f "icon.icns" ]; then
          echo "icon.icns exists, size: $(ls -lh icon.icns)"
        else
          echo "No icon.icns file available for build"
        fi
        
        python -m PyInstaller GeneticImprove.spec --clean --noconfirm
    
    - name: Fix app permissions, icon and security
      run: |
        # è®¾ç½®åº”ç”¨åç§°ä¸ºä¼Šåˆ©é€‰é…
        /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName ä¼Šåˆ©é€‰é…" "dist/ä¼Šåˆ©é€‰é….app/Contents/Info.plist" || true
        /usr/libexec/PlistBuddy -c "Set :CFBundleName ä¼Šåˆ©é€‰é…" "dist/ä¼Šåˆ©é€‰é….app/Contents/Info.plist" || true
        
        # å¦‚æœæœ‰ICNSæ–‡ä»¶ï¼Œç¡®ä¿æ­£ç¡®è®¾ç½®
        if [ -f "icon.icns" ]; then
          cp "icon.icns" "dist/ä¼Šåˆ©é€‰é….app/Contents/Resources/" || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleIconFile icon.icns" "dist/ä¼Šåˆ©é€‰é….app/Contents/Info.plist" || true
        fi
        
        # ä¿®å¤æƒé™
        chmod -R 755 "dist/ä¼Šåˆ©é€‰é….app"
        find "dist/ä¼Šåˆ©é€‰é….app" -name "*.dylib" -exec chmod 755 {} \;
        find "dist/ä¼Šåˆ©é€‰é….app" -name "*.so" -exec chmod 755 {} \;
        
        # æ¸…é™¤æ‰©å±•å±æ€§ï¼ˆé¿å…"å·²æŸå"è­¦å‘Šï¼‰
        xattr -cr "dist/ä¼Šåˆ©é€‰é….app"
        
        # åˆ›å»ºå®‰è£…è¯´æ˜æ–‡ä»¶
        cat > "å®‰è£…è¯´æ˜.txt" << 'EOF'
        ä¼Šåˆ©é€‰é… å®‰è£…è¯´æ˜
        
        å¦‚æœé‡åˆ°"Appleæ— æ³•éªŒè¯æ­¤åº”ç”¨"çš„æç¤ºï¼š
        
        æ–¹æ³•1ï¼ˆæ¨èï¼‰ï¼š
        1. å³é”®ç‚¹å‡»åº”ç”¨ç¨‹åº
        2. é€‰æ‹©"æ‰“å¼€"
        3. åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­ç‚¹å‡»"æ‰“å¼€"
        
        æ–¹æ³•2ï¼š
        1. æ‰“å¼€"ç³»ç»Ÿåå¥½è®¾ç½®" > "å®‰å…¨æ€§ä¸éšç§"
        2. åœ¨"é€šç”¨"é€‰é¡¹å¡ä¸­ç‚¹å‡»"ä»è¦æ‰“å¼€"
        
        è¿™æ˜¯å› ä¸ºåº”ç”¨æœªç»è¿‡Appleå®˜æ–¹ç­¾åï¼Œä½†è½¯ä»¶æœ¬èº«æ˜¯å®‰å…¨çš„ã€‚
        EOF
    
    - name: Create beautiful DMG with background
      run: |
        # è·å–ç‰ˆæœ¬å·
        VERSION=$(python -c "from version import get_version; print(get_version())")
        echo "Building version: $VERSION"
        
        APP_NAME="ä¼Šåˆ©é€‰é…"
        DMG_NAME="YiLiBreeding_v${VERSION}_mac"
        DMG_PATH="${DMG_NAME}.dmg"
        
        # åˆ›å»ºDMGèƒŒæ™¯å›¾ç‰‡ç›®å½•ï¼ˆå¦‚æœéœ€è¦ï¼‰
        mkdir -p dmg_resources
        
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„èƒŒæ™¯å›¾ç‰‡è¯´æ˜æ–‡ä»¶
        cat > dmg_resources/README.txt << EOF
        ä¼Šåˆ©é€‰é… v$VERSION
        
        å®‰è£…è¯´æ˜ï¼š
        1. å°† ä¼Šåˆ©é€‰é… æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
        2. ä»å¯åŠ¨å°æˆ–åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹å¯åŠ¨åº”ç”¨
        3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å³é”®ç‚¹å‡»é€‰æ‹©"æ‰“å¼€"
        EOF
        
        # ä½¿ç”¨create-dmgåˆ›å»ºç¾è§‚çš„DMG
        create-dmg \
          --volname "ä¼Šåˆ©é€‰é…" \
          --window-pos 200 120 \
          --window-size 600 300 \
          --icon-size 100 \
          --icon "${APP_NAME}.app" 150 150 \
          --hide-extension "${APP_NAME}.app" \
          --app-drop-link 450 150 \
          --text-size 14 \
          --format UDZO \
          --hdiutil-quiet \
          --no-internet-enable \
          "$DMG_PATH" \
          "dist/" || {
            # å¦‚æœcreate-dmgå¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ–¹æ³•
            echo "create-dmg failed, using simple method"
            
            DMG_DIR="dmg_temp"
            rm -rf "$DMG_DIR"
            mkdir -p "$DMG_DIR"
            
            cp -R "dist/ä¼Šåˆ©é€‰é….app" "$DMG_DIR/"
            ln -s /Applications "$DMG_DIR/Applications"
            
            hdiutil create -volname "ä¼Šåˆ©é€‰é…" \
                -srcfolder "$DMG_DIR" \
                -ov -format UDZO \
                "$DMG_PATH"
            
            rm -rf "$DMG_DIR"
        }
        
        echo "macOS DMG created: $DMG_PATH"
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        size=$(du -sh "$DMG_PATH" | cut -f1)
        echo "DMG size: $size"
    
    - name: Sign DMG (optional)
      run: |
        # å¦‚æœæœ‰å¼€å‘è€…è¯ä¹¦ï¼Œå¯ä»¥ç­¾å
        # codesign --force --deep --sign "Developer ID Application: Your Name" *.dmg
        echo "Skipping code signing (no certificate configured)"
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-release
        path: YiLiBreeding_v*_mac.dmg
        retention-days: 30

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        name: ä¼Šåˆ©é€‰é… v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ä¼Šåˆ©é€‰é… v${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸš€ æ–°åŠŸèƒ½å’Œæ”¹è¿›
          - ä¼˜åŒ–ä¸ªä½“é€‰é…æŠ¥å‘Šç”Ÿæˆæ€§èƒ½ï¼Œæ·»åŠ çº¦æŸæ•°æ®ç¼“å­˜æœºåˆ¶
          - å®ç°é€‰é…å¤‡æ³¨ç³»ç»Ÿï¼Œè¯¦ç»†è¯´æ˜çº¦æŸè¿‡æ»¤æƒ…å†µ
          - æ–°å¢è¿‘äº¤ç³»æ•°å’Œéšæ€§åŸºå› çº¦æŸåˆ†æåŠŸèƒ½
          - ä¿®å¤å¤‡æ³¨æ ¼å¼ï¼Œå»é™¤å†—ä½™å‰ç¼€æ–‡å­—
          - å¤§å¹…æå‡æŠ¥å‘Šç”Ÿæˆé€Ÿåº¦ï¼Œå‡å°‘æ–‡ä»¶I/Oæ“ä½œ
          - ä¿®å¤Macåº”ç”¨å›¾æ ‡æ˜¾ç¤ºå’ŒWindowsæ„å»ºå®Œæ•´æ€§é—®é¢˜
          
          ### ğŸ“¦ ä¸‹è½½é€‰é¡¹
          
          #### Windowsç‰ˆæœ¬
          - **å®‰è£…ç‰ˆ**: `GeneticImprove_v${{ steps.get_version.outputs.VERSION }}_win.exe` - æ¨èï¼ŒåŒ…å«è‡ªåŠ¨å®‰è£…ç¨‹åº
          - **ä¾¿æºç‰ˆ**: `GeneticImprove_v${{ steps.get_version.outputs.VERSION }}_win.zip` - è§£å‹å³ç”¨ï¼Œæ— éœ€å®‰è£…
          
          #### macOSç‰ˆæœ¬
          - **DMGå®‰è£…åŒ…**: `YiLiBreeding_v${{ steps.get_version.outputs.VERSION }}_mac.dmg`
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆ64ä½ï¼‰
          - **macOS**: macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬
          - è‡³å°‘ 2GB å¯ç”¨å†…å­˜
          - è‡³å°‘ 1GB å¯ç”¨ç£ç›˜ç©ºé—´
          
          ### ğŸ”§ å®‰è£…è¯´æ˜
          
          **Windowså®‰è£…ç‰ˆ**:
          1. ä¸‹è½½ `_setup.exe` æ–‡ä»¶
          2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
          3. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…
          4. æ¡Œé¢å¿«æ·æ–¹å¼è‡ªåŠ¨åˆ›å»º
          
          **Windowsä¾¿æºç‰ˆ**:
          1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
          2. è¿è¡Œæ–‡ä»¶å¤¹ä¸­çš„ `GeneticImprove.exe`
          
          **macOS**:
          1. ä¸‹è½½å¹¶æ‰“å¼€ DMG æ–‡ä»¶
          2. å°† ä¼Šåˆ©é€‰é….app æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          3. ä»å¯åŠ¨å°æˆ–åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹å¯åŠ¨
        files: |
          ./windows-installer/GeneticImprove_v${{ steps.get_version.outputs.VERSION }}_win.exe
          ./windows-portable/GeneticImprove_v${{ steps.get_version.outputs.VERSION }}_win.zip
          ./macos-release/YiLiBreeding_v${{ steps.get_version.outputs.VERSION }}_mac.dmg
        draft: false
        prerelease: false