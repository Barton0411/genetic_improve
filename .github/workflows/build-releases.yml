name: Build Cross-Platform Releases

on:
  push:
    tags:
      - 'v*.*.*'  # åªåœ¨æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘æž„å»º
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.5)'
        required: true
        default: '1.0.5'

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»ºReleaseå’Œä¸Šä¼ æ–‡ä»¶
  actions: read    # å…è®¸è¯»å–ActionsçŠ¶æ€

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Prepare database file
      run: |
        python scripts/prepare_database.py

    - name: Generate changelog
      run: |
        python auto_generate_changelog.py
        echo "Generated changelog file:"
        if (Test-Path "CHANGELOG_v*") { 
          Get-Item "CHANGELOG_v*" | ForEach { Write-Host $_.Name }
        }
    
    - name: Build Windows executable (OneDir)
      run: |
        python -m PyInstaller GeneticImprove_win.spec --clean --noconfirm
    
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
    
    - name: Create Inno Setup script
      run: |
        # èŽ·å–ç‰ˆæœ¬å·
        $VERSION = python -c "from version import get_version; print(get_version())"
        echo "Building version: $VERSION"
        
        # åˆ›å»ºInno Setupè„šæœ¬
        @"
        #define MyAppName "ä¼Šåˆ©å¥¶ç‰›é€‰é…"
        #define MyAppVersion "$VERSION"
        #define MyAppPublisher "Genetic Improve Team"
        #define MyAppURL "https://github.com/Barton0411/genetic_improve"
        #define MyAppExeName "ä¼Šåˆ©å¥¶ç‰›é€‰é….exe"
        
        [Setup]
        AppId={{7133EFA4-A392-4138-BA22-2BEB199B5056}
        AppName={#MyAppName}
        AppVersion={#MyAppVersion}
        AppPublisher={#MyAppPublisher}
        AppPublisherURL={#MyAppURL}
        AppSupportURL={#MyAppURL}
        AppUpdatesURL={#MyAppURL}
        DefaultDirName={autopf}\{#MyAppName}
        UninstallDisplayIcon={app}\{#MyAppExeName}
        ArchitecturesAllowed=x64compatible
        ArchitecturesInstallIn64BitMode=x64compatible
        DisableProgramGroupPage=yes
        OutputBaseFilename=ä¼Šåˆ©å¥¶ç‰›é€‰é…_v{#MyAppVersion}_win
        SetupIconFile=icon.ico
        SolidCompression=yes
        WizardStyle=modern
        OutputDir=installer_output
        Compression=lzma2
        CompressionThreads=auto
        
        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"
        
        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
        
        [Files]
        Source: "dist\ä¼Šåˆ©å¥¶ç‰›é€‰é…\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        
        [Icons]
        Name: "{autoprograms}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; WorkingDir: "{app}"
        Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; WorkingDir: "{app}"; Tasks: desktopicon
        
        [Run]
        Filename: "{app}\{#MyAppExeName}"; WorkingDir: "{app}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
        "@ | Out-File -FilePath setup.iss -Encoding UTF8
        
        echo "Inno Setup script created"
    
    - name: Build installer with Inno Setup
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Force -Path installer_output
        
        # ç¼–è¯‘å®‰è£…åŒ…
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss
        
        # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
        Get-ChildItem installer_output
    
    # Windowsä¾¿æºç‰ˆzipå·²åºŸå¼ƒï¼Œåªä¿ç•™exeå®‰è£…åŒ…
    # - name: Create portable ZIP package
    #   run: |
    #     # èŽ·å–ç‰ˆæœ¬å·
    #     $VERSION = python -c "from version import get_version; print(get_version())"
    #
    #     # åˆ›å»ºä¾¿æºç‰ˆZIP
    #     $ZIP_NAME = "ä¼Šåˆ©å¥¶ç‰›é€‰é…_v$VERSION" + "_win.zip"
    #     Compress-Archive -Path "dist\ä¼Šåˆ©å¥¶ç‰›é€‰é…\*" -DestinationPath $ZIP_NAME -Force
    #
    #     echo "Portable package created: $ZIP_NAME"
    #
    #     # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
    #     $size = (Get-Item $ZIP_NAME).Length / 1MB
    #     echo "Package size: $([math]::Round($size, 2)) MB"

    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: installer_output/*.exe
        retention-days: 30

    # Windowsä¾¿æºç‰ˆzipå·²åºŸå¼ƒ
    # - name: Upload Windows portable
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: windows-portable
    #     path: ä¼Šåˆ©å¥¶ç‰›é€‰é…_v*_win.zip
    #     retention-days: 30

    - name: Upload changelog artifact
      uses: actions/upload-artifact@v4
      with:
        name: changelog-file
        path: CHANGELOG_v*.txt
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        # å®‰è£…åˆ›å»ºDMGçš„å·¥å…·
        brew install create-dmg

    # macOSä¸æ‰“åŒ…æ•°æ®åº“ï¼Œè·³è¿‡æ•°æ®åº“å‡†å¤‡æ­¥éª¤ï¼ˆå‡å°å®‰è£…åŒ…ä½“ç§¯ï¼‰
    # - name: Prepare database file
    #   run: |
    #     python3 scripts/prepare_database.py

    - name: Generate changelog
      run: |
        python3 auto_generate_changelog.py
        echo "Generated changelog file:"
        ls -la CHANGELOG_v* || echo "No changelog files found"
    
    - name: Convert ICO to ICNS and build macOS application
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰icon.icoæ–‡ä»¶
        if [ -f "icon.ico" ]; then
          echo "Found icon.ico, converting to ICNS..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºŽå›¾æ ‡è½¬æ¢
          mkdir -p icon_temp.iconset
          
          # ä½¿ç”¨sipsè½¬æ¢ICOåˆ°PNGï¼Œç„¶åŽåˆ›å»ºICNS
          sips -z 16 16 "icon.ico" --out "icon_temp.iconset/icon_16x16.png" || echo "Failed to create 16x16 icon"
          sips -z 32 32 "icon.ico" --out "icon_temp.iconset/icon_16x16@2x.png" || echo "Failed to create 16x16@2x icon"
          sips -z 32 32 "icon.ico" --out "icon_temp.iconset/icon_32x32.png" || echo "Failed to create 32x32 icon"
          sips -z 64 64 "icon.ico" --out "icon_temp.iconset/icon_32x32@2x.png" || echo "Failed to create 32x32@2x icon"
          sips -z 128 128 "icon.ico" --out "icon_temp.iconset/icon_128x128.png" || echo "Failed to create 128x128 icon"
          sips -z 256 256 "icon.ico" --out "icon_temp.iconset/icon_128x128@2x.png" || echo "Failed to create 128x128@2x icon"
          sips -z 256 256 "icon.ico" --out "icon_temp.iconset/icon_256x256.png" || echo "Failed to create 256x256 icon"
          sips -z 512 512 "icon.ico" --out "icon_temp.iconset/icon_256x256@2x.png" || echo "Failed to create 256x256@2x icon"
          sips -z 512 512 "icon.ico" --out "icon_temp.iconset/icon_512x512.png" || echo "Failed to create 512x512 icon"
          sips -z 1024 1024 "icon.ico" --out "icon_temp.iconset/icon_512x512@2x.png" || echo "Failed to create 512x512@2x icon"
          
          # åˆ›å»ºICNSæ–‡ä»¶
          if iconutil -c icns icon_temp.iconset -o "icon.icns"; then
            echo "âœ… Successfully created icon.icns"
            
            # éªŒè¯ICNSæ–‡ä»¶
            if [ -f "icon.icns" ]; then
              echo "ICNS file size: $(ls -lh icon.icns | awk '{print $5}')"
              # æ£€æŸ¥ICNSæ–‡ä»¶å†…å®¹
              file "icon.icns"
            fi
          else
            echo "âŒ Failed to create ICNS file"
            
            # å°è¯•å¤‡ç”¨æ–¹æ³•ï¼šä½¿ç”¨ç®€å•çš„PNGè½¬ICNS
            if [ -f "icon.ico" ]; then
              echo "ðŸ”„ Trying alternative method: PNG to ICNS"
              
              # è½¬æ¢ICOä¸ºPNG
              sips -s format png "icon.ico" --out "temp_icon.png" || true
              
              if [ -f "temp_icon.png" ]; then
                # åˆ›å»ºç®€å•çš„iconset
                mkdir -p simple.iconset
                sips -z 512 512 "temp_icon.png" --out "simple.iconset/icon_512x512.png" || true
                sips -z 256 256 "temp_icon.png" --out "simple.iconset/icon_256x256.png" || true
                sips -z 128 128 "temp_icon.png" --out "simple.iconset/icon_128x128.png" || true
                sips -z 64 64 "temp_icon.png" --out "simple.iconset/icon_64x64.png" || true
                sips -z 32 32 "temp_icon.png" --out "simple.iconset/icon_32x32.png" || true
                sips -z 16 16 "temp_icon.png" --out "simple.iconset/icon_16x16.png" || true
                
                # å†æ¬¡å°è¯•åˆ›å»ºICNS
                iconutil -c icns simple.iconset -o "icon.icns" || true
                
                # æ¸…ç†
                rm -rf simple.iconset temp_icon.png
              fi
            fi
            
            # å¦‚æžœä»ç„¶å¤±è´¥ï¼Œåˆ é™¤æ— æ•ˆæ–‡ä»¶
            if [ ! -f "icon.icns" ] || [ ! -s "icon.icns" ]; then
              rm -f "icon.icns"
              echo "âš ï¸ Will proceed without icon"
            fi
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf icon_temp.iconset
        else
          echo "No icon.ico file found"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºäº†ICNSæ–‡ä»¶
        if [ -f "icon.icns" ]; then
          echo "icon.icns exists, size: $(ls -lh icon.icns)"
        else
          echo "No icon.icns file available for build"
        fi
        
        python -m PyInstaller GeneticImprove.spec --clean --noconfirm
    
    - name: Fix app permissions, icon and security
      run: |
        # è®¾ç½®åº”ç”¨æ˜¾ç¤ºåç§°ä¸ºä¼Šåˆ©å¥¶ç‰›é€‰é…
        /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName ä¼Šåˆ©å¥¶ç‰›é€‰é…" "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app/Contents/Info.plist" || true
        /usr/libexec/PlistBuddy -c "Set :CFBundleName ä¼Šåˆ©å¥¶ç‰›é€‰é…" "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app/Contents/Info.plist" || true
        
        # å¦‚æžœæœ‰ICNSæ–‡ä»¶ï¼Œç¡®ä¿æ­£ç¡®è®¾ç½®
        if [ -f "icon.icns" ]; then
          # ç¡®ä¿Resourcesç›®å½•å­˜åœ¨
          mkdir -p "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app/Contents/Resources/"
          
          # å¤åˆ¶å›¾æ ‡æ–‡ä»¶
          cp "icon.icns" "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app/Contents/Resources/" || true
          
          # è®¾ç½®Info.plistä¸­çš„å›¾æ ‡å¼•ç”¨ï¼ˆå°è¯•å¤šç§æ ¼å¼ï¼‰
          /usr/libexec/PlistBuddy -c "Set :CFBundleIconFile icon.icns" "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app/Contents/Info.plist" || true
          /usr/libexec/PlistBuddy -c "Set :CFBundleIconName icon" "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app/Contents/Info.plist" || true
          
          # éªŒè¯å›¾æ ‡æ–‡ä»¶æ˜¯å¦æ­£ç¡®å¤åˆ¶
          if [ -f "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app/Contents/Resources/icon.icns" ]; then
            echo "âœ… å›¾æ ‡æ–‡ä»¶å·²æˆåŠŸå¤åˆ¶åˆ°åº”ç”¨ç¨‹åºåŒ…ä¸­"
            ls -la "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app/Contents/Resources/icon.icns"
          else
            echo "âŒ å›¾æ ‡æ–‡ä»¶å¤åˆ¶å¤±è´¥"
          fi
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°icon.icnsæ–‡ä»¶"
        fi
        
        # ä¿®å¤æƒé™
        chmod -R 755 "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app"
        find "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app" -name "*.dylib" -exec chmod 755 {} \;
        find "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app" -name "*.so" -exec chmod 755 {} \;
        
        # æ¸…é™¤æ‰©å±•å±žæ€§ï¼ˆé¿å…"å·²æŸå"è­¦å‘Šï¼‰
        xattr -cr "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app"
        
        # åˆ›å»ºå®‰è£…è¯´æ˜Žæ–‡ä»¶
        cat > "å®‰è£…è¯´æ˜Ž.txt" << 'EOF'
        ä¼Šåˆ©å¥¶ç‰›é€‰é… å®‰è£…è¯´æ˜Ž
        
        å¦‚æžœé‡åˆ°"Appleæ— æ³•éªŒè¯æ­¤åº”ç”¨"çš„æç¤ºï¼š
        
        æ–¹æ³•1ï¼ˆæŽ¨èï¼‰ï¼š
        1. å³é”®ç‚¹å‡»åº”ç”¨ç¨‹åº
        2. é€‰æ‹©"æ‰“å¼€"
        3. åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­ç‚¹å‡»"æ‰“å¼€"
        
        æ–¹æ³•2ï¼š
        1. æ‰“å¼€"ç³»ç»Ÿåå¥½è®¾ç½®" > "å®‰å…¨æ€§ä¸Žéšç§"
        2. åœ¨"é€šç”¨"é€‰é¡¹å¡ä¸­ç‚¹å‡»"ä»è¦æ‰“å¼€"
        
        è¿™æ˜¯å› ä¸ºåº”ç”¨æœªç»è¿‡Appleå®˜æ–¹ç­¾åï¼Œä½†è½¯ä»¶æœ¬èº«æ˜¯å®‰å…¨çš„ã€‚
        EOF
    
    - name: Create beautiful DMG with background
      run: |
        # èŽ·å–ç‰ˆæœ¬å·
        VERSION=$(python -c "from version import get_version; print(get_version())")
        echo "Building version: $VERSION"
        
        APP_NAME="ä¼Šåˆ©å¥¶ç‰›é€‰é…"
        DMG_NAME="ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_mac"
        DMG_PATH="${DMG_NAME}.dmg"
        
        # åˆ›å»ºDMGèƒŒæ™¯å›¾ç‰‡ç›®å½•ï¼ˆå¦‚æžœéœ€è¦ï¼‰
        mkdir -p dmg_resources
        
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„èƒŒæ™¯å›¾ç‰‡è¯´æ˜Žæ–‡ä»¶
        cat > dmg_resources/README.txt << EOF
        ä¼Šåˆ©å¥¶ç‰›é€‰é… v$VERSION
        
        å®‰è£…è¯´æ˜Žï¼š
        1. å°† ä¼Šåˆ©å¥¶ç‰›é€‰é… æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
        2. ä»Žå¯åŠ¨å°æˆ–åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹å¯åŠ¨åº”ç”¨
        3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å³é”®ç‚¹å‡»é€‰æ‹©"æ‰“å¼€"
        EOF
        
        # ä½¿ç”¨create-dmgåˆ›å»ºç¾Žè§‚çš„DMG
        create-dmg \
          --volname "ä¼Šåˆ©å¥¶ç‰›é€‰é…" \
          --window-pos 200 120 \
          --window-size 600 300 \
          --icon-size 100 \
          --icon "${APP_NAME}.app" 150 150 \
          --hide-extension "${APP_NAME}.app" \
          --app-drop-link 450 150 \
          --text-size 14 \
          --format UDZO \
          --hdiutil-quiet \
          --no-internet-enable \
          "$DMG_PATH" \
          "dist/" || {
            # å¦‚æžœcreate-dmgå¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ–¹æ³•
            echo "create-dmg failed, using simple method"
            
            DMG_DIR="dmg_temp"
            rm -rf "$DMG_DIR"
            mkdir -p "$DMG_DIR"
            
            cp -R "dist/ä¼Šåˆ©å¥¶ç‰›é€‰é….app" "$DMG_DIR/"
            ln -s /Applications "$DMG_DIR/Applications"
            
            hdiutil create -volname "ä¼Šåˆ©å¥¶ç‰›é€‰é…" \
                -srcfolder "$DMG_DIR" \
                -ov -format UDZO \
                "$DMG_PATH"
            
            rm -rf "$DMG_DIR"
        }
        
        echo "macOS DMG created: $DMG_PATH"
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        size=$(du -sh "$DMG_PATH" | cut -f1)
        echo "DMG size: $size"
    
    - name: Sign DMG (optional)
      run: |
        # å¦‚æžœæœ‰å¼€å‘è€…è¯ä¹¦ï¼Œå¯ä»¥ç­¾å
        # codesign --force --deep --sign "Developer ID Application: Your Name" *.dmg
        echo "Skipping code signing (no certificate configured)"
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-release
        path: ä¼Šåˆ©å¥¶ç‰›é€‰é…_v*_mac.dmg
        retention-days: 30

  upload-to-oss:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: List downloaded artifacts
      run: |
        echo "ðŸ“¦ åˆ—å‡ºæ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶ï¼š"
        ls -laR
        echo ""
        echo "ðŸ“‚ ç›®å½•ç»“æž„ï¼š"
        tree -L 3 || find . -type f -print

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" =~ refs/tags/.* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"

    - name: Setup OSS CLI
      run: |
        # ä¸‹è½½å¹¶å®‰è£…é˜¿é‡Œäº‘OSS CLIå·¥å…·
        wget -q https://gosspublic.alicdn.com/ossutil/1.7.18/ossutil64 -O ossutil
        chmod +x ossutil

        # é…ç½®OSS CLIï¼ˆä½¿ç”¨GitHub Secretsä¸­çš„å¯†é’¥ï¼‰
        ./ossutil config -e oss-cn-beijing.aliyuncs.com -i "${{ secrets.ALIYUN_ACCESS_KEY_ID }}" -k "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"

    - name: Upload Windows installer to OSS
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        WIN_EXE="windows-installer/ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_win.exe"

        echo "ðŸ“¤ å‡†å¤‡ä¸Šä¼  Windows å®‰è£…åŒ…..."
        echo "æŸ¥æ‰¾æ–‡ä»¶: $WIN_EXE"

        # éªŒè¯æ–‡ä»¶å­˜åœ¨
        if [ ! -f "$WIN_EXE" ]; then
          echo "âŒ é”™è¯¯ï¼šWindowså®‰è£…åŒ…ä¸å­˜åœ¨: $WIN_EXE"
          echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
          ls -la windows-installer/
          exit 1
        fi

        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        FILE_SIZE=$(du -h "$WIN_EXE" | cut -f1)
        echo "âœ… æ‰¾åˆ°æ–‡ä»¶ï¼Œå¤§å°: $FILE_SIZE"

        # ä¸Šä¼ åˆ°OSS
        ./ossutil cp "$WIN_EXE" \
          "oss://genetic-improve/releases/v${VERSION}/ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_win.exe" --force

        # éªŒè¯ä¸Šä¼ 
        ./ossutil stat "oss://genetic-improve/releases/v${VERSION}/ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_win.exe"

        echo "âœ… Windows å®‰è£…åŒ…ä¸Šä¼ å®Œæˆï¼"
        echo "OSS URL: https://genetic-improve.oss-cn-beijing.aliyuncs.com/releases/v${VERSION}/ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_win.exe"

    - name: Upload macOS DMG to OSS
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        MAC_DMG="macos-release/ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_mac.dmg"

        echo "ðŸ“¤ å‡†å¤‡ä¸Šä¼  macOS DMG..."
        echo "æŸ¥æ‰¾æ–‡ä»¶: $MAC_DMG"

        # éªŒè¯æ–‡ä»¶å­˜åœ¨
        if [ ! -f "$MAC_DMG" ]; then
          echo "âŒ é”™è¯¯ï¼šmacOS DMGä¸å­˜åœ¨: $MAC_DMG"
          echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
          ls -la macos-release/
          exit 1
        fi

        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        FILE_SIZE=$(du -h "$MAC_DMG" | cut -f1)
        echo "âœ… æ‰¾åˆ°æ–‡ä»¶ï¼Œå¤§å°: $FILE_SIZE"

        # ä¸Šä¼ åˆ°OSS
        ./ossutil cp "$MAC_DMG" \
          "oss://genetic-improve/releases/v${VERSION}/ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_mac.dmg" --force

        # éªŒè¯ä¸Šä¼ 
        ./ossutil stat "oss://genetic-improve/releases/v${VERSION}/ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_mac.dmg"

        echo "âœ… macOS DMG ä¸Šä¼ å®Œæˆï¼"
        echo "OSS URL: https://genetic-improve.oss-cn-beijing.aliyuncs.com/releases/v${VERSION}/ä¼Šåˆ©å¥¶ç‰›é€‰é…_v${VERSION}_mac.dmg"

    - name: Upload changelog to OSS
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"

        # æ£€æŸ¥changelogæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "changelog-file/CHANGELOG_v${VERSION}.txt" ]; then
          echo "ðŸ“¤ ä¸Šä¼  CHANGELOG åˆ° OSS..."

          # ä¸Šä¼ åˆ°OSS releasesç›®å½•
          ./ossutil cp "changelog-file/CHANGELOG_v${VERSION}.txt" \
            "oss://genetic-improve/releases/v${VERSION}/CHANGELOG.txt" --force

          echo "âœ… Changelog ä¸Šä¼ å®Œæˆï¼"
          echo "OSS URL: https://genetic-improve.oss-cn-beijing.aliyuncs.com/releases/v${VERSION}/CHANGELOG.txt"
        else
          echo "âš ï¸ æœªæ‰¾åˆ° changelog æ–‡ä»¶ï¼Œè·³è¿‡ä¸Šä¼ "
          ls -la changelog-file/ || echo "changelog-file ç›®å½•ä¸å­˜åœ¨"
        fi

    - name: Update version.json and upload to OSS
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        echo "ðŸ“ æ›´æ–° version.json..."

        # è¯»å–version.jsonå†…å®¹å¹¶ä¸Šä¼ 
        if [ -f "version.json" ]; then
          echo "âœ… æ‰¾åˆ° version.jsonï¼Œä¸Šä¼ åˆ° OSS..."

          # ä¸Šä¼ version.jsonåˆ°latestç›®å½•ï¼ˆè½¯ä»¶æ£€æŸ¥æ›´æ–°æ—¶è¯»å–è¿™ä¸ªï¼‰
          ./ossutil cp "version.json" "oss://genetic-improve/releases/latest/version.json" --force

          # åŒæ—¶å¤‡ä»½åˆ°å½“å‰ç‰ˆæœ¬ç›®å½•
          ./ossutil cp "version.json" \
            "oss://genetic-improve/releases/v${VERSION}/version.json" --force

          echo "âœ… version.json ä¸Šä¼ å®Œæˆï¼"
          echo "Latest URL: https://genetic-improve.oss-cn-beijing.aliyuncs.com/releases/latest/version.json"
          echo "Version URL: https://genetic-improve.oss-cn-beijing.aliyuncs.com/releases/v${VERSION}/version.json"

          # æ˜¾ç¤ºversion.jsonå†…å®¹
          echo "ðŸ“„ version.json å†…å®¹ï¼š"
          cat version.json
        else
          echo "âŒ æœªæ‰¾åˆ° version.json æ–‡ä»¶"
          exit 1
        fi

  create-release:
    needs: [build-windows, build-macos, upload-to-oss]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Download changelog artifact
      uses: actions/download-artifact@v4
      with:
        name: changelog-file
        path: ./changelog
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        CHANGELOG_FILE="changelog/CHANGELOG_v${VERSION}.txt"

        # åˆ›å»ºrelease notesæ–‡ä»¶
        cat > release_notes.md << 'EOFNOTES'
        ## ä¼Šåˆ©å¥¶ç‰›é€‰é…ç³»ç»Ÿæ›´æ–°

        ### æ›´æ–°å†…å®¹
        EOFNOTES

        if [ -f "$CHANGELOG_FILE" ]; then
          echo "Found changelog file, reading content..."
          # è¯»å–changelogå†…å®¹å¹¶æ·»åŠ 
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              echo "- $line" >> release_notes.md
            fi
          done < "$CHANGELOG_FILE"
        else
          echo "No changelog found, using default content..."
          cat >> release_notes.md << 'EOFNOTES'
        - ä¼˜åŒ–å¯¼èˆªæ ç•Œé¢é…è‰²æ–¹æ¡ˆï¼Œæå‡è§†è§‰ä½“éªŒ
        - æ”¹è¿›èœå•é€‰ä¸­çŠ¶æ€æ˜¾ç¤ºæ•ˆæžœ
        - ä¿®å¤ExcelæŠ¥å‘Šä¸­å›¾è¡¨é‡å æ˜¾ç¤ºé—®é¢˜
        - ä¼˜åŒ–æ•£ç‚¹å›¾å¸ƒå±€æŽ’åˆ—æ–¹å¼
        EOFNOTES
        fi

        cat release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        name: ä¼Šåˆ©å¥¶ç‰›é€‰é… v${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        files: |
          windows-installer/*.exe
          macos-release/*.dmg
        draft: false
        prerelease: false