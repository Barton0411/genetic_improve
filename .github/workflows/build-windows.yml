name: Build Windows Executable

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Create spec file
      run: |
        @"
# -*- mode: python ; coding: utf-8 -*-
import os
import sys

block_cipher = None

a = Analysis(
    ['main.py'],
    pathex=['.'],
    binaries=[],
    datas=[
        ('config', 'config'),
        ('templates', 'templates'),
        ('docs', 'docs'),
        ('gui', 'gui'),
        ('core', 'core'),
        ('utils', 'utils'),
        ('*.mp4', '.'),
        ('*.jpg', '.'),
        ('*.ico', '.'),
    ],
    hiddenimports=[
        'pandas', 'numpy', 'openpyxl', 'matplotlib', 'scipy', 'sklearn',
        'PyQt6', 'PyQt6.QtCore', 'PyQt6.QtGui', 'PyQt6.QtWidgets',
        'PyQt6.QtMultimedia', 'PyQt6.QtMultimediaWidgets',
        'sqlalchemy', 'cv2', 'cryptography', 'dateutil', 'networkx', 'seaborn',
        'gui', 'gui.main_window', 'gui.login_dialog', 'gui.splash_screen',
        'gui.dialogs', 'gui.progress', 'gui.worker', 'gui.db_update_worker',
        'gui.allocation_dialog', 'gui.matching_worker', 'gui.recommendation_worker',
        'gui.simple_recommendation_worker', 'gui.auto_grouping_dialog',
        'core', 'core.data', 'core.data.uploader', 'core.data.processor',
        'core.data.update_manager', 'core.data.data_loader',
        'core.breeding_calc', 'core.breeding_calc.cow_traits_calc',
        'core.breeding_calc.bull_traits_calc', 'core.breeding_calc.index_page',
        'core.breeding_calc.mated_bull_traits_calc',
        'core.grouping', 'core.grouping.group_manager',
        'core.matching', 'core.matching.complete_mating_executor',
        'core.matching.cycle_based_matcher', 'core.matching.matrix_recommendation_generator',
        'core.matching.allocation_utils', 'core.matching.models',
        'core.inbreeding', 'core.inbreeding.inbreeding_page',
        'core.inbreeding.inbreeding_calculator', 'core.inbreeding.animal',
        'core.report', 'core.report.ppt_generator',
        'utils', 'utils.file_manager', 'utils.database',
        'config', 'config.settings', 'config.index_library',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=['test', 'tests'],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='遗传改良系统',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    runtime_tmpdir=None,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='icon.ico'
)
"@ | Out-File -FilePath "genetic_improve.spec" -Encoding UTF8

    - name: Build executable with PyInstaller
      run: |
        pyinstaller genetic_improve.spec --clean
      continue-on-error: true
    
    - name: Create release directory
      run: |
        mkdir release
        # 复制可执行文件
        if (Test-Path "dist\遗传改良系统.exe") {
          Copy-Item -Path "dist\遗传改良系统.exe" -Destination "release\"
        } elseif (Test-Path "dist\遗传改良系统\遗传改良系统.exe") {
          Copy-Item -Path "dist\遗传改良系统\*" -Destination "release\" -Recurse
        }
        # 复制必要的配置和模板文件
        Copy-Item -Path "config" -Destination "release\config" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "templates" -Destination "release\templates" -Recurse -ErrorAction SilentlyContinue
        Copy-Item -Path "README.md" -Destination "release\" -ErrorAction SilentlyContinue
        Copy-Item -Path "docs\用户手册.md" -Destination "release\" -ErrorAction SilentlyContinue
    
    - name: Create zip archive
      run: |
        Compress-Archive -Path "release\*" -DestinationPath "genetic_improve_system_win64.zip"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: genetic-improve-system-windows
        path: genetic_improve_system_win64.zip
    
    # 暂时注释掉自动创建Release，避免权限问题
    # - name: Create Release
    #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    #   uses: softprops/action-gh-release@v1
    #   with:
    #     tag_name: v${{ github.run_number }}
    #     name: Release Build ${{ github.run_number }}
    #     body: |
    #       自动构建版本 #${{ github.run_number }}
    #       
    #       更新内容：
    #       - 完善个体选配功能：肉牛标记和递进机制
    #       - 修复肉牛标记逻辑
    #       - 实现真正的递进分配机制
    #       - 添加推荐矩阵保存功能
    #       - 改进分组同步机制
    #       
    #       下载后解压即可使用。
    #     files: genetic_improve_system_win64.zip
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}