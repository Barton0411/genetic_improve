# 项目开发规则

## 版本发布规范

### 版本发布自动化流程

**触发命令：** 当用户说"发布新版本 vX.X.X.X"或类似表达时，AI必须自动执行完整发布流程。

**使用TodoWrite跟踪进度：** 开始时创建任务清单，实时更新状态。

### 第0步：确认信息

如果用户没有提供完整信息，主动询问：
1. 版本号是什么？（如：v1.2.0.19）
2. 是否需要清理测试文件？（默认：是）

### 第1步：分析变更内容

执行以下命令自动分析变更：
```bash
# 1. 找出上一个版本标签
git describe --tags --abbrev=0

# 2. 获取从上个版本到现在的所有commit
git log <上个版本>..HEAD --oneline --pretty=format:"%s"

# 3. 获取修改的文件列表
git diff --name-only <上个版本>..HEAD
```

根据commit message和文件变更，自动分类为：
- **新功能**：feat:开头的commit，或新增功能相关文件
- **Bug修复**：fix:开头的commit
- **性能改进**：perf:开头的commit
- **文档更新**：docs:开头的commit

### 第2步：清理测试文件（如需要）

如果用户要求清理测试文件：
```bash
# 扫描test目录下7天未修改的文件
find test -type f -mtime +7

# 扫描临时文件
find . -name "*.log" -o -name "*.tmp" -o -name "*.cache" -mtime +7
```

**列出文件清单，等待用户确认后再删除。**

### 第3步：更新文档（docs/目录）

按照`docs/文档维护规则.md`中的检查清单更新：

**必须更新的文档：**
1. `docs/05-项目管理/版本历史.md` - 添加新版本条目
2. `docs/05-项目管理/已完成任务.md` - 标记完成的任务，更新完成度
3. `docs/05-项目管理/项目路线图.md` - 移除已完成任务，调整优先级
4. `docs/README.md` - 更新版本号、完成度、功能列表、版本历史表格

**可选更新（根据变更内容）：**
5. `docs/01-快速开始/快速入门指南.md` - 如有重大功能更新
6. `docs/01-快速开始/常见问题FAQ.md` - 如有新的常见问题
7. `docs/02-用户手册/` - 创建或更新功能文档（如有新功能）
8. `docs/03-开发文档/API参考.md` - 如有API变更

**更新所有文档的日期字段为今天日期。**

### 第4步：更新代码版本号（必须严格遵守）

当需要发布新版本时，**必须**按以下顺序更新所有相关文件：

#### 4.1 更新 version.py
**位置：** `/version.py`

**必须更新内容：**
1. `VERSION` 变量（格式：`"1.2.0.19"`，不带v前缀）
2. `VERSION_HISTORY` 列表（在最前面添加新版本记录）

**新版本记录格式：**
```python
{
    "version": "1.2.0.19",
    "date": "2025-11-03",  # 今天日期
    "author": "Development Team",
    "changes": [
        # 从version.json的changes原样复制过来
    ]
}
```

**重要规则：**
- `VERSION_HISTORY`的`changes`必须与`version.json`的`changes`完全一致
- `VERSION_HISTORY`是所有历史版本的`version.json` changes的集合
- 每次发布时，将`version.json`的`changes`原样复制到`VERSION_HISTORY`最前面
- 两者格式和内容必须完全一致，不做任何修改
- 这样用户可以在应用内查看完整的版本历史

- **变更说明（changes）编写规则**：
  - **不使用 emoji 表情符号**，改用"序号+分类小标题"格式
  - 格式：`序号. <b>分类</b>：具体描述`（使用HTML标签以便在更新对话框中正确显示加粗效果）
  - 常用分类：界面、功能、修复、优化、性能等
  - **严禁出现以下技术细节**：
    - 颜色代码（如#456ba0、rgba(255,255,255)等）
    - CSS属性名（如gradient、padding、margin等）
    - 代码文件名（如main_window.py、sheet8_builder.py等）
    - 具体数值参数（如"从16行到22行"、"间距0.2"等）
    - 技术术语（如"通过QSS设置"、"使用QPalette"等）
  - 使用专业但用户可理解的语言描述功能变化
  - 示例对比：
    - ❌ 错误："🎨 全新导航栏渐变蓝设计：从#456ba0到#2c5282的专业渐变背景"
    - ❌ 错误："✨ 优化菜单项样式：白色半透明文字，选中状态为浅色背景配深蓝文字"
    - ❌ 错误："🔧 修复Sheet 8图表重叠：调整间距从16行到22行"
    - ✅ 正确："1. <b>界面</b>：优化导航栏配色方案，提升视觉体验"
    - ✅ 正确："2. <b>界面</b>：改进菜单选中状态显示效果"
    - ✅ 正确："3. <b>修复</b>：修复Excel报告中图表重叠显示问题"

#### 4.2 更新 version.json（⚠️ 最容易遗漏！）
**位置：** `/version.json`

**这是最容易遗漏的文件！客户端依赖此文件检查更新！**

**必须更新内容：**
```json
{
  "version": "v1.2.0.19",  // 带v前缀
  "mac_download_url": "https://genetic-improve.oss-cn-beijing.aliyuncs.com/releases/v1.2.0.19/伊利奶牛选配_v1.2.0.19_macOS.dmg",
  "win_download_url": "https://genetic-improve.oss-cn-beijing.aliyuncs.com/releases/v1.2.0.19/伊利奶牛选配_v1.2.0.19_Windows.exe",
  "changes": [
    "1. <b>界面</b>：具体描述",
    "2. <b>修复</b>：具体描述",
    "3. <b>优化</b>：具体描述"
  ],
  "force_update": false
}
```

**changes编写规则（严格遵守）：**
- ❌ 不使用emoji表情符号
- ❌ 不出现颜色代码（#456ba0、rgba等）
- ❌ 不出现CSS属性名（gradient、padding等）
- ❌ 不出现代码文件名（main_window.py等）
- ❌ 不出现具体数值参数（如"从16行到22行"）
- ❌ 不出现技术术语（QSS、QPalette等）
- ❌ 避免口语化表达
- ✅ 使用"序号. <b>分类</b>：描述"格式
- ✅ 使用HTML `<b>`标签加粗分类
- ✅ 常用分类：界面、功能、修复、优化、性能
- ✅ 使用专业但用户可理解的语言

**示例对比：**
- ❌ 错误："🎨 全新导航栏渐变蓝设计：从#456ba0到#2c5282"
- ❌ 错误："修复Sheet 8图表重叠：调整间距从16行到22行"
- ❌ 错误："更新了软件界面配色，导航栏采用蓝色风格"（太口语化）
- ✅ 正确："1. <b>界面</b>：优化导航栏配色方案，提升视觉体验"
- ✅ 正确："2. <b>修复</b>：修复Excel报告中图表重叠显示问题"
- ✅ 正确："3. <b>界面</b>：改进菜单选中状态显示效果"

#### 4.3 更新 CHANGELOG.md
**位置：** `/CHANGELOG.md`

在文件第6行之后添加新版本条目：
```markdown
## [1.2.0.19] - 2025-11-03 📋 简短描述

### 🎨 界面优化（或其他分类）
- 详细说明1
- 详细说明2

### 🔧 问题修复
- 详细说明
```

#### 版本更新检查清单（必须全部确认）

在继续第5步之前，确认以下所有项：
- [ ] version.py 的 VERSION 已更新（无v前缀）
- [ ] version.py 的 VERSION_HISTORY 已添加新条目
- [ ] version.json 的 version 已更新（带v前缀）
- [ ] version.json 的 mac_download_url 已更新版本号
- [ ] version.json 的 win_download_url 已更新版本号
- [ ] version.json 的 changes 列表已更新（无emoji）
- [ ] version.py 和 version.json 的 changes 完全一致
- [ ] CHANGELOG.md 已添加新版本条目
- [ ] 所有文件的版本号一致
- [ ] docs/ 目录下的文档已更新

### 第5步：执行Git操作

**重要：严格按照以下顺序执行，每一步都要等待前一步成功后再执行下一步**

#### 5.1 检查状态和添加文件

```bash
# 1. 查看所有变更
git status

# 2. 添加版本相关文件（必须包含这3个文件）
git add version.py CHANGELOG.md version.json

# 3. 添加文档变更
git add docs/

# 4. 添加其他修改的源代码文件
git add [其他修改的文件]
```

#### 5.2 创建提交

使用规范的commit message格式：

```bash
git commit -m "🎨 v1.2.0.19: [简短标题]

### [分类emoji + 标题]
- 更新点1
- 更新点2
- 更新点3

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

**Emoji使用规范：**
- 🎨 界面优化、设计改进
- ✨ 新功能
- 🔧 问题修复、技术改进
- 📊 数据相关、图表优化
- 🎯 用户体验改进
- 🔄 重构、流程优化
- 🐛 Bug修复
- 📝 文档更新
- 🚀 性能优化

#### 5.3 推送到main分支

```bash
git push origin main
```

等待推送成功。

#### 5.4 创建并推送版本标签

**重要：推送标签会触发GitHub Actions自动构建！**

```bash
# 1. 创建版本标签
git tag -a v1.2.0.19 -m "v1.2.0.19: [简短描述]"

# 2. 查看标签是否创建成功
git tag -l | tail -5

# 3. 推送标签（这会触发GitHub Actions）
git push origin v1.2.0.19
```

#### 5.5 确认推送成功

```bash
# 查看最近的commit
git log -1

# 查看远程分支状态
git branch -vv
```

### 第6步：生成完整报告

总结所有操作并报告给用户：

```
✅ 版本 v1.2.0.19 发布完成

## 📊 版本信息
- 版本号：v1.2.0.19
- 发布日期：2025-11-03
- 完成度：[X]% → [Y]%

## 📝 本次变更
### ✨ 新功能
- [列表]

### 🐛 Bug修复
- [列表]

### 🔧 性能改进
- [列表]

## 📄 已更新的文件
1. ✅ version.py（VERSION + VERSION_HISTORY）
2. ✅ version.json（version + urls + changes）⚠️
3. ✅ CHANGELOG.md
4. ✅ docs/05-项目管理/版本历史.md
5. ✅ docs/05-项目管理/已完成任务.md
6. ✅ docs/05-项目管理/项目路线图.md
7. ✅ docs/README.md
[其他更新的文档...]

## 🗑️ 清理的文件
- [列表，如果有]

## 📦 Git操作
- ✅ Commit: [commit hash]
- ✅ Tag: v1.2.0.19
- ✅ Pushed to GitHub
- ✅ GitHub Actions: https://github.com/[用户名]/genetic_improve/actions

## 🎯 下一步建议
1. 检查GitHub Actions构建状态
2. 测试新版本功能
3. 通知相关人员版本更新
```

---

## 完整版本更新检查清单

发布新版本前，确认以下所有项：

**代码版本文件：**
- [ ] version.py 的 VERSION 已更新（无v前缀）
- [ ] version.py 的 VERSION_HISTORY 已添加新条目
- [ ] version.json 的 version 已更新（带v前缀）⚠️
- [ ] version.json 的 mac_download_url 已更新版本号⚠️
- [ ] version.json 的 win_download_url 已更新版本号⚠️
- [ ] version.json 的 changes 列表已更新（无emoji）⚠️
- [ ] version.py 和 version.json 的 changes 完全一致
- [ ] CHANGELOG.md 已添加新版本条目

**文档更新：**
- [ ] docs/05-项目管理/版本历史.md 已更新
- [ ] docs/05-项目管理/已完成任务.md 已更新
- [ ] docs/05-项目管理/项目路线图.md 已更新
- [ ] docs/README.md 已更新版本号和完成度
- [ ] 所有文档的"更新时间"字段已更新

**Git操作：**
- [ ] 已提交所有更改到git
- [ ] 已推送到main分支
- [ ] 已创建并推送版本标签
- [ ] GitHub Actions构建已触发

**质量检查：**
- [ ] 所有文件的版本号保持一致
- [ ] 变更日志描述清晰准确（无技术细节）
- [ ] version.json的changes符合规范（无emoji、无代码）

### 版本号规则

格式：`主版本.次版本.修订号.构建号` (例如: 1.2.0.15)

- **主版本号**: 重大架构变更或功能重构
- **次版本号**: 新功能添加或重要改进
- **修订号**: 问题修复和小幅优化
- **构建号**: 日常构建和测试版本

### Emoji使用规范

- 🎨 界面优化、设计改进
- ✨ 新功能
- 🔧 问题修复、技术改进
- 📊 数据相关、图表优化
- 🎯 用户体验改进
- 🔄 重构、流程优化
- 🐛 Bug修复
- 📝 文档更新
- 🚀 性能优化
- 🔒 安全修复
- 🌈 视觉体验提升

## Git提交规范

### Commit Message格式

```
<emoji> <type>: <subject>

<body>

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### Type类型
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式调整
- refactor: 重构
- perf: 性能优化
- test: 测试相关
- chore: 构建/工具变动

## 代码风格

### Python代码
- 使用4个空格缩进
- 遵循PEP 8规范
- 函数和方法添加docstring
- 复杂逻辑添加注释

### 文件命名
- Python文件：snake_case（小写+下划线）
- 类名：PascalCase（大驼峰）
- 常量：UPPER_CASE（全大写+下划线）

## 重要提醒

⚠️ **version.json 是GitHub Actions上传到OSS的关键文件，客户端通过读取OSS上的version.json来检查更新。如果忘记更新此文件，用户将无法正确获取新版本信息！**

每次版本更新时，AI助手必须：
1. 主动检查并更新version.json
2. 在提交前再次确认version.json内容正确
3. 确保version.json与version.py的版本号完全一致
