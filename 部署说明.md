# 部署data_api更新说明

## 需要更新的原因
服务器上的data_api.py仍然要求认证，导致上传缺失公牛记录失败（401错误）。
本次更新移除了数据API的认证要求，使其与下载公牛数据库的逻辑保持一致。

## 更新内容
1. 移除了JWT认证验证
2. 所有数据API端点无需认证：
   - `/api/data/version` - 获取数据库版本
   - `/api/data/bull_library` - 获取公牛库数据
   - `/api/data/missing_bulls` - 上传缺失公牛记录

## 部署步骤

### 方法1：通过SSH手动部署

```bash
# 1. 连接到服务器
ssh ecs-user@39.96.189.27

# 2. 备份现有文件
cd /home/ecs-user/api
cp data_api.py data_api.py.backup

# 3. 上传新文件（在本地终端执行）
scp data_api_update.py ecs-user@39.96.189.27:/home/ecs-user/api/data_api.py

# 4. 在服务器上重启服务
pm2 restart data_api

# 5. 检查服务状态
pm2 status data_api
```

### 方法2：直接在服务器上编辑

```bash
# 1. 连接到服务器
ssh ecs-user@39.96.189.27

# 2. 编辑文件
cd /home/ecs-user/api
nano data_api.py

# 3. 找到并修改以下行（移除认证参数）：
# 原来：
# @app.get("/api/data/version")
# async def get_database_version(user=Depends(verify_token)):

# 改为：
# @app.get("/api/data/version")
# async def get_database_version():

# 对其他端点做同样修改

# 4. 删除JWT相关代码
# 删除verify_token函数和JWT相关的import

# 5. 保存并重启
pm2 restart data_api
```

## 验证部署

部署后，运行以下命令测试：

```bash
# 测试上传缺失公牛（无需认证）
curl -X POST http://39.96.189.27/api/data/missing_bulls \
  -H "Content-Type: application/json" \
  -d '{"bulls":[{"bull":"TEST","source":"test","time":"2025-01-01T00:00:00","user":"test"}]}'

# 应该返回成功响应
```

## 注意事项
- 确保在修改前备份原文件
- 修改后需要重启pm2服务
- 如果端口8082未开放，data_api可能运行在80端口（通过nginx代理）