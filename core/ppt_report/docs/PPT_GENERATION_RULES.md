# PPT自动生成规则（2025-11模板）

本规则面向 `/Users/bozhenwang/projects/mating/genetic_improve/牧场牧场育种分析报告-模版.pptx`，已通过 XML 扁平化文件解析（见 `ppt_generation_rules.json`）得到全部 58 页的尺寸、布局和元素坐标。由于后续内容根据 Excel 数据动态生成，本规则以“版式模板 + 数据映射”的方式描述实现要求。

## 1. 模板概览
- 幻灯片尺寸：13.33" × 7.50"（3387mm × 1905mm），所有坐标单位优先使用厘米（1cm ≈ 360000 EMU）。
- 布局索引：
  | Layout | 名称             | 用途                                   |
  | ------ | ---------------- | -------------------------------------- |
  | 0      | 封面             | Slide 1，固定版式                     |
  | 1      | 间隔/章节页      | Slide 2 的 TOC + 每个章节分隔页       |
  | 2      | 正文页-单列      | 未使用，可保留备用                     |
  | 3      | 正文页-两列      | 未使用                                 |
  | 4      | 图片页           | 未使用                                 |
  | 5      | 空白内容页       | 所有内容页面基准布局（标题、内容手工放置）|
  | 6/7/8  | 备用             | 暂未启用                               |
- 色彩/字体（来自 `config.py`）：
  - 主色：蓝 `RGB(0,139,206)`，用于标题、装饰线与图表主色。
  - 辅色：黄绿 `RGB(138,184,74)`（章节竖条）、浅蓝灰 `RGB(174,200,223)`（章节编号底）、深灰 `RGB(64,64,64)` 与浅灰 `RGB(128,128,128)`（正文文字）。
  - Fonts：中文 `微软雅黑`，数字/编号 `Arial`。
  - 字号参考：封面标题 44-60pt、章节标题 60pt、正文页标题 36pt、内容 18-24pt、评论 16pt。

## 2. 固定页面规范
### 2.1 Slide 1 封面（Layout 0）
- 标题矩形：`left=13.83cm, top=9.26cm, width=18.31cm, height=3.10cm`，文字两端对齐、44pt 蓝色加粗并带阴影，文案 `{牧场名}育种分析综合报告`。
- 日期/服务人文本框：`left=23.35cm, top=13.81cm, width=8.79cm, height=4.21cm`，包含两行文字：`YYYY年M月` 与 `服务人员：{reporter}`，字号 24pt。

### 2.2 Slide 2 目录（Layout 1）
- 背景椭圆：`(6.35cm, 2.03cm, 22.86cm × 15.24cm)`。
- 左列章节 (01-04) x 坐标 `9.5/10.01/12.17cm`；右列 (05-07) x 坐标 `18.14/18.62/20.8cm`；每项包含竖线、编号框（48pt）、标题（20pt）、副标题（14pt）。章节文案固定，可根据实际生成的分册数量裁剪或增补。

### 2.3 章节分隔页（Layout 1 通用模板）
- 绿色竖条：`left≈8.61cm, top≈6.26cm, size=0.7 × 5.5cm`。
- 编号底：`left≈10.67cm, top≈6.26cm, size=3.81 × 3.81cm`，编号文字 80pt 白色。
- 主标题：`left≈15.8cm, top≈6.26cm, width≈17.78cm`，60pt 白色。
- 副标题：`left≈17.88cm, top≈9.64cm, width≈17.78cm`，20pt `RGB(220,235,250)`。
  > 每一章节（01~07，必要时可追加 08 项目总结）都沿用上述坐标，只替换编号与文案。

### 2.4 正文内容页（Layout 5 空白）
- 标题：`left=2.74cm, top=1.37cm, width=27.94cm, height=1.52cm`，36pt 蓝色；副标题或提示文字可放在标题下 `top≈3.2cm`。
- 内容区：建议以 `left=3.5cm, top=4.3cm, width=12cm` 为左列基准，`left=17.2cm` 为右列基准。图表尺寸常用 `width=12cm, height=8cm`。
- 评论/结论框：`left=2.03cm, top=15.5cm, width=27cm, height≈1.2cm`，16pt 浅灰文本，浅灰背景。

## 3. 动态章节与数据映射
下表概述每个 Part 的页面组成（章节页 + 内容页数量）以及所需 Excel 数据（样例路径：`/Users/bozhenwang/GeneticImprove/sheet8_2025_10_12_13_13/reports/育种分析综合报告_20251104_180856.xlsx`）。

| Part | 页面结构 | Excel Sheet | 主要字段/用途 |
| ---- | -------- | ----------- | ------------ |
| 1 封面/目录 | 固定 2 页 | 牧场基础信息 | A/B 区域提取牧场名、报告时间、服务人员；目录文案固定，可按实际分册控制显示。|
| 2 牧场概况 | 章节页 + 2 内容页（标准+高级）。必要时根据牛群类别动态追加对比页。 | 牧场基础信息、牧场牛群原始数据 | - Sheet1 横向读取：牧场名、服务人、总牛数、成母牛/后备牛占比、平均胎次/泌乳天数。<br>- `牧场牛群原始数据` 汇总牛只类别、胎次、是否核心牛的数量，用于饼图/柱图。 |
| 3 系谱记录分析 | 章节页 + 2 内容页 | 系谱识别分析、全群母牛系谱识别明细 | - `系谱识别分析`：识别率、未知率、核对进度等；<br> - 明细表按胎次 or 核心牛筛选，必要时分多页。 |
| 4 指数分布（TPI/NM$） | 章节页 + 2 内容页 | 育种指数分布分析、TPI分布分析、NM$分布分析 | - `育种指数分布分析`: 区间 vs 头数/占比，生成堆叠条形或折线；<br>- TPI/NM$ Sheet 直接提供分布表格。 |
| 5 母牛排名 | 章节页 + N 内容页（标准/高级 + 多页表格） | 育种性状明细、母牛指数排名明细 | - 取 TPI/NM$ Top 20 + 核心牛 Top10，若记录>20需分页；<br>- 明细列包括耳号、胎次、TPI、NM$、生产指标。 |
| 6 配种记录 & 隐性基因 | 章节页 + 2 内容页 + 可选明细页 | 配种记录-隐性基因分析、配种记录-近交系数分析、配种记录-隐性基因及近交系数明细 | - Summary Sheet 生成饼图（隐性基因载体比例）与条形图（近交区间）；<br>- 明细表若记录超 25 头需分页。 |
| 7 公牛使用 & 选配推荐 | 章节页 + 3 内容页（已用、备选、选配结果） | 已用公牛性状汇总、已用公牛性状明细、备选公牛排名、备选公牛-隐性基因分析、备选公牛-近交系数分析、个体选配推荐结果 | - 已用公牛：按使用频次、性状指数绘制柱图+TOP表；<br>- 备选公牛：展示推荐 Top 10 + 载体/近交风险；<br>- 选配结果：引用 `个体选配推荐结果` Sheet（母牛ID、公牛ID、预期指数、近交风险），按每页 12~15 条渲染多页。 |
| 8 项目总结/建议（可选） | 章节页 + 1 内容页 | 综合指标（可由前述 DataFrame 汇总） | - 依据前述数据生成 KPI 提示与行动建议，若 Excel 后续补 Sheet，可直接引用。 |

### 动态分页规则建议
1. **表格分页**：任何列表当行数 > 18 行时自动拆分为多页，每页共享相同标题与表头。`ppt_generation_rules.json` 中的 `table` 对象仅提供行高参考，分页逻辑由构建器负责。
2. **图表数据不足**：当某 Sheet 缺失（如部分牧场未上传配种记录），保持标题并在内容区显示“暂无数据”文本框（20pt 浅灰）。
3. **章节可选**：若数据源缺失整块（例如没有备选公牛），允许跳过对应章节，并在目录中同步移除编号，保持页码连续。

## 4. Excel 数据读取要求
- 数据入口：`DataCollector.collect_all_data()`。需更新 `sheets_to_read` 映射为**当前 Excel 实际 Sheet 名**（参照上表 20 个 Sheet）。
- `牧场基础信息` 需 `header=None` 并通过关键词定位字段，解析后缓存 `farm_info_dict`（字段：`farm_name`, `report_time`, `service_staff`, `total_count`, `lactating_count`, `heifer_count`, `avg_lactation`, `avg_dim`）。
- 其他 Sheet 默认第一行为列名。若存在多表头（如“育种指数分布分析”），需要在 DataCollector 中清洗：删除全空列，向前填充分组列，转换百分比列为 float。
- 所有数值字段在入库前统一转换：
  - 头数、胎次、频次 → `int`
  - 占比、指数、进展值 → `float`，保留 2 位小数。
  - 日期列统一为 `datetime` 或 `YYYY-MM-DD` 字符串。

## 5. 后续实现顺序建议
1. **同步 `DataCollector`**：补齐 Sheet 映射 + 清洗函数，确保 `data_cache` 覆盖所有章节所需字段。
2. **完成 Part1 Builder**：`slide_01_cover.py`、`slide_02_toc.py` 已实现，可直接调用，也可整合进 `Part1CoverBuilder`。
3. **按章节实现内容页**：优先完成 Part2（可复用 Excel 表格/饼图逻辑），随后逐步实现 Part3~Part7。每个章节需提供 `standard` 与 `enhanced` 两种实现（python-pptx 原生图表 / Matplotlib 图像）。
4. **分页/条件渲染**：在生成器中根据 DataFrame 行数动态添加幻灯片。
5. **测试**：使用示例 Excel 路径运行 `ExcelBasedPPTGenerator`，确保输出 PPT 与模板尺寸一致、无元素溢出。

该文档会随模板或数据结构调整而更新，所有坐标及颜色应直接复用 `config.py` 中的常量，避免硬编码。

## 模板分页策略（clone_slide）

针对 `/Users/bozhenwang/projects/mating_genetic_improve/牧场牧场育种分析报告-模版.pptx`，需要按照既有页面内容决定是否克隆。约定如下：

| 页码范围 | 模块 | 动态? | 分页 / 克隆规则 |
| --- | --- | --- | --- |
| 1 | 封面 | 否 | 仅替换牧场名、日期、汇报人。 |
| 2 | 目录 | 否 | 更新目录文案即可。 |
| 3 | 章节引导页 | 否 | 固定内容，替换文字。 |
| 4 | 牧场基础信息页 | 否 | 固定表格/图表，替换数据。 |
| 5-10 | 其余 Part1/Part2 静态页 | 否 | 模板已有页按需求填充，不新增克隆。 |
| 11-22 | 关键性状进展折线图 | 是 | 每张折线图一页。根据 Excel 中需要绘制的指标数动态克隆模板页，保留原图设计，仅替换数据源。 |
| 23-36 | 其它静态分析页 | 否 | 模板固定，直接填数据。 |
| 37-41 | 表格页（主题不同） | 是 | 每页主表格固定尺寸：高 10cm、宽 33cm。若表格数据超出高度，克隆该页；保留表头并继续填充剩余行。 |
| 42-47 | 公牛进展分析折线图 | 是 | 根据 Excel 中的折线图数量克隆模板页，每页沿用模板中的图表结构和配色，仅替换数据。 |
| 48 | 过渡/固定页 | 否 | 仅替换内容。 |
| 49 | 备选公牛排名 | 部分动态 | 上半部分“优质冻精技术标准”保持原样。下方“备选公牛排名”表格高度阈值 6cm，超过则克隆该页并在新页继续填充，保留 3 行表头。 |
| 50-52 | 备选公牛·隐性基因分析 | 是 | 按 Excel 中的公牛数量分页。无论某公牛风险占比是否为 0，只要存在条目即占用一行，超出模板容纳行数则克隆该页。 |
| 53-55 | 备选公牛·近交系数分析 | 是 | 与 50-52 页同理，按条目数克隆。 |
| 56-58 | 结尾固定页 | 否 | 固定内容，替换文本/图表即可。 |

实现时优先使用 `clone_slide(template_slide)` 复制页面，确保字体、颜色、图表和布局完全继承模板。分页容量、表头高度等参数可以在对应的 Builder 中以常量形式维护，便于调整。其它未列出的页视为固定页，只进行内容替换，不新增副本。
