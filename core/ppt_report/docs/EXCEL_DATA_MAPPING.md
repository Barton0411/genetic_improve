# Excel数据映射（育种分析综合报告）

样例文件：`/Users/bozhenwang/GeneticImprove/sheet8_2025_10_12_13_13/reports/育种分析综合报告_20251104_180856.xlsx`

`DataCollector` 需要覆盖下列 Sheet。表格中列出了关键信息和预期的 PPT 用途，便于后续在构建器内定位字段并决定分页策略。

| Sheet 名称 | 主要内容与结构 | 关键字段/说明 | PPT 章节用途 |
| --------- | -------------- | -------------- | ------------- |
| 牧场基础信息 | 横向区域表，包含「一、基本信息」「成母牛/后备牛分布」「胎次分布」「上传数据概览」。 | `牧场名称`、`报告生成时间`、`牧场服务人员`、成母牛/后备牛数量、合计头数、平均胎次、平均泌乳天数、上传数据条目数。 | Part1 封面（牧场名、日期、服务人），Part2 牧场概况（基本数据信息表、上传数据概览）。 |
| 牧场牛群原始数据 | 逐牛记录 50+ 列，包含耳号、牛舍、胎次、繁育状态、父母号等。 | 用于统计在场/离场、牛只类别、胎次、核心牛与用途。 | Part2 高级版饼图、柱状图（牛群结构、胎次分布）。 |
| 系谱识别分析 | 表头为「一、系谱识别情况汇总（按出生年份）」等统计段。 | 出生年份、母牛数、父号识别率、外祖父识别率、目标对比列。 | Part3 系谱分析图表（识别率折线/堆叠）。 |
| 全群母牛系谱识别明细 | 明细字段包含父号、外祖父、胎次、出生日期等。 | 可筛选缺失系谱的牛只清单。 | Part3 明细表（高风险牛名单、识别缺口TOP）。 |
| 年份汇总与性状进展 | Sheet 由三块组成：在群母牛年份汇总、全部母牛年份汇总、对比数据。 | 各年份的头数、TPI/NM$/产奶指标年度均值与增幅。 | Part4 或 Part5 的年度趋势折线（可选）。 |
| NM$分布分析 | 「在群母牛」「全部母牛」两套分布区间（含头数、占比）。 | 区间标签、头数、占比。 | Part4 内容页（NM$ 区间柱状图/表格）。 |
| TPI分布分析 | 与 NM$ 类似，针对 TPI。 | 区间标签、头数、占比。 | Part4 内容页（TPI 区间折线/热力）。 |
| 育种性状明细 | 母牛耳号、家系、TPI/NM$、主要性状指标。 | `TPI`, `NM$`, `MILK`, `FAT`, `PROT`, `SCS`, `PTAT`, `UDC`, `FLC` 等。 | Part5 高级版图表（散点/雷达），或与排名明细联动。 |
| 育种指数分布分析 | 与「育种指数」相关的区间统计。 | 分布区间、头数、占比。 | Part4/Part5 辅助图。 |
| 母牛指数排名明细 | 排名结果（TPI/NM$ 双排序）及背景信息。 | `排名`, `测试指数`, `TPI`, `NM$`, 产奶指标等。 | Part5 表格（TopN）、分页列表。 |
| 配种记录-隐性基因分析 | 「隐性基因纯合汇总表（13235 配次）」格式，列出各基因纯合/携带数量。 | 基因名称列、母牛载体数量、公牛载体数量、风险占比。 | Part6 图表（载体分布）。 |
| 配种记录-近交系数分析 | 近交区间汇总。 | 区间标签、头数、占比、平均 F 值。 | Part6 图表（近交区间柱状）。 |
| 配种记录-隐性基因及近交系数明细 | 每条配种记录的近交系数与各隐性基因状态。 | `母牛号`, `配种日期`, `父号/公牛号`, `近交系数`, 各 HH 基因、BLAD 等。 | Part6 明细表（高风险配种 TOP）。 |
| 已用公牛性状汇总 | 按年份统计已用公牛数量、配次、关键性状均值。 | 年份、配次、TPI/NM$/性状均值。 | Part7 已用公牛汇总图表。 |
| 已用公牛性状明细 | 每头已用公牛的配次、性状指标。 | `公牛号`, `配次`, `TPI`, `NM$`, `SCS`, `PTAT` 等。 | Part7 已用公牛 TOP 表/雷达图。 |
| 备选公牛排名 | 冻精筛选标准 + 目标排名（通常含多列标准阈值）。 | `公牛号`, `TPI`, `NM$`, `FLC`, `体型指数`, 是否性控等。 | Part7 备选公牛列表；根据标准筛出 TopN。 |
| 备选公牛-隐性基因分析 | 每头备选公牛的隐性基因载体情况。 | 各 HH/BLAD 等字段（同「明细表」结构）。 | Part7 备选风险提示，可与排名联动。 |
| 备选公牛-近交系数分析 | 针对选定公牛的后代近交系数评估。 | `后代近交系数`、配种组合统计。 | Part7 近交风险图/表。 |
| 备选公牛-明细表 | 每头母牛对应的备选公牛及隐性基因明细。 | `母牛号`, `备选公牛号`, `近交系数`, 隐性基因列。 | Part7 选配推荐表（若 Excel 中已有完整匹配，可直接输出）。 |
| 个体选配推荐结果 | Sheet 顶部为 `选配统计摘要`，下方通常是推荐明细。 | `母牛ID`, `推荐公牛`, `预期TPI`, `预期NM$`, `后代近交F`, `风险提示`。 | Part7 选配推荐页（多页表格）。 |

> **注意**：Excel 中大量列名为 `Unnamed:*`，需要在解析时根据首行文本（如“分布区间”“头数”“占比”）重新命名，以避免后续 DataFrame 运算出错。

## 解析建议
1. `DataCollector` 中的 `sheets_to_read` 应与上表 1:1 对应，可根据内存情况跳读大表（例如 `牧场牛群原始数据` 可只保留统计所需列）。
2. 对于「多段式」Sheet（例如 `牧场基础信息`、`年份汇总与性状进展`、`个体选配推荐结果`），需要额外的解析函数将不同区域拆分成结构化 dict。建议在 `data_collector.py` 中新增 `parse_farm_overview()`, `parse_yearly_summary()`, `parse_mating_summary()` 等方法。
3. 将所有 DataFrame 存入 `data_cache`，并保留 `*_dict` 形式的快捷访问，供 PPT builder 直接取用。
4. 任何涉及 TopN 排序的页面请在解析阶段预先计算排名（例如 `母牛指数排名明细` -> `top_cows` 列表），避免在 PPT 构建时重复筛选。
