# 伊利奶牛选配系统

[![Version](https://img.shields.io/badge/version-1.2.0.2-blue)](https://github.com/Barton0411/genetic_improve)
[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)
[![Python](https://img.shields.io/badge/python-3.9%2B-yellow)](https://www.python.org/)

一个专业的奶牛遗传改良和选配管理系统，集成了数据分析、遗传评估、选配推荐等功能。

## 🎯 功能特点

### 核心功能
- ✅ **育种项目管理** - 多项目并行管理，独立数据存储
- ✅ **数据上传** - 支持母牛、公牛、配种记录、体型外貌、基因组数据
- ✅ **关键育种性状分析** - 产奶量、乳脂率、乳蛋白率等性状分析
- ✅ **牛只指数计算排名** - 基于遗传评估的综合指数排名
- ✅ **近交系数分析** - 群体近交水平监控和风险评估
- ✅ **隐性基因分析** - 遗传缺陷基因筛查和载体识别
- ✅ **个体选配推荐** - 智能选配算法，优化后代遗传潜力
- ✅ **冻精分配管理** - 基于选配结果的冻精智能分配
- ✅ **选配报告生成** - 详细的选配推荐报告和后代预测
- ✅ **选配结果推送** - 支持推送选配结果到外部API
- ✅ **PPT自动报告** - 专业的育种分析演示文稿生成

### 技术特点
- 🔐 **安全登录** - 阿里云账号验证系统
- ☁️ **云端数据库** - 基于阿里云PolarDB的高性能数据存储
- 🔄 **自动更新** - 完整的应用内智能更新系统，支持强制更新和跨平台安装
- 📱 **现代界面** - 基于PyQt6的现代化用户界面
- 🚀 **高性能** - 优化的数据处理和缓存机制
- 📊 **数据可视化** - 丰富的图表和血缘图展示
- 📤 **多格式导出** - 支持Excel、PPT等多种格式导出

## 🏗️ 系统架构

```
伊利奶牛选配系统/
├── core/                    # 核心功能模块
│   ├── config/             # 配置管理
│   ├── data_processor/     # 数据处理器
│   ├── genetics/           # 遗传学计算
│   ├── mating/             # 选配算法
│   ├── reports/            # 报告生成
│   └── update/             # 版本更新
├── gui/                    # 用户界面
│   ├── main_window.py      # 主窗口
│   ├── login_dialog.py     # 登录对话框
│   ├── splash_screen.py    # 启动画面
│   └── components/         # UI组件
├── database/               # 数据库相关
│   ├── connection.py       # 数据库连接
│   ├── models/             # 数据模型
│   └── migrations/         # 数据库迁移
├── utils/                  # 工具模块
├── assets/                 # 静态资源
├── deployment/             # 部署配置
└── docs/                   # 文档
```

## 🔧 安装与部署

### 系统要求
- **操作系统**: Windows 10/11 或 macOS 10.14+
- **内存**: 最低4GB，推荐8GB+
- **存储空间**: 最低2GB可用空间
- **网络**: 稳定的互联网连接（用于云端数据同步）

### 安装方法

#### 方法1: 下载预编译版本（推荐）
1. 访问 [Releases页面](https://github.com/Barton0411/genetic_improve/releases)
2. 下载适合您操作系统的安装包：
   - Windows: `伊利奶牛选配_v1.1.2.0_win.exe`
   - macOS: `伊利奶牛选配_v1.1.2.0_mac.dmg`
3. 运行安装包并按照提示完成安装

#### 方法2: 从源代码构建
```bash
# 克隆仓库
git clone https://github.com/Barton0411/genetic_improve.git
cd genetic_improve

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\\Scripts\\activate

# 安装依赖
pip install -r requirements.txt

# 运行程序
python main.py
```

### 首次使用配置
1. 运行程序，将显示登录界面
2. 使用提供的账号密码登录系统
3. 系统将自动检查并下载最新版本
4. 登录成功后即可开始使用各项功能

## 📚 使用指南

### 基本工作流程
1. **创建项目** - 新建育种项目或选择现有项目
2. **数据上传** - 上传母牛、公牛等基础数据
3. **数据分析** - 查看关键性状分析和遗传评估结果
4. **选配决策** - 使用个体选配功能获取推荐方案
5. **结果推送** - 推送选配结果到外部系统（可选）
6. **报告生成** - 生成详细的选配报告和分析PPT

### 主要模块说明

#### 数据管理
- **母牛数据**: 基本信息、生产性能、体型外貌数据
- **公牛数据**: 种公牛信息、遗传评估值、精液库存
- **配种记录**: 历史配种数据、妊娠结果
- **基因组数据**: SNP标记、基因型信息

#### 遗传分析
- **育种值估计**: BLUP方法估计个体育种值
- **近交分析**: 计算个体和群体近交系数
- **遗传进展**: 分析群体遗传改良趋势
- **基因频率**: 监控重要基因的频率变化

#### 选配优化
- **约束条件**: 设置近交、隐性基因等约束
- **目标权重**: 调整不同性状的选择重点
- **算法选择**: 多种选配算法可选
- **结果评估**: 预测后代性能和遗传风险

#### 选配结果推送
- **配置牧场信息**: 在项目文件夹创建 `farm_info.json`
  ```json
  {
    "farm_code": "10001"
  }
  ```
- **推送数据字段**:
  - 母牛号（必填）
  - 上传日期（自动生成）
  - 分组、选配公牛、母牛指数得分
- **推送模式**:
  - 本地测试：保存到 `api_push_data.json`
  - API推送：发送到指定API接口（待集成）

## 🛠️ 开发指南

### 开发环境设置
```bash
# 安装开发依赖
pip install -r requirements-dev.txt

# 安装pre-commit钩子
pre-commit install

# 运行测试
python -m pytest tests/

# 代码格式化
black .
```

### 构建发布版本
```bash
# Windows
python build_scripts/build_windows.py

# macOS
python build_scripts/build_mac.py
```

### 数据库开发
- **连接信息**: 详见 `deployment/README.md`
- **模型定义**: 使用SQLAlchemy ORM
- **迁移管理**: Alembic数据库迁移工具

## 🚀 部署架构

### 云服务架构
```
用户端应用程序
       ↓
    负载均衡器
       ↓
  API服务器集群 (阿里云ECS)
       ↓
  数据库集群 (阿里云PolarDB)
       ↓
  对象存储 (阿里云OSS)
```

### 服务器配置
- **域名**: `https://api.genepop.com`
- **备用服务器**: `http://39.96.189.27:8080`
- **数据库**: 阿里云PolarDB MySQL
- **文件存储**: 阿里云OSS
- **SSL证书**: Let's Encrypt自动续期

### 版本更新机制
- **检查频率**: 用户登录时自动检查
- **更新通知**: GUI对话框提示用户
- **下载方式**: 浏览器自动下载，手动安装
- **回滚支持**: 支持版本回退机制

## 📊 版本历史

### v1.1.2.0 (2025-09-21) 🆕
- 🎨 **缺失公牛数据智能预估**
  - 基于遗传趋势的年份预估算法
  - 线性插值填充缺失年份
  - 默认公牛(999HO99999)数据兜底
- 📊 **数据质量可视化标记**
  - 红色字体：年份预估值
  - 灰色背景+黄色字体：默认值
  - 所有Excel报告支持格式标记
- 🚀 **性能优化**
  - 预填充估算值，简化计算流程
  - 优化内存使用，提升处理速度

### v1.1.0.5 (2025-09-19)
- 📤 **新增选配结果推送功能**
  - 在个体选配页面添加推送按钮
  - 支持本地测试和API推送模式
  - 自动处理缺失字段
- 📝 **更新开发文档**
  - 完善API配置说明
  - 添加推送功能使用指南
- 🔧 **优化数据验证**
  - 必填字段验证（farm_code、母牛号）
  - 智能处理缺失列

### v1.1.0.1 (2025-09-19)
- 🐛 修复个体选配中常规公牛无法分配的问题
- ✨ 增强推荐矩阵生成时的数据验证
- 🔍 在推荐生成阶段过滤无库存和无数据的公牛
- 📊 新增公牛数据质量检查报告
- 🛡️ 提升系统容错性，防止无效数据导致分配失败
- 📝 优化日志输出，提供更详细的数据筛选信息

### v1.1.0.0 (2025-09-17) - 🚀 重大版本发布
1. 重大版本发布：完整自动更新机制，用户无需自行下载
2. 支持跨平台运行（Windows/macOS）
3. 支持近交系数计算，采用6代系谱通经法计算
4. 支持个体选配自动分组
5. 支持备注选配时部分牛只无选配的原因呈现
6. 本次重构后，自动化生产报告模块，暂未开放
7. 本次重构后，体型外貌鉴定自动分析模块，暂未开放

### v1.0.9.13 (2025-09-17)
- ✨ 为强制更新对话框添加关闭按钮
- 🔒 增加关闭确认机制，防止意外跳过重要更新
- ⌨️ 支持ESC键关闭对话框（需确认）
- 🎯 优化用户体验，提供更多操作选择

### v1.0.9.12 (2025-09-17)
- 🔍 增强版本更新检查日志记录
- 🐛 修复Windows平台版本检查问题诊断
- 📊 添加详细的版本检查流程跟踪
- 🛠️ 改进错误信息和调试输出
- ⚡ 优化版本管理器初始化流程
- 🔒 增强异常处理和错误报告

### v1.0.9.11 (2025-09-17)
- 🔥 macOS改为手动拖拽安装，避免应用崩溃
- ⚡ 移除自动删除复制逻辑，防止应用包损坏
- 🛡️ 利用macOS原生应用替换机制
- 🎯 简化安装流程，提升用户体验
- 🔒 修复QtCore模块内存访问崩溃问题
- 📦 保持DMG挂载状态便于用户操作
- 🌙 优化手动安装指导显示
- 🚀 同时支持Windows和macOS平台打包

### v1.0.9.10 (2025-09-17)
- 🔥 完整实现应用内自动更新系统
- ⚡ 真实下载功能替代模拟进度条
- 🛡️ 智能DMG挂载和应用识别机制
- 🎯 通用应用名称识别，无需硬编码
- 🔒 多重安全验证避免误操作其他应用
- 📦 支持完全自动安装和重启
- 🌙 修复暗色模式下手动安装指导显示问题
- 🚀 端到端自动更新流程验证完成

### v1.0.6 (2025-09-16)
- 🔥 实现强制更新系统，确保关键更新必须安装
- ⚡ 新增应用内智能更新功能，无需手动下载安装包
- 🛡️ 增强更新安全性，支持完整文件替换和回滚机制
- 🎨 全新设计的更新对话框，支持深色/浅色模式自动适配
- 📦 智能路径检测，支持任意安装位置的程序更新
- 🔒 保护用户数据，更新过程中项目文件和配置安全不受影响
- 🚀 三阶段更新流程：准备→执行→验证，确保更新可靠性
- 💻 跨平台兼容，完美支持Windows、macOS和Linux系统

### v1.0.5 (2025-09-16)
- ✨ 完善版本自动更新系统，支持GUI选择下载
- 🐛 修复版本检查逻辑，优化服务器连接稳定性
- 📝 更新文档和部署指南
- 🔧 优化GitHub Actions构建流程

### v1.0.4 (2025-09-15)
- 🎨 修复Mac应用图标显示问题
- 🔧 优化Windows构建完整性
- 📱 更新应用名称为"伊利奶牛选配"

### v1.0.3 (2025-08-27)
- 🐛 修复后代近交系数排序问题
- 🎨 修复血缘图滚轮缩放时图形消失问题
- ✨ 添加代数选择按钮，支持2-6代血缘图显示
- 🎯 提升用户界面交互体验

### v1.0.2 (2025-08-08)
- ⚡ 优化冻精分配算法
- 📊 加载公牛指数得分用于计算后代得分
- 🐛 修复冻精预览表列宽问题
- ✨ 添加育种项目管理文件操作功能

### v1.0.1 (2025-07-29)
- 🚀 重大改进PPT生成功能
- ✨ 新增多个专业分析页面
- 🔧 修复数据库连接问题
- 📦 更新依赖项管理

### v1.0.0 (2025-07-28)
- 🎉 初始版本发布
- ✨ 实现核心育种管理功能
- 🔐 集成阿里云认证系统
- 📊 完整的数据分析和报告生成

## 🤝 技术支持

### 联系方式
- **技术支持**: 通过GitHub Issues提交问题
- **功能建议**: 通过GitHub Discussions讨论
- **紧急联系**: 联系系统管理员

### 常见问题
1. **登录问题**: 检查网络连接和账号密码
2. **数据上传失败**: 确认文件格式和数据完整性  
3. **报告生成错误**: 检查数据依赖关系
4. **界面显示异常**: 更新显卡驱动或重启应用

### 故障排除
- 查看应用日志: `~/.genetic_improve/app_debug.log`
- 重置用户配置: 删除用户配置目录
- 清除缓存数据: 重新启动应用程序

## 📄 许可证

Copyright © 2025 伊利奶牛选配系统开发团队. All rights reserved.

本软件为专有软件，未经授权不得复制、分发或修改。

---

**构建信息**
- 版本: v1.1.0.0 (重大版本发布)
- 构建时间: 2025-09-17
- Python版本: 3.9+
- PyQt版本: 6.x
- 支持平台: Windows, macOS
- 新特性: 完整自动更新机制